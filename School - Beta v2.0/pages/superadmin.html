<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - My School</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <!-- Local Storage Only -->
    <script src="../assets/js/firebase-config.js"></script>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>My School</span>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="#" id="nav-dashboard" class="nav-item active" onclick="event.preventDefault(); SuperAdmin.showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Schools</div>
                    <a href="#" id="nav-schools" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('schools')">
                        <i class="fas fa-school"></i>
                        <span>All Schools</span>
                    </a>
                    <a href="#" id="nav-codes" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('codes')">
                        <i class="fas fa-key"></i>
                        <span>Activation Codes</span>
                    </a>
                    <a href="#" id="nav-restrictions" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('restrictions')">
                        <i class="fas fa-shield-alt"></i>
                        <span>Access Control</span>
                    </a>
                    <a href="#" id="nav-blog" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('blog')">
                        <i class="fas fa-blog"></i>
                        <span>Blog</span>
                    </a>
                    <a href="#" id="nav-resources" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('resources')">
                        <i class="fas fa-folder-open"></i>
                        <span>Resources</span>
                    </a>
                    <a href="#" id="nav-pricing" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('pricing')">
                        <i class="fas fa-tags"></i>
                        <span>Pricing</span>
                    </a>
                    <a href="#" id="nav-pages" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('pages')">
                        <i class="fas fa-file-alt"></i>
                        <span>Pages</span>
                    </a>
                    <a href="#" id="nav-chat" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('chat')">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                    </a>
                </div>
                <!-- School Admin View (shown when school is selected) -->
                <div class="nav-section" id="schoolAdminNav" style="display: none;">
                    <div class="nav-section-title">School Management</div>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('dashboard'); return false;">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>School Dashboard</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('students'); return false;">
                        <i class="fas fa-user-graduate"></i>
                        <span>Students</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('staff'); return false;">
                        <i class="fas fa-users"></i>
                        <span>Staff</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('parents'); return false;">
                        <i class="fas fa-user-friends"></i>
                        <span>Parents</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('scores'); return false;">
                        <i class="fas fa-star"></i>
                        <span>Scores & Grades</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('attendance'); return false;">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Attendance</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('finance'); return false;">
                        <i class="fas fa-wallet"></i>
                        <span>Finance</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('reports'); return false;">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('idcards'); return false;">
                        <i class="fas fa-id-card"></i>
                        <span>ID Cards</span>
                    </a>
                    <a href="#" class="nav-item" onclick="SuperAdmin.showSchoolSection('settings'); return false;">
                        <i class="fas fa-cogs"></i>
                        <span>School Settings</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Settings</div>
                    <a href="#" id="nav-announcement" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('announcement')">
                        <i class="fas fa-bullhorn"></i>
                        <span>Announcement</span>
                    </a>
                    <a href="#" id="nav-theme" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('theme')">
                        <i class="fas fa-palette"></i>
                        <span>Theme Settings</span>
                    </a>
                    <a href="#" id="nav-help" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('help')">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Guide</span>
                    </a>
                    <a href="#" id="nav-data" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('data')">
                        <i class="fas fa-database"></i>
                        <span>Data Management</span>
                    </a>
                    <a href="#" id="nav-profile" class="nav-item" onclick="event.preventDefault(); SuperAdmin.showSection('profile')">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">SA</div>
                    <div class="user-details">
                        <div class="user-name" id="currentUserName">Super Admin</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
                <button class="btn logout-btn" onclick="Auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <!-- School View Banner -->
            <div id="schoolViewBanner" class="school-view-banner" style="display: none;">
                <div class="school-view-banner-content">
                    <i class="fas fa-school"></i>
                    <span>You are viewing <strong id="viewingSchoolName">School Name</strong> as Administrator</span>
                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.exitSchoolView()">
                        <i class="fas fa-times"></i> Exit View
                    </button>
                </div>
            </div>
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <!-- School Selector Dropdown -->
                    <div class="school-selector">
                        <select id="schoolSelector" class="form-control" onchange="SuperAdmin.selectSchool(this.value)">
                            <option value="">-- Select School to Manage --</option>
                        </select>
                    </div>
                </div>
                <div class="navbar-right">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="notification-container">
                        <button class="navbar-icon-btn" onclick="NotificationPanel.toggle()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button class="btn btn-sm btn-link" onclick="NotificationPanel.markAllRead()">Mark all read</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <div class="navbar-profile" onclick="SuperAdmin.showProfile()">
                        <div class="avatar">SA</div>
                        <span class="name">Super Admin</span>
                    </div>
                </div>
            </nav>

            <div class="page-content">
                <!-- Main Super Admin Content -->
                <div id="mainContent" style="display: block;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Super Admin Dashboard</h1>
                            <p class="page-subtitle">Manage all schools and system settings</p>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="SuperAdmin.generateCode()">
                                <i class="fas fa-plus"></i> Generate Code
                            </button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-school"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Schools</div>
                                <div class="stat-value" id="totalSchools">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Active Schools</div>
                                <div class="stat-value" id="activeSchools">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Staff</div>
                                <div class="stat-value" id="totalUsers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Students</div>
                                <div class="stat-value" id="totalStudentsAll">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Available Codes</div>
                                <div class="stat-value" id="availableCodes">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Expired Schools</div>
                                <div class="stat-value" id="expiredSchools">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-naira-sign"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Income</div>
                                <div class="stat-value" id="totalIncome">₦0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar Widget -->
                    <div class="grid-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar"></i> Calendar</h3>
                                <button class="btn btn-sm btn-outline" onclick="Calendar.showAddEventModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="calendarWidget" class="calendar-widget"></div>
                            </div>
                        </div>
                    </div>

                    <div id="dashboardWidgets" class="dashboard-widgets">
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-school"></i> Recent Schools</h3>
                                </div>
                                <div class="card-body">
                                    <div id="recentSchools">
                                        <div class="empty-state">
                                            <p>No schools registered yet</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-key"></i> Recent Activation Codes</h3>
                                </div>
                                <div class="card-body">
                                    <div id="recentCodes">
                                        <div class="empty-state">
                                            <p>No codes generated yet</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- School Admin View Container (Outside mainContent) -->
                <div id="schoolAdminContainer" style="display: none;">
                <!-- School Dashboard Section -->
                <div id="schoolDashboardSection">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title" id="schoolDashTitle">School Dashboard</h1>
                            <p class="page-subtitle" id="schoolDashSubtitle">Manage school operations</p>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Students</div>
                                <div class="stat-value" id="schoolTotalStudents">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="fas fa-chalkboard-teacher"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Teachers</div>
                                <div class="stat-value" id="schoolTotalTeachers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Attendance Today</div>
                                <div class="stat-value" id="schoolAttendanceToday">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="schoolBalanceAmount">₦0</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-line"></i> Recent Activity</h3>
                            </div>
                            <div class="card-body">
                                <div id="schoolRecentActivity">
                                    <div class="empty-state"><p>No recent activity</p></div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3>
                            </div>
                            <div class="card-body">
                                <div id="schoolNotifications">
                                    <div class="empty-state"><p>No notifications</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- School Students Section -->
                <div id="schoolStudentsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Students</h1></div>
                        <div class="flex gap-2">
                            <label class="btn btn-outline" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Import CSV
                                <input type="file" id="schoolCsvImportInput" accept=".csv" style="display: none;" onchange="SuperAdmin.importSchoolCSV(this)">
                            </label>
                            <button class="btn btn-outline" onclick="SuperAdmin.exportSchoolCSV()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolStudentModal()">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="schoolStudentsTable"></div>
                    </div>
                </div>
                
                <!-- School Staff Section -->
                <div id="schoolStaffSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Staff Management</h1></div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolStaffModal('teacher')">
                                <i class="fas fa-chalkboard-teacher"></i> Add Teacher
                            </button>
                            <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolStaffModal('accountant')">
                                <i class="fas fa-calculator"></i> Add Accountant
                            </button>
                            <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolStaffModal('director')">
                                <i class="fas fa-user-tie"></i> Add Director
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="schoolAllStaff" onclick="SuperAdmin.switchSchoolStaffTab('schoolAllStaff')">All Staff</button>
                        <button class="tab-btn" data-tab="schoolTeachers" onclick="SuperAdmin.switchSchoolStaffTab('schoolTeachers')">Teachers</button>
                        <button class="tab-btn" data-tab="schoolAccountants" onclick="SuperAdmin.switchSchoolStaffTab('schoolAccountants')">Accountants</button>
                        <button class="tab-btn" data-tab="schoolDirectors" onclick="SuperAdmin.switchSchoolStaffTab('schoolDirectors')">Directors</button>
                    </div>
                    <div class="card">
                        <div class="card-body" id="schoolStaffTable"></div>
                    </div>
                </div>
                
                <!-- School Parents Section -->
                <div id="schoolParentsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Parent Accounts</h1></div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolParentModal()">
                                <i class="fas fa-plus"></i> Add Parent
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="schoolParentsTable"></div>
                    </div>
                </div>
                
                <!-- School Scores Section -->
                <div id="schoolScoresSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Scores & Grades</h1></div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="schoolScoreClassSelect" class="form-control" onchange="SuperAdmin.loadSchoolScoreStudents()">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="schoolScoreSubjectSelect" class="form-control" onchange="SuperAdmin.loadSchoolScoreStudents()">
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Term:</label>
                                    <select id="schoolScoreTermSelect" class="form-control" onchange="SuperAdmin.loadSchoolScoreStudents()">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Year:</label>
                                    <select id="schoolScoreYearSelect" class="form-control" onchange="SuperAdmin.loadSchoolScoreStudents()">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                            </div>
                            <div id="schoolScoresTable"></div>
                        </div>
                    </div>
                </div>
                
                <!-- School Attendance Section -->
                <div id="schoolAttendanceSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Attendance</h1></div>
                    </div>
                    <div class="grid-2 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-users"></i> Manual Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="filters-bar">
                                    <div class="filter-group">
                                        <label>Class:</label>
                                        <select id="schoolAttendanceClassSelect" class="form-control" onchange="SuperAdmin.loadSchoolAttendanceStudents()">
                                            <option value="">Select Class</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Date:</label>
                                        <input type="date" id="schoolAttendanceDate" class="form-control" value="">
                                    </div>
                                    <button class="btn btn-primary" onclick="SuperAdmin.loadSchoolAttendanceStudents()">
                                        <i class="fas fa-sync"></i> Load
                                    </button>
                                    <button class="btn btn-success" onclick="SuperAdmin.markAllSchoolStudentsPresent()">
                                        <i class="fas fa-check"></i> Mark All Present
                                    </button>
                                </div>
                                <div id="schoolAttendanceList"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-qrcode"></i> QR Scan Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Scan Date:</label>
                                        <input type="date" id="schoolScanAttendanceDate" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Manual Entry:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="schoolScanStudentInput" class="form-control" placeholder="Enter student ID">
                                        <button class="btn btn-primary" onclick="SuperAdmin.scanSchoolStudentForAttendance()">
                                            <i class="fas fa-check"></i> Mark Present
                                        </button>
                                    </div>
                                </div>
                                <div id="schoolScanResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Attendance Summary</h3>
                        </div>
                        <div class="card-body">
                            <div id="schoolAttendanceSummary"></div>
                        </div>
                    </div>
                </div>
                
                <!-- School Finance Section -->
                <div id="schoolFinanceSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Finance</h1></div>
                        <button class="btn btn-primary" onclick="SuperAdmin.showAddSchoolTransactionModal()">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-arrow-up"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Income</div>
                                <div class="stat-value" id="schoolTotalIncome">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger"><i class="fas fa-arrow-down"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Expenses</div>
                                <div class="stat-value" id="schoolTotalExpenses">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="schoolBalance">₦0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Transactions</h3>
                            <select id="schoolFinanceTypeFilter" class="form-control" style="width: auto;" onchange="SuperAdmin.loadSchoolTransactions()">
                                <option value="all">All</option>
                                <option value="income">Income</option>
                                <option value="expense">Expenses</option>
                            </select>
                        </div>
                        <div class="card-body" id="schoolTransactionsList"></div>
                    </div>
                </div>
                
                <!-- School Reports Section -->
                <div id="schoolReportsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Reports & Analytics</h1></div>
                    </div>
                    <div class="reports-grid">
                        <div class="report-card-item" onclick="SuperAdmin.showSchoolReportType('student')">
                            <div class="report-icon"><i class="fas fa-user-graduate"></i></div>
                            <h3>Student Report</h3>
                            <p>Individual student term results</p>
                        </div>
                        <div class="report-card-item" onclick="SuperAdmin.showSchoolReportType('class')">
                            <div class="report-icon"><i class="fas fa-users"></i></div>
                            <h3>Class Report</h3>
                            <p>All students in a class</p>
                        </div>
                        <div class="report-card-item" onclick="SuperAdmin.showSchoolReportType('attendance')">
                            <div class="report-icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3>Attendance</h3>
                            <p>Daily/weekly/monthly attendance</p>
                        </div>
                        <div class="report-card-item" onclick="SuperAdmin.showSchoolReportType('scores')">
                            <div class="report-icon"><i class="fas fa-star"></i></div>
                            <h3>Scores Report</h3>
                            <p>Score analysis by subject</p>
                        </div>
                        <div class="report-card-item" onclick="SuperAdmin.showSchoolReportType('finance')">
                            <div class="report-icon"><i class="fas fa-wallet"></i></div>
                            <h3>Finance Report</h3>
                            <p>Income & expenses summary</p>
                        </div>
                    </div>
                    <div id="schoolReportFilters" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="schoolReportTypeTitle">Select Report Options</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row" id="schoolReportFiltersContent"></div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-primary" onclick="SuperAdmin.generateSchoolReport()">
                                    <i class="fas fa-sync"></i> Generate Report
                                </button>
                                <button class="btn btn-outline" onclick="SuperAdmin.exportSchoolReport('csv')">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-outline" onclick="SuperAdmin.exportSchoolReport('print')">
                                    <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="schoolReportContent" class="card mt-3" style="display: none;">
                        <div class="card-body" id="schoolReportContentBody"></div>
                    </div>
                </div>
                
                <!-- School ID Cards Section -->
                <div id="schoolIdCardsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">ID Cards</h1></div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Select Type</label>
                                    <select id="schoolIdCardType" class="form-control" onchange="SuperAdmin.loadSchoolIDCardUsers()">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                        <option value="accountant">Accountant</option>
                                        <option value="director">Director</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Select Person</label>
                                    <select id="schoolIdCardUser" class="form-control">
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Format</label>
                                    <select id="schoolIdCardFormat" class="form-control">
                                        <option value="portrait">Portrait</option>
                                        <option value="landscape">Landscape</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="SuperAdmin.generateSchoolIDCard()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            <div id="schoolIdCardPreview" style="margin-top: 24px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- School Settings Section -->
                <div id="schoolSettingsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">School Settings</h1></div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-building"></i> School Information</h3>
                            </div>
                            <div class="card-body">
                                <div id="schoolInfoForm"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-cogs"></i> Configuration</h3>
                            </div>
                            <div class="card-body">
                                <div id="schoolConfigForm"></div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                
                <!-- Schools Section -->
                <div id="schoolsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">All Schools</h1></div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="schoolsListContent"></div>
                    </div>
                </div>
                <!-- Activation Codes Section -->
                <div id="codesSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Activation Codes</h1></div>
                        <div class="flex gap-2">
                            <button class="btn btn-danger" onclick="SuperAdmin.clearAllCodes()">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                            <button class="btn btn-primary" onclick="SuperAdmin.generateCode()">
                                <i class="fas fa-plus"></i> Generate Code
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="codesListContent"></div>
                    </div>
                </div>
                <!-- Announcement Section -->
                <div id="announcementSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Announcement</h1>
                            <p class="page-subtitle">Create announcements visible to all school users</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullhorn"></i> Global Announcement</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Announcement Message</label>
                                <textarea id="announcementMessage" class="form-control" rows="3" placeholder="Enter your announcement message here..."></textarea>
                                <small class="text-muted">This message will be displayed at the top of all school dashboards.</small>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <label class="switch">
                                    <input type="checkbox" id="announcementActive" checked>
                                    <span class="slider"></span>
                                </label>
                                <span id="announcementStatusText" class="ml-2">Active</span>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-primary" onclick="SuperAdmin.saveAnnouncement()">
                                    <i class="fas fa-save"></i> Save Announcement
                                </button>
                                <button class="btn btn-secondary" onclick="SuperAdmin.clearAnnouncement()">
                                    <i class="fas fa-trash"></i> Clear Announcement
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-eye"></i> Preview</h3>
                        </div>
                        <div class="card-body" id="announcementPreview">
                            <p class="text-muted">No announcement set</p>
                        </div>
                    </div>
                </div>
                <!-- Theme Settings Section -->
                <div id="themeSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Theme Settings</h1>
                            <p class="page-subtitle">Customize the look and feel of the entire system</p>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-secondary" onclick="SuperAdmin.resetThemeSettings()">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-paint-brush"></i> Color Settings</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Primary Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="primaryColor" value="#16a34a" style="width: 60px; height: 40px; cursor: pointer;" onchange="document.getElementById('primaryColorHex').value = this.value;">
                                        <input type="text" id="primaryColorHex" class="form-control" value="#16a34a" style="width: 100px;" onchange="document.getElementById('primaryColor').value = this.value;">
                                    </div>
                                </div>
                                <div class="color-presets mt-2">
                                    <button class="color-preset" data-color="#16a34a" style="background: #16a34a;" onclick="document.getElementById('primaryColor').value='#16a34a'; document.getElementById('primaryColorHex').value='#16a34a';"></button>
                                    <button class="color-preset" data-color="#3b82f6" style="background: #3b82f6;" onclick="document.getElementById('primaryColor').value='#3b82f6'; document.getElementById('primaryColorHex').value='#3b82f6';"></button>
                                    <button class="color-preset" data-color="#8b5cf6" style="background: #8b5cf6;" onclick="document.getElementById('primaryColor').value='#8b5cf6'; document.getElementById('primaryColorHex').value='#8b5cf6';"></button>
                                    <button class="color-preset" data-color="#ef4444" style="background: #ef4444;" onclick="document.getElementById('primaryColor').value='#ef4444'; document.getElementById('primaryColorHex').value='#ef4444';"></button>
                                    <button class="color-preset" data-color="#f97316" style="background: #f97316;" onclick="document.getElementById('primaryColor').value='#f97316'; document.getElementById('primaryColorHex').value='#f97316';"></button>
                                    <button class="color-preset" data-color="#ec4899" style="background: #ec4899;" onclick="document.getElementById('primaryColor').value='#ec4899'; document.getElementById('primaryColorHex').value='#ec4899';"></button>
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form-label">Accent Color</label>
                                    <div class="flex gap-2">
                                        <input type="color" id="accentColor" value="#10b981" style="width: 60px; height: 40px; cursor: pointer;" onchange="document.getElementById('accentColorHex').value = this.value;">
                                        <input type="text" id="accentColorHex" class="form-control" value="#10b981" style="width: 100px;" onchange="document.getElementById('accentColor').value = this.value;">
                                    </div>
                                </div>
                                <div class="form-group mt-3">
                                    <label class="form-label">Font Family</label>
                                    <select id="fontSelect" class="form-control">
                                        <option value="Inter, Poppins, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif">Inter (Default)</option>
                                        <option value="Poppins, Inter, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif">Poppins</option>
                                        <option value="Roboto, Open Sans, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif">Roboto</option>
                                        <option value="Open Sans, Roboto, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif">Open Sans</option>
                                        <option value="Lato, Open Sans, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif">Lato</option>
                                    </select>
                                </div>
                                <div class="mt-3" style="display: flex; gap: 10px;">
                                    <button class="btn btn-secondary" onclick="SuperAdmin.previewTheme()">
                                        <i class="fas fa-eye"></i> Preview
                                    </button>
                                    <button class="btn btn-primary" onclick="SuperAdmin.saveThemeSettings()">
                                        <i class="fas fa-save"></i> Save Theme
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-eye"></i> Preview</h3>
                            </div>
                            <div class="card-body">
                                <div style="background: var(--light); padding: 20px; border-radius: var(--radius);" id="themePreviewBox">
                                    <button class="btn btn-primary mb-2">Primary Button</button>
                                    <button class="btn btn-secondary mb-2">Secondary Button</button>
                                    <button class="btn btn-outline mb-2">Outline Button</button>
                                    <div class="badge badge-primary" style="margin-left: 8px;">Sample Badge</div>
                                    <p class="text-muted mt-2" style="font-size: 14px;">This is how your UI elements will look with the current theme settings.</p>
                                    <div class="stat-card mt-2" style="padding: 15px;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div class="stat-icon primary" style="width: 40px; height: 40px;">
                                                <i class="fas fa-school"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: bold;">Sample Stat</div>
                                                <div style="font-size: 12px; color: var(--gray);">Preview stat card</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-info-circle"></i> Theme Information</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Theme changes will apply to all users across all school dashboards. Dark mode is controlled individually by each user and is not affected by these settings.</p>
                            <p id="themeLastUpdated" class="text-muted" style="font-size: 12px;"></p>
                        </div>
                    </div>
                </div>
                <!-- Help & Guide Section -->
                <div id="helpSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Help & Guide Editor</h1>
                            <p class="page-subtitle">Manage help content for all user roles</p>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Select User Role to Edit:</label>
                                <select id="helpRoleSelect" class="form-control" onchange="SuperAdmin.loadHelpEditor()">
                                    <option value="super_admin">Super Admin</option>
                                    <option value="school_admin">School Admin</option>
                                    <option value="teacher">Teacher</option>
                                    <option value="director">Director</option>
                                    <option value="accountant">Accountant</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-list"></i> Help Sections</h3>
                                <button class="btn btn-sm btn-primary" onclick="SuperAdmin.addHelpSection()">
                                    <i class="fas fa-plus"></i> Add Section
                                </button>
                            </div>
                            <div class="card-body" id="helpSectionsList"></div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-edit"></i> Edit Section</h3>
                            </div>
                            <div class="card-body" id="helpEditorArea">
                                <p class="text-muted">Select a section from the left to edit</p>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-eye"></i> Preview</h3>
                        </div>
                        <div class="card-body" id="helpPreviewArea">
                            <p class="text-muted">Preview will appear here</p>
                        </div>
                    </div>
                </div>
                <!-- Profile Section -->
                <div id="profileSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">My Profile</h1>
                            <p class="page-subtitle">Manage your account settings</p>
                        </div>
                    </div>
                    <div class="profile-page">
                        <div class="profile-header-card">
                            <div class="profile-avatar-section">
                                <div class="profile-avatar-large" id="profileAvatarLarge">
                                    <img id="profileAvatarImg" src="" alt="Profile" style="display: none;">
                                    <span id="profileAvatarInitials"></span>
                                </div>
                                <label class="profile-avatar-edit">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="Profile.handleAvatarUpload(this)">
                                </label>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profileName">Super Admin</h2>
                                <p id="profileRole">Super Admin</p>
                                <p class="profile-member-since"><i class="fas fa-calendar"></i> Member since: <span id="profileMemberSince">-</span></p>
                            </div>
                            <div class="profile-stats">
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="activityScore">0</div>
                                    <div class="profile-stat-label">Activity Score</div>
                                </div>
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="totalLogins">0</div>
                                    <div class="profile-stat-label">Total Logins</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-user"></i> Personal Information</h3></div>
                                <div class="card-body">
                                    <form id="profileForm">
                                        <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="profileNameInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Email</label><input type="email" id="profileEmailInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="profilePhoneInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Address</label><textarea id="profileAddressInput" class="form-control" rows="2"></textarea></div>
                                        <button type="button" class="btn btn-primary" onclick="Profile.saveProfile()"><i class="fas fa-save"></i> Save Changes</button>
                                    </form>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-lock"></i> Change Password</h3></div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="form-group"><label class="form-label">Current Password</label><input type="password" id="currentPassword" class="form-control" required></div>
                                        <div class="form-group"><label class="form-label">New Password</label><input type="password" id="newPassword" class="form-control" required minlength="6"></div>
                                        <div class="form-group"><label class="form-label">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" required></div>
                                        <button type="button" class="btn btn-warning" onclick="Profile.changePassword()"><i class="fas fa-key"></i> Change Password</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3></div>
                            <div class="card-body"><div id="profileActivityList"><div class="empty-state"><p>No recent activity</p></div></div></div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3></div>
                            <div class="card-body"><div id="profileNotifications"><div class="empty-state"><p>No notifications</p></div></div></div>
                        </div>
                    </div>
                </div>
                <!-- Data Management Section -->
                <div id="dataSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Data Management</h1>
                            <p class="page-subtitle">Export, backup, and manage system data</p>
                        </div>
                    </div>
                    
                    <!-- System Overview -->
                    <div class="stats-grid mb-4" id="systemDataStats">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-school"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalSchools">0</div>
                                <div class="stat-label">Schools</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-users"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalUsers">0</div>
                                <div class="stat-label">Users</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="fas fa-user-graduate"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalStudents">0</div>
                                <div class="stat-label">Students</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="fas fa-clipboard-list"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalScores">0</div>
                                <div class="stat-label">Scores</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalAttendance">0</div>
                                <div class="stat-label">Attendance</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger"><i class="fas fa-file-invoice-dollar"></i></div>
                            <div class="stat-content">
                                <div class="stat-value" id="statTotalFinance">0</div>
                                <div class="stat-label">Finance</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Export/Import Section -->
                    <div class="grid-2 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-download"></i> Export Data</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Download a backup of system data.</p>
                                <div class="form-group mb-3">
                                    <label>Select Data to Export:</label>
                                    <select id="exportDataType" class="form-control">
                                        <option value="all">All Data</option>
                                        <option value="schools">Schools Only</option>
                                        <option value="users">Users Only</option>
                                        <option value="students">Students Only</option>
                                        <option value="scores">Scores Only</option>
                                        <option value="attendance">Attendance Only</option>
                                        <option value="finance">Finance Only</option>
                                        <option value="codes">Activation Codes Only</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary btn-block" onclick="SuperAdmin.exportData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-upload"></i> Import Data</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Restore data from a backup file.</p>
                                <div class="form-group mb-3">
                                    <label>Select JSON Backup File:</label>
                                    <input type="file" id="importFile" class="form-control" accept=".json">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="flex-align-center">
                                        <input type="checkbox" id="importMode">
                                        <span style="margin-left: 8px;">Replace existing data (uncheck to merge)</span>
                                    </label>
                                </div>
                                <button class="btn btn-primary btn-block" onclick="SuperAdmin.importData()">
                                    <i class="fas fa-upload"></i> Import Data
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Delete Specific Data -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-trash-alt"></i> Delete Specific Data</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Delete specific types of data from the system.</p>
                            <div class="grid-3">
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Delete All Scores</h4>
                                        <p id="scoresCount">0 scores</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.deleteDataType('scores')">
                                        <i class="fas fa-trash"></i> Delete Scores
                                    </button>
                                </div>
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Delete All Attendance</h4>
                                        <p id="attendanceCount">0 records</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.deleteDataType('attendance')">
                                        <i class="fas fa-trash"></i> Delete Attendance
                                    </button>
                                </div>
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Delete All Finance</h4>
                                        <p id="financeCount">0 records</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.deleteDataType('finance')">
                                        <i class="fas fa-trash"></i> Delete Finance
                                    </button>
                                </div>
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Delete All Messages</h4>
                                        <p id="messagesCount">0 messages</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.deleteDataType('messages')">
                                        <i class="fas fa-trash"></i> Delete Messages
                                    </button>
                                </div>
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Delete All Schools</h4>
                                        <p id="schoolsDeleteCount">0 schools</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.deleteAllSchools()">
                                        <i class="fas fa-trash"></i> Delete All Schools
                                    </button>
                                </div>
                                <div class="danger-action" style="flex-direction: column; align-items: stretch;">
                                    <div class="danger-action-info">
                                        <h4>Clear Activation Codes</h4>
                                        <p id="codesCount">0 codes</p>
                                    </div>
                                    <button class="btn btn-danger btn-sm" onclick="SuperAdmin.clearAllCodes()">
                                        <i class="fas fa-trash"></i> Clear Codes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Danger Zone -->
                    <div class="danger-zone">
                        <div class="danger-zone-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Danger Zone</h3>
                        </div>
                        <p>These actions are irreversible. Please proceed with caution.</p>
                        <div class="danger-action">
                            <div class="danger-action-info">
                                <h4>Delete Single School</h4>
                                <p>Remove a specific school and all its data</p>
                            </div>
                            <button class="btn btn-danger" onclick="SuperAdmin.deleteSchoolPrompt()">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                        <div class="danger-action">
                            <div class="danger-action-info">
                                <h4>Full System Reset</h4>
                                <p>Reset entire system to initial state - keeps only Super Admin</p>
                            </div>
                            <button class="btn btn-danger" onclick="SuperAdmin.resetSystemPrompt()">
                                <i class="fas fa-radiation"></i> Reset System
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Restrictions Section -->
                <div id="restrictionsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Access Control</h1>
                            <p class="page-subtitle">Manage feature restrictions for schools</p>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-shield-alt"></i> Select School to Manage</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">School</label>
                                <select id="restrictionSchoolSelect" class="form-control" onchange="SuperAdmin.loadSchoolRestrictions()">
                                    <option value="">-- Select School --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="restrictionsForm" style="display: none;">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-lock"></i> Disabled Features</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Uncheck features to disable them for this school. Disabled features will not be accessible.</p>
                                <div id="featuresList" class="features-grid">
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-user-friends"></i> Limits (Optional)</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Maximum Students (leave empty for unlimited)</label>
                                            <input type="number" id="maxStudents" class="form-control" placeholder="e.g. 500">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Maximum Staff (leave empty for unlimited)</label>
                                            <input type="number" id="maxStaff" class="form-control" placeholder="e.g. 50">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mb-4">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-sticky-note"></i> Restriction Note</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label class="form-label">Reason for restriction (visible to school admin)</label>
                                    <textarea id="restrictionNote" class="form-control" rows="3" placeholder="Enter reason for these restrictions..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="SuperAdmin.saveRestrictions()">
                                <i class="fas fa-save"></i> Save Restrictions
                            </button>
                            <button class="btn btn-secondary" onclick="SuperAdmin.clearRestrictions()">
                                <i class="fas fa-times"></i> Clear All Restrictions
                            </button>
                        </div>
                    </div>
                    
                    <div id="noSchoolSelected" class="text-center py-5">
                        <i class="fas fa-school" style="font-size: 48px; color: var(--muted);"></i>
                        <p class="text-muted mt-3">Select a school above to manage its access restrictions</p>
                    </div>
                </div>
                
                <!-- Blog Section -->
                <div id="blogSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Blog Management</h1>
                            <p class="page-subtitle">Create and manage blog posts</p>
                        </div>
                        <button class="btn btn-primary" onclick="SuperAdmin.showBlogEditor()">
                            <i class="fas fa-plus"></i> New Post
                        </button>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> All Posts</h3>
                        </div>
                        <div class="card-body">
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="blogSearch" class="form-control" placeholder="Search posts..." onkeyup="SuperAdmin.filterBlogPosts()">
                                <select id="blogFilterStatus" class="form-control" style="width:150px;" onchange="SuperAdmin.loadBlogManager()">
                                    <option value="">All Status</option>
                                    <option value="published">Published</option>
                                    <option value="draft">Draft</option>
                                </select>
                            </div>
                            <div id="blogPostsList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Blog Editor Modal -->
                <div id="blogEditorModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;overflow-y:auto;">
                    <div style="max-width:900px;margin:50px auto;background:#fff;border-radius:12px;padding:2rem;">
                        <div class="flex justify-between items-center mb-3">
                            <h2 id="blogEditorTitle">Create New Post</h2>
                            <button class="btn btn-outline" onclick="SuperAdmin.closeBlogEditor()">Cancel</button>
                        </div>
                        <input type="hidden" id="blogPostId">
                        <div class="form-group mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" id="blogTitle" class="form-control" placeholder="Enter post title">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <input type="text" id="blogCategory" class="form-control" placeholder="e.g., News, Updates">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="blogStatus" class="form-control">
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Featured Image URL</label>
                            <input type="text" id="blogFeaturedImage" class="form-control" placeholder="https://...">
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Content</label>
                            <textarea id="blogContent" class="form-control" rows="12" placeholder="Write your post content here... (HTML supported)"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Video URL (YouTube/MP4)</label>
                                    <input type="text" id="blogVideoUrl" class="form-control" placeholder="YouTube or MP4 URL">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Audio URL (MP3)</label>
                                    <input type="text" id="blogAudioUrl" class="form-control" placeholder="MP3 URL">
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <input type="checkbox" id="blogCommentsEnabled" checked> Enable Comments
                            </label>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">
                                <input type="checkbox" id="blogFeatured"> Mark as Featured
                            </label>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="SuperAdmin.saveBlogPost()">
                                <i class="fas fa-save"></i> Save Post
                            </button>
                            <button class="btn btn-outline" onclick="SuperAdmin.closeBlogEditor()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Resources Section -->
                <div id="resourcesSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Resources Management</h1>
                            <p class="page-subtitle">Upload and manage downloadable resources</p>
                        </div>
                        <button class="btn btn-primary" onclick="SuperAdmin.showResourceEditor()">
                            <i class="fas fa-plus"></i> Add Resource
                        </button>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-folder"></i> All Resources</h3>
                        </div>
                        <div class="card-body">
                            <div class="flex gap-2 mb-3">
                                <input type="text" id="resourceSearch" class="form-control" placeholder="Search resources..." onkeyup="SuperAdmin.filterResources()">
                                <select id="resourceFilterCategory" class="form-control" style="width:150px;" onchange="SuperAdmin.loadResourcesManager()">
                                    <option value="">All Categories</option>
                                    <option value="Documents">Documents</option>
                                    <option value="Videos">Videos</option>
                                    <option value="Audio">Audio</option>
                                    <option value="Images">Images</option>
                                </select>
                            </div>
                            <div id="resourcesList"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Resource Editor Modal -->
                <div id="resourceEditorModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;overflow-y:auto;">
                    <div style="max-width:600px;margin:50px auto;background:#fff;border-radius:12px;padding:2rem;">
                        <div class="flex justify-between items-center mb-3">
                            <h2 id="resourceEditorTitle">Add New Resource</h2>
                            <button class="btn btn-outline" onclick="SuperAdmin.closeResourceEditor()">Cancel</button>
                        </div>
                        <input type="hidden" id="resourceId">
                        <div class="form-group mb-3">
                            <label class="form-label">Title</label>
                            <input type="text" id="resourceTitle" class="form-control" placeholder="Resource title">
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Description</label>
                            <textarea id="resourceDescription" class="form-control" rows="3" placeholder="Brief description"></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select id="resourceCategory" class="form-control">
                                        <option value="Documents">Documents</option>
                                        <option value="Videos">Videos</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Images">Images</option>
                                        <option value="Archives">Archives</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">File URL</label>
                                    <input type="text" id="resourceFileUrl" class="form-control" placeholder="https://...">
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="SuperAdmin.saveResource()">
                                <i class="fas fa-save"></i> Save Resource
                            </button>
                            <button class="btn btn-outline" onclick="SuperAdmin.closeResourceEditor()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <!-- Pricing Section -->
                <div id="pricingSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Pricing Management</h1>
                            <p class="page-subtitle">Manage subscription plans</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Basic Plan</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Price</label>
                                        <input type="text" id="basicPrice" class="form-control" value="Free">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Period</label>
                                        <input type="text" id="basicPeriod" class="form-control" value="forever">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea id="basicDescription" class="form-control" rows="2">Perfect for small schools getting started</textarea>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">CTA Button</label>
                                        <input type="text" id="basicCta" class="form-control" value="Get Started">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Features (one per line)</label>
                                        <textarea id="basicFeatures" class="form-control" rows="6">Up to 100 students
5 staff accounts
Basic attendance
Score management
Student ID cards
Email support</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card" style="border:3px solid var(--primary);">
                                <div class="card-header" style="background:var(--primary);color:#fff;">
                                    <h3 class="card-title" style="color:#fff;">Pro Plan</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Price</label>
                                        <input type="text" id="proPrice" class="form-control" value="#50,000">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Period</label>
                                        <input type="text" id="proPeriod" class="form-control" value="/year">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea id="proDescription" class="form-control" rows="2">Best for growing schools</textarea>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">CTA Button</label>
                                        <input type="text" id="proCta" class="form-control" value="Start Free Trial">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Features (one per line)</label>
                                        <textarea id="proFeatures" class="form-control" rows="6">Up to 500 students
20 staff accounts
QR Attendance
Parent Portal
ID Card Generation
Reports & Analytics
Priority support</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Premium Plan</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Price</label>
                                        <input type="text" id="premiumPrice" class="form-control" value="#100,000">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Period</label>
                                        <input type="text" id="premiumPeriod" class="form-control" value="/year">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea id="premiumDescription" class="form-control" rows="2">For large institutions</textarea>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">CTA Button</label>
                                        <input type="text" id="premiumCta" class="form-control" value="Contact Sales">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Features (one per line)</label>
                                        <textarea id="premiumFeatures" class="form-control" rows="6">Unlimited students
Unlimited staff
All Pro features
SMS Notifications
Multi-branch support
Custom integrations
Dedicated support
White-label option</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="SuperAdmin.savePricing()">
                        <i class="fas fa-save"></i> Save Pricing
                    </button>
                </div>
                
                <!-- Pages Section -->
                <div id="pagesSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Pages Management</h1>
                            <p class="page-subtitle">Edit static pages content</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-shield-alt"></i> Privacy Policy</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <textarea id="privacyContent" class="form-control" rows="20" placeholder="Privacy policy content (HTML supported)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-file-contract"></i> Terms & Conditions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <textarea id="termsContent" class="form-control" rows="20" placeholder="Terms and conditions content (HTML supported)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="SuperAdmin.savePages()">
                        <i class="fas fa-save"></i> Save Pages
                    </button>
                </div>
                
                <!-- Chat Section -->
                <div id="chatSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Chat</h1>
                        </div>
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-sidebar" id="chatSidebar">
                            <button class="chat-sidebar-close" id="chatSidebarClose" onclick="Chat.closeSidebar()" style="display: none;">&times;</button>
                            <div class="chat-search">
                                <input type="text" id="chatSearch" placeholder="Search conversations...">
                            </div>
                            <button class="btn btn-outline mt-2" id="newChatBtn" style="width:100%" onclick="Chat.showNewChatModal()">New Chat</button>
                            <div class="chat-list" id="chatList"></div>
                            <div id="groupsList"></div>
                            <button class="btn btn-primary mt-2" id="createGroupBtn" style="width:100%" onclick="Chat.createGroup()">Create Group Chat</button>
                            <button class="btn btn-outline mt-2" id="createSuperGroupBtn" style="width:100%" onclick="Chat.showSuperAdminGroupModal()">Super Admin Group</button>
                        </div>
                        <div class="chat-main" id="chatMain">
                            <div class="chat-header" id="chatHeader">
                                <button class="chat-back-btn" id="chatBackBtn" onclick="Chat.showSidebar()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                                <div class="chat-header-info">
                                    <h3>Select a conversation</h3>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area">
                                <button class="btn btn-icon" onclick="Chat.showEmojiPicker()" title="Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" id="chatInput" placeholder="Type a message...">
                                <div class="chat-input-actions">
                                    <button id="fileBtn" title="Attach File"><i class="fas fa-paperclip"></i></button>
                                    <button id="voiceBtn" title="Voice Message"><i class="fas fa-microphone"></i></button>
                                    <button id="sendBtn" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Chat Creation Modal -->
                <div id="createGroupModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create Group Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('createGroupModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Group Name</label>
                                <input type="text" id="groupNameInput" class="form-control" placeholder="Enter group name">
                            </div>
                            <div class="form-group">
                                <label>Select Staff Members</label>
                                <button class="btn btn-outline mt-2" onclick="Chat.selectAllStaff()">Select All Staff</button>
                                <div id="groupStaffList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('createGroupModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="Chat.createGroupChat()">Create Group</button>
                        </div>
                    </div>
                </div>

                <!-- Super Admin Group Creation Modal -->
                <div id="superAdminGroupModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create Super Admin Group</h3>
                            <button class="modal-close" onclick="Modal.hide('superAdminGroupModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Group Name</label>
                                <input type="text" id="superGroupNameInput" class="form-control" placeholder="Enter group name">
                            </div>
                            <div class="form-group">
                                <label>Filter by:</label>
                                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                    <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('admins')">Admins</button>
                                    <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('directors')">Directors</button>
                                    <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('all')">All Schools</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Select Users</label>
                                <div id="superGroupUserList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('superAdminGroupModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="Chat.createSuperAdminGroup()">Create Group</button>
                        </div>
                    </div>
                </div>

                <!-- New Chat Modal -->
                <div id="newChatModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Start New Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('newChatModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="newChatSearch" class="form-control" placeholder="Search users..." oninput="Chat.filterNewChatUsers(this.value)">
                            <div id="newChatUserList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Schools Modal -->
                <div id="schoolsModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">All Schools</h3>
                            <button class="modal-close" onclick="Modal.hide('schoolsModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="filters-bar mb-3">
                                <div class="filter-group" style="flex: 2;">
                                    <input type="text" id="schoolSearchInput" class="form-control" placeholder="Search schools..." onkeyup="SuperAdmin.filterSchools()">
                                </div>
                                <div class="filter-group">
                                    <select id="schoolStatusFilter" class="form-control" onchange="SuperAdmin.filterSchools()">
                                        <option value="all">All Status</option>
                                        <option value="active">Active</option>
                                        <option value="inactive">Inactive</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <select id="schoolTypeFilter" class="form-control" onchange="SuperAdmin.filterSchools()">
                                        <option value="all">All Types</option>
                                        <option value="primary">Primary</option>
                                        <option value="secondary">Secondary</option>
                                        <option value="both">Both</option>
                                    </select>
                                </div>
                            </div>
                            <div id="schoolsList"></div>
                        </div>
                    </div>
                </div>

                <!-- View School Modal -->
                <div id="viewSchoolModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 700px;">
                        <div class="modal-header">
                            <h3 class="modal-title">School Details</h3>
                            <button class="modal-close" onclick="Modal.hide('viewSchoolModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="viewSchoolContent">
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('viewSchoolModal')">Close</button>
                        </div>
                    </div>
                </div>

                <!-- Edit School Modal -->
                <div id="editSchoolModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Edit School</h3>
                            <button class="modal-close" onclick="Modal.hide('editSchoolModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="editSchoolForm">
                                <input type="hidden" id="editSchoolId">
                                <div class="form-group">
                                    <label>School Name</label>
                                    <input type="text" id="editSchoolName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label>Alias</label>
                                    <input type="text" id="editSchoolAlias" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Email</label>
                                    <input type="email" id="editSchoolEmail" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="editSchoolPhone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Address</label>
                                    <textarea id="editSchoolAddress" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label>School Type</label>
                                    <select id="editSchoolType" class="form-control">
                                        <option value="primary">Primary School</option>
                                        <option value="secondary">Secondary School</option>
                                        <option value="both">Primary & Secondary</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Currency</label>
                                    <select id="editSchoolCurrency" class="form-control">
                                        <option value="NGN">NGN (Naira)</option>
                                        <option value="USD">USD (Dollar)</option>
                                        <option value="EUR">EUR (Euro)</option>
                                        <option value="GBP">GBP (Pound)</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('editSchoolModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="SuperAdmin.saveSchoolEdit()">Save Changes</button>
                        </div>
                    </div>
                </div>

                <!-- Renew School Modal -->
                <div id="renewSchoolModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Renew Subscription</h3>
                            <button class="modal-close" onclick="Modal.hide('renewSchoolModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="renewSchoolId">
                            <div class="form-group">
                                <label>Extend Subscription By</label>
                                <select id="renewDays" class="form-control">
                                    <option value="30">30 Days (1 Month)</option>
                                    <option value="90">90 Days (3 Months)</option>
                                    <option value="180">180 Days (6 Months)</option>
                                    <option value="365" selected>365 Days (1 Year)</option>
                                    <option value="730">730 Days (2 Years)</option>
                                </select>
                            </div>
                            <p id="renewCurrentExpiry" class="text-muted"></p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('renewSchoolModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="SuperAdmin.confirmRenewSchool()">Renew</button>
                        </div>
                    </div>
                </div>
                
                <!-- Add School Student Modal -->
                <div id="addSchoolStudentModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Add Student</h3>
                            <button class="modal-close" onclick="Modal.hide('addSchoolStudentModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="addSchoolStudentModalBody">
                            <!-- Content loaded via JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- View School Student Modal -->
                <div id="viewStudentModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 450px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Student Details</h3>
                            <button class="modal-close" onclick="Modal.hide('viewStudentModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="viewStudentContent">
                            <!-- Content loaded via JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Add School Staff Modal -->
                <div id="addSchoolStaffModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Add Staff</h3>
                            <button class="modal-close" onclick="Modal.hide('addSchoolStaffModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="addSchoolStaffModalBody">
                            <!-- Content loaded via JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Add School Parent Modal -->
                <div id="addSchoolParentModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Add Parent</h3>
                            <button class="modal-close" onclick="Modal.hide('addSchoolParentModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="addSchoolParentModalBody">
                            <!-- Content loaded via JavaScript -->
                        </div>
                    </div>
                </div>
                
                <!-- Add School Transaction Modal -->
                <div id="addSchoolTransactionModal" class="modal-overlay" style="display: none;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Add Transaction</h3>
                            <button class="modal-close" onclick="Modal.hide('addSchoolTransactionModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body" id="addSchoolTransactionModalBody">
                            <!-- Content loaded via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <!-- Close page-content -->
        </div>
        <!-- Close main-content -->
        </main>

        <!-- Footer OUTSIDE main-content -->
        <footer class="main-footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <i class="fas fa-graduation-cap"></i>
                    <span>My School System</span>
                </div>
                <div class="footer-links">
                    <a href="../public/blog.html" target="_blank"><i class="fas fa-blog"></i> Blog</a>
                    <a href="../public/resources.html" target="_blank"><i class="fas fa-folder-open"></i> Resources</a>
                    <a href="../public/pricing.html" target="_blank"><i class="fas fa-tags"></i> Pricing</a>
                    <a href="../public/privacy.html" target="_blank"><i class="fas fa-shield-alt"></i> Privacy</a>
                    <a href="../public/terms.html" target="_blank"><i class="fas fa-file-contract"></i> Terms</a>
                </div>
                <div class="footer-info">
                    <p>&copy; 2026 My School System. All rights reserved.</p>
                    <p>My School System - Odebunmi Tawwab</p>
                </div>
                <div class="footer-social">
                    <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://twitter.com" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                    <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                    <a href="https://linkedin.com" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="../assets/js/storage.js"></script>
    <script src="../public/js/public.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/core.js"></script>
    <script src="../assets/js/attendance.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/chat.js"></script>
    <script src="../assets/js/finance.js"></script>
    <script src="../assets/js/qr.js"></script>
    <script src="../assets/js/reports.js"></script>
    <script src="../assets/js/calendar.js"></script>
    <script>
        window.SuperAdmin = {
            currentSchoolId: null,
            currentSchoolView: false,
            
            init() {
                if (!Auth.checkRole(['super_admin'])) {
                    window.location.href = '../login.html';
                    return;
                }
                this.loadSchoolSelector();
                this.loadStats();
                this.showSection('dashboard');
            },
            
            loadSchoolSelector() {
                const schools = Storage.getSchools();
                const selector = document.getElementById('schoolSelector');
                if (!selector) return;
                
                let html = '<option value="">-- Select School to Manage --</option>';
                schools.forEach(school => {
                    html += `<option value="${school.id}">${school.name}</option>`;
                });
                selector.innerHTML = html;
            },
            
            selectSchool(schoolId) {
                if (!schoolId) {
                    this.exitSchoolView();
                    return;
                }
                
                this.currentSchoolId = schoolId;
                this.currentSchoolView = true;
                
                // Set Auth override so all CRUD operations use this school
                Auth.setSchoolIdOverride(schoolId);
                
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found - ID: ' + schoolId);
                    return;
                }
                
                // Show page-content (ensure it's visible)
                const pageContent = document.querySelector('.page-content');
                if (pageContent) {
                    pageContent.style.display = 'block';
                }
                
                // Ensure sidebar is visible
                const sidebar = document.getElementById('mainSidebar');
                if (sidebar) {
                    sidebar.classList.remove('collapsed');
                    sidebar.style.display = 'flex';
                }
                
                // Show school view banner
                const banner = document.getElementById('schoolViewBanner');
                if (banner) banner.style.display = 'block';
                document.getElementById('viewingSchoolName').textContent = school.name;
                
                // Show school admin navigation
                const schoolNav = document.getElementById('schoolAdminNav');
                if (schoolNav) {
                    schoolNav.style.display = 'block';
                    // Make sure nav items are visible and clickable
                    schoolNav.querySelectorAll('.nav-item').forEach(item => {
                        item.style.pointerEvents = 'auto';
                        item.style.opacity = '1';
                        item.style.visibility = 'visible';
                    });
                }
                
                // Remove active from main nav items
                document.querySelectorAll('.sidebar-nav .nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Update page title
                document.getElementById('schoolDashTitle').textContent = school.name + ' Dashboard';
                document.getElementById('schoolDashSubtitle').textContent = 'Managing school operations';
                
                // Switch to school dashboard
                this.showSchoolSection('dashboard');
                
                Toast.success('Now viewing ' + school.name + ' as administrator');
            },
            
            // Direct method to show school sections
            showSchoolSection(section) {
                if (!this.currentSchoolView || !this.currentSchoolId) {
                    Toast.error('Please select a school first');
                    return;
                }
                
                var sectionMap = {
                    'dashboard': 'schoolDashboardSection',
                    'students': 'schoolStudentsSection',
                    'staff': 'schoolStaffSection',
                    'parents': 'schoolParentsSection',
                    'scores': 'schoolScoresSection',
                    'attendance': 'schoolAttendanceSection',
                    'finance': 'schoolFinanceSection',
                    'reports': 'schoolReportsSection',
                    'idcards': 'schoolIdCardsSection',
                    'settings': 'schoolSettingsSection'
                };
                
                // Map to loadSchoolSectionData function
                var loadMap = {
                    'dashboard': 'schoolDashboard',
                    'students': 'schoolStudents',
                    'staff': 'schoolStaff',
                    'parents': 'schoolParents',
                    'scores': 'schoolScores',
                    'attendance': 'schoolAttendance',
                    'finance': 'schoolFinance',
                    'reports': 'schoolReports',
                    'idcards': 'schoolIdCards',
                    'settings': 'schoolSettings'
                };
                
                // Hide main content, show school admin container
                var mainContent = document.getElementById('mainContent');
                if (mainContent) mainContent.style.display = 'none';
                
                var schoolContainer = document.getElementById('schoolAdminContainer');
                if (schoolContainer) schoolContainer.style.display = 'block';
                
                // Hide all school sections first
                var schoolSections = document.querySelectorAll('[id$="Section"]');
                for (var i = 0; i < schoolSections.length; i++) {
                    if (schoolSections[i].id.indexOf('school') === 0 && schoolSections[i].id.indexOf('schoolAdmin') === -1) {
                        schoolSections[i].style.display = 'none';
                    }
                }
                
                // Show selected section
                var sectionId = sectionMap[section];
                if (sectionId) {
                    var sectionEl = document.getElementById(sectionId);
                    if (sectionEl) {
                        sectionEl.style.display = 'block';
                        // Ensure it's visible
                        sectionEl.style.visibility = 'visible';
                        sectionEl.style.opacity = '1';
                    }
                }
                
                // Update active nav
                document.querySelectorAll('#schoolAdminNav .nav-item').forEach(function(item) {
                    item.classList.remove('active');
                });
                // Find the clicked nav item by onclick content
                var navItems = document.querySelectorAll('#schoolAdminNav .nav-item');
                for (var j = 0; j < navItems.length; j++) {
                    if (navItems[j].onclick && navItems[j].onclick.toString().indexOf("showSchoolSection('" + section + "')") !== -1) {
                        navItems[j].classList.add('active');
                    }
                }
                
                // Load data for this section
                var loadSection = loadMap[section];
                if (loadSection) {
                    this.loadSchoolSectionData(loadSection);
                }
            },
            
            exitSchoolView() {
                this.currentSchoolId = null;
                this.currentSchoolView = false;
                
                // Clear Auth override to return to Super Admin's own school context
                Auth.clearSchoolIdOverride();
                
                // Hide school view banner
                document.getElementById('schoolViewBanner').style.display = 'none';
                
                // Hide school admin navigation
                document.getElementById('schoolAdminNav').style.display = 'none';
                
                // Hide school admin container
                var schoolContainer = document.getElementById('schoolAdminContainer');
                if (schoolContainer) schoolContainer.style.display = 'none';
                
                // Show main content
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.style.display = 'block';
                }
                
                // Reset school selector
                document.getElementById('schoolSelector').value = '';
                
                // Switch back to main dashboard
                this.showSection('dashboard');
                
                Toast.info('Returned to Super Admin view');
            },
            
            getCurrentSchoolId() {
                return this.currentSchoolId;
            },
            
            showSection(section) {
                try {
                    // Determine if we're in school view
                    const isSchoolSection = section.startsWith('school');
                    
                    // Show/hide main content based on view type
                    const mainContent = document.getElementById('mainContent');
                    if (mainContent) {
                        mainContent.style.display = isSchoolSection ? 'none' : 'block';
                    }
                    
                    // Hide all super admin sections
                    const superAdminSections = ['dashboard', 'schools', 'codes', 'restrictions', 'blog', 'resources', 'pricing', 'pages', 'chat', 'announcement', 'theme', 'help', 'data', 'profile'];
                    superAdminSections.forEach(s => {
                        const el = document.getElementById(s + 'Section');
                        if (el) el.style.display = 'none';
                    });
                    
                    // Hide all school admin sections
                    const schoolSections = ['schoolDashboard', 'schoolStudents', 'schoolStaff', 'schoolParents', 'schoolScores', 'schoolAttendance', 'schoolFinance', 'schoolReports', 'schoolIdCards', 'schoolSettings'];
                    schoolSections.forEach(s => {
                        const el = document.getElementById(s + 'Section');
                        if (el) el.style.display = 'none';
                    });
                    
                    // Remove active class from all nav items
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    
                    // Show selected section
                    const sectionId = section + 'Section';
                    const sectionEl = document.getElementById(sectionId);
                    if (sectionEl) {
                        sectionEl.style.display = 'block';
                    } else {
                        // Try alternate ID format with hyphens
                        const altId = section.replace(/([A-Z])/g, '-$1').toLowerCase() + 'Section';
                        const altEl = document.getElementById(altId);
                        if (altEl) {
                            altEl.style.display = 'block';
                        }
                    }
                    
                    // Add active class to nav item
                    let navId = 'nav-' + section;
                    let navItem = document.getElementById(navId);
                    
                    // If not found, try with hyphens for camelCase
                    if (!navItem && section.includes('school')) {
                        navId = 'nav-' + section.replace(/([A-Z])/g, '-$1').toLowerCase();
                        navItem = document.getElementById(navId);
                    }
                    
                    if (navItem) {
                        navItem.classList.add('active');
                    }
                    
                    // Ensure the school nav section is visible when in school view
                    if (isSchoolSection) {
                        const schoolNav = document.getElementById('schoolAdminNav');
                        if (schoolNav) {
                            schoolNav.style.display = 'block';
                        }
                    }
                    
                    // Load section data if in school view
                    if (this.currentSchoolView && section.startsWith('school')) {
                        this.loadSchoolSectionData(section);
                    }
                } catch (e) {
                    console.error('Error showing section:', e);
                    Toast.error('Error loading section: ' + e.message);
                }
            },
            
            loadSchoolSectionData(section) {
                if (!this.currentSchoolId) return;
                
                switch(section) {
                    case 'schoolDashboard':
                        this.loadSchoolDashboard();
                        break;
                    case 'schoolStudents':
                        this.loadSchoolStudents();
                        break;
                    case 'schoolStaff':
                        this.loadSchoolStaff();
                        break;
                    case 'schoolParents':
                        this.loadSchoolParents();
                        break;
                    case 'schoolScores':
                        this.loadSchoolScores();
                        break;
                    case 'schoolAttendance':
                        this.loadSchoolAttendance();
                        break;
                    case 'schoolFinance':
                        this.loadSchoolFinance();
                        break;
                    case 'schoolReports':
                        this.loadSchoolReports();
                        break;
                    case 'schoolIdCards':
                        this.loadSchoolIDCards();
                        break;
                    case 'schoolSettings':
                        this.loadSchoolSettings();
                        break;
                }
            },
            
            loadSchoolDashboard() {
                const schoolId = this.currentSchoolId;
                const students = Storage.getStudents(schoolId);
                const users = Storage.getUsers(schoolId);
                const teachers = users.filter(u => u.role === 'teacher');
                
                document.getElementById('schoolTotalStudents').textContent = students.length;
                document.getElementById('schoolTotalTeachers').textContent = teachers.length;
                
                const today = new Date().toISOString().split('T')[0];
                const attendance = Storage.getAttendance(schoolId, today);
                const present = attendance.filter(a => a.status === 'present').length;
                const percentage = students.length ? Math.round((present / students.length) * 100) : 0;
                document.getElementById('schoolAttendanceToday').textContent = percentage + '%';
                
                const finance = Storage.getFinance(schoolId);
                const income = finance.filter(f => f.type === 'income').reduce((s, f) => s + f.amount, 0);
                const expenses = finance.filter(f => f.type === 'expense').reduce((s, f) => s + f.amount, 0);
                const balance = income - expenses;
                document.getElementById('schoolBalanceAmount').textContent = '₦' + balance.toLocaleString();
            },
            
            loadSchoolStudents() {
                const schoolId = this.currentSchoolId;
                const students = Storage.getStudents(schoolId);
                const container = document.getElementById('schoolStudentsTable');
                
                if (!container) return;
                
                if (students.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><h3>No students</h3><p>Add students to get started</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Student</th><th>ID</th><th>Class</th><th>Parent Name</th><th>Parent Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                students.forEach(student => {
                    html += `<tr>
                        <td><div style="display: flex; align-items: center; gap: 12px;"><div class="avatar">${Utils.getInitials(student.name)}</div><div><div style="font-weight: 600;">${student.name}</div></div></div></td>
                        <td>${student.id}</td>
                        <td>${student.class}</td>
                        <td>${student.parentName || '-'}</td>
                        <td>${student.parentPhone || '-'}</td>
                        <td><span class="badge badge-${student.status === 'active' ? 'success' : 'warning'}">${student.status || 'active'}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.viewSchoolStudent('${student.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchoolStudent('${student.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolStudent('${student.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            loadSchoolStaff() {
                const schoolId = this.currentSchoolId;
                const users = Storage.getUsers(schoolId);
                const container = document.getElementById('schoolStaffTable');
                
                if (!container) return;
                
                const staff = users.filter(u => ['teacher', 'accountant', 'director'].includes(u.role));
                
                if (staff.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No staff members</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Phone</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                staff.forEach(user => {
                    const roleLabel = user.role === 'teacher' ? 'Teacher' : user.role === 'accountant' ? 'Accountant' : 'Director';
                    html += `<tr>
                        <td><div style="font-weight: 600;">${user.name}</div></td>
                        <td>${roleLabel}</td>
                        <td>${user.email || '-'}</td>
                        <td>${user.phone || '-'}</td>
                        <td><span class="badge badge-success">Active</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchoolStaff('${user.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolStaff('${user.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            loadSchoolParents() {
                const schoolId = this.currentSchoolId;
                const container = document.getElementById('schoolParentsTable');
                
                if (!container) return;
                
                const parents = Storage.getData('users')?.filter(u => u.schoolId === schoolId && u.role === 'parent') || [];
                
                if (parents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No parent accounts</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Children</th><th>Actions</th></tr></thead><tbody>';
                
                parents.forEach(parent => {
                    const students = Storage.getStudents(schoolId).filter(s => s.parentPhone === parent.phone);
                    html += `<tr>
                        <td><div style="font-weight: 600;">${parent.name}</div></td>
                        <td>${parent.email || '-'}</td>
                        <td>${parent.phone || '-'}</td>
                        <td>${students.length}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchoolParent('${parent.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolParent('${parent.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            loadSchoolScores() {
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const classes = school?.settings?.classes || Storage.getClasses(schoolId);
                const classSelect = document.getElementById('schoolScoreClassSelect');
                
                if (classSelect) {
                    classSelect.innerHTML = '<option value="">Select Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                }
            },
            
            loadSchoolAttendance() {
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const classes = school?.settings?.classes || Storage.getClasses(schoolId);
                const classSelect = document.getElementById('schoolAttendanceClassSelect');
                
                if (classSelect) {
                    classSelect.innerHTML = '<option value="">Select Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                }
                
                document.getElementById('schoolAttendanceDate').value = new Date().toISOString().split('T')[0];
            },
            
            loadSchoolFinance() {
                const schoolId = this.currentSchoolId;
                const finance = Storage.getFinance(schoolId);
                const income = finance.filter(f => f.type === 'income').reduce((s, f) => s + f.amount, 0);
                const expenses = finance.filter(f => f.type === 'expense').reduce((s, f) => s + f.amount, 0);
                const balance = income - expenses;
                
                document.getElementById('schoolTotalIncome').textContent = '₦' + income.toLocaleString();
                document.getElementById('schoolTotalExpenses').textContent = '₦' + expenses.toLocaleString();
                document.getElementById('schoolBalance').textContent = '₦' + balance.toLocaleString();
                
                this.loadSchoolTransactions();
            },
            
            loadSchoolTransactions() {
                const schoolId = this.currentSchoolId;
                const typeFilter = document.getElementById('schoolFinanceTypeFilter')?.value || 'all';
                let finance = Storage.getFinance(schoolId);
                
                if (typeFilter !== 'all') {
                    finance = finance.filter(f => f.type === typeFilter);
                }
                
                const container = document.getElementById('schoolTransactionsList');
                if (!container) return;
                
                if (finance.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No transactions</p></div>';
                    return;
                }
                
                finance.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Type</th><th>Amount</th><th>Actions</th></tr></thead><tbody>';
                
                finance.forEach(f => {
                    html += `<tr>
                        <td>${f.date}</td>
                        <td>${f.description}</td>
                        <td>${f.category}</td>
                        <td><span class="badge badge-${f.type === 'income' ? 'success' : 'danger'}">${f.type}</span></td>
                        <td>₦${f.amount.toLocaleString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.deleteSchoolTransaction('${f.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            loadSchoolReports() {
                // Reports section is ready - just show the grid
            },
            
            loadSchoolIDCards() {
                const schoolId = this.currentSchoolId;
                const type = document.getElementById('schoolIdCardType')?.value || 'student';
                const select = document.getElementById('schoolIdCardUser');
                
                if (!select) return;
                
                let users = [];
                if (type === 'student') {
                    users = Storage.getStudents(schoolId);
                } else {
                    users = Storage.getUsers(schoolId).filter(u => u.role === type);
                }
                
                select.innerHTML = '<option value="">Select...</option>' + users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            },
            
            loadSchoolSettings() {
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                
                if (!school) return;
                
                const infoHtml = `
                    <div class="form-group"><label class="form-label">School Name</label><input type="text" id="schoolNameInput" class="form-control" value="${school.name || ''}"></div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email" id="schoolEmailInput" class="form-control" value="${school.email || ''}"></div>
                    <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="schoolPhoneInput" class="form-control" value="${school.phone || ''}"></div>
                    <div class="form-group"><label class="form-label">Address</label><textarea id="schoolAddressInput" class="form-control" rows="2">${school.address || ''}</textarea></div>
                    <button class="btn btn-primary" onclick="SuperAdmin.saveSchoolInfo()"><i class="fas fa-save"></i> Save Changes</button>
                `;
                
                const configHtml = `
                    <div class="form-group"><label class="form-label">School Type</label><select id="schoolTypeInput" class="form-control"><option value="primary" ${school.type === 'primary' ? 'selected' : ''}>Primary</option><option value="secondary" ${school.type === 'secondary' ? 'selected' : ''}>Secondary</option><option value="both" ${school.type === 'both' ? 'selected' : ''}>Both</option></select></div>
                    <div class="form-group"><label class="form-label">Status</label><select id="schoolStatusInput" class="form-control"><option value="active" ${school.status === 'active' ? 'selected' : ''}>Active</option><option value="inactive" ${school.status === 'inactive' ? 'selected' : ''}>Inactive</option></select></div>
                    <button class="btn btn-primary" onclick="SuperAdmin.saveSchoolConfig()"><i class="fas fa-save"></i> Save Changes</button>
                `;
                
                document.getElementById('schoolInfoForm').innerHTML = infoHtml;
                document.getElementById('schoolConfigForm').innerHTML = configHtml;
            },
            
            // School Management CRUD Operations
            showAddSchoolStudentModal() {
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const classes = school?.settings?.classes || Storage.getClasses(schoolId);
                
                const html = `
                    <form id="addSchoolStudentForm">
                        <div class="form-group"><label class="form-label">Full Name *</label><input type="text" id="schoolStudentName" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Class *</label><select id="schoolStudentClass" class="form-control" required>${classes.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                        <div class="form-group"><label class="form-label">Email</label><input type="email" id="schoolStudentEmail" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="schoolStudentPhone" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Gender</label><select id="schoolStudentGender" class="form-control"><option value="male">Male</option><option value="female">Female</option></select></div>
                        <div class="form-group"><label class="form-label">Date of Birth</label><input type="date" id="schoolStudentDob" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Parent Name</label><input type="text" id="schoolStudentParentName" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Parent Phone</label><input type="tel" id="schoolStudentParentPhone" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Address</label><textarea id="schoolStudentAddress" class="form-control" rows="2"></textarea></div>
                        <div class="flex gap-2 mt-3">
                            <button type="button" class="btn btn-secondary" onclick="Modal.hide('addSchoolStudentModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.addSchoolStudent()"><i class="fas fa-save"></i> Save Student</button>
                        </div>
                    </form>
                `;
                
                Modal.show('addSchoolStudentModal', html, 'Add Student');
            },
            
            addSchoolStudent() {
                const schoolId = this.currentSchoolId;
                const name = document.getElementById('schoolStudentName').value.trim();
                const className = document.getElementById('schoolStudentClass').value;
                
                if (!name || !className) {
                    Toast.error('Name and class are required');
                    return;
                }
                
                const student = {
                    id: Storage.generateUniqueId('STU'),
                    schoolId,
                    name,
                    class: className,
                    email: document.getElementById('schoolStudentEmail').value.trim(),
                    phone: document.getElementById('schoolStudentPhone').value.trim(),
                    gender: document.getElementById('schoolStudentGender').value,
                    dob: document.getElementById('schoolStudentDob').value,
                    parentName: document.getElementById('schoolStudentParentName').value.trim(),
                    parentPhone: document.getElementById('schoolStudentParentPhone').value.trim(),
                    address: document.getElementById('schoolStudentAddress').value.trim(),
                    status: 'active',
                    enrollmentDate: new Date().toISOString()
                };
                
                Storage.addItem('students', student);
                Toast.success('Student added successfully');
                Modal.hide('addSchoolStudentModal');
                this.loadSchoolStudents();
            },
            
            viewSchoolStudent(id) {
                const schoolId = this.currentSchoolId;
                const student = Storage.getStudents(schoolId).find(s => s.id === id);
                
                if (!student) {
                    Toast.error('Student not found');
                    return;
                }
                
                const html = `
                    <div style="text-align: center;">
                        <div class="avatar avatar-xl" style="margin: 0 auto 16px;">${Utils.getInitials(student.name)}</div>
                        <h3>${student.name}</h3>
                        <p class="text-muted">${student.id}</p>
                        <div style="text-align: left; margin-top: 24px;">
                            <div class="list-group">
                                <div class="list-group-item"><span class="text-muted">Class</span><span>${student.class}</span></div>
                                <div class="list-group-item"><span class="text-muted">Email</span><span>${student.email || '-'}</span></div>
                                <div class="list-group-item"><span class="text-muted">Phone</span><span>${student.phone || '-'}</span></div>
                                <div class="list-group-item"><span class="text-muted">Parent Name</span><span>${student.parentName || '-'}</span></div>
                                <div class="list-group-item"><span class="text-muted">Parent Phone</span><span>${student.parentPhone || '-'}</span></div>
                                <div class="list-group-item"><span class="text-muted">Address</span><span>${student.address || '-'}</span></div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('viewStudentContent').innerHTML = html;
                Modal.show('viewStudentModal');
            },
            
            editSchoolStudent(id) {
                const schoolId = this.currentSchoolId;
                const student = Storage.getStudents(schoolId).find(s => s.id === id);
                
                if (!student) {
                    Toast.error('Student not found');
                    return;
                }
                
                // For simplicity, we'll just show the add modal with values
                this.showAddSchoolStudentModal();
                document.getElementById('schoolStudentName').value = student.name || '';
                document.getElementById('schoolStudentClass').value = student.class || '';
                document.getElementById('schoolStudentEmail').value = student.email || '';
                document.getElementById('schoolStudentPhone').value = student.phone || '';
                document.getElementById('schoolStudentGender').value = student.gender || 'male';
                document.getElementById('schoolStudentDob').value = student.dob || '';
                document.getElementById('schoolStudentParentName').value = student.parentName || '';
                document.getElementById('schoolStudentParentPhone').value = student.parentPhone || '';
                document.getElementById('schoolStudentAddress').value = student.address || '';
                
                // Store the edit ID
                document.getElementById('addSchoolStudentForm').dataset.editId = id;
                document.querySelector('#addSchoolStudentModal .modal-title').textContent = 'Edit Student';
            },
            
            deleteSchoolStudent(id) {
                Modal.confirm({
                    title: 'Delete Student',
                    message: 'Are you sure you want to delete this student?',
                    onConfirm: () => {
                        Storage.deleteItem('students', id);
                        Toast.success('Student deleted');
                        this.loadSchoolStudents();
                    }
                });
            },
            
            showAddSchoolStaffModal(role) {
                const roleLabels = { teacher: 'Teacher', accountant: 'Accountant', director: 'Director' };
                const html = `
                    <form id="addSchoolStaffForm">
                        <div class="form-group"><label class="form-label">Full Name *</label><input type="text" id="schoolStaffName" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Username *</label><input type="text" id="schoolStaffUsername" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Email *</label><input type="email" id="schoolStaffEmail" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="schoolStaffPhone" class="form-control"></div>
                        <div class="form-group"><label class="form-label">Password *</label><input type="password" id="schoolStaffPassword" class="form-control" required minlength="6"></div>
                        <div class="form-group"><label class="form-label">Role</label><select id="schoolStaffRole" class="form-control"><option value="${role}">${roleLabels[role]}</option></select></div>
                        <input type="hidden" id="schoolStaffRoleHidden" value="${role}">
                        <div class="flex gap-2 mt-3">
                            <button type="button" class="btn btn-secondary" onclick="Modal.hide('addSchoolStaffModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.addSchoolStaff()"><i class="fas fa-save"></i> Save Staff</button>
                        </div>
                    </form>
                `;
                
                Modal.show('addSchoolStaffModal', html, 'Add ' + roleLabels[role]);
            },
            
            addSchoolStaff() {
                const schoolId = this.currentSchoolId;
                const name = document.getElementById('schoolStaffName').value.trim();
                const username = document.getElementById('schoolStaffUsername').value.trim();
                const email = document.getElementById('schoolStaffEmail').value.trim();
                const password = document.getElementById('schoolStaffPassword').value;
                const role = document.getElementById('schoolStaffRoleHidden').value || document.getElementById('schoolStaffRole').value;
                
                if (!name || !username || !email || !password) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                
                const existingUsers = Storage.getData('users') || [];
                if (existingUsers.some(u => u.username === username)) {
                    Toast.error('Username already exists');
                    return;
                }
                
                const user = {
                    id: Storage.generateUniqueId('USR'),
                    schoolId,
                    name,
                    username,
                    email,
                    phone: document.getElementById('schoolStaffPhone').value.trim(),
                    password: Utils.hashPassword(password),
                    role,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                Storage.addItem('users', user);
                Toast.success(role + ' added successfully');
                Modal.hide('addSchoolStaffModal');
                this.loadSchoolStaff();
            },
            
            editSchoolStaff(id) {
                Toast.info('Edit staff functionality - use add with same username');
            },
            
            deleteSchoolStaff(id) {
                Modal.confirm({
                    title: 'Delete Staff',
                    message: 'Are you sure you want to delete this staff member?',
                    onConfirm: () => {
                        Storage.deleteItem('users', id);
                        Toast.success('Staff deleted');
                        this.loadSchoolStaff();
                    }
                });
            },
            
            showAddSchoolParentModal() {
                const html = `
                    <form id="addSchoolParentForm">
                        <div class="form-group"><label class="form-label">Full Name *</label><input type="text" id="schoolParentName" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Username *</label><input type="text" id="schoolParentUsername" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Email *</label><input type="email" id="schoolParentEmail" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Phone *</label><input type="tel" id="schoolParentPhone" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Password *</label><input type="password" id="schoolParentPassword" class="form-control" required minlength="6"></div>
                        <div class="flex gap-2 mt-3">
                            <button type="button" class="btn btn-secondary" onclick="Modal.hide('addSchoolParentModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.addSchoolParent()"><i class="fas fa-save"></i> Save Parent</button>
                        </div>
                    </form>
                `;
                
                Modal.show('addSchoolParentModal', html, 'Add Parent');
            },
            
            addSchoolParent() {
                const schoolId = this.currentSchoolId;
                const name = document.getElementById('schoolParentName').value.trim();
                const username = document.getElementById('schoolParentUsername').value.trim();
                const email = document.getElementById('schoolParentEmail').value.trim();
                const phone = document.getElementById('schoolParentPhone').value.trim();
                const password = document.getElementById('schoolParentPassword').value;
                
                if (!name || !username || !email || !phone || !password) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                
                const existingUsers = Storage.getData('users') || [];
                if (existingUsers.some(u => u.username === username)) {
                    Toast.error('Username already exists');
                    return;
                }
                
                const user = {
                    id: Storage.generateUniqueId('USR'),
                    schoolId,
                    name,
                    username,
                    email,
                    phone,
                    password: Utils.hashPassword(password),
                    role: 'parent',
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                Storage.addItem('users', user);
                Toast.success('Parent account created');
                Modal.hide('addSchoolParentModal');
                this.loadSchoolParents();
            },
            
            editSchoolParent(id) {
                Toast.info('Edit parent functionality');
            },
            
            deleteSchoolParent(id) {
                Modal.confirm({
                    title: 'Delete Parent',
                    message: 'Are you sure you want to delete this parent account?',
                    onConfirm: () => {
                        Storage.deleteItem('users', id);
                        Toast.success('Parent deleted');
                        this.loadSchoolParents();
                    }
                });
            },
            
            saveSchoolInfo() {
                const schoolId = this.currentSchoolId;
                const updates = {
                    name: document.getElementById('schoolNameInput').value.trim(),
                    email: document.getElementById('schoolEmailInput').value.trim(),
                    phone: document.getElementById('schoolPhoneInput').value.trim(),
                    address: document.getElementById('schoolAddressInput').value.trim()
                };
                
                Storage.updateItem('schools', schoolId, updates);
                Toast.success('School information saved');
            },
            
            saveSchoolConfig() {
                const schoolId = this.currentSchoolId;
                const updates = {
                    type: document.getElementById('schoolTypeInput').value,
                    status: document.getElementById('schoolStatusInput').value
                };
                
                Storage.updateItem('schools', schoolId, updates);
                Toast.success('School configuration saved');
            },
            
            // Additional helper methods for school management
            switchSchoolStaffTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`)?.classList.add('active');
                
                const schoolId = this.currentSchoolId;
                const users = Storage.getUsers(schoolId);
                let staff = users.filter(u => ['teacher', 'accountant', 'director'].includes(u.role));
                
                if (tab === 'schoolTeachers') {
                    staff = staff.filter(u => u.role === 'teacher');
                } else if (tab === 'schoolAccountants') {
                    staff = staff.filter(u => u.role === 'accountant');
                } else if (tab === 'schoolDirectors') {
                    staff = staff.filter(u => u.role === 'director');
                }
                
                const container = document.getElementById('schoolStaffTable');
                if (staff.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No staff in this category</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Phone</th><th>Actions</th></tr></thead><tbody>';
                staff.forEach(user => {
                    const roleLabel = user.role === 'teacher' ? 'Teacher' : user.role === 'accountant' ? 'Accountant' : 'Director';
                    html += `<tr><td>${user.name}</td><td>${roleLabel}</td><td>${user.email || '-'}</td><td>${user.phone || '-'}</td><td>
                        <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchoolStaff('${user.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolStaff('${user.id}')"><i class="fas fa-trash"></i></button>
                    </td></tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            showAddSchoolTransactionModal() {
                const html = `
                    <form id="addSchoolTransactionForm">
                        <div class="form-group"><label class="form-label">Type *</label><select id="schoolTransactionType" class="form-control"><option value="income">Income</option><option value="expense">Expense</option></select></div>
                        <div class="form-group"><label class="form-label">Description *</label><input type="text" id="schoolTransactionDesc" class="form-control" required></div>
                        <div class="form-group"><label class="form-label">Category *</label><select id="schoolTransactionCategory" class="form-control">
                            <option value="Tuition">Tuition</option>
                            <option value="Registration">Registration</option>
                            <option value="Books">Books</option>
                            <option value="Uniform">Uniform</option>
                            <option value="Transport">Transport</option>
                            <option value="Donation">Donation</option>
                            <option value="Salary">Salary</option>
                            <option value="Utilities">Utilities</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Supplies">Supplies</option>
                            <option value="Other">Other</option>
                        </select></div>
                        <div class="form-group"><label class="form-label">Amount *</label><input type="number" id="schoolTransactionAmount" class="form-control" required min="1"></div>
                        <div class="form-group"><label class="form-label">Date *</label><input type="date" id="schoolTransactionDate" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>
                        <div class="flex gap-2 mt-3">
                            <button type="button" class="btn btn-secondary" onclick="Modal.hide('addSchoolTransactionModal')">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.addSchoolTransaction()"><i class="fas fa-save"></i> Save Transaction</button>
                        </div>
                    </form>
                `;
                
                Modal.show('addSchoolTransactionModal', html, 'Add Transaction');
            },
            
            addSchoolTransaction() {
                const schoolId = this.currentSchoolId;
                const type = document.getElementById('schoolTransactionType').value;
                const description = document.getElementById('schoolTransactionDesc').value.trim();
                const category = document.getElementById('schoolTransactionCategory').value;
                const amount = parseFloat(document.getElementById('schoolTransactionAmount').value);
                const date = document.getElementById('schoolTransactionDate').value;
                
                if (!description || !amount || !date) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                
                const transaction = {
                    id: Storage.generateId(),
                    schoolId,
                    type,
                    description,
                    category,
                    amount,
                    date,
                    createdAt: new Date().toISOString()
                };
                
                Storage.addItem('finance', transaction);
                Toast.success('Transaction added');
                Modal.hide('addSchoolTransactionModal');
                this.loadSchoolFinance();
            },
            
            deleteSchoolTransaction(id) {
                Modal.confirm({
                    title: 'Delete Transaction',
                    message: 'Are you sure you want to delete this transaction?',
                    onConfirm: () => {
                        Storage.deleteItem('finance', id);
                        Toast.success('Transaction deleted');
                        this.loadSchoolFinance();
                    }
                });
            },
            
            showSchoolReportType(type) {
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const classes = school?.settings?.classes || Storage.getClasses(schoolId);
                
                document.getElementById('schoolReportFilters').style.display = 'block';
                document.getElementById('schoolReportContent').style.display = 'none';
                
                let filtersHtml = '';
                
                if (type === 'student' || type === 'class') {
                    filtersHtml += `
                        <div class="form-group"><label>Class</label><select id="schoolFilterClass" class="form-control">${classes.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                        <div class="form-group"><label>Term</label><select id="schoolFilterTerm" class="form-control"><option value="First Term">First Term</option><option value="Second Term">Second Term</option><option value="Third Term">Third Term</option></select></div>
                        <div class="form-group"><label>Year</label><select id="schoolFilterYear" class="form-control"><option value="2026">2026</option><option value="2025">2025</option></select></div>
                    `;
                } else if (type === 'attendance') {
                    filtersHtml += `
                        <div class="form-group"><label>Class</label><select id="schoolFilterClass" class="form-control"><option value="">All Classes</option>${classes.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
                        <div class="form-group"><label>Date</label><input type="date" id="schoolFilterDate" class="form-control" value="${new Date().toISOString().split('T')[0]}"></div>
                    `;
                } else if (type === 'finance') {
                    filtersHtml += `
                        <div class="form-group"><label>Type</label><select id="schoolFilterFinanceType" class="form-control"><option value="all">All</option><option value="income">Income</option><option value="expense">Expense</option></select></div>
                        <div class="form-group"><label>Start Date</label><input type="date" id="schoolFilterStartDate" class="form-control"></div>
                        <div class="form-group"><label>End Date</label><input type="date" id="schoolFilterEndDate" class="form-control"></div>
                    `;
                }
                
                document.getElementById('schoolReportFiltersContent').innerHTML = filtersHtml;
                document.getElementById('schoolReportTypeTitle').textContent = type.charAt(0).toUpperCase() + type.slice(1) + ' Report';
                window.schoolCurrentReportType = type;
            },
            
            generateSchoolReport() {
                const type = window.schoolCurrentReportType;
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const container = document.getElementById('schoolReportContentBody');
                
                let html = `<div style="padding: 20px;"><h2 style="text-align:center;color:var(--primary);">${school?.name || 'School'}</h2><h3 style="text-align:center;">${type.charAt(0).toUpperCase() + type.slice(1)} Report</h3>`;
                
                if (type === 'student' || type === 'class') {
                    const className = document.getElementById('schoolFilterClass')?.value;
                    const term = document.getElementById('schoolFilterTerm')?.value;
                    const year = document.getElementById('schoolFilterYear')?.value;
                    
                    let students = Storage.getStudents(schoolId);
                    if (className) students = students.filter(s => s.class === className);
                    
                    html += `<p>Class: ${className || 'All'} | Term: ${term} | Year: ${year}</p>`;
                    html += `<table style="width:100%;border-collapse:collapse;"><tr style="background:var(--primary);color:white;"><th style="padding:8px;border:1px solid #ddd;">Student</th><th style="padding:8px;border:1px solid #ddd;">Class</th><th style="padding:8px;border:1px solid #ddd;">Status</th></tr>`;
                    students.forEach(s => {
                        html += `<tr><td style="padding:8px;border:1px solid #ddd;">${s.name}</td><td style="padding:8px;border:1px solid #ddd;">${s.class}</td><td style="padding:8px;border:1px solid #ddd;">${s.status}</td></tr>`;
                    });
                    html += '</table>';
                } else if (type === 'finance') {
                    const financeType = document.getElementById('schoolFilterFinanceType')?.value || 'all';
                    let finance = Storage.getFinance(schoolId);
                    if (financeType !== 'all') finance = finance.filter(f => f.type === financeType);
                    
                    const total = finance.reduce((s, f) => f.type === 'income' ? s + f.amount : s - f.amount, 0);
                    html += `<p>Total: ₦${total.toLocaleString()}</p>`;
                    html += `<table style="width:100%;border-collapse:collapse;"><tr style="background:var(--primary);color:white;"><th style="padding:8px;border:1px solid #ddd;">Date</th><th style="padding:8px;border:1px solid #ddd;">Description</th><th style="padding:8px;border:1px solid #ddd;">Type</th><th style="padding:8px;border:1px solid #ddd;">Amount</th></tr>`;
                    finance.forEach(f => {
                        html += `<tr><td style="padding:8px;border:1px solid #ddd;">${f.date}</td><td style="padding:8px;border:1px solid #ddd;">${f.description}</td><td style="padding:8px;border:1px solid #ddd;">${f.type}</td><td style="padding:8px;border:1px solid #ddd;">₦${f.amount.toLocaleString()}</td></tr>`;
                    });
                    html += '</table>';
                }
                
                html += `<p style="text-align:center;font-size:10px;color:#999;margin-top:30px;">My School System - Odebunmi Tawwab | ${new Date().toLocaleDateString()}</p></div>`;
                
                container.innerHTML = html;
                document.getElementById('schoolReportContent').style.display = 'block';
            },
            
            exportSchoolReport(format) {
                Toast.info('Export functionality - use Print for PDF');
            },
            
            generateSchoolIDCard() {
                const userId = document.getElementById('schoolIdCardUser').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                
                const schoolId = this.currentSchoolId;
                const school = Storage.getSchoolById(schoolId);
                const type = document.getElementById('schoolIdCardType').value;
                
                let user, student;
                if (type === 'student') {
                    student = Storage.getStudents(schoolId).find(s => s.id === userId);
                } else {
                    user = Storage.getUsers(schoolId).find(u => u.id === userId);
                }
                
                const name = student?.name || user?.name;
                const id = student?.id || user?.id;
                
                const html = `
                    <div class="id-card horizontal" style="max-width: 400px; margin: 0 auto;">
                        <div class="id-card-header" style="background: var(--primary); color: white; padding: 10px; text-align: center; font-weight: bold;">${school?.name || 'School'}</div>
                        <div style="padding: 15px; display: flex; gap: 15px;">
                            <div style="width: 80px; height: 80px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user" style="font-size: 40px; color: #999;"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 16px;">${name}</div>
                                <div style="color: #666;">${type === 'student' ? 'Student' : type.charAt(0).toUpperCase() + type.slice(1)}</div>
                                <div style="font-size: 12px; color: #999;">ID: ${id}</div>
                                ${student ? `<div style="font-size: 12px; color: #999;">Class: ${student.class}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('schoolIdCardPreview').innerHTML = html;
            },
            
            // Import/Export functions
            importSchoolCSV(input) {
                Toast.info('CSV import functionality');
            },
            
            exportSchoolCSV() {
                const schoolId = this.currentSchoolId;
                const students = Storage.getStudents(schoolId);
                
                if (students.length === 0) {
                    Toast.error('No students to export');
                    return;
                }
                
                const csv = 'ID,Name,Class,Email,Phone,Parent Name,Parent Phone,Status\n' + 
                    students.map(s => `${s.id},${s.name},${s.class},${s.email || ''},${s.phone || ''},${s.parentName || ''},${s.parentPhone || ''},${s.status}`).join('\n');
                
                Utils.downloadFile(csv, 'students.csv', 'text/csv');
                Toast.success('Students exported');
            },
            
            loadStats() {
                const schools = Storage.getSchools();
                const users = Storage.getData('users');
                const codes = Storage.getData('activationCodes');
                const students = Storage.getData('students');
                const scores = Storage.getData('scores');
                const attendance = Storage.getData('attendance');
                const finance = Storage.getData('finance');
                
                const activeSchools = schools.filter(s => s.status === 'active').length;
                const expiredSchools = schools.filter(s => {
                    const check = Storage.checkSchoolExpiration(s.id);
                    return check.expired;
                }).length;
                
                const totalStudents = students.length;
                const totalStaff = users.filter(u => u.role !== 'super_admin').length;
                const totalIncome = finance.filter(f => f.type === 'income').reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
                
                document.getElementById('totalSchools').textContent = schools.length;
                document.getElementById('activeSchools').textContent = activeSchools;
                document.getElementById('totalUsers').textContent = totalStaff;
                document.getElementById('availableCodes').textContent = codes.filter(c => !c.isUsed).length;
                
                document.getElementById('totalStudentsAll').textContent = totalStudents;
                document.getElementById('expiredSchools').textContent = expiredSchools;
                document.getElementById('totalIncome').textContent = '₦' + totalIncome.toLocaleString();
                
                this.renderRecentSchools(schools);
                this.renderRecentCodes(codes);
            },
            
            renderRecentSchools(schools) {
                const container = document.getElementById('recentSchools');
                if (!schools.length) return;
                
                const recent = schools.slice(-5).reverse();
                let html = '<div class="list-group">';
                
                recent.forEach(school => {
                    html += `
                        <div class="list-group-item">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="stat-icon primary" style="width: 40px; height: 40px;">
                                    <i class="fas fa-school"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${school.name}</div>
                                    <div style="font-size: 12px; color: var(--gray);">${school.type}</div>
                                </div>
                            </div>
                            <span class="badge badge-${school.status === 'active' ? 'success' : 'warning'}">${school.status}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            renderRecentCodes(codes) {
                const container = document.getElementById('recentCodes');
                if (!codes.length) return;
                
                const recent = codes.slice(-5).reverse();
                let html = '<div class="list-group">';
                
                recent.forEach(code => {
                    html += `
                        <div class="list-group-item">
                            <div>
                                <div style="font-weight: 600; font-family: monospace;">${code.code}</div>
                                <div style="font-size: 12px; color: var(--gray);">${code.isUsed ? 'Used' : 'Available'}</div>
                            </div>
                            <span class="badge badge-${code.isUsed ? 'warning' : 'success'}">${code.isUsed ? 'Used' : 'Available'}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            },
            
            showSchools() {
                const schools = Storage.getSchools();
                const container = document.getElementById('schoolsList');
                
                if (!schools.length) {
                    container.innerHTML = '<div class="empty-state"><p>No schools registered</p></div>';
                } else {
                    let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Phone</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                    
                    schools.forEach(school => {
                        const createdDate = school.createdAt ? new Date(school.createdAt).toLocaleDateString() : '-';
                        html += `
                            <tr>
                                <td><strong>${school.name}</strong></td>
                                <td>${school.type === 'both' ? 'Primary & Secondary' : (school.type.charAt(0).toUpperCase() + school.type.slice(1)) + ' School'}</td>
                                <td>${school.email || '-'}</td>
                                <td>${school.phone || '-'}</td>
                                <td><span class="badge badge-${school.status === 'active' ? 'success' : 'warning'}">${school.status}</span></td>
                                <td>${createdDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.viewSchool('${school.id}')" title="View"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchool('${school.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-${school.status === 'active' ? 'warning' : 'success'}" onclick="SuperAdmin.toggleSchoolStatus('${school.id}')" title="${school.status === 'active' ? 'Deactivate' : 'Activate'}"><i class="fas fa-${school.status === 'active' ? 'ban' : 'check'}"></i></button>
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.renewSchool('${school.id}')" title="Renew"><i class="fas fa-redo"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolPrompt('${school.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
                
                document.getElementById('schoolSearchInput').value = '';
                document.getElementById('schoolStatusFilter').value = 'all';
                document.getElementById('schoolTypeFilter').value = 'all';
                Modal.show('schoolsModal');
            },
            
            filterSchools() {
                const searchTerm = document.getElementById('schoolSearchInput').value.toLowerCase();
                const statusFilter = document.getElementById('schoolStatusFilter').value;
                const typeFilter = document.getElementById('schoolTypeFilter').value;
                
                let schools = Storage.getSchools();
                
                if (searchTerm) {
                    schools = schools.filter(s => 
                        s.name.toLowerCase().includes(searchTerm) || 
                        (s.email && s.email.toLowerCase().includes(searchTerm)) ||
                        (s.phone && s.phone.includes(searchTerm))
                    );
                }
                
                if (statusFilter !== 'all') {
                    schools = schools.filter(s => s.status === statusFilter);
                }
                
                if (typeFilter !== 'all') {
                    schools = schools.filter(s => s.type === typeFilter);
                }
                
                const container = document.getElementById('schoolsList');
                
                if (!schools.length) {
                    container.innerHTML = '<div class="empty-state"><p>No schools found</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Type</th><th>Email</th><th>Phone</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
                
                schools.forEach(school => {
                    const createdDate = school.createdAt ? new Date(school.createdAt).toLocaleDateString() : '-';
                    html += `
                        <tr>
                            <td><strong>${school.name}</strong></td>
                            <td>${school.type === 'both' ? 'Primary & Secondary' : (school.type.charAt(0).toUpperCase() + school.type.slice(1)) + ' School'}</td>
                            <td>${school.email || '-'}</td>
                            <td>${school.phone || '-'}</td>
                            <td><span class="badge badge-${school.status === 'active' ? 'success' : 'warning'}">${school.status}</span></td>
                            <td>${createdDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="SuperAdmin.viewSchool('${school.id}')" title="View"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchool('${school.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-${school.status === 'active' ? 'warning' : 'success'}" onclick="SuperAdmin.toggleSchoolStatus('${school.id}')" title="${school.status === 'active' ? 'Deactivate' : 'Activate'}"><i class="fas fa-${school.status === 'active' ? 'ban' : 'check'}"></i></button>
                                <button class="btn btn-sm btn-outline" onclick="SuperAdmin.renewSchool('${school.id}')" title="Renew"><i class="fas fa-redo"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteSchoolPrompt('${school.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            getSchoolStats(schoolId) {
                const students = Storage.getStudents(schoolId);
                const users = Storage.getUsers(schoolId);
                const teachers = users.filter(u => u.role === 'teacher');
                const staff = users.filter(u => ['accountant', 'admin', 'director'].includes(u.role));
                
                return {
                    totalStudents: students.length,
                    totalTeachers: teachers.length,
                    totalStaff: staff.length,
                    activeStudents: students.filter(s => s.status === 'active').length
                };
            },
            
            viewSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                const stats = this.getSchoolStats(schoolId);
                const adminUser = Storage.getUsers(schoolId).find(u => u.role === 'school_admin');
                const schoolClasses = school.settings?.classes || [];
                const schoolSubjects = school.settings?.subjects || {};
                
                const typeDisplay = school.type === 'both' ? 'Primary & Secondary' : (school.type.charAt(0).toUpperCase() + school.type.slice(1)) + ' School';
                const expiryDate = school.expiresAt ? new Date(school.expiresAt).toLocaleDateString() : 'N/A';
                const daysLeft = school.expiresAt ? Math.ceil((new Date(school.expiresAt) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                
                let html = `
                    <div class="school-details">
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-icon primary"><i class="fas fa-user-graduate"></i></div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.totalStudents}</div>
                                    <div class="stat-label">Students</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon success"><i class="fas fa-chalkboard-teacher"></i></div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.totalTeachers}</div>
                                    <div class="stat-label">Teachers</div>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon warning"><i class="fas fa-users"></i></div>
                                <div class="stat-content">
                                    <div class="stat-value">${stats.totalStaff}</div>
                                    <div class="stat-label">Staff</div>
                                </div>
                            </div>
                        </div>
                        
                        <h4 style="margin: 20px 0 10px;">School Information</h4>
                        <table class="table" style="margin-bottom: 20px;">
                            <tr><td style="width: 140px;"><strong>Name:</strong></td><td>${school.name}</td></tr>
                            <tr><td><strong>Alias:</strong></td><td>${school.alias || '-'}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${typeDisplay}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${school.email || '-'}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${school.phone || '-'}</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${school.address || '-'}</td></tr>
                            <tr><td><strong>Currency:</strong></td><td>${school.currency || 'NGN'}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge badge-${school.status === 'active' ? 'success' : 'warning'}">${school.status}</span></td></tr>
                            <tr><td><strong>Created:</strong></td><td>${school.createdAt ? new Date(school.createdAt).toLocaleDateString() : '-'}</td></tr>
                            <tr><td><strong>Expires:</strong></td><td>${expiryDate} ${daysLeft > 0 && daysLeft < 30 ? `<span class="badge badge-warning">${daysLeft} days left</span>` : ''}</td></tr>
                        </table>
                        
                        ${adminUser ? `
                            <h4 style="margin: 20px 0 10px;">Admin User</h4>
                            <table class="table" style="margin-bottom: 20px;">
                                <tr><td style="width: 140px;"><strong>Name:</strong></td><td>${adminUser.name || '-'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${adminUser.email || '-'}</td></tr>
                                <tr><td><strong>Phone:</strong></td><td>${adminUser.phone || '-'}</td></tr>
                                <tr><td><strong>Username:</strong></td><td>${adminUser.username || '-'}</td></tr>
                            </table>
                        ` : ''}
                        
                        <h4 style="margin: 20px 0 10px;">Classes (${schoolClasses.length})</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
                            ${schoolClasses.length > 0 ? schoolClasses.map(c => `<span class="badge badge-info">${c}</span>`).join('') : 'No classes configured'}
                        </div>
                        
                        <h4 style="margin: 20px 0 10px;">Subjects by Level</h4>
                        ${Object.entries(schoolSubjects).filter(([k]) => k !== 'custom').map(([level, subs]) => `
                            <div style="margin-bottom: 10px;">
                                <strong>${level}:</strong> ${Array.isArray(subs) ? subs.join(', ') : 'N/A'}
                            </div>
                        `).join('') || 'No subjects configured'}
                    </div>
                `;
                
                document.getElementById('viewSchoolContent').innerHTML = html;
                Modal.show('viewSchoolModal');
            },
            
            editSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                document.getElementById('editSchoolId').value = school.id;
                document.getElementById('editSchoolName').value = school.name || '';
                document.getElementById('editSchoolAlias').value = school.alias || '';
                document.getElementById('editSchoolEmail').value = school.email || '';
                document.getElementById('editSchoolPhone').value = school.phone || '';
                document.getElementById('editSchoolAddress').value = school.address || '';
                document.getElementById('editSchoolType').value = school.type || 'primary';
                document.getElementById('editSchoolCurrency').value = school.currency || 'NGN';
                
                Modal.show('editSchoolModal');
            },
            
            saveSchoolEdit() {
                const schoolId = document.getElementById('editSchoolId').value;
                const school = Storage.getSchoolById(schoolId);
                
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                const updates = {
                    name: document.getElementById('editSchoolName').value.trim(),
                    alias: document.getElementById('editSchoolAlias').value.trim(),
                    email: document.getElementById('editSchoolEmail').value.trim(),
                    phone: document.getElementById('editSchoolPhone').value.trim(),
                    address: document.getElementById('editSchoolAddress').value.trim(),
                    type: document.getElementById('editSchoolType').value,
                    currency: document.getElementById('editSchoolCurrency').value
                };
                
                if (!updates.name) {
                    Toast.error('School name is required');
                    return;
                }
                
                Storage.updateItem('schools', schoolId, updates);
                Toast.success('School updated successfully');
                Modal.hide('editSchoolModal');
                this.showSchools();
                this.loadStats();
            },
            
            toggleSchoolStatus(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                const newStatus = school.status === 'active' ? 'inactive' : 'active';
                
                Modal.confirm({
                    title: newStatus === 'active' ? 'Activate School' : 'Deactivate School',
                    message: `Are you sure you want to ${newStatus} this school? ${newStatus === 'inactive' ? 'Users will not be able to login.' : 'Users will be able to login again.'}`,
                    onConfirm: () => {
                        Storage.updateItem('schools', schoolId, { status: newStatus });
                        Toast.success(`School ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
                        this.showSchools();
                        this.loadStats();
                    }
                });
            },
            
            renewSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                document.getElementById('renewSchoolId').value = school.id;
                const currentExpiry = school.expiresAt ? new Date(school.expiresAt).toLocaleDateString() : 'No expiry set';
                document.getElementById('renewCurrentExpiry').textContent = `Current expiry: ${currentExpiry}`;
                
                Modal.show('renewSchoolModal');
            },
            
            confirmRenewSchool() {
                const schoolId = document.getElementById('renewSchoolId').value;
                const days = parseInt(document.getElementById('renewDays').value);
                const school = Storage.getSchoolById(schoolId);
                
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                let currentExpiry = school.expiresAt ? new Date(school.expiresAt) : new Date();
                if (new Date() > currentExpiry) {
                    currentExpiry = new Date();
                }
                
                const newExpiry = new Date(currentExpiry);
                newExpiry.setDate(newExpiry.getDate() + days);
                
                Storage.updateItem('schools', schoolId, {
                    expiresAt: newExpiry.toISOString(),
                    status: 'active',
                    subscriptionDays: (school.subscriptionDays || 0) + days
                });
                
                Toast.success(`Subscription extended by ${days} days`);
                Modal.hide('renewSchoolModal');
                this.showSchools();
                this.loadStats();
            },
            
            deleteSchoolPrompt(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                const stats = this.getSchoolStats(schoolId);
                
                Modal.confirm({
                    title: 'Delete School',
                    message: `<strong>Warning:</strong> This will permanently delete "${school.name}" and all its data including:
                    <ul style="margin: 10px 0;">
                        <li>${stats.totalStudents} students</li>
                        <li>${stats.totalTeachers} teachers</li>
                        <li>${stats.totalStaff} staff</li>
                        <li>All scores, attendance, finance records</li>
                    </ul>
                    This action cannot be undone!`,
                    onConfirm: () => {
                        this.deleteSchool(schoolId);
                    }
                });
            },
            
            deleteSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) return;
                
                const users = Storage.getUsers(schoolId);
                const students = Storage.getStudents(schoolId);
                
                const allData = Storage.getData();
                
                const dataKeysToDelete = ['users', 'students', 'scores', 'attendance', 'finance', 'messages', 'activities', 'notifications'];
                
                dataKeysToDelete.forEach(key => {
                    const data = Storage.getData(key) || [];
                    const filtered = data.filter(item => item.schoolId !== schoolId);
                    Storage.setData(key, filtered);
                });
                
                const schools = Storage.getData('schools') || [];
                const updatedSchools = schools.filter(s => s.id !== schoolId);
                Storage.setData('schools', updatedSchools);
                
                Toast.success(`School "${school.name}" and all its data have been deleted`);
                this.showSchools();
                this.loadStats();
            },
            
            showActivationCodes() {
                const codes = Storage.getData('activationCodes');
                const container = document.getElementById('codesList');
                
                if (!codes.length) {
                    container.innerHTML = '<div class="empty-state"><p>No codes generated</p></div>';
                } else {
                    let html = '<div class="table-container"><table class="table"><thead><tr><th>Code</th><th>Status</th><th>Expires</th><th>Used By</th></tr></thead><tbody>';
                    
                    codes.forEach(code => {
                        html += `
                            <tr>
                                <td style="font-family: monospace;">${code.code}</td>
                                <td><span class="badge badge-${code.isUsed ? 'warning' : 'success'}">${code.isUsed ? 'Used' : 'Available'}</span></td>
                                <td>${Utils.formatDate(code.expiresAt)}</td>
                                <td>${code.schoolId ? 'Registered' : '-'}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
                
                Modal.show('codesModal');
            },
            
            generateNewCode(subscriptionDays = 365) {
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let code = 'ACT-';
                for (let i = 0; i < 8; i++) {
                    code += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                
                const codeData = {
                    id: Storage.generateId(),
                    code: code,
                    schoolId: null,
                    isUsed: false,
                    subscriptionDays: subscriptionDays,
                    expiresAt: new Date(Date.now() + subscriptionDays * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    usedAt: null
                };
                
                Storage.addItem('activationCodes', codeData);
                
                Toast.success('Code generated: ' + code + ' (' + subscriptionDays + ' days)');
                this.showCodesList();
                this.loadStats();
            },
            
            generateCode() {
                const days = prompt('Enter subscription days (default: 365):', '365');
                if (days === null) return;
                const subscriptionDays = parseInt(days) || 365;
                this.generateNewCode(subscriptionDays);
            },
            
            clearAllCodes() {
                if (!confirm('Are you sure you want to delete ALL activation codes? This cannot be undone.')) {
                    return;
                }
                Storage.setData('activationCodes', []);
                Toast.success('All activation codes have been cleared');
                this.showActivationCodes();
                this.loadStats();
            },
            
            showSection(section) {
                // Map section names to element IDs
                const sectionMap = {
                    'dashboard': 'mainContent',
                    'schools': 'schoolsSection',
                    'codes': 'codesSection',
                    'restrictions': 'restrictionsSection',
                    'blog': 'blogSection',
                    'resources': 'resourcesSection',
                    'pricing': 'pricingSection',
                    'pages': 'pagesSection',
                    'chat': 'chatSection',
                    'announcement': 'announcementSection',
                    'theme': 'themeSection',
                    'help': 'helpSection',
                    'data': 'dataSection',
                    'profile': 'profileSection'
                };
                
                // Hide all sections first - be explicit
                const allSections = ['mainContent', 'schoolsSection', 'codesSection', 'restrictionsSection', 'blogSection', 'resourcesSection', 'pricingSection', 'pagesSection', 'chatSection', 'announcementSection', 'themeSection', 'helpSection', 'dataSection', 'profileSection'];
                allSections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.display = 'none';
                        el.setAttribute('data-hidden', 'true');
                    }
                });
                
                // Show target section
                const targetId = sectionMap[section] || 'mainContent';
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    targetEl.style.display = 'block';
                    targetEl.removeAttribute('data-hidden');
                }
                
                // Show/hide dashboard widgets (Recent Schools/Codes)
                const dashboardWidgets = document.getElementById('dashboardWidgets');
                if (dashboardWidgets) {
                    if (section === 'dashboard') {
                        dashboardWidgets.style.display = 'block';
                    } else {
                        dashboardWidgets.style.display = 'none';
                    }
                }
                
                // Update nav active state
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const navMap = {
                    'dashboard': 'nav-dashboard', 'schools': 'nav-schools', 'codes': 'nav-codes',
                    'restrictions': 'nav-restrictions', 'blog': 'nav-blog', 'resources': 'nav-resources',
                    'pricing': 'nav-pricing', 'pages': 'nav-pages',
                    'chat': 'nav-chat', 'announcement': 'nav-announcement', 'theme': 'nav-theme', 'help': 'nav-help',
                    'data': 'nav-data', 'profile': 'nav-profile'
                };
                const activeNav = document.getElementById(navMap[section]);
                if (activeNav) activeNav.classList.add('active');
                
                // Load content
                if (section === 'dashboard') {
                    this.loadStats();
                }
                if (section === 'schools') this.showSchoolsList();
                if (section === 'codes') this.showCodesList();
                if (section === 'restrictions') this.populateSchoolDropdown();
                if (section === 'blog') this.loadBlogManager();
                if (section === 'resources') this.loadResourcesManager();
                if (section === 'pricing') this.loadPricingManager();
                if (section === 'pages') this.loadPagesManager();
                if (section === 'announcement') this.loadAnnouncement();
                if (section === 'chat') { if (!Chat.currentUser) { Chat.init(); } }
                if (section === 'theme') this.loadThemeSettings();
                if (section === 'help') this.loadHelpEditor();
                if (section === 'data') this.showDataSection();
                if (section === 'profile') Profile.init();
            },
            
            loadThemeSettings() {
                const theme = ThemeManager.getGlobalTheme();
                document.getElementById('primaryColor').value = theme.primary || '#16a34a';
                document.getElementById('primaryColorHex').value = theme.primary || '#16a34a';
                document.getElementById('accentColor').value = theme.accent || '#10b981';
                document.getElementById('accentColorHex').value = theme.accent || '#10b981';
                document.getElementById('fontSelect').value = theme.fontFamily || 'Inter, Poppins, -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif';
                
                if (theme.updatedAt) {
                    document.getElementById('themeLastUpdated').textContent = 'Last updated: ' + new Date(theme.updatedAt).toLocaleString();
                }
            },
            
            previewTheme() {
                const theme = {
                    primary: document.getElementById('primaryColor').value,
                    accent: document.getElementById('accentColor').value,
                    fontFamily: document.getElementById('fontSelect').value
                };
                ThemeManager.previewTheme(theme, 15000);
            },
            
            saveThemeSettings() {
                const theme = {
                    primary: document.getElementById('primaryColor').value,
                    accent: document.getElementById('accentColor').value,
                    fontFamily: document.getElementById('fontSelect').value
                };
                ThemeManager.saveGlobalTheme(theme);
                Toast.success('Theme saved successfully');
                this.loadThemeSettings();
            },
            
            resetThemeSettings() {
                Modal.confirm({
                    title: 'Reset Theme',
                    message: 'Are you sure you want to reset the theme to default settings?',
                    onConfirm: () => {
                        ThemeManager.resetTheme();
                        this.loadThemeSettings();
                        Toast.success('Theme reset to default');
                    }
                });
            },
            
            loadAnnouncement() {
                const announcement = Storage.getAnnouncement();
                const textarea = document.getElementById('announcementMessage');
                const statusText = document.getElementById('announcementStatusText');
                const preview = document.getElementById('announcementPreview');
                const activeCheckbox = document.getElementById('announcementActive');
                
                if (announcement && announcement.isActive) {
                    textarea.value = announcement.message || '';
                    statusText.textContent = 'Active';
                    preview.innerHTML = `<div class="announcement-banner active" style="position: relative; padding: 15px; margin-bottom: 10px;">
                        <div class="announcement-content">${announcement.message || 'No message'}</div>
                    </div>`;
                    if (activeCheckbox) activeCheckbox.checked = true;
                } else {
                    textarea.value = '';
                    statusText.textContent = 'Inactive';
                    preview.innerHTML = '<p class="text-muted">No announcement set</p>';
                    if (activeCheckbox) activeCheckbox.checked = false;
                }
                
                // Add event listeners for real-time preview
                if (textarea) {
                    textarea.oninput = () => SuperAdmin.updatePreview();
                }
                if (activeCheckbox) {
                    activeCheckbox.onchange = () => SuperAdmin.updatePreview();
                }
            },
            
            updatePreview() {
                const textarea = document.getElementById('announcementMessage');
                const preview = document.getElementById('announcementPreview');
                const activeCheckbox = document.getElementById('announcementActive');
                const message = textarea.value.trim();
                
                if (message && activeCheckbox.checked) {
                    preview.innerHTML = `<div class="announcement-banner active" style="position: relative; padding: 15px; margin-bottom: 10px;">
                        <div class="announcement-content">${message}</div>
                    </div>`;
                } else if (!activeCheckbox.checked) {
                    preview.innerHTML = '<p class="text-muted"><i class="fas fa-pause"></i> Announcement is currently disabled</p>';
                } else {
                    preview.innerHTML = '<p class="text-muted">Type a message above to see preview</p>';
                }
            },
            
            saveAnnouncement() {
                const message = document.getElementById('announcementMessage').value.trim();
                const isActive = document.getElementById('announcementActive').checked;
                
                if (!message) {
                    Toast.warning('Please enter an announcement message');
                    return;
                }
                
                Storage.setAnnouncement(message, isActive);
                Toast.success('Announcement saved successfully');
                this.loadAnnouncement();
                
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
            },
            
            clearAnnouncement() {
                if (!confirm('Are you sure you want to clear the announcement?')) return;
                
                Storage.clearAnnouncement();
                Toast.success('Announcement cleared');
                this.loadAnnouncement();
                
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
            },

            showSchoolsList() {
                const schools = Storage.getSchools();
                const container = document.getElementById('schoolsListContent');
                
                if (!schools.length) {
                    container.innerHTML = '<div class="empty-state"><p>No schools registered</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Type</th><th>Admin</th><th>Students</th><th>Staff</th><th>Expires</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                schools.forEach(school => {
                    const check = Storage.checkSchoolExpiration(school.id);
                    const expired = check.expired;
                    const isActive = school.status === 'active';
                    const students = Storage.getStudents(school.id).length;
                    const staff = Storage.getUsers(school.id).filter(u => u.role !== 'super_admin').length;
                    const admin = Storage.getUsers(school.id).find(u => u.role === 'school_admin');
                    
                    html += `
                        <tr>
                            <td><strong>${school.name}</strong></td>
                            <td><span class="badge badge-info">${school.type || 'N/A'}</span></td>
                            <td>${admin ? admin.name : '<span class="text-muted">No admin</span>'}</td>
                            <td><span class="badge badge-primary">${students}</span></td>
                            <td><span class="badge badge-secondary">${staff}</span></td>
                            <td>${school.expiresAt ? Utils.formatDate(school.expiresAt) : 'Lifetime'}</td>
                            <td><span class="badge badge-${expired ? 'danger' : (isActive ? 'success' : 'warning')}">${expired ? 'Expired' : (isActive ? 'Active' : 'Inactive')}</span></td>
                            <td>
                                <div class="flex gap-1">
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.viewSchoolDetails('${school.id}')" title="View Details"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.editSchool('${school.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-${isActive ? 'warning' : 'success'}" onclick="SuperAdmin.toggleSchoolStatus('${school.id}')" title="${isActive ? 'Deactivate' : 'Activate'}"><i class="fas fa-${isActive ? 'ban' : 'check'}"></i></button>
                                    <button class="btn btn-sm btn-outline" onclick="SuperAdmin.renewSchool('${school.id}')" title="Renew"><i class="fas fa-redo"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            viewSchoolDetails(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) return;
                
                const students = Storage.getStudents(schoolId);
                const users = Storage.getUsers(schoolId);
                const staff = users.filter(u => u.role !== 'super_admin');
                const admin = users.find(u => u.role === 'school_admin');
                const teachers = users.filter(u => u.role === 'teacher');
                const attendance = Storage.getAttendance(schoolId);
                const scores = Storage.getScores(schoolId);
                const finance = Storage.getFinance(schoolId);
                
                const totalIncome = finance.filter(f => f.type === 'income').reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
                const totalExpenses = finance.filter(f => f.type === 'expense').reduce((sum, f) => sum + (parseFloat(f.amount) || 0), 0);
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'schoolDetailsModal';
                modal.innerHTML = `
                    <div class="modal modal-lg" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-school"></i> ${school.name}</h3>
                            <button class="modal-close" onclick="document.getElementById('schoolDetailsModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="grid-2 mb-3">
                                <div class="card">
                                    <div class="card-header"><h4 class="card-title">School Info</h4></div>
                                    <div class="card-body">
                                        <p><strong>Type:</strong> ${school.type || 'N/A'}</p>
                                        <p><strong>Email:</strong> ${school.email || 'N/A'}</p>
                                        <p><strong>Phone:</strong> ${school.phone || 'N/A'}</p>
                                        <p><strong>Address:</strong> ${school.address || 'N/A'}</p>
                                        <p><strong>Status:</strong> <span class="badge badge-${school.status === 'active' ? 'success' : 'warning'}">${school.status}</span></p>
                                        <p><strong>Expires:</strong> ${school.expiresAt ? Utils.formatDate(school.expiresAt) : 'Lifetime'}</p>
                                    </div>
                                </div>
                                <div class="card">
                                    <div class="card-header"><h4 class="card-title">Statistics</h4></div>
                                    <div class="card-body">
                                        <div class="stat-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                            <div class="stat-item"><strong>Students:</strong> ${students.length}</div>
                                            <div class="stat-item"><strong>Staff:</strong> ${staff.length}</div>
                                            <div class="stat-item"><strong>Teachers:</strong> ${teachers.length}</div>
                                            <div class="stat-item"><strong>Attendance:</strong> ${attendance.length}</div>
                                            <div class="stat-item"><strong>Scores:</strong> ${scores.length}</div>
                                            <div class="stat-item"><strong>Income:</strong> ₦${totalIncome.toLocaleString()}</div>
                                            <div class="stat-item"><strong>Expenses:</strong> ₦${totalExpenses.toLocaleString()}</div>
                                            <div class="stat-item"><strong>Balance:</strong> ₦${(totalIncome - totalExpenses).toLocaleString()}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header"><h4 class="card-title">School Admin</h4></div>
                                <div class="card-body">
                                    ${admin ? `
                                        <div class="flex-align-center" style="justify-content: space-between;">
                                            <div>
                                                <p><strong>Name:</strong> ${admin.name}</p>
                                                <p><strong>Email:</strong> ${admin.email || 'N/A'}</p>
                                                <p><strong>Phone:</strong> ${admin.phone || 'N/A'}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button class="btn btn-sm btn-outline" onclick="SuperAdmin.changeStaffPassword('${admin.id}', '${school.id}')"><i class="fas fa-key"></i> Change Password</button>
                                            </div>
                                        </div>
                                    ` : '<p class="text-muted">No admin assigned</p>'}
                                </div>
                            </div>
                            
                            <div class="card mb-3">
                                <div class="card-header"><h4 class="card-title">Staff Members (${staff.length})</h4></div>
                                <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                                    ${staff.length > 0 ? `
                                        <table class="table table-sm">
                                            <thead><tr><th>Name</th><th>Role</th><th>Email</th><th>Status</th><th>Actions</th></tr></thead>
                                            <tbody>
                                                ${staff.map(s => `
                                                    <tr>
                                                        <td>${s.name}</td>
                                                        <td><span class="badge badge-info">${s.role}</span></td>
                                                        <td>${s.email || 'N/A'}</td>
                                                        <td><span class="badge badge-${s.status === 'active' ? 'success' : 'warning'}">${s.status}</span></td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline" onclick="SuperAdmin.changeStaffPassword('${s.id}', '${school.id}')" title="Change Password"><i class="fas fa-key"></i></button>
                                                            <button class="btn btn-sm btn-${s.status === 'active' ? 'warning' : 'success'}" onclick="SuperAdmin.toggleStaffStatus('${s.id}', '${school.id}')" title="${s.status === 'active' ? 'Deactivate' : 'Activate'}"><i class="fas fa-${s.status === 'active' ? 'ban' : 'check'}"></i></button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    ` : '<p class="text-muted">No staff members</p>'}
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header"><h4 class="card-title">Recent Students (${students.length} total)</h4></div>
                                <div class="card-body" style="max-height: 250px; overflow-y: auto;">
                                    ${students.length > 0 ? `
                                        <table class="table table-sm">
                                            <thead><tr><th>Name</th><th>Class</th><th>Parent Contact</th></tr></thead>
                                            <tbody>
                                                ${students.slice(0, 20).map(s => `
                                                    <tr>
                                                        <td>${s.name}</td>
                                                        <td>${s.class}</td>
                                                        <td>${s.parentPhone || 'N/A'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        ${students.length > 20 ? `<p class="text-muted">...and ${students.length - 20} more</p>` : ''}
                                    ` : '<p class="text-muted">No students enrolled</p>'}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('schoolDetailsModal').remove()">Close</button>
                            <button class="btn btn-primary" onclick="SuperAdmin.editSchool('${school.id}'); document.getElementById('schoolDetailsModal').remove();"><i class="fas fa-edit"></i> Edit School</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            },
            
            changeStaffPassword(staffId, schoolId) {
                const user = Storage.getItemById('users', staffId);
                if (!user) return;
                
                const newPassword = prompt(`Enter new password for ${user.name}:`);
                if (!newPassword || newPassword.length < 6) {
                    Toast.error('Password must be at least 6 characters');
                    return;
                }
                
                const confirmPassword = prompt('Confirm new password:');
                if (newPassword !== confirmPassword) {
                    Toast.error('Passwords do not match');
                    return;
                }
                
                Storage.updateItem('users', staffId, {
                    password: Storage.hashPassword(newPassword)
                });
                
                Toast.success(`Password changed for ${user.name}`);
            },
            
            toggleStaffStatus(staffId, schoolId) {
                const user = Storage.getItemById('users', staffId);
                if (!user) return;
                
                const newStatus = user.status === 'active' ? 'inactive' : 'active';
                if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} ${user.name}?`)) return;
                
                Storage.updateItem('users', staffId, { status: newStatus });
                Toast.success(`Staff member ${newStatus === 'active' ? 'activated' : 'deactivated'}`);
                
                const modal = document.getElementById('schoolDetailsModal');
                if (modal) {
                    this.viewSchoolDetails(schoolId);
                }
            },
            
            showCodesList() {
                const codes = Storage.getData('activationCodes');
                const container = document.getElementById('codesListContent');
                
                if (!codes.length) {
                    container.innerHTML = '<div class="empty-state"><p>No codes generated</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Code</th><th>Status</th><th>Created</th><th>Expires</th><th>Actions</th></tr></thead><tbody>';
                
                const sortedCodes = [...codes].reverse();
                
                sortedCodes.forEach(code => {
                    const isExpired = new Date(code.expiresAt) < new Date() && !code.isUsed;
                    html += `
                        <tr>
                            <td style="font-family: monospace;">${code.code}</td>
                            <td><span class="badge badge-${code.isUsed ? 'warning' : (isExpired ? 'danger' : 'success')}">${code.isUsed ? 'Used' : (isExpired ? 'Expired' : 'Active')}</span></td>
                            <td>${Utils.formatDate(code.createdAt)}</td>
                            <td>${Utils.formatDate(code.expiresAt)}</td>
                            <td>
                                ${!code.isUsed ? `<button class="btn btn-sm" onclick="SuperAdmin.editCodeExpiration('${code.id}')"><i class="fas fa-edit"></i></button>` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            renewSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                const days = prompt('Extend subscription by how many days?', '365');
                if (!days || isNaN(days)) return;
                
                Storage.renewSchoolSubscription(schoolId, parseInt(days));
                Toast.success(`Subscription extended by ${days} days`);
                this.showSchoolsList();
                
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
            },
            
            editSchool(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'editSchoolModal';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-edit"></i> Edit School</h3>
                            <button class="modal-close" onclick="document.getElementById('editSchoolModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">School Name</label>
                                <input type="text" id="editSchoolName" class="form-control" value="${school.name || ''}">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="editSchoolEmail" class="form-control" value="${school.email || ''}">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" id="editSchoolPhone" class="form-control" value="${school.phone || ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <textarea id="editSchoolAddress" class="form-control" rows="2">${school.address || ''}</textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select id="editSchoolType" class="form-control">
                                        <option value="primary" ${school.type === 'primary' ? 'selected' : ''}>Primary</option>
                                        <option value="secondary" ${school.type === 'secondary' ? 'selected' : ''}>Secondary</option>
                                        <option value="both" ${(school.type === 'both' || school.type === 'mixed') ? 'selected' : ''}>Both</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <select id="editSchoolStatus" class="form-control">
                                        <option value="active" ${school.status === 'active' ? 'selected' : ''}>Active</option>
                                        <option value="inactive" ${school.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subscription Expires</label>
                                <input type="date" id="editSchoolExpires" class="form-control" value="${school.expiresAt ? school.expiresAt.split('T')[0] : ''}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('editSchoolModal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="SuperAdmin.saveSchoolEdit('${school.id}')"><i class="fas fa-save"></i> Save Changes</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            },
            
            saveSchoolEdit(schoolId) {
                const name = document.getElementById('editSchoolName').value.trim();
                const email = document.getElementById('editSchoolEmail').value.trim();
                const phone = document.getElementById('editSchoolPhone').value.trim();
                const address = document.getElementById('editSchoolAddress').value.trim();
                const type = document.getElementById('editSchoolType').value;
                const status = document.getElementById('editSchoolStatus').value;
                const expiresAt = document.getElementById('editSchoolExpires').value;
                
                if (!name) {
                    Toast.error('School name is required');
                    return;
                }
                
                const updates = {
                    name,
                    email,
                    phone,
                    address,
                    type,
                    status,
                    updatedAt: new Date().toISOString()
                };
                
                if (expiresAt) {
                    updates.expiresAt = new Date(expiresAt).toISOString();
                }
                
                Storage.updateItem('schools', schoolId, updates);
                Toast.success('School updated successfully');
                document.getElementById('editSchoolModal').remove();
                this.showSchoolsList();
                
                if (window.syncToFirebase) {
                    window.syncToFirebase();
                }
            },
            
            toggleSchoolStatus(schoolId) {
                const school = Storage.getSchoolById(schoolId);
                if (!school) return;
                
                const newStatus = school.status === 'active' ? 'inactive' : 'active';
                const action = newStatus === 'active' ? 'activate' : 'deactivate';
                
                if (!confirm(`Are you sure you want to ${action} this school?`)) return;
                
                const schools = Storage.getSchools();
                const index = schools.findIndex(s => s.id === schoolId);
                if (index !== -1) {
                    schools[index] = {
                        ...schools[index],
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    };
                    Storage.setData('schools', schools);
                    Toast.success(`School ${newStatus === 'active' ? 'activated' : 'deactivated'} successfully`);
                    this.showSchoolsList();
                    
                    if (window.syncToFirebase) {
                        window.syncToFirebase();
                    }
                }
            },
            
            editCodeExpiration(codeId) {
                const codes = Storage.getData('activationCodes');
                const code = codes.find(c => c.id === codeId);
                if (!code) return;
                
                const newDate = prompt('Enter new expiration date (YYYY-MM-DD):', code.expiresAt.split('T')[0]);
                if (!newDate) return;
                
                Storage.updateCodeExpiration(codeId, new Date(newDate).toISOString());
                Toast.success('Code expiration updated');
                this.showCodesList();
            },
            
            showDataSection() {
                this.loadDataStats();
            },
            
            loadDataStats() {
                const schools = Storage.getSchools();
                const users = Storage.getData('users') || [];
                const students = Storage.getData('students') || [];
                const scores = Storage.getData('scores') || [];
                const attendance = Storage.getData('attendance') || [];
                const finance = Storage.getData('finance') || [];
                const messages = Storage.getData('messages') || [];
                const codes = Storage.getData('activationCodes') || [];
                
                document.getElementById('statTotalSchools').textContent = schools.length;
                document.getElementById('statTotalUsers').textContent = users.length;
                document.getElementById('statTotalStudents').textContent = students.length;
                document.getElementById('statTotalScores').textContent = scores.length;
                document.getElementById('statTotalAttendance').textContent = attendance.length;
                document.getElementById('statTotalFinance').textContent = finance.length;
                
                document.getElementById('scoresCount').textContent = scores.length + ' scores';
                document.getElementById('attendanceCount').textContent = attendance.length + ' records';
                document.getElementById('financeCount').textContent = finance.length + ' records';
                document.getElementById('messagesCount').textContent = messages.length + ' messages';
                document.getElementById('schoolsDeleteCount').textContent = schools.length + ' schools';
                document.getElementById('codesCount').textContent = codes.length + ' codes';
            },
            
            exportData() {
                const dataType = document.getElementById('exportDataType').value;
                let exportData = {};
                
                if (dataType === 'all') {
                    const keys = ['schools', 'users', 'students', 'scores', 'attendance', 'finance', 'messages', 'activities', 'notifications', 'activationCodes'];
                    keys.forEach(key => {
                        exportData[key] = Storage.getData(key) || [];
                    });
                    exportData.exportDate = new Date().toISOString();
                    exportData.version = '1.0';
                } else {
                    exportData[dataType] = Storage.getData(dataType) || [];
                }
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${dataType}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                Toast.success('Data exported successfully');
            },
            
            importData() {
                const fileInput = document.getElementById('importFile');
                const file = fileInput.files[0];
                const replaceMode = document.getElementById('importMode').checked;
                
                if (!file) {
                    Toast.error('Please select a file to import');
                    return;
                }
                
                Modal.confirm({
                    title: 'Import Data',
                    message: replaceMode 
                        ? 'This will REPLACE all existing data with the imported data. This cannot be undone. Continue?'
                        : 'This will MERGE imported data with existing data. Continue?',
                    onConfirm: () => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                
                                if (replaceMode) {
                                    Object.keys(importedData).forEach(key => {
                                        if (key !== 'exportDate' && key !== 'version') {
                                            Storage.setData(key, importedData[key] || []);
                                        }
                                    });
                                } else {
                                    Object.keys(importedData).forEach(key => {
                                        if (key !== 'exportDate' && key !== 'version') {
                                            const existing = Storage.getData(key) || [];
                                            const newData = importedData[key] || [];
                                            const merged = [...existing, ...newData];
                                            Storage.setData(key, merged);
                                        }
                                    });
                                }
                                
                                Toast.success('Data imported successfully');
                                this.loadDataStats();
                                fileInput.value = '';
                            } catch (err) {
                                Toast.error('Error importing data: Invalid file format');
                                console.error(err);
                            }
                        };
                        reader.readAsText(file);
                    }
                });
            },
            
            verifyPasswordAndConfirm(callback) {
                const modalHtml = `
                    <div id="passwordVerifyModal" class="modal-overlay">
                        <div class="modal" style="max-width: 400px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Verify Password</h3>
                                <button class="modal-close" onclick="Modal.hide('passwordVerifyModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Please enter your password to confirm this action:</p>
                                <div class="form-group">
                                    <label>Password</label>
                                    <input type="password" id="confirmPassword" class="form-control" placeholder="Enter your password">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="Modal.hide('passwordVerifyModal')">Cancel</button>
                                <button class="btn btn-primary" onclick="SuperAdmin.checkPasswordAndProceed()">Confirm</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existing = document.getElementById('passwordVerifyModal');
                if (existing) existing.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                window._pendingConfirmCallback = callback;
                Modal.show('passwordVerifyModal');
                document.getElementById('confirmPassword').focus();
            },
            
            checkPasswordAndProceed() {
                const password = document.getElementById('confirmPassword').value;
                const currentUser = Auth.getCurrentUser();
                
                const hashedInput = Storage.hashPassword(password);
                
                if (hashedInput !== currentUser.password) {
                    Toast.error('Incorrect password');
                    return;
                }
                
                Modal.hide('passwordVerifyModal');
                
                if (window._pendingConfirmCallback) {
                    window._pendingConfirmCallback();
                    window._pendingConfirmCallback = null;
                }
            },
            
            deleteDataType(dataType) {
                const counts = {
                    scores: (Storage.getData('scores') || []).length,
                    attendance: (Storage.getData('attendance') || []).length,
                    finance: (Storage.getData('finance') || []).length,
                    messages: (Storage.getData('messages') || []).length
                };
                
                Modal.confirm({
                    title: 'Delete ' + dataType.charAt(0).toUpperCase() + dataType.slice(1),
                    message: `Are you sure you want to delete all ${counts[dataType]} ${dataType} records? This cannot be undone.`,
                    onConfirm: () => {
                        Storage.setData(dataType, []);
                        Toast.success(`All ${dataType} deleted`);
                        this.loadDataStats();
                    }
                });
            },
            
            deleteAllSchools() {
                const schools = Storage.getSchools();
                if (schools.length === 0) {
                    Toast.error('No schools to delete');
                    return;
                }
                
                this.verifyPasswordAndConfirm(() => {
                    Modal.confirm({
                        title: 'Delete All Schools',
                        message: `<strong>WARNING:</strong> This will permanently delete ALL ${schools.length} schools and ALL their data including:
                        <ul style="margin: 10px 0;">
                            <li>All students, teachers, staff</li>
                            <li>All scores, attendance, finance records</li>
                            <li>All messages and activities</li>
                        </ul>
                        This action CANNOT be undone!`,
                        onConfirm: () => {
                            const dataKeys = ['users', 'students', 'scores', 'attendance', 'finance', 'messages', 'activities', 'notifications'];
                            dataKeys.forEach(key => Storage.setData(key, []));
                            Storage.setData('schools', []);
                            Storage.setData('activationCodes', []);
                            Toast.success('All schools and data deleted');
                            this.loadDataStats();
                            this.loadStats();
                        }
                    });
                });
            },
            
            resetSystemPrompt() {
                this.verifyPasswordAndConfirm(() => {
                    const schools = Storage.getSchools();
                    const users = Storage.getData('users') || [];
                    
                    Modal.confirm({
                        title: 'Full System Reset',
                        message: `<strong>WARNING: FULL SYSTEM RESET</strong><br><br>
                        This will permanently delete EVERYTHING except your Super Admin account:<br><br>
                        <ul style="margin: 10px 0;">
                            <li>${schools.length} schools</li>
                            <li>${users.length} users</li>
                            <li>All students, scores, attendance, finance</li>
                            <li>All messages and activities</li>
                            <li>All activation codes</li>
                            <li>All announcements</li>
                        </ul>
                        After reset, only your Super Admin login will work.<br><br>
                        <strong>This action CANNOT be undone!</strong>`,
                        onConfirm: () => {
                            Storage.setData('schools', []);
                            Storage.setData('users', []);
                            Storage.setData('students', []);
                            Storage.setData('scores', []);
                            Storage.setData('attendance', []);
                            Storage.setData('finance', []);
                            Storage.setData('messages', []);
                            Storage.setData('activities', []);
                            Storage.setData('notifications', []);
                            Storage.setData('activationCodes', []);
                            Storage.setAnnouncement(null);
                            localStorage.removeItem('globalThemeSettings');
                            
                            Toast.success('System reset complete. Only Super Admin account remains.');
                            this.loadDataStats();
                            this.loadStats();
                        }
                    });
                });
            },
            
            checkFirebaseStatus() {
                const statusEl = document.getElementById('firebaseStatus');
                if (!statusEl) return;
                
                const isReady = typeof window.syncToFirebase === 'function' && Storage.useCloudSync;
                
                if (isReady) {
                    statusEl.innerHTML = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Connected</span>';
                } else {
                    statusEl.innerHTML = '<span class="badge badge-secondary"><i class="fas fa-times-circle"></i> Not Connected</span>';
                }
            },
            
            async syncToCloud() {
                const success = await window.syncToFirebase();
                if (success) {
                    Toast.success('Data pushed to cloud successfully');
                } else {
                    Toast.error('Failed to sync to cloud');
                }
            },
            
            async syncFromCloud() {
                if (!confirm('This will replace your local data with cloud data. Continue?')) return;
                
                const success = await window.syncFromFirebase();
                if (success) {
                    Toast.success('Data loaded from cloud successfully');
                    this.loadStats();
                    this.showSchoolsList();
                } else {
                    Toast.error('Failed to load from cloud');
                }
            },
            
            exportData() {
                const data = Storage.exportAllData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                Toast.success('Data exported successfully');
            },
            
            deleteSchoolPrompt() {
                const schools = Storage.getSchools();
                if (!schools.length) {
                    Toast.error('No schools to delete');
                    return;
                }
                
                let html = `
                    <div id="selectSchoolModal" class="modal-overlay">
                        <div class="modal" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Select School to Delete</h3>
                                <button class="modal-close" onclick="Modal.hide('selectSchoolModal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-3">Select a school to delete:</p>
                                <div class="form-group">
                                    <select id="schoolToDelete" class="form-control">
                                        ${schools.map(s => `<option value="${s.id}">${s.name} (${s.type})</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="Modal.hide('selectSchoolModal')">Cancel</button>
                                <button class="btn btn-danger" onclick="SuperAdmin.confirmDeleteSchool()">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                
                const existing = document.getElementById('selectSchoolModal');
                if (existing) existing.remove();
                document.body.insertAdjacentHTML('beforeend', html);
                Modal.show('selectSchoolModal');
            },
            
            confirmDeleteSchool() {
                const schoolId = document.getElementById('schoolToDelete').value;
                const school = Storage.getSchoolById(schoolId);
                
                if (!school) {
                    Toast.error('School not found');
                    return;
                }
                
                const stats = this.getSchoolStats(schoolId);
                
                Modal.confirm({
                    title: 'Delete School',
                    message: `<strong>WARNING:</strong> This will permanently delete "${school.name}" and all its data:<br><br>
                    <ul style="margin: 10px 0;">
                        <li>${stats.totalStudents} students</li>
                        <li>${stats.totalTeachers} teachers</li>
                        <li>${stats.totalStaff} staff</li>
                        <li>All scores, attendance, finance records</li>
                    </ul>
                    This action cannot be undone!`,
                    onConfirm: () => {
                        this.deleteSchool(schoolId);
                        Modal.hide('selectSchoolModal');
                        Toast.success('School deleted successfully');
                        this.loadStats();
                        this.loadDataStats();
                    }
                });
            },
            
            loadHelpEditor() {
                const role = document.getElementById('helpRoleSelect').value;
                const content = Storage.getHelpContent(role);
                
                this.currentHelpRole = role;
                this.currentHelpContent = content;
                
                this.renderHelpSectionsList(content);
                this.renderHelpPreview(content);
                document.getElementById('helpEditorArea').innerHTML = '<p class="text-muted">Select a section from the left to edit</p>';
            },
            
            renderHelpSectionsList(content) {
                const container = document.getElementById('helpSectionsList');
                
                if (!content || !content.sections || !content.sections.length) {
                    container.innerHTML = '<div class="empty-state"><p>No sections yet</p></div>';
                    return;
                }
                
                let html = '<div class="list-group">';
                content.sections.forEach((section, index) => {
                    html += `
                        <div class="list-group-item" style="cursor: pointer;" onclick="SuperAdmin.editHelpSection(${index})">
                            <div class="flex-align-center" style="gap: 12px;">
                                <i class="fas ${section.icon || 'fa-book'}" style="color: var(--primary);"></i>
                                <div>
                                    <div style="font-weight: 600;">${section.title}</div>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); SuperAdmin.deleteHelpSectionPrompt(${index})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            },
            
            editHelpSection(index) {
                const role = this.currentHelpRole;
                const content = Storage.getHelpContent(role);
                const section = content.sections[index];
                
                if (!section) return;
                
                this.currentEditSectionIndex = index;
                
                const editorArea = document.getElementById('helpEditorArea');
                editorArea.innerHTML = `
                    <form id="helpSectionForm">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" id="helpSectionTitle" class="form-control" value="${section.title}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Icon (Font Awesome class)</label>
                            <input type="text" id="helpSectionIcon" class="form-control" value="${section.icon || 'fa-book'}" placeholder="fa-book">
                            <small class="text-muted">Examples: fa-book, fa-users, fa-cog, fa-chart-line</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content (HTML supported)</label>
                            <textarea id="helpSectionContent" class="form-control" rows="10" style="font-family: monospace;">${this.escapeHtml(section.content)}</textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.saveHelpSection()">Save Changes</button>
                            <button type="button" class="btn btn-outline" onclick="SuperAdmin.previewHelpSection()">Preview</button>
                        </div>
                    </form>
                `;
            },
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            },
            
            saveHelpSection() {
                const role = this.currentHelpRole;
                const index = this.currentEditSectionIndex;
                
                const title = document.getElementById('helpSectionTitle').value.trim();
                const icon = document.getElementById('helpSectionIcon').value.trim() || 'fa-book';
                const content = document.getElementById('helpSectionContent').value;
                
                if (!title) {
                    Toast.error('Please enter a section title');
                    return;
                }
                
                const sectionData = { title, icon, content };
                
                if (index !== undefined && index !== null) {
                    Storage.updateHelpSection(role, index, sectionData);
                    Toast.success('Section updated successfully');
                } else {
                    Storage.addHelpSection(role, sectionData);
                    Toast.success('Section added successfully');
                }
                
                this.loadHelpEditor();
            },
            
            addHelpSection() {
                const role = document.getElementById('helpRoleSelect').value;
                this.currentHelpRole = role;
                this.currentEditSectionIndex = null;
                
                const editorArea = document.getElementById('helpEditorArea');
                editorArea.innerHTML = `
                    <form id="helpSectionForm">
                        <div class="form-group">
                            <label class="form-label">Section Title</label>
                            <input type="text" id="helpSectionTitle" class="form-control" placeholder="Enter section title">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Icon (Font Awesome class)</label>
                            <input type="text" id="helpSectionIcon" class="form-control" value="fa-book" placeholder="fa-book">
                            <small class="text-muted">Examples: fa-book, fa-users, fa-cog, fa-chart-line</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Content (HTML supported)</label>
                            <textarea id="helpSectionContent" class="form-control" rows="10" style="font-family: monospace;" placeholder="Enter help content. HTML tags are supported."></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" class="btn btn-primary" onclick="SuperAdmin.saveNewHelpSection()">Add Section</button>
                        </div>
                    </form>
                `;
            },
            
            saveNewHelpSection() {
                const role = this.currentHelpRole;
                
                const title = document.getElementById('helpSectionTitle').value.trim();
                const icon = document.getElementById('helpSectionIcon').value.trim() || 'fa-book';
                const content = document.getElementById('helpSectionContent').value;
                
                if (!title) {
                    Toast.error('Please enter a section title');
                    return;
                }
                
                const sectionData = { title, icon, content };
                
                Storage.addHelpSection(role, sectionData);
                Toast.success('Section added successfully');
                
                this.loadHelpEditor();
            },
            
            deleteHelpSectionPrompt(index) {
                Modal.confirm({
                    title: 'Delete Section',
                    message: 'Are you sure you want to delete this help section?',
                    onConfirm: () => {
                        const role = this.currentHelpRole;
                        Storage.deleteHelpSection(role, index);
                        Toast.success('Section deleted');
                        this.loadHelpEditor();
                    }
                });
            },
            
            renderHelpPreview(content) {
                const container = document.getElementById('helpPreviewArea');
                
                if (!content || !content.sections || !content.sections.length) {
                    container.innerHTML = '<div class="empty-state"><p>No content to preview</p></div>';
                    return;
                }
                
                let html = `
                    <div class="help-guide-container">
                        <div class="help-guide-header">
                            <h2>${content.title}</h2>
                        </div>
                        <div class="help-guide-accordion">
                `;
                
                content.sections.forEach((section, index) => {
                    html += `
                        <div class="help-accordion-item">
                            <div class="help-accordion-header" onclick="this.parentElement.classList.toggle('active')">
                                <div class="help-accordion-title">
                                    <i class="fas ${section.icon || 'fa-book'}"></i>
                                    <span>${section.title}</span>
                                </div>
                                <i class="fas fa-chevron-down help-accordion-arrow"></i>
                            </div>
                            <div class="help-accordion-body">
                                <div class="help-content">${section.content}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                container.innerHTML = html;
            },
            
            previewHelpSection() {
                const title = document.getElementById('helpSectionTitle').value.trim();
                const icon = document.getElementById('helpSectionIcon').value.trim() || 'fa-book';
                const content = document.getElementById('helpSectionContent').value;
                
                Modal.alert({
                    title: title,
                    message: `
                        <div class="help-preview-modal">
                            <div class="help-section-preview">
                                <div class="help-content">${content}</div>
                            </div>
                        </div>
                    `
                });
            },
            
            showProfile() {
                this.showSection('profile');
            },
            
            viewSchool(id) {
                const school = Storage.getSchoolById(id);
                const users = Storage.getUsers(id);
                const students = Storage.getStudents(id);
                
                Modal.alert({
                    title: school.name,
                    message: `
                        <p><strong>Type:</strong> ${school.type}</p>
                        <p><strong>Email:</strong> ${school.email || '-'}</p>
                        <p><strong>Phone:</strong> ${school.phone || '-'}</p>
                        <p><strong>Address:</strong> ${school.address || '-'}</p>
                        <p><strong>Users:</strong> ${users.length}</p>
                        <p><strong>Students:</strong> ${students.length}</p>
                    `
                });
            },
            
            populateSchoolDropdown() {
                const select = document.getElementById('restrictionSchoolSelect');
                if (!select) return;
                
                const schools = Storage.getSchools();
                select.innerHTML = '<option value="">-- Select School --</option>';
                schools.forEach(school => {
                    const hasRestrictions = school.restrictions && 
                        (school.restrictions.disabled_features?.length > 0 || 
                         school.restrictions.max_students || 
                         school.restrictions.max_staff);
                    const badge = hasRestrictions ? ' <span class="badge badge-warning">Restricted</span>' : '';
                    select.innerHTML += `<option value="${school.id}">${school.name}${badge}</option>`;
                });
            },
            
            loadSchoolRestrictions() {
                const schoolId = document.getElementById('restrictionSchoolSelect').value;
                const form = document.getElementById('restrictionsForm');
                const noSelection = document.getElementById('noSchoolSelected');
                
                if (!schoolId) {
                    form.style.display = 'none';
                    noSelection.style.display = 'block';
                    return;
                }
                
                form.style.display = 'block';
                noSelection.style.display = 'none';
                
                const school = Storage.getSchoolById(schoolId);
                const restrictions = school?.restrictions || { disabled_features: [] };
                
                // Build features list
                const featuresList = document.getElementById('featuresList');
                const features = Auth.RESTRICTABLE_FEATURES;
                let featuresHtml = '<div class="row">';
                
                Object.keys(features).forEach((key, index) => {
                    const isDisabled = restrictions.disabled_features?.includes(key);
                    featuresHtml += `
                        <div class="col-md-6 mb-2">
                            <label class="feature-toggle" style="display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                                <input type="checkbox" data-feature="${key}" ${!isDisabled ? 'checked' : ''} style="width: 18px; height: 18px;">
                                <span style="font-weight: 500;">${features[key]}</span>
                            </label>
                        </div>
                    `;
                });
                featuresHtml += '</div>';
                featuresList.innerHTML = featuresHtml;
                
                // Set limits
                document.getElementById('maxStudents').value = restrictions.max_students || '';
                document.getElementById('maxStaff').value = restrictions.max_staff || '';
                document.getElementById('restrictionNote').value = restrictions.restriction_note || '';
            },
            
            saveRestrictions() {
                const schoolId = document.getElementById('restrictionSchoolSelect').value;
                if (!schoolId) {
                    Toast.error('Please select a school');
                    return;
                }
                
                // Get disabled features
                const checkboxes = document.querySelectorAll('#featuresList input[data-feature]');
                const disabledFeatures = [];
                checkboxes.forEach(cb => {
                    if (!cb.checked) {
                        disabledFeatures.push(cb.dataset.feature);
                    }
                });
                
                const restrictions = {
                    disabled_features: disabledFeatures,
                    max_students: document.getElementById('maxStudents').value ? parseInt(document.getElementById('maxStudents').value) : null,
                    max_staff: document.getElementById('maxStaff').value ? parseInt(document.getElementById('maxStaff').value) : null,
                    restriction_note: document.getElementById('restrictionNote').value.trim()
                };
                
                const result = Auth.updateSchoolRestrictions(schoolId, restrictions);
                if (result.success) {
                    Toast.success('Restrictions saved successfully');
                    this.populateSchoolDropdown();
                    this.loadSchoolRestrictions();
                } else {
                    Toast.error(result.message);
                }
            },
            
            clearRestrictions() {
                const schoolId = document.getElementById('restrictionSchoolSelect').value;
                if (!schoolId) {
                    Toast.error('Please select a school');
                    return;
                }
                
                if (!confirm('Are you sure you want to clear all restrictions for this school?')) {
                    return;
                }
                
                const restrictions = {
                    disabled_features: [],
                    max_students: null,
                    max_staff: null,
                    restriction_note: ''
                };
                
                const result = Auth.updateSchoolRestrictions(schoolId, restrictions);
                if (result.success) {
                    Toast.success('Restrictions cleared successfully');
                    this.populateSchoolDropdown();
                    this.loadSchoolRestrictions();
                } else {
                    Toast.error(result.message);
                }
            },
            
            // ==================== BLOG MANAGEMENT ====================
            loadBlogManager() {
                const status = document.getElementById('blogFilterStatus')?.value || '';
                let posts = status ? PublicContent.getBlogPosts(status) : PublicContent.getBlogPosts();
                
                const container = document.getElementById('blogPostsList');
                if (!container) return;
                
                if (posts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-blog"></i><h3>No Posts Yet</h3><p>Create your first blog post</p></div>';
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Title</th><th>Category</th><th>Status</th><th>Views</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                posts.forEach(post => {
                    const statusBadge = post.status === 'published' ? 
                        '<span class="badge badge-success">Published</span>' : 
                        '<span class="badge badge-warning">Draft</span>';
                    
                    html += `<tr>
                        <td>${post.title}</td>
                        <td>${post.category}</td>
                        <td>${statusBadge}</td>
                        <td>${post.views || 0}</td>
                        <td>${PublicContent.formatDate(post.createdAt)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="SuperAdmin.editBlogPost('${post.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteBlogPost('${post.id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            
            filterBlogPosts() {
                this.loadBlogManager();
            },
            
            showBlogEditor(postId = null) {
                document.getElementById('blogEditorModal').style.display = 'block';
                document.getElementById('blogEditorTitle').textContent = postId ? 'Edit Post' : 'Create New Post';
                
                if (postId) {
                    const post = PublicContent.getBlogPost(postId);
                    if (post) {
                        document.getElementById('blogPostId').value = post.id;
                        document.getElementById('blogTitle').value = post.title;
                        document.getElementById('blogCategory').value = post.category;
                        document.getElementById('blogStatus').value = post.status;
                        document.getElementById('blogFeaturedImage').value = post.featuredImage || '';
                        document.getElementById('blogContent').value = post.content;
                        document.getElementById('blogVideoUrl').value = post.videoUrl || '';
                        document.getElementById('blogAudioUrl').value = post.audioUrl || '';
                        document.getElementById('blogCommentsEnabled').checked = post.commentsEnabled !== false;
                        document.getElementById('blogFeatured').checked = post.featured || false;
                    }
                } else {
                    document.getElementById('blogPostId').value = '';
                    document.getElementById('blogTitle').value = '';
                    document.getElementById('blogCategory').value = '';
                    document.getElementById('blogStatus').value = 'draft';
                    document.getElementById('blogFeaturedImage').value = '';
                    document.getElementById('blogContent').value = '';
                    document.getElementById('blogVideoUrl').value = '';
                    document.getElementById('blogAudioUrl').value = '';
                    document.getElementById('blogCommentsEnabled').checked = true;
                    document.getElementById('blogFeatured').checked = false;
                }
            },
            
            closeBlogEditor() {
                document.getElementById('blogEditorModal').style.display = 'none';
            },
            
            saveBlogPost() {
                const postId = document.getElementById('blogPostId').value;
                const postData = {
                    title: document.getElementById('blogTitle').value.trim(),
                    category: document.getElementById('blogCategory').value.trim(),
                    status: document.getElementById('blogStatus').value,
                    featuredImage: document.getElementById('blogFeaturedImage').value.trim(),
                    content: document.getElementById('blogContent').value,
                    videoUrl: document.getElementById('blogVideoUrl').value.trim(),
                    audioUrl: document.getElementById('blogAudioUrl').value.trim(),
                    commentsEnabled: document.getElementById('blogCommentsEnabled').checked,
                    featured: document.getElementById('blogFeatured').checked
                };
                
                if (!postData.title) {
                    Toast.error('Please enter a title');
                    return;
                }
                
                if (postId) {
                    PublicContent.updateBlogPost(postId, postData);
                    Toast.success('Post updated successfully');
                } else {
                    PublicContent.createBlogPost(postData);
                    Toast.success('Post created successfully');
                }
                
                this.closeBlogEditor();
                this.loadBlogManager();
            },
            
            editBlogPost(id) {
                this.showBlogEditor(id);
            },
            
            deleteBlogPost(id) {
                if (!confirm('Are you sure you want to delete this post?')) return;
                PublicContent.deleteBlogPost(id);
                Toast.success('Post deleted');
                this.loadBlogManager();
            },
            
            // ==================== RESOURCES MANAGEMENT ====================
            loadResourcesManager() {
                const category = document.getElementById('resourceFilterCategory')?.value || '';
                let resources = category ? PublicContent.getResources(category) : PublicContent.getResources();
                
                const container = document.getElementById('resourcesList');
                if (!container) return;
                
                if (resources.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><h3>No Resources Yet</h3><p>Add your first resource</p></div>';
                    return;
                }
                
                let html = '<div class="row">';
                resources.forEach(res => {
                    const iconMap = { 'Documents': 'fa-file-pdf', 'Videos': 'fa-video', 'Audio': 'fa-music', 'Images': 'fa-image', 'Archives': 'fa-file-archive' };
                    const icon = iconMap[res.category] || 'fa-file';
                    
                    html += `<div class="col-md-4 mb-3">
                        <div class="card" style="height:100%;">
                            <div class="card-body">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas ${icon}" style="font-size:24px;color:var(--primary);"></i>
                                    <span class="badge badge-info">${res.category}</span>
                                </div>
                                <h4 class="card-title">${res.title}</h4>
                                <p class="text-muted">${res.description || 'No description'}</p>
                                <p class="text-muted"><small>Downloads: ${res.downloads || 0}</small></p>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-primary" onclick="SuperAdmin.editResource('${res.id}')"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-danger" onclick="SuperAdmin.deleteResource('${res.id}')"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });
                html += '</div>';
                container.innerHTML = html;
            },
            
            filterResources() {
                this.loadResourcesManager();
            },
            
            showResourceEditor(resourceId = null) {
                document.getElementById('resourceEditorModal').style.display = 'block';
                document.getElementById('resourceEditorTitle').textContent = resourceId ? 'Edit Resource' : 'Add New Resource';
                
                if (resourceId) {
                    const res = PublicContent.getResource(resourceId);
                    if (res) {
                        document.getElementById('resourceId').value = res.id;
                        document.getElementById('resourceTitle').value = res.title;
                        document.getElementById('resourceDescription').value = res.description || '';
                        document.getElementById('resourceCategory').value = res.category;
                        document.getElementById('resourceFileUrl').value = res.fileUrl || '';
                    }
                } else {
                    document.getElementById('resourceId').value = '';
                    document.getElementById('resourceTitle').value = '';
                    document.getElementById('resourceDescription').value = '';
                    document.getElementById('resourceCategory').value = 'Documents';
                    document.getElementById('resourceFileUrl').value = '';
                }
            },
            
            closeResourceEditor() {
                document.getElementById('resourceEditorModal').style.display = 'none';
            },
            
            saveResource() {
                const resourceId = document.getElementById('resourceId').value;
                const resourceData = {
                    title: document.getElementById('resourceTitle').value.trim(),
                    description: document.getElementById('resourceDescription').value.trim(),
                    category: document.getElementById('resourceCategory').value,
                    fileUrl: document.getElementById('resourceFileUrl').value.trim()
                };
                
                if (!resourceData.title || !resourceData.fileUrl) {
                    Toast.error('Please enter title and file URL');
                    return;
                }
                
                if (resourceId) {
                    PublicContent.updateResource(resourceId, resourceData);
                    Toast.success('Resource updated');
                } else {
                    PublicContent.addResource(resourceData);
                    Toast.success('Resource added');
                }
                
                this.closeResourceEditor();
                this.loadResourcesManager();
            },
            
            editResource(id) {
                this.showResourceEditor(id);
            },
            
            deleteResource(id) {
                if (!confirm('Are you sure you want to delete this resource?')) return;
                PublicContent.deleteResource(id);
                Toast.success('Resource deleted');
                this.loadResourcesManager();
            },
            
            // ==================== PRICING MANAGEMENT ====================
            loadPricingManager() {
                const pricing = PublicContent.getPricing();
                
                document.getElementById('basicPrice').value = pricing.basic.price;
                document.getElementById('basicPeriod').value = pricing.basic.period;
                document.getElementById('basicDescription').value = pricing.basic.description;
                document.getElementById('basicCta').value = pricing.basic.cta;
                document.getElementById('basicFeatures').value = pricing.basic.features.join('\n');
                
                document.getElementById('proPrice').value = pricing.pro.price;
                document.getElementById('proPeriod').value = pricing.pro.period;
                document.getElementById('proDescription').value = pricing.pro.description;
                document.getElementById('proCta').value = pricing.pro.cta;
                document.getElementById('proFeatures').value = pricing.pro.features.join('\n');
                
                document.getElementById('premiumPrice').value = pricing.premium.price;
                document.getElementById('premiumPeriod').value = pricing.premium.period;
                document.getElementById('premiumDescription').value = pricing.premium.description;
                document.getElementById('premiumCta').value = pricing.premium.cta;
                document.getElementById('premiumFeatures').value = pricing.premium.features.join('\n');
            },
            
            savePricing() {
                const pricing = {
                    basic: {
                        name: 'Basic',
                        price: document.getElementById('basicPrice').value,
                        period: document.getElementById('basicPeriod').value,
                        description: document.getElementById('basicDescription').value,
                        cta: document.getElementById('basicCta').value,
                        features: document.getElementById('basicFeatures').value.split('\n').filter(f => f.trim()),
                        highlighted: false
                    },
                    pro: {
                        name: 'Pro',
                        price: document.getElementById('proPrice').value,
                        period: document.getElementById('proPeriod').value,
                        description: document.getElementById('proDescription').value,
                        cta: document.getElementById('proCta').value,
                        features: document.getElementById('proFeatures').value.split('\n').filter(f => f.trim()),
                        highlighted: true
                    },
                    premium: {
                        name: 'Premium',
                        price: document.getElementById('premiumPrice').value,
                        period: document.getElementById('premiumPeriod').value,
                        description: document.getElementById('premiumDescription').value,
                        cta: document.getElementById('premiumCta').value,
                        features: document.getElementById('premiumFeatures').value.split('\n').filter(f => f.trim()),
                        highlighted: false
                    }
                };
                
                PublicContent.updatePricing(pricing);
                Toast.success('Pricing saved successfully');
            },
            
            // ==================== PAGES MANAGEMENT ====================
            loadPagesManager() {
                const privacy = PublicContent.getPage('privacy');
                const terms = PublicContent.getPage('terms');
                
                document.getElementById('privacyContent').value = privacy || PublicContent.getDefaultPrivacy();
                document.getElementById('termsContent').value = terms || PublicContent.getDefaultTerms();
            },
            
            savePages() {
                const privacy = document.getElementById('privacyContent').value;
                const terms = document.getElementById('termsContent').value;
                
                PublicContent.updatePage('privacy', privacy);
                PublicContent.updatePage('terms', terms);
                
                Toast.success('Pages saved successfully');
            }
        };

        function toggleSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
        }
        
        // Close sidebar when clicking on nav items (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });
        
        // Close sidebar when clicking outside (mobile overlay)
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 992 && 
                sidebar && sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });

        window.NotificationPanel = {
            init() { this.loadNotifications(); },
            loadNotifications() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
                const unreadNotifications = notifications.filter(n => n.userId === user.id && !n.read);
                const dot = document.getElementById('notificationDot');
                if (dot) dot.style.display = unreadNotifications.length > 0 ? 'block' : 'none';
                const list = document.getElementById('notificationList');
                if (!list) return;
                if (userNotifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
                    return;
                }
                let html = '';
                userNotifications.forEach(notif => {
                    const time = this.getTimeAgo(notif.createdAt);
                    const iconClass = this.getIconClass(notif.type);
                    html += `<div class="notification-dropdown-item ${notif.read ? '' : 'unread'}" onclick="NotificationPanel.handleNotificationClick('${notif.id}')">
                        <div class="notification-dropdown-icon ${notif.type || 'info'}"><i class="fas ${iconClass}"></i></div>
                        <div class="notification-dropdown-content"><p>${notif.message}</p><div class="notification-dropdown-time">${time}</div></div></div>`;
                });
                list.innerHTML = html;
            },
            getIconClass(type) {
                const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', error: 'fa-times-circle', message: 'fa-envelope', student: 'fa-user-graduate', score: 'fa-clipboard-list', attendance: 'fa-clipboard-check', finance: 'fa-wallet', school: 'fa-school', code: 'fa-key' };
                return icons[type] || 'fa-bell';
            },
            getTimeAgo(dateStr) {
                const date = new Date(dateStr), now = new Date(), diff = now - date;
                const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            },
            toggle() {
                const dropdown = document.getElementById('notificationDropdown');
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) this.loadNotifications();
            },
            handleNotificationClick(notifId) {
                const notifications = Storage.getData('notifications') || [];
                const index = notifications.findIndex(n => n.id === notifId);
                if (index !== -1) { notifications[index].read = true; Storage.setData('notifications', notifications); this.loadNotifications(); }
                document.getElementById('notificationDropdown').classList.remove('show');
            },
            markAllRead() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                notifications.forEach(n => { if (n.userId === user.id) n.read = true; });
                Storage.setData('notifications', notifications);
                this.loadNotifications();
            }
        };

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const btn = document.querySelector('.notification-container');
            if (dropdown && btn && !btn.contains(e.target)) dropdown.classList.remove('show');
        });

        window.Profile = {
            init() { this.loadProfile(); },
            loadProfile() {
                const user = Auth.getCurrentUser();
                if (!user) return;
                document.getElementById('profileName').textContent = user.name;
                document.getElementById('profileRole').textContent = 'Super Admin';
                document.getElementById('profileNameInput').value = user.name || '';
                document.getElementById('profileEmailInput').value = user.email || '';
                document.getElementById('profilePhoneInput').value = user.phone || '';
                document.getElementById('profileAddressInput').value = user.address || '';
                document.getElementById('profileAvatarInitials').textContent = Utils.getInitials(user.name);
                if (user.avatar) {
                    const img = document.getElementById('profileAvatarImg');
                    img.src = user.avatar;
                    img.style.display = 'block';
                    document.getElementById('profileAvatarInitials').style.display = 'none';
                }
                document.getElementById('profileMemberSince').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
                const activityData = this.getActivityData();
                document.getElementById('activityScore').textContent = activityData.score;
                document.getElementById('totalLogins').textContent = activityData.logins;
                this.loadRecentActivity();
                this.loadNotifications();
            },
            getActivityData() {
                const user = Auth.getCurrentUser();
                const activities = Storage.getData('activities') || [];
                const userActivities = activities.filter(a => a.userId === user.id);
                return { score: Math.min(100, userActivities.length * 5 + 10), logins: userActivities.filter(a => a.type === 'login').length || 1 };
            },
            loadRecentActivity() {
                const user = Auth.getCurrentUser();
                const activities = Storage.getData('activities') || [];
                const userActivities = activities.filter(a => a.userId === user.id).slice(0, 10);
                const container = document.getElementById('profileActivityList');
                if (!userActivities.length) { container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>'; return; }
                let html = '<div class="activity-timeline">';
                userActivities.forEach(activity => {
                    const iconMap = { login: 'fa-sign-in-alt', profile_update: 'fa-user-edit', password_change: 'fa-key' };
                    html += `<div class="activity-item"><div class="activity-icon"><i class="fas ${iconMap[activity.type] || 'fa-circle'}"></i></div><div class="activity-content"><p>${activity.description || activity.type}</p><span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span></div></div>`;
                });
                container.innerHTML = html + '</div>';
            },
            loadNotifications() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
                const container = document.getElementById('profileNotifications');
                if (!userNotifications.length) { container.innerHTML = '<div class="empty-state"><p>No notifications</p></div>'; return; }
                let html = '<div class="notifications-list">';
                userNotifications.forEach(notif => { html += `<div class="notification-item ${notif.read ? '' : 'unread'}"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><p>${notif.message}</p><span class="notification-time">${new Date(notif.timestamp || notif.createdAt).toLocaleString()}</span></div></div>`; });
                container.innerHTML = html + '</div>';
            },
            handleAvatarUpload(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { this.updateAvatar(e.target.result); };
                reader.readAsDataURL(file);
                input.value = '';
            },
            updateAvatar(avatarData) {
                const user = Auth.getCurrentUser();
                const result = Auth.updateProfile(user.id, { avatar: avatarData });
                if (result.success) { Toast.success('Profile picture updated'); this.loadProfile(); this.updateNavAvatar(avatarData); this.updateSidebarAvatar(avatarData); }
                else { Toast.error('Failed to update profile picture'); }
            },
            updateNavAvatar(avatarData) {
                const navAvatar = document.getElementById('navAvatar');
                if (navAvatar && avatarData) { navAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
            },
            updateSidebarAvatar(avatarData) {
                const sidebarAvatar = document.getElementById('currentUserAvatar');
                if (sidebarAvatar && avatarData) { sidebarAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
            },
            saveProfile() {
                const user = Auth.getCurrentUser();
                const name = document.getElementById('profileNameInput').value.trim();
                const email = document.getElementById('profileEmailInput').value.trim();
                const phone = document.getElementById('profilePhoneInput').value.trim();
                const address = document.getElementById('profileAddressInput').value.trim();
                if (!name) { Toast.error('Name is required'); return; }
                const result = Auth.updateProfile(user.id, { name, email, phone, address });
                if (result.success) { Toast.success('Profile updated successfully'); this.loadProfile(); this.logActivity('profile_update', 'Updated profile'); Auth.addNotification(user.id, 'Your profile information was updated', 'info'); NotificationPanel.init(); }
                else { Toast.error('Failed to update profile'); }
            },
            changePassword() {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                if (!currentPassword || !newPassword || !confirmPassword) { Toast.error('Please fill all password fields'); return; }
                if (newPassword !== confirmPassword) { Toast.error('New passwords do not match'); return; }
                if (newPassword.length < 6) { Toast.error('Password must be at least 6 characters'); return; }
                const user = Auth.getCurrentUser();
                const result = Auth.changePassword(user.id, currentPassword, newPassword);
                if (result.success) { Toast.success('Password changed successfully'); document.getElementById('passwordForm').reset(); this.logActivity('password_change', 'Changed password'); Auth.addNotification(user.id, 'Your password was changed successfully', 'success'); NotificationPanel.init(); }
                else { Toast.error(result.message); }
            },
            logActivity(type, description) {
                const user = Auth.getCurrentUser();
                const activities = Storage.getData('activities') || [];
                activities.push({ id: Storage.generateId(), userId: user.id, type, description, timestamp: new Date().toISOString() });
                Storage.setData('activities', activities);
            }
        };
        
        Profile.init = function() { this.loadProfile(); };
        Profile.loadProfile = function() {
            const user = Auth.getCurrentUser();
            if (!user) return;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRole').textContent = 'Super Admin';
            document.getElementById('profileNameInput').value = user.name || '';
            document.getElementById('profileEmailInput').value = user.email || '';
            document.getElementById('profilePhoneInput').value = user.phone || '';
            document.getElementById('profileAddressInput').value = user.address || '';
            document.getElementById('profileAvatarInitials').textContent = Utils.getInitials(user.name);
            if (user.avatar) {
                const img = document.getElementById('profileAvatarImg');
                img.src = user.avatar;
                img.style.display = 'block';
                document.getElementById('profileAvatarInitials').style.display = 'none';
            }
            document.getElementById('profileMemberSince').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            const activityData = this.getActivityData();
            document.getElementById('activityScore').textContent = activityData.score;
            document.getElementById('totalLogins').textContent = activityData.logins;
            this.loadRecentActivity();
            this.loadNotifications();
        };
        Profile.getActivityData = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id);
            return { score: Math.min(100, userActivities.length * 5 + 10), logins: userActivities.filter(a => a.type === 'login').length || 1 };
        };
        Profile.loadRecentActivity = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileActivityList');
            if (!userActivities.length) { container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>'; return; }
            let html = '<div class="activity-timeline">';
            userActivities.forEach(activity => {
                const iconMap = { login: 'fa-sign-in-alt', profile_update: 'fa-user-edit', password_change: 'fa-key' };
                html += `<div class="activity-item"><div class="activity-icon"><i class="fas ${iconMap[activity.type] || 'fa-circle'}"></i></div><div class="activity-content"><p>${activity.description || activity.type}</p><span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span></div></div>`;
            });
            container.innerHTML = html + '</div>';
        };
        Profile.loadNotifications = function() {
            const user = Auth.getCurrentUser();
            const notifications = Storage.getData('notifications') || [];
            const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileNotifications');
            if (!userNotifications.length) { container.innerHTML = '<div class="empty-state"><p>No notifications</p></div>'; return; }
            let html = '<div class="notifications-list">';
            userNotifications.forEach(notif => { html += `<div class="notification-item ${notif.read ? '' : 'unread'}"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><p>${notif.message}</p><span class="notification-time">${new Date(notif.timestamp || notif.createdAt).toLocaleString()}</span></div></div>`; });
            container.innerHTML = html + '</div>';
        };
        Profile.handleAvatarUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { this.updateAvatar(e.target.result); };
            reader.readAsDataURL(file);
            input.value = '';
        };
        Profile.updateAvatar = function(avatarData) {
            const user = Auth.getCurrentUser();
            const result = Auth.updateProfile(user.id, { avatar: avatarData });
            if (result.success) { Toast.success('Profile picture updated'); this.loadProfile(); this.updateNavAvatar(avatarData); this.updateSidebarAvatar(avatarData); }
            else { Toast.error('Failed to update profile picture'); }
        };
        Profile.updateNavAvatar = function(avatarData) {
            const navAvatar = document.getElementById('navAvatar');
            if (navAvatar && avatarData) { navAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        Profile.updateSidebarAvatar = function(avatarData) {
            const sidebarAvatar = document.getElementById('currentUserAvatar');
            if (sidebarAvatar && avatarData) { sidebarAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        Profile.saveProfile = function() {
            const user = Auth.getCurrentUser();
            const name = document.getElementById('profileNameInput').value.trim();
            const email = document.getElementById('profileEmailInput').value.trim();
            const phone = document.getElementById('profilePhoneInput').value.trim();
            const address = document.getElementById('profileAddressInput').value.trim();
            if (!name) { Toast.error('Name is required'); return; }
            const result = Auth.updateProfile(user.id, { name, email, phone, address });
            if (result.success) { Toast.success('Profile updated successfully'); this.loadProfile(); this.logActivity('profile_update', 'Updated profile'); Auth.addNotification(user.id, 'Your profile information was updated', 'info'); NotificationPanel.init(); }
            else { Toast.error('Failed to update profile'); }
        };
        Profile.changePassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) { Toast.error('Please fill all password fields'); return; }
            if (newPassword !== confirmPassword) { Toast.error('New passwords do not match'); return; }
            if (newPassword.length < 6) { Toast.error('Password must be at least 6 characters'); return; }
            const user = Auth.getCurrentUser();
            const result = Auth.changePassword(user.id, currentPassword, newPassword);
            if (result.success) { Toast.success('Password changed successfully'); document.getElementById('passwordForm').reset(); this.logActivity('password_change', 'Changed password'); Auth.addNotification(user.id, 'Your password was changed successfully', 'success'); NotificationPanel.init(); }
            else { Toast.error(result.message); }
        };
        Profile.logActivity = function(type, description) {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            activities.push({ id: Storage.generateId(), userId: user.id, type, description, timestamp: new Date().toISOString() });
            Storage.setData('activities', activities);
        };
        
        function toggleDarkMode() {
            const isDark = ThemeManager.toggleDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        function initDarkModeToggle() {
            const isDark = ThemeManager.isDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        window.toggleDarkMode = toggleDarkMode;
        
        document.addEventListener('DOMContentLoaded', () => {
            SuperAdmin.init();
            Chat.init();
            NotificationPanel.init();
            initDarkModeToggle();
            Calendar.init();
        });
    </script>
    <style>
        .features-grid .feature-toggle {
            transition: all 0.2s;
        }
        .features-grid .feature-toggle:hover {
            background: #f8fafc;
            border-color: #16a34a !important;
        }
        .features-grid input[type="checkbox"] {
            accent-color: #16a34a;
        }
        
        /* School Selector */
        .school-selector {
            margin-left: 15px;
        }
        .school-selector select {
            min-width: 250px;
            padding: 8px 12px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--light);
            color: var(--text);
            font-size: 14px;
        }
        .school-selector select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* School View Banner */
        .school-view-banner {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .school-view-banner-content {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }
        .school-view-banner-content i {
            font-size: 18px;
        }
        .school-view-banner-content strong {
            font-weight: 600;
        }
        .school-view-banner .btn-outline {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 4px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
        }
        .school-view-banner .btn-outline:hover {
            background: white;
            color: var(--primary);
        }
        
        /* School Admin Nav */
        .nav-section-title {
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 600;
            color: var(--gray);
            padding: 16px 16px 8px;
            letter-spacing: 0.5px;
        }
    </style>
</body>
</html>
