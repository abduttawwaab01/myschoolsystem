<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <!-- Local Storage Only -->
    <script src="../assets/js/firebase-config.js"></script>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>My School</span>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#" class="nav-item active" data-page="dashboard" onclick="event.preventDefault(); Admin.showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-item" data-page="students" onclick="event.preventDefault(); Admin.showSection('students')">
                        <i class="fas fa-user-graduate"></i>
                        <span>Students</span>
                    </a>
                    <a href="#" class="nav-item" data-page="staff" onclick="event.preventDefault(); Admin.showSection('staff')">
                        <i class="fas fa-users"></i>
                        <span>Staff</span>
                    </a>
                    <a href="#" class="nav-item" data-page="parents" onclick="event.preventDefault(); Admin.showSection('parents')">
                        <i class="fas fa-user-friends"></i>
                        <span>Parents</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Finance</div>
                    <a href="#" class="nav-item" data-page="finance" onclick="event.preventDefault(); Admin.showSection('finance')">
                        <i class="fas fa-wallet"></i>
                        <span>Finance</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <a href="#" class="nav-item" data-page="reports" onclick="event.preventDefault(); Admin.showSection('reports')">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </a>
                    <a href="#" class="nav-item" data-page="idcards" onclick="event.preventDefault(); Admin.showSection('idcards')">
                        <i class="fas fa-id-card"></i>
                        <span>ID Cards</span>
                    </a>
                    <a href="#" class="nav-item" data-page="attendance" onclick="event.preventDefault(); Admin.showSection('attendance')">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Student Attendance</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Questions & Tests</div>
                    <a href="#" class="nav-item" data-page="viewQuestions" onclick="event.preventDefault(); Admin.showSection('viewQuestions')">
                        <i class="fas fa-question-circle"></i>
                        <span>View Questions</span>
                    </a>
                    <a href="#" class="nav-item" data-page="viewTestResults" onclick="event.preventDefault(); Admin.showSection('viewTestResults')">
                        <i class="fas fa-chart-line"></i>
                        <span>Test Results</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Communication</div>
                    <a href="#" class="nav-item" data-page="chat" onclick="event.preventDefault(); Admin.showSection('chat')">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                        <span class="badge" id="chatBadge" style="display: none;">0</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Public Pages</div>
                    <a href="../public/blog.html" target="_blank" class="nav-item">
                        <i class="fas fa-blog"></i>
                        <span>Blog</span>
                    </a>
                    <a href="../public/resources.html" target="_blank" class="nav-item">
                        <i class="fas fa-folder-open"></i>
                        <span>Resources</span>
                    </a>
                    <a href="../public/pricing.html" target="_blank" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span>Pricing</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Support</div>
                    <a href="#" class="nav-item" data-page="help" onclick="event.preventDefault(); Admin.showSection('help')">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Guide</span>
                    </a>
                    <a href="#" class="nav-item" data-page="parentAnnouncements" onclick="event.preventDefault(); Admin.showSection('parentAnnouncements')">
                        <i class="fas fa-bullhorn"></i>
                        <span>Parent Announcements</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" data-page="profile" onclick="event.preventDefault(); Admin.showSection('profile')">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                    <a href="#" class="nav-item" data-page="schoolSettings" onclick="event.preventDefault(); Admin.showSection('schoolSettings')">
                        <i class="fas fa-cogs"></i>
                        <span>School Settings</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">AD</div>
                    <div class="user-details">
                        <div class="user-name" id="currentUserName">Admin</div>
                        <div class="user-role">School Admin</div>
                    </div>
                </div>
                <button class="btn logout-btn" onclick="Auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div id="announcementBanner" class="announcement-banner">
                <div class="announcement-content" id="announcementContent"></div>
                <button class="announcement-close" onclick="document.getElementById('announcementBanner').classList.remove('active')">&times;</button>
            </div>
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search students, teachers...">
                    </div>
                </div>
                <div class="navbar-right">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="notification-container">
                        <button class="navbar-icon-btn" onclick="NotificationPanel.toggle()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button class="btn btn-sm btn-link" onclick="NotificationPanel.markAllRead()">Mark all read</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <div class="navbar-profile" onclick="Admin.showProfile()">
                        <div class="avatar" id="navAvatar">AD</div>
                        <span class="name" id="navUserName">Admin</span>
                    </div>
                </div>
            </nav>

            <div class="page-content">
                <div id="dashboardSection">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Dashboard</h1>
                            <p class="page-subtitle">Welcome back, <span id="welcomeName">Admin</span></p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Total Students</div>
                                <div class="stat-value" id="totalStudents">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Teachers</div>
                                <div class="stat-value" id="totalTeachers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Attendance Today</div>
                                <div class="stat-value" id="attendanceToday">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="balanceAmount">₦0</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar"></i> Calendar</h3>
                                <button class="btn btn-sm btn-outline" onclick="Calendar.showAddEventModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="calendarWidget" class="calendar-widget"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-chart-line"></i> Recent Activity</h3>
                            </div>
                            <div class="card-body">
                                <div id="recentActivity">
                                    <div class="empty-state">
                                        <p>No recent activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3>
                            </div>
                            <div class="card-body">
                                <div id="notifications">
                                    <div class="empty-state">
                                        <p>No notifications</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="studentsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Students</h1>
                        </div>
                        <div class="flex gap-2">
                            <label class="btn btn-outline" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Import CSV
                                <input type="file" id="csvImportInput" accept=".csv" style="display: none;" onchange="Admin.importCSV(this)">
                            </label>
                            <button class="btn btn-outline" onclick="Students.export('csv')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-primary" onclick="Modal.show('addStudentModal')">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="studentsTable">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h3>No students</h3>
                                <p>Add students to get started</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="staffSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Staff Management</h1>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="Admin.showAddStaffModal('teacher')">
                                <i class="fas fa-chalkboard-teacher"></i> Add Teacher
                            </button>
                            <button class="btn btn-primary" onclick="Admin.showAddStaffModal('accountant')">
                                <i class="fas fa-calculator"></i> Add Accountant
                            </button>
                            <button class="btn btn-primary" onclick="Admin.showAddStaffModal('director')">
                                <i class="fas fa-user-tie"></i> Add Director
                            </button>
                        </div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="allStaff" onclick="Admin.switchStaffTab('allStaff')">All Staff</button>
                        <button class="tab-btn" data-tab="teachers" onclick="Admin.switchStaffTab('teachers')">Teachers</button>
                        <button class="tab-btn" data-tab="accountants" onclick="Admin.switchStaffTab('accountants')">Accountants</button>
                        <button class="tab-btn" data-tab="directors" onclick="Admin.switchStaffTab('directors')">Directors</button>
                    </div>
                    <div class="card">
                        <div class="card-body" id="staffTable"></div>
                    </div>
                </div>

                <div id="parentsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Parent Accounts</h1>
                            <p class="page-subtitle">Manage parent login accounts for the parent portal</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="Admin.showAddParentModal()">
                                <i class="fas fa-plus"></i> Add Parent
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="parentsTable">
                            <p class="text-muted">Loading...</p>
                        </div>
                    </div>
                </div>

                <div id="classesSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Classes Management</h1>
                            <p class="page-subtitle">Enable or disable classes for your school</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="classesList"></div>
                    </div>
                </div>

                <div id="subjectsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Subjects Management</h1>
                            <p class="page-subtitle">Select subjects offered by your school</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="subjectsList"></div>
                    </div>
                </div>

                <div id="scoreTypesSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Score Types Settings</h1>
                            <p class="page-subtitle">Configure which test types your school uses</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div id="scoreTypesList"></div>
                        </div>
                    </div>
                </div>

                <div id="attendanceSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Attendance</h1>
                        </div>
                    </div>
                    <div class="grid-2 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-users"></i> Manual Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="filters-bar">
                                    <div class="filter-group">
                                        <label>Class:</label>
                                        <select id="classSelect" class="form-control">
                                            <option value="">Select Class</option>
                                        </select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Date:</label>
                                        <input type="date" id="attendanceDate" class="form-control">
                                    </div>
                                    <button class="btn btn-primary" onclick="Attendance.loadStudents()">
                                        <i class="fas fa-sync"></i> Load
                                    </button>
                                    <button class="btn btn-success" onclick="Attendance.markAllPresent()">
                                        <i class="fas fa-check"></i> Mark All Present
                                    </button>
                                </div>
                                <div id="studentsList"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-qrcode"></i> QR Scan Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Scan Date:</label>
                                        <input type="date" id="scanAttendanceDate" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Manual Entry:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="scanStudentInput" class="form-control" placeholder="Enter student ID or scan QR code">
                                        <button class="btn btn-primary" onclick="QR.scanStudentForAttendance()">
                                            <i class="fas fa-check"></i> Mark Present
                                        </button>
                                    </div>
                                </div>
                                <div id="scanResult" class="mt-3"></div>
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="QR.openQRScanner()">
                                        <i class="fas fa-camera"></i> Open Camera Scanner
                                    </button>
                                </div>
                                <div id="qrScannerContainer" class="mt-3" style="display: none;">
                                    <div class="qr-scanner-wrapper" style="position: relative; max-width: 400px; margin: 0 auto;">
                                        <video id="qrScanner" style="width: 100%; border-radius: 12px; border: 3px solid var(--primary);"></video>
                                        <div class="qr-scan-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px dashed var(--primary); border-radius: 12px; pointer-events: none;"></div>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px;">
                                        <p class="text-muted" style="font-size: 13px;"><i class="fas fa-info-circle"></i> Position the QR code within the frame to scan automatically</p>
                                        <button class="btn btn-secondary mt-2" onclick="QR.closeQRScanner()">
                                            <i class="fas fa-times"></i> Close Scanner
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Recently Scanned Today Section -->
                    <div class="card" style="margin-top:20px;border-left:4px solid #16a34a;">
                        <div class="card-header" style="background:rgba(22,163,74,0.1);">
                            <h3 class="card-title" style="color:#16a34a;">
                                <i class="fas fa-user-check"></i> Recently Scanned Today 
                                <span id="scannedCountBadge" style="display:none;background:#16a34a;color:white;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:10px;">0</span>
                                <button onclick="QRScanner.clearRecentlyScanned()" style="float:right;background:none;border:none;color:#666;cursor:pointer;font-size:12px;">Clear</button>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="recentlyScannedContainer">
                                <p class="text-muted" style="text-align:center;padding:20px;">No students scanned today</p>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Attendance Summary</h3>
                        </div>
                        <div class="card-body">
                            <div id="attendanceSummary"></div>
                        </div>
                    </div>
                </div>

                <div id="scoresSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Scores & Grades</h1>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="scoreClassSelect" class="form-control">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="scoreSubjectSelect" class="form-control">
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Term:</label>
                                    <select id="scoreTermSelect" class="form-control">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Year:</label>
                                    <select id="scoreYearSelect" class="form-control">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                            </div>
                            <div id="scoresTable"></div>
                        </div>
                    </div>
                </div>

                <div id="financeSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Finance</h1>
                        </div>
                            <button class="btn btn-primary" onclick="Modal.show('addTransactionModal')">
                                <i class="fas fa-plus"></i> Add Transaction
                            </button>
                            <button class="btn btn-success" onclick="Modal.show('generateReceiptModal')" style="margin-left: 10px;">
                                <i class="fas fa-receipt"></i> Generate Receipt
                            </button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-arrow-up"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Income</div>
                                <div class="stat-value" id="totalIncome">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger"><i class="fas fa-arrow-down"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Expenses</div>
                                <div class="stat-value" id="totalExpenses">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="balance">₦0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Transactions</h3>
                            <select id="financeTypeFilter" class="form-control" style="width: auto;">
                                <option value="all">All</option>
                                <option value="income">Income</option>
                                <option value="expense">Expenses</option>
                            </select>
                        </div>
                        <div class="card-body" id="transactionsList"></div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title">Receipts</h3>
                            </div>
                            <div class="card-body" id="receiptsList"></div>
                        </div>
                    </div>
                </div>

                <div id="reportsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Reports & Analytics</h1>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card-item" onclick="Reports.showReportType('student'); document.getElementById('currentReportType').value = 'student';">
                            <div class="report-icon"><i class="fas fa-user-graduate"></i></div>
                            <h3>Student Report</h3>
                            <p>Individual student term results</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('class'); document.getElementById('currentReportType').value = 'class';">
                            <div class="report-icon"><i class="fas fa-users"></i></div>
                            <h3>Class Report</h3>
                            <p>All students in a class</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('attendance'); document.getElementById('currentReportType').value = 'attendance';">
                            <div class="report-icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3>Attendance</h3>
                            <p>Daily/weekly/monthly attendance</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('scores'); document.getElementById('currentReportType').value = 'scores';">
                            <div class="report-icon"><i class="fas fa-star"></i></div>
                            <h3>Scores Report</h3>
                            <p>Daily/Weekly/Mid-term/Exam</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('subject'); document.getElementById('currentReportType').value = 'subject';">
                            <div class="report-icon"><i class="fas fa-chart-bar"></i></div>
                            <h3>Subject Analysis</h3>
                            <p>Subject performance analysis</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('finance'); document.getElementById('currentReportType').value = 'finance';">
                            <div class="report-icon"><i class="fas fa-wallet"></i></div>
                            <h3>Finance Report</h3>
                            <p>Income & expenses summary</p>
                        </div>
                    </div>
                    
                    <!-- Hidden field to store current report type for export -->
                    <input type="hidden" id="currentReportType" value="">
                    
                    <div id="reportFilters" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="reportTypeTitle">Select Report Options</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row" id="reportFiltersContent"></div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-primary" onclick="Reports.generateSelectedReport(); document.getElementById('currentReportType').value = Reports.currentReportType;">
                                    <i class="fas fa-sync"></i> Generate Report
                                </button>
                                <button class="btn btn-outline" onclick="AdminReportsExport('csv')">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-outline" onclick="AdminReportsExport('pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-outline" onclick="AdminReportsExport('doc')">
                                    <i class="fas fa-file-word"></i> DOC
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reportContent" class="card mt-3" style="display: none;">
                        <div class="card-body" id="reportContentBody"></div>
                    </div>
                </div>

                <div id="idcardsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">ID Cards</h1>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Select Type</label>
                                    <select id="idCardType" class="form-control" onchange="Admin.loadIDCardUsers()">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                        <option value="accountant">Accountant</option>
                                        <option value="director">Director</option>
                                        <option value="school_admin">School Admin</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Select Person</label>
                                    <select id="idCardUser" class="form-control">
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Format</label>
                                    <select id="idCardFormat" class="form-control">
                                        <option value="portrait">Portrait</option>
                                        <option value="landscape">Landscape</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="Admin.generateIDCard()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Front Only</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-success" onclick="Admin.downloadIDCard('png', 'portrait')">
                                    <i class="fas fa-image"></i> Portrait PNG
                                </button>
                                <button class="btn btn-success" onclick="Admin.downloadIDCard('png', 'landscape')">
                                    <i class="fas fa-image"></i> Landscape PNG
                                </button>
                                <button class="btn btn-danger" onclick="Admin.downloadIDCard('pdf', 'portrait')">
                                    <i class="fas fa-file-pdf"></i> Portrait PDF
                                </button>
                                <button class="btn btn-danger" onclick="Admin.downloadIDCard('pdf', 'landscape')">
                                    <i class="fas fa-file-pdf"></i> Landscape PDF
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Back Only</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-outline" onclick="Admin.downloadIDCardBack('png', 'portrait')">
                                    <i class="fas fa-image"></i> Portrait PNG
                                </button>
                                <button class="btn btn-outline" onclick="Admin.downloadIDCardBack('png', 'landscape')">
                                    <i class="fas fa-image"></i> Landscape PNG
                                </button>
                                <button class="btn btn-outline" onclick="Admin.downloadIDCardBack('pdf', 'portrait')">
                                    <i class="fas fa-file-pdf"></i> Portrait PDF
                                </button>
                                <button class="btn btn-outline" onclick="Admin.downloadIDCardBack('pdf', 'landscape')">
                                    <i class="fas fa-file-pdf"></i> Landscape PDF
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Both Sides</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-info" onclick="Admin.downloadIDCardBoth('png', 'side')">
                                    <i class="fas fa-images"></i> Side by Side (PNG)
                                </button>
                                <button class="btn btn-info" onclick="Admin.downloadIDCardBoth('png', 'stack')">
                                    <i class="fas fa-images"></i> Stacked (PNG)
                                </button>
                                <button class="btn btn-warning" onclick="Admin.downloadIDCardBoth('pdf', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF (2 pages)
                                </button>
                            </div>
                            <div id="idCardPreview" style="margin-top: 24px; display: flex; justify-content: center; flex-wrap: wrap; gap: 20px;"></div>
                        </div>
                    </div>
                </div>

                <div id="attendanceSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Student Attendance</h1>
                            <p class="text-muted">View and export student attendance records by term</p>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-row mb-4">
                                <div class="form-group">
                                    <label class="form-label">Year</label>
                                    <select id="attendanceYear" class="form-control" onchange="Admin.loadTermAttendance()">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Term</label>
                                    <select id="attendanceTerm" class="form-control" onchange="Admin.loadTermAttendance()">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Class</label>
                                    <select id="attendanceClass" class="form-control" onchange="Admin.loadTermAttendance()">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button class="btn btn-primary" onclick="Admin.loadTermAttendance()">
                                        <i class="fas fa-search"></i> Load
                                    </button>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button class="btn btn-success" onclick="Admin.exportTermAttendance()">
                                        <i class="fas fa-download"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                            <div id="attendanceTableContainer">
                                <div class="empty-state">
                                    <i class="fas fa-clipboard-check"></i>
                                    <h3>No Attendance Data</h3>
                                    <p>Select a term and class to view attendance records</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View Questions Section (Admin/Director - View Only) -->
                <div id="viewQuestionsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Question Bank</h1>
                            <p class="page-subtitle">View all questions (Read-only)</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Teacher:</label>
                                    <select id="adminQuestionFilterTeacher" class="form-control" onchange="Admin.loadAdminQuestions()">
                                        <option value="">All Teachers</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="adminQuestionFilterSubject" class="form-control" onchange="Admin.loadAdminQuestions()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="adminQuestionFilterClass" class="form-control" onchange="Admin.loadAdminQuestions()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body" id="adminQuestionsList">
                            <div class="empty-state">
                                <i class="fas fa-question-circle"></i>
                                <h3>No questions found</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- View Test Results Section (Admin/Director) -->
                <div id="viewTestResultsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Test Results</h1>
                            <p class="page-subtitle">View all student test results</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" onclick="Admin.exportTestResultsDOC()">
                                <i class="fas fa-file-word"></i> Export DOC
                            </button>
                            <button class="btn btn-outline" onclick="Admin.exportTestResultsPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="adminResultFilterSubject" class="form-control" onchange="Admin.loadAdminTestResults()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="adminResultFilterClass" class="form-control" onchange="Admin.loadAdminTestResults()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Test Type:</label>
                                    <select id="adminResultFilterTestType" class="form-control" onchange="Admin.loadAdminTestResults()">
                                        <option value="">All</option>
                                        <option value="exam">Exam</option>
                                        <option value="midterm">Mid-term</option>
                                        <option value="quiz">Quiz</option>
                                        <option value="assignment">Assignment</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body" id="adminTestResultsList">
                            <div class="empty-state">
                                <i class="fas fa-chart-line"></i>
                                <h3>No results yet</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chatSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Chat</h1>
                        </div>
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-sidebar" id="chatSidebar">
                            <button class="chat-sidebar-close" id="chatSidebarClose" onclick="Chat.closeSidebar()" style="display: none;">&times;</button>
                            <div class="chat-search">
                                <input type="text" id="chatSearch" placeholder="Search conversations...">
                            </div>
                            <button class="btn btn-outline mt-2" id="newChatBtn" style="width:100%" onclick="Chat.showNewChatModal()">New Chat</button>
                            <div class="chat-list" id="chatList"></div>
                            <div id="groupsList"></div>
                            <button class="btn btn-primary mt-2" id="createGroupBtn" style="width:100%" onclick="Chat.showCreateGroupModal()">Create Group Chat</button>
                            <button class="btn btn-outline mt-2" id="createSuperGroupBtn" style="width:100%" onclick="Chat.showSuperAdminGroupModal()">Super Admin Group</button>
                                                        <!-- Super Admin Group Creation Modal -->
                                                        <div id="superAdminGroupModal" class="modal-overlay" style="display:none;">
                                                            <div class="modal">
                                                                <div class="modal-header">
                                                                    <h3 class="modal-title">Create Group (Super Admin)</h3>
                                                                    <button class="modal-close" onclick="Modal.hide('superAdminGroupModal')">&times;</button>
                                                                </div>
                                                                <div class="modal-body">
                                                                    <div class="form-group">
                                                                        <label>Group Name</label>
                                                                        <input type="text" id="superGroupNameInput" class="form-control" placeholder="Enter group name">
                                                                    </div>
                                                                    <div class="form-group">
                                                                        <label>Select Users</label>
                                                                        <div>
                                                                            <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('admins')">Admins</button>
                                                                            <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('directors')">Directors</button>
                                                                            <button class="btn btn-outline mb-2" onclick="Chat.selectSuperGroup('all')">All Schools</button>
                                                                        </div>
                                                                        <div id="superGroupUserList" style="max-height:200px;overflow-y:auto;"></div>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer">
                                                                    <button class="btn btn-secondary" onclick="Modal.hide('superAdminGroupModal')">Cancel</button>
                                                                    <button class="btn btn-primary" onclick="Chat.createSuperAdminGroup()">Create Group</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                        <!-- Group Chat Creation Modal -->
                                        <div id="createGroupModal" class="modal-overlay" style="display:none;">
                                            <div class="modal">
                                                <div class="modal-header">
                                                    <h3 class="modal-title">Create Group Chat</h3>
                                                    <button class="modal-close" onclick="Modal.hide('createGroupModal')">&times;</button>
                                                </div>
                                                <div class="modal-body">
                                                    <div class="form-group">
                                                        <label>Group Name</label>
                                                        <input type="text" id="groupNameInput" class="form-control" placeholder="Enter group name">
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Select Staff</label>
                                                        <div id="groupStaffList" style="max-height:200px;overflow-y:auto;"></div>
                                                        <button class="btn btn-outline mt-2" onclick="Chat.selectAllStaff()">Select All Staff</button>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn btn-secondary" onclick="Modal.hide('createGroupModal')">Cancel</button>
                                                    <button class="btn btn-primary" onclick="Chat.createGroupChat()">Create Group</button>
                                                </div>
                                            </div>
                                        </div>
                        </div>
                        <div class="chat-main" id="chatMain">
                            <div class="chat-header" id="chatHeader">
                                <button class="chat-back-btn" id="chatBackBtn" onclick="Chat.showSidebar()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                                <div class="chat-header-info">
                                    <h3>Select a conversation</h3>
                                </div>
                            </div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area">
                                <button class="btn btn-icon" onclick="Chat.showEmojiPicker()" title="Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" id="chatInput" placeholder="Type a message...">
                                <div class="chat-input-actions">
                                    <button id="fileBtn" title="Attach File"><i class="fas fa-paperclip"></i></button>
                                    <button id="voiceBtn" title="Voice Message"><i class="fas fa-microphone"></i></button>
                                    <button id="sendBtn" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Chat Modal -->
                <div id="newChatModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Start New Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('newChatModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="newChatSearch" class="form-control" placeholder="Search users..." oninput="Chat.filterNewChatUsers(this.value)">
                            <div id="newChatUserList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <div id="helpSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Help & Guide</h1>
                            <p class="page-subtitle">Learn how to use the system effectively</p>
                        </div>
                    </div>
                    <div id="helpGuideContainer"></div>
                </div>

                <!-- Parent Announcements Section -->
                <div id="parentAnnouncementsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Parent Announcements</h1>
                            <p class="page-subtitle">Create announcements visible only to parents</p>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullhorn"></i> Create New Announcement</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Message</label>
                                <textarea id="parentAnnouncementMessage" class="form-control" rows="3" placeholder="Enter announcement message for parents..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="Admin.createParentAnnouncement()">
                                <i class="fas fa-paper-plane"></i> Post to Parents
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> Previous Announcements</h3>
                        </div>
                        <div class="card-body">
                            <div id="parentAnnouncementsList"></div>
                        </div>
                    </div>
                </div>

                <div id="profileSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">My Profile</h1>
                            <p class="page-subtitle">Manage your account settings</p>
                        </div>
                    </div>
                    
                    <div class="profile-page">
                        <div class="profile-header-card">
                            <div class="profile-avatar-section">
                                <div class="profile-avatar-large" id="profileAvatarLarge">
                                    <img id="profileAvatarImg" src="" alt="Profile" style="display: none;">
                                    <span id="profileAvatarInitials"></span>
                                </div>
                                <label class="profile-avatar-edit">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="Profile.handleAvatarUpload(this)">
                                </label>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profileName">Admin</h2>
                                <p id="profileRole">School Admin</p>
                                <p class="profile-member-since"><i class="fas fa-calendar"></i> Member since: <span id="profileMemberSince">-</span></p>
                            </div>
                            <div class="profile-stats">
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="activityScore">0</div>
                                    <div class="profile-stat-label">Activity Score</div>
                                </div>
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="totalLogins">0</div>
                                    <div class="profile-stat-label">Total Logins</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user"></i> Personal Information</h3>
                                </div>
                                <div class="card-body">
                                    <form id="profileForm">
                                        <div class="form-group">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" id="profileNameInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <input type="email" id="profileEmailInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" id="profilePhoneInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Address</label>
                                            <textarea id="profileAddressInput" class="form-control" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Gender</label>
                                            <select id="profileGenderInput" class="form-control">
                                                <option value="">Select</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="Profile.saveProfile()">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-lock"></i> Change Password</h3>
                                </div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="form-group">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" id="currentPassword" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">New Password</label>
                                            <input type="password" id="newPassword" class="form-control" required minlength="6">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" id="confirmPassword" class="form-control" required>
                                        </div>
                                        <button type="button" class="btn btn-warning" onclick="Profile.changePassword()">
                                            <i class="fas fa-key"></i> Change Password
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3>
                            </div>
                            <div class="card-body">
                                <div id="profileActivityList">
                                    <div class="empty-state">
                                        <p>No recent activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3>
                            </div>
                            <div class="card-body">
                                <div id="profileNotifications">
                                    <div class="empty-state">
                                        <p>No notifications</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="schoolSettingsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">School Settings</h1>
                            <p class="text-muted">Manage your school's profile and ID card settings</p>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-school"></i> School Profile</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">School Name</label>
                                    <input type="text" id="schoolName" class="form-control" placeholder="Enter school name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">School Phone</label>
                                    <input type="tel" id="schoolPhone" class="form-control" placeholder="Enter phone number">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">School Email</label>
                                    <input type="email" id="schoolEmail" class="form-control" placeholder="Enter email address">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Website</label>
                                    <input type="url" id="schoolWebsite" class="form-control" placeholder="https://example.com">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address</label>
                                <textarea id="schoolAddress" class="form-control" rows="2" placeholder="Enter school address"></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">School Motto</label>
                                    <input type="text" id="schoolMotto" class="form-control" placeholder="Enter school motto">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Year Established</label>
                                    <input type="number" id="schoolEstablished" class="form-control" placeholder="e.g., 2010">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-id-card"></i> ID Card Settings</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">ID Card Theme Color</label>
                                    <div style="display: flex; gap: 10px; align-items: center;">
                                        <input type="color" id="schoolIdCardColor" value="#16a34a" style="width: 60px; height: 40px; cursor: pointer;" onchange="document.getElementById('schoolIdCardColorText').value = this.value">
                                        <input type="text" id="schoolIdCardColorText" class="form-control" value="#16a34a" style="width: 120px;" onchange="document.getElementById('schoolIdCardColor').value = this.value">
                                    </div>
                                    <small style="color: #64748b;">This color will be used for ID card borders and headers</small>
                                </div>
                            </div>
                            
                            <div class="form-row mt-3">
                                <div class="form-group">
                                    <label class="form-label">ID Card Back Message</label>
                                    <textarea id="schoolIdCardBackMessage" class="form-control" rows="3" placeholder="Enter message to display on the back of ID cards..."></textarea>
                                    <small style="color: #64748b;">This message will appear on the back of ID cards (e.g., "If found, please return to...")</small>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">School Logo (for ID Cards)</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="schoolLogo" accept="image/*" onchange="Admin.previewSchoolLogo(this)">
                                        <div id="schoolLogoPreview" class="passport-preview" style="display:none;">
                                            <img id="schoolLogoImg" src="" alt="School Logo Preview" style="width: 80px; height: 80px; object-fit: contain;">
                                            <button type="button" class="btn btn-sm btn-danger" onclick="Admin.clearSchoolLogo()">Remove</button>
                                        </div>
                                    </div>
                                    <small style="color: #64748b;">Recommended: Square image (PNG/JPG), max 500KB</small>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="Admin.saveSchoolSettings()">
                                <i class="fas fa-save"></i> Save All Settings
                            </button>
                            <button type="button" class="btn btn-outline ml-2" onclick="Admin.downloadBackup()">
                                <i class="fas fa-download"></i> Download Backup
                            </button>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-calendar-alt"></i> Academic Year Settings</h3>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">Set the current academic year and term for your school. This affects reports, scores, and attendance tracking.</p>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Current Year</label>
                                    <select id="schoolCurrentYear" class="form-control">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                    </select>
                                    <small style="color: #64748b;">Auto-detected based on current date</small>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Current Term</label>
                                    <select id="schoolCurrentTerm" class="form-control">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                    <small style="color: #64748b;">Auto-detected based on current month</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" id="schoolAutoAdvance" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    Auto-advance term/year
                                </label>
                                <small style="color: #64748b;">Automatically suggest advancing to next term/year based on date</small>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="Admin.saveAcademicSettings()">
                                <i class="fas fa-save"></i> Save Academic Settings
                            </button>
                        </div>
                    </div>

                    <div class="grid-2 mt-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-book"></i> Subject Management</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Configure which subjects are taught in your school</p>
                                <button type="button" class="btn btn-primary" onclick="Admin.openSubjectsManagement()">
                                    <i class="fas fa-cog"></i> Manage Subjects
                                </button>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Test Types</h3>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">Configure which test types your school uses for scoring</p>
                                <button type="button" class="btn btn-primary" onclick="Admin.openScoreTypesSettings()">
                                    <i class="fas fa-cog"></i> Manage Test Types
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="card-title">ID Card Preview</h3>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                                <div id="schoolSettingsPortraitPreview"></div>
                                <div id="schoolSettingsLandscapePreview"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="addStudentModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Add Student</h3>
                <button class="modal-close" onclick="Modal.hide('addStudentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Class</label>
                            <input type="text" name="class" class="form-control" required placeholder="e.g., JSS 1A">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Username <small>(Optional - auto-generated if left blank)</small></label>
                            <input type="text" name="username" class="form-control" placeholder="e.g., johndoe2024">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password <small>(Optional - defaults to Student ID if left blank)</small></label>
                            <input type="password" name="password" class="form-control" placeholder="Enter password">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" name="dob" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select name="gender" class="form-control">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Parent Name</label>
                            <input type="text" name="parentName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parent Phone</label>
                            <input type="tel" name="parentPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passport Photo (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="studentPassport" accept="image/*" onchange="Admin.previewStudentPassport(this)">
                            <div id="studentPassportPreview" class="passport-preview" style="display:none;">
                                <img id="studentPassportImg" src="" alt="Passport Preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="Admin.clearStudentPassport()">Remove</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addStudentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Admin.saveStudent()">Save Student</button>
            </div>
        </div>
    </div>

    <div id="addStaffModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="addStaffModalTitle">Add Staff</h3>
                <button class="modal-close" onclick="Modal.hide('addStaffModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffRole" value="">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Full Name</label>
                            <input type="text" id="staffName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Username</label>
                            <input type="text" id="staffUsername" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Email</label>
                            <input type="email" id="staffEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Phone</label>
                            <input type="tel" id="staffPhone" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Password</label>
                            <input type="password" id="staffPassword" class="form-control" required minlength="6" placeholder="Minimum 6 characters">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select id="staffGender" class="form-control">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="staffAddress" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group" id="staffClassAssign" style="display: none;">
                        <label class="form-label">Assign Class (Optional)</label>
                        <select id="staffClass" class="form-control">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passport Photo (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="staffPassport" accept="image/*" onchange="Admin.previewStaffPassport(this)">
                            <div id="staffPassportPreview" class="passport-preview" style="display:none;">
                                <img id="staffPassportImg" src="" alt="Passport Preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="Admin.clearStaffPassport()">Remove</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addStaffModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Admin.saveStaff()">Save Staff</button>
            </div>
        </div>
    </div>

    <div id="editStaffModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Edit Staff</h3>
                <button class="modal-close" onclick="Modal.hide('editStaffModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="editStaffForm">
                    <input type="hidden" id="editStaffId" value="">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Full Name</label>
                            <input type="text" id="editStaffName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Username</label>
                            <input type="text" id="editStaffUsername" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Email</label>
                            <input type="email" id="editStaffEmail" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Phone</label>
                            <input type="tel" id="editStaffPhone" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">New Password (leave blank to keep current)</label>
                            <input type="password" id="editStaffPassword" class="form-control" minlength="6" placeholder="Minimum 6 characters">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select id="editStaffGender" class="form-control">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea id="editStaffAddress" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group" id="editStaffClassAssign" style="display: none;">
                        <label class="form-label">Assign Class</label>
                        <select id="editStaffClass" class="form-control">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passport Photo (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="editStaffPassport" accept="image/*" onchange="Admin.previewEditStaffPassport(this)">
                            <div id="editStaffPassportPreview" class="passport-preview" style="display:none;">
                                <img id="editStaffPassportImg" src="" alt="Passport Preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="Admin.clearEditStaffPassport()">Remove</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('editStaffModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Admin.saveEditedStaff()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="addTransactionModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Add Transaction</h3>
                <button class="modal-close" onclick="Modal.hide('addTransactionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <div class="form-group">
                        <label class="form-label required">Type</label>
                        <select name="type" class="form-control" required>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Amount</label>
                        <input type="number" name="amount" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Description</label>
                        <input type="text" name="description" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Category</label>
                        <select name="category" class="form-control" required>
                            <option value="">Select Category</option>
                            <optgroup label="Income">
                                <option value="Tuition">Tuition</option>
                                <option value="Registration">Registration</option>
                                <option value="Other Income">Other Income</option>
                            </optgroup>
                            <optgroup label="Expenses">
                                <option value="Salary">Salary</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Supplies">Supplies</option>
                                <option value="Other Expense">Other Expense</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" name="date" class="form-control" id="transactionDateInput">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addTransactionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Finance.addTransaction(Form.getData('transactionForm'))">Save</button>
            </div>
        </div>
    </div>

    <div id="viewStudentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Student Details</h3>
                <button class="modal-close" onclick="Modal.hide('viewStudentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="viewStudentContent"></div>
        </div>
    </div>

    <!-- Edit Parent Modal -->
    <div id="editParentModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit"></i> Edit Parent Account</h3>
                <button class="modal-close" onclick="Modal.hide('editParentModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editParentId" value="">
                <div class="form-group">
                    <label class="form-label">Parent Name</label>
                    <input type="text" id="editParentName" class="form-control">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="editParentEmail" class="form-control">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" id="editParentPhone" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password (leave blank to keep current)</label>
                    <input type="password" id="editParentPassword" class="form-control" placeholder="Enter new password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('editParentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Admin.updateParent()"><i class="fas fa-save"></i> Update Parent</button>
            </div>
        </div>
    </div>

        <div id="generateReceiptModal" class="modal-overlay">
            <div class="modal">
                <div class="modal-header">
                    <h3 class="modal-title">Generate Receipt</h3>
                    <button class="modal-close" onclick="Modal.hide('generateReceiptModal')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="receiptForm">
                        <div class="form-group">
                            <label class="form-label required">Payment Type</label>
                            <select name="paymentType" class="form-control" required>
                                <option value="School Fees">School Fees</option>
                                <option value="Hostel Fees">Hostel Fees</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Amount</label>
                            <input type="number" name="amount" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Payer Name</label>
                            <input type="text" name="payerName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Receiver Name</label>
                            <input type="text" name="receiverName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Payment Description</label>
                            <input type="text" name="description" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Date</label>
                            <input type="date" name="date" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Receipt Format</label>
                            <select name="format" class="form-control" required>
                                <option value="pdf">PDF</option>
                                <option value="doc">DOC</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="Modal.hide('generateReceiptModal')">Cancel</button>
                    <button class="btn btn-success" onclick="Finance.generateReceipt(Form.getData('receiptForm'))">Generate</button>
                </div>
            </div>
        </div>
        <!-- Close page-content -->
    </div>
    <!-- Close main-content -->
    </main>

    <!-- Footer OUTSIDE main-content -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>My School System</span>
            </div>
            <div class="footer-links">
                <a href="../public/blog.html" target="_blank"><i class="fas fa-blog"></i> Blog</a>
                <a href="../public/resources.html" target="_blank"><i class="fas fa-folder-open"></i> Resources</a>
                <a href="../public/pricing.html" target="_blank"><i class="fas fa-tags"></i> Pricing</a>
                <a href="../public/privacy.html" target="_blank"><i class="fas fa-shield-alt"></i> Privacy</a>
                <a href="../public/terms.html" target="_blank"><i class="fas fa-file-contract"></i> Terms</a>
            </div>
            <div class="footer-info">
                <p>&copy; 2026 My School System. All rights reserved.</p>
                <p>My School System - Odebunmi Tawwab</p>
            </div>
            <div class="footer-social">
                <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://twitter.com" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://linkedin.com" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
        </div>
    </footer>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="../assets/js/storage.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/core.js"></script>
    <script src="../assets/js/attendance.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/chat.js"></script>
    <script src="../assets/js/qr.js"></script>
    <script src="../assets/js/idcard.js"></script>
    <script src="../assets/js/finance.js"></script>
    <script src="../assets/js/reports.js"></script>
    <script src="../assets/js/calendar.js"></script>
    <script src="../assets/js/export.js"></script>
    <script>
        // Direct export functions for admin reports
        window.AdminReportsExport = function(format) {
            try {
                const schoolId = Auth.getCurrentSchoolId();
                const school = Auth.getSchool();
                if (!schoolId) { Toast.error('No school selected'); return; }
                
                // Get report type from hidden field (set by Generate Report button)
                let reportType = document.getElementById('currentReportType')?.value;
                
                // Fallback: try to get from Reports object
                if (!reportType && typeof Reports !== 'undefined' && Reports.currentReportType) {
                    reportType = Reports.currentReportType;
                }
                
                if (!reportType) { 
                    Toast.error('Please click "Generate Report" first, then try export'); 
                    return; 
                }
                
                const getEl = (id) => document.getElementById(id);
                const classVal = getEl('filterClass')?.value;
                const studentVal = getEl('filterStudent')?.value;
                const termVal = getEl('filterTerm')?.value;
                const yearVal = getEl('filterYear')?.value;
                
                let csv = '';
                let filename = '';
                
                if (reportType === 'student' && studentVal && termVal && yearVal) {
                    const student = Storage.getItemById('students', studentVal);
                    const scores = Storage.getScores(schoolId, studentVal).filter(s => s.term === termVal && s.year === parseInt(yearVal));
                    csv = 'Subject,Type,Score,Grade\n';
                    scores.forEach(s => {
                        const grade = s.score >= 90 ? 'A' : s.score >= 80 ? 'B' : s.score >= 70 ? 'C' : s.score >= 60 ? 'D' : s.score >= 50 ? 'E' : 'F';
                        csv += `${s.subject},${s.type},${s.score},${grade}\n`;
                    });
                    filename = `student_report_${student?.name?.replace(/\s/g,'_') || 'student'}_${termVal}_${yearVal}.csv`;
                } else if (reportType === 'class' && classVal && termVal && yearVal) {
                    const students = Storage.getStudentsByClass(schoolId, classVal);
                    csv = 'Student,Subject,Type,Score\n';
                    students.forEach(student => {
                        const scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                        if (scores.length === 0) {
                            csv += `${student.name},N/A,N/A,0\n`;
                        } else {
                            scores.forEach(s => {
                                csv += `${student.name},${s.subject},${s.type},${s.score}\n`;
                            });
                        }
                    });
                    filename = `class_scores_${classVal}_${termVal}_${yearVal}.csv`;
                } else if (reportType === 'attendance' && termVal && yearVal) {
                    const classFilter = classVal || '';
                    const students = classFilter ? Storage.getStudentsByClass(schoolId, classFilter) : Storage.getStudents(schoolId);
                    const attendance = Storage.getAttendance(schoolId).filter(a => a.term === termVal && a.year === parseInt(yearVal));
                    csv = 'Student,Class,Present,Absent,Total,Percentage\n';
                    students.forEach(student => {
                        const stuAtt = attendance.filter(a => a.studentId === student.id);
                        const present = stuAtt.filter(a => a.status === 'present').length;
                        const absent = stuAtt.filter(a => a.status === 'absent').length;
                        const total = present + absent;
                        const pct = total > 0 ? Math.round((present / total) * 100) : 0;
                        csv += `${student.name},${student.class},${present},${absent},${total},${pct}%\n`;
                    });
                    filename = `attendance_${classFilter || 'all'}_${termVal}_${yearVal}.csv`;
                } else if (reportType === 'scores' && classVal && termVal && yearVal) {
                    const students = Storage.getStudentsByClass(schoolId, classVal);
                    const scoreTypeFilter = getEl('filterScoreType')?.value || 'all';
                    csv = 'Student,Subject,Type,Score\n';
                    students.forEach(student => {
                        let scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                        if (scoreTypeFilter !== 'all') scores = scores.filter(s => s.type === scoreTypeFilter);
                        if (scores.length === 0) {
                            csv += `${student.name},N/A,N/A,0\n`;
                        } else {
                            scores.forEach(s => {
                                csv += `${student.name},${s.subject},${s.type},${s.score}\n`;
                            });
                        }
                    });
                    filename = `scores_${classVal}_${termVal}_${yearVal}.csv`;
                } else if (reportType === 'finance') {
                    const financeType = document.getElementById('filterFinanceType')?.value || 'all';
                    const dateFrom = document.getElementById('filterDateFrom')?.value || '';
                    const dateTo = document.getElementById('filterDateTo')?.value || '';
                    
                    const transactions = Storage.getFinance(schoolId);
                    let filtered = transactions;
                    
                    if (financeType && financeType !== 'all') {
                        filtered = filtered.filter(t => t.type === financeType);
                    }
                    if (dateFrom) {
                        filtered = filtered.filter(t => new Date(t.date) >= new Date(dateFrom));
                    }
                    if (dateTo) {
                        filtered = filtered.filter(t => new Date(t.date) <= new Date(dateTo));
                    }
                    
                    csv = 'Type,Description,Category,Amount,Date,Payment Method\n';
                    filtered.forEach(t => {
                        csv += `${t.type},${t.description},${t.category},${t.amount},${t.date},${t.paymentMethod || 'cash'}\n`;
                    });
                    filename = `finance_report_${dateFrom || 'start'}_${dateTo || 'end'}.csv`;
                } else if (reportType === 'subject') {
                    const subject = document.getElementById('filterSubject')?.value;
                    const term = document.getElementById('filterTerm')?.value;
                    const year = document.getElementById('filterYear')?.value;
                    
                    if (subject && term && year) {
                        csv = 'Student,Class,Score\n';
                        const students = Storage.getStudents(schoolId);
                        students.forEach(student => {
                            const scores = Storage.getScores(schoolId, student.id).filter(s => s.subject === subject && s.term === term && s.year === parseInt(year));
                            if (scores.length > 0) {
                                scores.forEach(s => {
                                    csv += `${student.name},${student.class},${s.score}\n`;
                                });
                            }
                        });
                        filename = `subject_report_${subject}_${term}_${year}.csv`;
                    }
                }
                
                if (csv) {
                    csv += `\nMy School System - Odebunmi Tawwab`;
                    
                    if (format === 'csv') {
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                        Toast.success('Report exported to CSV');
                    } else if (format === 'doc') {
                        const content = generateReportHTML(reportType, school, schoolId, classVal, studentVal, termVal, yearVal);
                        const fullHtml = `<!DOCTYPE html><html><head><title>Report</title></head><body>${content}</body></html>`;
                        const blob = new Blob([fullHtml], { type: 'application/msword' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${reportType}_${new Date().toISOString().split('T')[0]}.doc`;
                        a.click();
                        URL.revokeObjectURL(url);
                        Toast.success('Report exported to DOC');
                    } else if (format === 'pdf') {
                        const content = generateReportHTML(reportType, school, schoolId, classVal, studentVal, termVal, yearVal);
                        const temp = document.createElement('div');
                        temp.innerHTML = content;
                        document.body.appendChild(temp);
                        
                        if (window.html2canvas && window.jspdf) {
                            html2canvas(temp, { scale: 2 }).then(canvas => {
                                const imgData = canvas.toDataURL('image/png');
                                const pdf = new window.jspdf.jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'pt', format: [canvas.width, canvas.height] });
                                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                                pdf.save(`report_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`);
                                document.body.removeChild(temp);
                                Toast.success('Report exported to PDF');
                            }).catch(err => {
                                document.body.removeChild(temp);
                                Toast.error('Error generating PDF');
                            });
                        } else {
                            const fullHtml = `<!DOCTYPE html><html><head><title>Report</title></head><body>${content}</body></html>`;
                            const printWindow = window.open('', '_blank');
                            printWindow.document.write(fullHtml);
                            printWindow.document.close();
                            printWindow.print();
                            document.body.removeChild(temp);
                            Toast.success('Report opened for printing/saving as PDF');
                        }
                    }
                } else {
                    Toast.error('Please select required fields for export');
                }
            } catch(e) {
                console.error('Export error:', e);
                Toast.error('Export error: ' + e.message);
            }
        };
        
        function generateReportHTML(reportType, school, schoolId, classVal, studentVal, termVal, yearVal) {
            let html = '';
            
            if (reportType === 'student' && studentVal) {
                const student = Storage.getItemById('students', studentVal);
                const scores = Storage.getScores(schoolId, studentVal).filter(s => s.term === termVal && s.year === parseInt(yearVal));
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Student Report - ${termVal} ${yearVal}</h3>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr><td><strong>Student:</strong> ${student?.name || 'N/A'}</td><td><strong>Class:</strong> ${student?.class || 'N/A'}</td></tr>
                    </table>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Subject</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Type</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Grade</th>
                        </tr>
                        ${scores.map(s => {
                            const grade = s.score >= 90 ? 'A' : s.score >= 80 ? 'B' : s.score >= 70 ? 'C' : s.score >= 60 ? 'D' : s.score >= 50 ? 'E' : 'F';
                            return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${s.subject}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.type}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td><td style="padding: 8px; border: 1px solid #ddd;">${grade}</td></tr>`;
                        }).join('')}
                    </table>
                    <p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p>
                </div>`;
            } else if (reportType === 'class' && classVal) {
                const students = Storage.getStudentsByClass(schoolId, classVal);
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Class Report - ${classVal} ${termVal} ${yearVal}</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Subject</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Type</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                        </tr>`;
                students.forEach(student => {
                    const scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                    if (scores.length === 0) {
                        html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">0</td></tr>`;
                    } else {
                        scores.forEach(s => {
                            html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.subject}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.type}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td></tr>`;
                        });
                    }
                });
                html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
            } else if (reportType === 'attendance') {
                const classFilter = classVal || '';
                const students = classFilter ? Storage.getStudentsByClass(schoolId, classFilter) : Storage.getStudents(schoolId);
                const attendance = Storage.getAttendance(schoolId).filter(a => a.term === termVal && a.year === parseInt(yearVal));
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Attendance Report - ${termVal} ${yearVal}</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Class</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Present</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Absent</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Total</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">%</th>
                        </tr>`;
                students.forEach(student => {
                    const stuAtt = attendance.filter(a => a.studentId === student.id);
                    const present = stuAtt.filter(a => a.status === 'present').length;
                    const absent = stuAtt.filter(a => a.status === 'absent').length;
                    const total = present + absent;
                    const pct = total > 0 ? Math.round((present / total) * 100) : 0;
                    html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${student.class}</td><td style="padding: 8px; border: 1px solid #ddd;">${present}</td><td style="padding: 8px; border: 1px solid #ddd;">${absent}</td><td style="padding: 8px; border: 1px solid #ddd;">${total}</td><td style="padding: 8px; border: 1px solid #ddd;">${pct}%</td></tr>`;
                });
                html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
            } else if (reportType === 'scores' && classVal) {
                const students = Storage.getStudentsByClass(schoolId, classVal);
                const getEl = (id) => document.getElementById(id);
                const scoreTypeFilter = getEl('filterScoreType')?.value || 'all';
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Scores Report - ${classVal} ${termVal} ${yearVal}</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Subject</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Type</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                        </tr>`;
                students.forEach(student => {
                    let scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                    if (scoreTypeFilter !== 'all') scores = scores.filter(s => s.type === scoreTypeFilter);
                    if (scores.length === 0) {
                        html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">0</td></tr>`;
                    } else {
                        scores.forEach(s => {
                            html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.subject}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.type}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td></tr>`;
                        });
                    }
                });
                html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
            } else if (reportType === 'finance') {
                const financeType = document.getElementById('filterFinanceType')?.value || 'all';
                const dateFrom = document.getElementById('filterDateFrom')?.value || '';
                const dateTo = document.getElementById('filterDateTo')?.value || '';
                
                const transactions = Storage.getFinance(schoolId);
                let filtered = transactions;
                
                if (financeType && financeType !== 'all') {
                    filtered = filtered.filter(t => t.type === financeType);
                }
                if (dateFrom) {
                    filtered = filtered.filter(t => new Date(t.date) >= new Date(dateFrom));
                }
                if (dateTo) {
                    filtered = filtered.filter(t => new Date(t.date) <= new Date(dateTo));
                }
                
                const income = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
                const expenses = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
                const balance = income - expenses;
                
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Financial Report ${dateFrom || dateTo ? `- ${dateFrom} to ${dateTo}` : ''}</h3>
                    <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                        <div style="background: #dcfce7; padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="margin: 0; color: #166534;">Income</p>
                            <p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #16a34a;">₦${income.toLocaleString()}</p>
                        </div>
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="margin: 0; color: #991b1b;">Expenses</p>
                            <p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #dc2626;">₦${expenses.toLocaleString()}</p>
                        </div>
                        <div style="background: #e0e7ff; padding: 15px; border-radius: 8px; text-align: center;">
                            <p style="margin: 0; color: #3730a3;">Balance</p>
                            <p style="margin: 5px 0; font-size: 20px; font-weight: bold; color: #4f46e5;">₦${balance.toLocaleString()}</p>
                        </div>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Type</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Description</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Category</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Amount</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Date</th>
                        </tr>`;
                filtered.slice(0, 50).forEach(t => {
                    html += `<tr>
                        <td style="padding: 8px; border: 1px solid #ddd; color: ${t.type === 'income' ? '#16a34a' : '#dc2626'};">${t.type}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${t.description}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${t.category}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">₦${t.amount.toLocaleString()}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${t.date}</td>
                    </tr>`;
                });
                html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
            } else if (reportType === 'subject') {
                const subject = document.getElementById('filterSubject')?.value;
                const term = document.getElementById('filterTerm')?.value;
                const year = document.getElementById('filterYear')?.value;
                
                const students = Storage.getStudents(schoolId);
                html = `<div style="padding: 20px; font-family: Arial, sans-serif;">
                    <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                    <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                    <h3 style="text-align: center; margin: 20px 0;">Subject Report - ${subject || 'All'} ${term || ''} ${year || ''}</h3>
                    <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                        <tr style="background: #16a34a; color: white;">
                            <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Class</th>
                            <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                        </tr>`;
                students.forEach(student => {
                    const scores = Storage.getScores(schoolId, student.id).filter(s => (!subject || s.subject === subject) && (!term || s.term === term) && (!year || s.year === parseInt(year)));
                    if (scores.length > 0) {
                        scores.forEach(s => {
                            html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${student.class}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td></tr>`;
                        });
                    }
                });
                html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
            }
            
            return html;
        }
    </script>
    <script>
        const Admin = {
            init() {
                if (!Auth.checkRole(['school_admin', 'super_admin'])) {
                    window.location.href = '../login.html';
                    return;
                }
                const user = Auth.getCurrentUser();
                document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('navUserName').textContent = user.name;
                document.getElementById('currentUserAvatar').textContent = Utils.getInitials(user.name);
                document.getElementById('navAvatar').textContent = Utils.getInitials(user.name);
                displayAnnouncementBanner();
                this.loadDashboard();
                this.setupEventListeners();
                this.applyFeatureRestrictions();
            },
            
            applyFeatureRestrictions() {
                const restrictions = [
                    { feature: 'chat', navPage: 'chat' },
                    { feature: 'downloads', navPage: null },
                    { feature: 'scores_entry', navPage: 'scores' },
                    { feature: 'attendance_qr', navPage: 'attendance' },
                    { feature: 'id_cards', navPage: 'idcards' },
                    { feature: 'finance', navPage: 'finance' },
                    { feature: 'reports', navPage: 'reports' },
                    { feature: 'question_bank', navPage: 'questions' },
                    { feature: 'create_test', navPage: 'tests' },
                    { feature: 'test_results', navPage: 'viewTestResults' },
                    { feature: 'calendar_events', navPage: 'calendar' },
                    { feature: 'print_export', navPage: null }
                ];
                
                restrictions.forEach(r => {
                    if (!Auth.hasFeature(r.feature)) {
                        if (r.navPage) {
                            const navItem = document.querySelector(`.nav-item[data-page="${r.navPage}"]`);
                            if (navItem) {
                                navItem.style.display = 'none';
                            }
                        }
                    }
                });
            },
            
            checkFeatureAccess(feature, action = 'access') {
                if (!Auth.hasFeature(feature)) {
                    const features = Auth.RESTRICTABLE_FEATURES;
                    const featureName = features[feature] || feature;
                    Toast.error(`This feature (${featureName}) has been restricted by the Super Admin.`);
                    return false;
                }
                return true;
            },
            loadDashboard() {
                const schoolId = Auth.getCurrentSchoolId();
                const students = Storage.getStudents(schoolId);
                const users = Storage.getUsers(schoolId);
                const teachers = users.filter(u => u.role === 'teacher');
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                const today = new Date().toISOString().split('T')[0];
                const attendance = Storage.getAttendance(schoolId, today);
                const present = attendance.filter(a => a.status === 'present').length;
                const percentage = students.length ? Math.round((present / students.length) * 100) : 0;
                document.getElementById('attendanceToday').textContent = percentage + '%';
                const finance = Storage.getFinance(schoolId);
                const income = finance.filter(f => f.type === 'income').reduce((s, f) => s + f.amount, 0);
                const expenses = finance.filter(f => f.type === 'expense').reduce((s, f) => s + f.amount, 0);
                const balance = income - expenses;
                document.getElementById('balanceAmount').textContent = '₦' + Utils.formatNumber(balance);
            },
            setupEventListeners() {
                const form = document.getElementById('studentForm');
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveStudent();
                });
            },
            showSection(section) {
                // Check feature access before showing section
                const featureMap = {
                    'chat': 'chat',
                    'scores': 'scores_entry',
                    'attendance': 'attendance_qr',
                    'idcards': 'id_cards',
                    'finance': 'finance',
                    'reports': 'reports'
                };
                
                if (featureMap[section] && !Auth.hasFeature(featureMap[section])) {
                    const features = Auth.RESTRICTABLE_FEATURES;
                    Toast.error(`This feature (${features[featureMap[section]]}) has been restricted by the Super Admin.`);
                    return;
                }
                
                // Hide all sections
                document.querySelectorAll('#dashboardSection, #studentsSection, #staffSection, #parentsSection, #classesSection, #subjectsSection, #scoreTypesSection, #attendanceSection, #scoresSection, #financeSection, #reportsSection, #idcardsSection, #chatSection, #helpSection, #parentAnnouncementsSection, #profileSection, #schoolSettingsSection, #viewQuestionsSection, #viewTestResultsSection').forEach(el => {
                    if (el) {
                        el.style.display = 'none';
                    }
                });
                // Show target section
                const targetEl = document.getElementById(section + 'Section');
                if (targetEl) {
                    targetEl.style.display = 'block';
                }
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === section) {
                        item.classList.add('active');
                    }
                });
                if (section === 'students') {
                    Students.loadStudents();
                }
                if (section === 'parentAnnouncements') {
                    this.loadParentAnnouncements();
                }
                if (section === 'staff') {
                    this.showStaffList();
                }
                if (section === 'parents') {
                    this.showParentsList();
                }
                if (section === 'classes') {
                    this.showClassesManagement();
                }
                if (section === 'subjects') {
                    this.showSubjectsManagement();
                }
                if (section === 'scoreTypes') {
                    this.showScoreTypesSettings();
                }
                if (section === 'attendance') {
                    Admin.initAttendanceSection();
                    Attendance.init();
                    QRScanner.renderRecentlyScanned();
                }
                if (section === 'scores') {
                    Scores.init();
                }
                if (section === 'finance') {
                    Finance.init();
                }
                if (section === 'reports') {
                    Reports.init();
                }
                if (section === 'chat') {
                    Chat.init();
                }
                if (section === 'idcards') {
                    this.loadIDCardUsers();
                }
                if (section === 'help') {
                    this.loadHelpGuide();
                }
                if (section === 'profile') {
                    Profile.init();
                }
                if (section === 'schoolSettings') {
                    this.initSchoolSettings();
                }
                if (section === 'viewQuestions') {
                    this.initViewQuestions();
                }
                if (section === 'viewTestResults') {
                    this.initViewTestResults();
                }
            },
            initViewQuestions() {
                const schoolId = Auth.getCurrentSchoolId();
                const school = Storage.getSchoolById(schoolId);
                const users = Storage.getUsers(schoolId);
                const teachers = users.filter(u => u.role === 'teacher');
                
                const teacherSelect = document.getElementById('adminQuestionFilterTeacher');
                let html = '<option value="">All Teachers</option>';
                teachers.forEach(t => {
                    html += '<option value="' + t.id + '">' + t.name + '</option>';
                });
                teacherSelect.innerHTML = html;
                
                const levelMap = {
                    'Nursery 1': 'Nursery', 'Nursery 2': 'Nursery',
                    'Primary 1': 'Primary', 'Primary 2': 'Primary', 'Primary 3': 'Primary',
                    'Primary 4': 'Primary', 'Primary 5': 'Primary', 'Primary 6': 'Primary',
                    'JSS 1': 'JSS', 'JSS 2': 'JSS', 'JSS 3': 'JSS',
                    'SS 1': 'SS', 'SS 2': 'SS', 'SS 3': 'SS'
                };
                
                const subjectSelects = ['adminQuestionFilterSubject', 'adminResultFilterSubject'];
                const classSelects = ['adminQuestionFilterClass', 'adminResultFilterClass'];
                const classes = school?.settings?.classes || [];
                const subjectsByLevel = school?.settings?.subjects || {};
                
                subjectSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let optHtml = '<option value="">All Subjects</option>';
                    Object.values(subjectsByLevel).forEach(levelSubjects => {
                        levelSubjects.forEach(subj => {
                            optHtml += '<option value="' + subj + '">' + subj + '</option>';
                        });
                    });
                    select.innerHTML = optHtml;
                });
                
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let optHtml = '<option value="">All Classes</option>';
                    classes.forEach(cls => {
                        optHtml += '<option value="' + cls + '">' + cls + '</option>';
                    });
                    select.innerHTML = optHtml;
                });
                
                this.loadAdminQuestions();
            },
            loadAdminQuestions() {
                const schoolId = Auth.getCurrentSchoolId();
                const teacherId = document.getElementById('adminQuestionFilterTeacher').value;
                const subject = document.getElementById('adminQuestionFilterSubject').value;
                const className = document.getElementById('adminQuestionFilterClass').value;
                
                let questions = Storage.getData('questions') || [];
                questions = questions.filter(q => q.schoolId === schoolId);
                
                if (teacherId) questions = questions.filter(q => q.teacherId === teacherId);
                if (subject) questions = questions.filter(q => q.subject === subject);
                if (className) questions = questions.filter(q => q.class === className);
                
                const users = Storage.getUsers(schoolId);
                
                const container = document.getElementById('adminQuestionsList');
                if (!questions.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-question-circle"></i><h3>No questions found</h3></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>#</th><th>Question</th><th>Teacher</th><th>Subject</th><th>Class</th><th>Type</th><th>Marks</th></tr></thead><tbody>';
                
                questions.forEach((q, index) => {
                    const teacher = users.find(u => u.id === q.teacherId);
                    const typeLabels = { mcq: 'MCQ', tf: 'T/F', fillblank: 'Fill Blank', essay: 'Essay' };
                    html += '<tr>';
                    html += '<td>' + (index + 1) + '</td>';
                    html += '<td>' + q.question.substring(0, 40) + (q.question.length > 40 ? '...' : '') + '</td>';
                    html += '<td>' + (teacher ? teacher.name : 'Unknown') + '</td>';
                    html += '<td>' + q.subject + '</td>';
                    html += '<td>' + q.class + '</td>';
                    html += '<td><span class="test-type-badge ' + q.testType + '">' + typeLabels[q.type] + '</span></td>';
                    html += '<td>' + q.marks + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            initViewTestResults() {
                this.initViewQuestions();
            },
            loadAdminTestResults() {
                const schoolId = Auth.getCurrentSchoolId();
                const subject = document.getElementById('adminResultFilterSubject').value;
                const className = document.getElementById('adminResultFilterClass').value;
                const testType = document.getElementById('adminResultFilterTestType').value;
                
                let results = Storage.getData('testResults') || [];
                results = results.filter(r => r.schoolId === schoolId);
                
                if (subject) results = results.filter(r => r.subject === subject);
                if (className) results = results.filter(r => r.class === className);
                if (testType) results = results.filter(r => r.testType === testType);
                
                const container = document.getElementById('adminTestResultsList');
                if (!results.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><h3>No results found</h3></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Student</th><th>Test</th><th>Subject</th><th>Class</th><th>Type</th><th>Score</th><th>Percentage</th><th>Date</th></tr></thead><tbody>';
                
                results.forEach(r => {
                    const student = Storage.getStudents(schoolId).find(s => s.id === r.studentId);
                    html += '<tr>';
                    html += '<td>' + (student ? student.name : 'Unknown') + '</td>';
                    html += '<td>' + r.testTitle + '</td>';
                    html += '<td>' + r.subject + '</td>';
                    html += '<td>' + r.class + '</td>';
                    html += '<td><span class="test-type-badge ' + r.testType + '">' + r.testType + '</span></td>';
                    html += '<td>' + r.obtainedMarks + '/' + r.totalMarks + '</td>';
                    html += '<td>' + Math.round(r.percentage) + '%</td>';
                    html += '<td>' + new Date(r.completedAt).toLocaleDateString() + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            exportTestResultsPDF() {
                this.exportAdminTestResults('PDF');
            },
            
            exportTestResultsDOC() {
                this.exportAdminTestResults('DOC');
            },
            
            exportAdminTestResults(format) {
                const schoolId = Auth.getCurrentSchoolId();
                const subject = document.getElementById('adminResultFilterSubject').value;
                const className = document.getElementById('adminResultFilterClass').value;
                const testType = document.getElementById('adminResultFilterTestType').value;
                
                let results = Storage.getData('testResults') || [];
                results = results.filter(r => r.schoolId === schoolId);
                
                if (subject) results = results.filter(r => r.subject === subject);
                if (className) results = results.filter(r => r.class === className);
                if (testType) results = results.filter(r => r.testType === testType);
                
                const school = Storage.getSchoolById(schoolId);
                const schoolName = school ? school.name : 'My School';
                
                const processedResults = results.map(r => {
                    const student = Storage.getStudents(schoolId).find(s => s.id === r.studentId);
                    return {
                        studentId: student ? student.admissionNo || student.id : 'N/A',
                        studentName: student ? student.name : 'Unknown',
                        subject: r.subject,
                        testType: r.testType,
                        totalMarks: r.totalMarks,
                        obtainedMarks: r.obtainedMarks,
                        percentage: r.percentage
                    };
                });
                
                const htmlContent = ExportUtils.generateTestResultsPrintHTML(processedResults, {
                    title: 'Test Results Report',
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                if (format === 'PDF') {
                    ExportUtils.exportToPDF(htmlContent, 'test-results.pdf');
                } else {
                    ExportUtils.exportToDOC(htmlContent, 'test-results.doc');
                }
            },
            
            initSchoolSettings() {
                const school = Auth.getSchool();
                if (school) {
                    document.getElementById('schoolIdCardColor').value = school.idCardColor || '#16a34a';
                    document.getElementById('schoolIdCardColorText').value = school.idCardColor || '#16a34a';
                    document.getElementById('schoolIdCardBackMessage').value = school.idCardBackMessage || '';
                    document.getElementById('schoolMotto').value = school.motto || '';
                    
                    if (document.getElementById('schoolName')) document.getElementById('schoolName').value = school.name || '';
                    if (document.getElementById('schoolAddress')) document.getElementById('schoolAddress').value = school.address || '';
                    if (document.getElementById('schoolPhone')) document.getElementById('schoolPhone').value = school.phone || '';
                    if (document.getElementById('schoolIdCardColor')) document.getElementById('schoolIdCardColor').value = school.idCardColor || '#16a34a';
                    if (document.getElementById('schoolEmail')) document.getElementById('schoolEmail').value = school.email || '';
                    if (document.getElementById('schoolWebsite')) document.getElementById('schoolWebsite').value = school.website || '';
                    if (document.getElementById('schoolEstablished')) document.getElementById('schoolEstablished').value = school.established || '';
                    
                    if (school.logoUrl) {
                        document.getElementById('schoolLogoPreview').style.display = 'block';
                        document.getElementById('schoolLogoImg').src = school.logoUrl;
                    }
                }
                
                window.schoolLogoRemoved = false;
                
                // Load academic year settings
                this.loadAcademicSettings();
                
                // Load preview
                this.updateSchoolSettingsPreview();
            },
            previewSchoolLogo(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('schoolLogoPreview').style.display = 'block';
                        document.getElementById('schoolLogoImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearSchoolLogo() {
                document.getElementById('schoolLogo').value = '';
                document.getElementById('schoolLogoPreview').style.display = 'none';
                document.getElementById('schoolLogoImg').src = '';
                window.schoolLogoRemoved = true;
            },
            saveSchoolSettings() {
                const schoolId = Auth.getCurrentSchoolId();
                const school = Auth.getSchool();
                
                const updates = {
                    idCardColor: document.getElementById('schoolIdCardColor').value,
                    idCardBackMessage: document.getElementById('schoolIdCardBackMessage').value.trim(),
                    motto: document.getElementById('schoolMotto').value.trim(),
                    name: document.getElementById('schoolName') ? document.getElementById('schoolName').value.trim() : school.name,
                    address: document.getElementById('schoolAddress') ? document.getElementById('schoolAddress').value.trim() : (school.address || ''),
                    phone: document.getElementById('schoolPhone') ? document.getElementById('schoolPhone').value.trim() : (school.phone || ''),
                    email: document.getElementById('schoolEmail') ? document.getElementById('schoolEmail').value.trim() : (school.email || ''),
                    website: document.getElementById('schoolWebsite') ? document.getElementById('schoolWebsite').value.trim() : (school.website || ''),
                    established: document.getElementById('schoolEstablished') ? document.getElementById('schoolEstablished').value.trim() : (school.established || '')
                };
                
                if (window.schoolLogoRemoved) {
                    updates.logoUrl = null;
                    window.schoolLogoRemoved = false;
                }
                
                const logoInput = document.getElementById('schoolLogo');
                if (logoInput && logoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updates.logoUrl = e.target.result;
                        Admin.saveSchoolSettingsData(schoolId, updates);
                    };
                    reader.readAsDataURL(logoInput.files[0]);
                } else if (!window.schoolLogoRemoved) {
                    delete updates.logoUrl;
                    Admin.saveSchoolSettingsData(schoolId, updates);
                } else {
                    Admin.saveSchoolSettingsData(schoolId, updates);
                }
            },
            saveSchoolSettingsData(schoolId, updates) {
                const result = Storage.updateItem('schools', schoolId, updates);
                if (result) {
                    Toast.success('School settings saved successfully!');
                    this.updateSchoolSettingsPreview();
                } else {
                    Toast.error('Failed to save settings');
                }
            },
            loadAcademicSettings() {
                const school = Auth.getSchool();
                if (!school) return;
                
                const currentYear = new Date().getFullYear();
                const currentMonth = new Date().getMonth();
                
                // Auto-detect current term based on month
                let detectedTerm = 'First Term';
                if (currentMonth >= 0 && currentMonth < 4) {
                    detectedTerm = 'First Term';
                } else if (currentMonth >= 4 && currentMonth < 8) {
                    detectedTerm = 'Second Term';
                } else {
                    detectedTerm = 'Third Term';
                }
                
                // Load saved values or use auto-detected values
                const savedYear = school.currentYear || currentYear.toString();
                const savedTerm = school.currentTerm || detectedTerm;
                const savedAutoAdvance = school.autoAdvanceTerm !== false;
                
                document.getElementById('schoolCurrentYear').value = savedYear;
                document.getElementById('schoolCurrentTerm').value = savedTerm;
                document.getElementById('schoolAutoAdvance').checked = savedAutoAdvance;
            },
            saveAcademicSettings() {
                const schoolId = Auth.getCurrentSchoolId();
                const school = Auth.getSchool();
                
                const updates = {
                    currentYear: document.getElementById('schoolCurrentYear').value,
                    currentTerm: document.getElementById('schoolCurrentTerm').value,
                    autoAdvanceTerm: document.getElementById('schoolAutoAdvance').checked
                };
                
                const result = Storage.updateItem('schools', schoolId, updates);
                if (result) {
                    Toast.success('Academic settings saved successfully!');
                } else {
                    Toast.error('Failed to save academic settings');
                }
            },
            updateSchoolSettingsPreview() {
                const school = Auth.getSchool();
                if (!school) return;
                
                const schoolColor = school.idCardColor || '#16a34a';
                const schoolLogo = school.logoUrl || IDCard.getDefaultLogo();
                
                const portraitHtml = `
                    <div style="width:200px;height:310px;border:2px solid ${schoolColor};border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1);font-family:'Segoe UI',Arial,sans-serif;">
                        <div style="background:${schoolColor};padding:10px;text-align:center;">
                            <img src="${schoolLogo}" style="width:30px;height:30px;border-radius:50%;background:#fff;padding:2px;object-fit:contain;">
                            <div style="font-size:11px;color:#fff;font-weight:700;margin-top:4px;">${school.name}</div>
                            <div style="font-size:6px;color:rgba(255,255,255,0.8);">ID CARD</div>
                        </div>
                        <div style="padding:10px;text-align:center;">
                            <div style="width:50px;height:55px;background:#e2e8f0;border-radius:4px;margin:0 auto 6px;"></div>
                            <div style="font-size:10px;font-weight:700;">Student Name</div>
                            <div style="font-size:8px;color:#64748b;">Class: JSS 1A</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="width:45px;height:45px;background:#e2e8f0;margin:0 auto;border-radius:3px;"></div>
                        </div>
                    </div>`;
                
                const landscapeHtml = `
                    <div style="width:300px;height:170px;border:2px solid ${schoolColor};border-radius:10px;overflow:hidden;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.1);font-family:'Segoe UI',Arial,sans-serif;display:flex;">
                        <div style="width:80px;background:${schoolColor};padding:8px;text-align:center;">
                            <img src="${schoolLogo}" style="width:25px;height:25px;border-radius:50%;background:#fff;padding:2px;object-fit:contain;">
                            <div style="font-size:8px;color:#fff;font-weight:700;margin-top:4px;">${school.name}</div>
                        </div>
                        <div style="flex:1;padding:8px;display:flex;align-items:center;">
                            <div style="flex:1;">
                                <div style="font-size:11px;font-weight:700;">Student Name</div>
                                <div style="font-size:8px;color:#64748b;">Class: JSS 1A</div>
                            </div>
                            <div style="text-align:center;">
                                <div style="width:40px;height:45px;background:#e2e8f0;border-radius:3px;margin-bottom:3px;"></div>
                                <div style="width:35px;height:35px;background:#e2e8f0;border-radius:2px;"></div>
                            </div>
                        </div>
                    </div>`;
                
                document.getElementById('schoolSettingsPortraitPreview').innerHTML = '<div><p style="text-align:center;font-size:12px;margin-bottom:8px;">Portrait</p>' + portraitHtml + '</div>';
                document.getElementById('schoolSettingsLandscapePreview').innerHTML = '<div><p style="text-align:center;font-size:12px;margin-bottom:8px;">Landscape</p>' + landscapeHtml + '</div>';
            },
            loadHelpGuide() {
                const role = 'school_admin';
                const content = Storage.getHelpContent(role);
                const container = document.getElementById('helpGuideContainer');
                if (!content || !content.sections || !content.sections.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-question-circle"></i><h3>No help content available</h3><p>Contact your administrator for assistance.</p></div>';
                    return;
                }
                let html = `
                    <div class="help-guide-container">
                        <div class="help-guide-header">
                            <h2>${content.title}</h2>
                        </div>
                        <div class="help-guide-accordion">
                `;
                content.sections.forEach((section, index) => {
                    html += `
                        <div class="help-accordion-item ${index === 0 ? 'active' : ''}">
                            <div class="help-accordion-header" onclick="this.parentElement.classList.toggle('active')">
                                <div class="help-accordion-title">
                                    <i class="fas ${section.icon || 'fa-book'}"></i>
                                    <span>${section.title}</span>
                                </div>
                                <i class="fas fa-chevron-down help-accordion-arrow"></i>
                            </div>
                            <div class="help-accordion-body">
                                <div class="help-content">${section.content}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
                container.innerHTML = html;
            },
            loadParentAnnouncements() {
                const schoolId = Auth.getCurrentSchoolId();
                const announcements = Storage.getParentAnnouncements(schoolId);
                const container = document.getElementById('parentAnnouncementsList');
                
                if (!announcements || announcements.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No announcements yet</p></div>';
                    return;
                }
                
                let html = '';
                announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(ann => {
                    const date = new Date(ann.createdAt).toLocaleDateString() + ' ' + new Date(ann.createdAt).toLocaleTimeString();
                    html += `
                        <div class="announcement-item" style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <p style="margin: 0 0 8px;">${ann.message}</p>
                                    <small class="text-muted">${date}</small>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="Admin.deleteParentAnnouncement('${ann.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },
            createParentAnnouncement() {
                const message = document.getElementById('parentAnnouncementMessage').value.trim();
                if (!message) {
                    Toast.error('Please enter a message');
                    return;
                }
                const schoolId = Auth.getCurrentSchoolId();
                const user = Auth.getCurrentUser();
                Storage.addParentAnnouncement(message, schoolId, user.id);
                document.getElementById('parentAnnouncementMessage').value = '';
                Toast.success('Announcement posted to parents');
                this.loadParentAnnouncements();
            },
            deleteParentAnnouncement(id) {
                Storage.deleteParentAnnouncement(id);
                Toast.success('Announcement removed');
                this.loadParentAnnouncements();
            },
            saveStudent() {
                const form = document.getElementById('studentForm');
                const data = Form.getData('studentForm');
                if (!data.name || !data.class) {
                    Toast.error('Please fill required fields');
                    return;
                }
                const passportInput = document.getElementById('studentPassport');
                if (passportInput && passportInput.files[0]) {
                    Admin.processStudentPassport(passportInput.files[0], (passportUrl) => {
                        data.passportUrl = passportUrl;
                        Students.add(data);
                        Admin.clearStudentPassportForm();
                    });
                } else {
                    Students.add(data);
                }
            },
            processStudentPassport(file, callback) {
                if (file.size > 500 * 1024) {
                    Toast.error('Image size must be less than 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    callback(e.target.result);
                };
                reader.readAsDataURL(file);
            },
            previewStudentPassport(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('studentPassportPreview').style.display = 'block';
                        document.getElementById('studentPassportImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearStudentPassport() {
                document.getElementById('studentPassport').value = '';
                document.getElementById('studentPassportPreview').style.display = 'none';
                document.getElementById('studentPassportImg').src = '';
            },
            clearStudentPassportForm() {
                document.getElementById('studentForm').reset();
                Admin.clearStudentPassport();
            },
            showAddStaffModal(role) {
                const titles = {
                    teacher: 'Add Teacher',
                    accountant: 'Add Accountant',
                    director: 'Add Director'
                };
                document.getElementById('addStaffModalTitle').textContent = titles[role] || 'Add Staff';
                document.getElementById('staffRole').value = role;
                document.getElementById('staffForm').reset();
                Admin.clearStaffPassport();
                const classes = Storage.getSchoolClasses(Auth.getCurrentSchoolId());
                const classSelect = document.getElementById('staffClass');
                classSelect.innerHTML = '<option value="">Select Class</option>' + 
                    classes.map(c => `<option value="${c}">${c}</option>`).join('');
                document.getElementById('staffClassAssign').style.display = (role === 'teacher') ? 'block' : 'none';
                Modal.show('addStaffModal');
            },
            showParentsList() {
                const schoolId = Auth.getCurrentSchoolId();
                const users = Storage.getUsers(schoolId);
                const parents = users.filter(u => u.role === 'parent');
                const students = Storage.getStudents(schoolId);
                const container = document.getElementById('parentsTable');
                
                if (parents.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-user-friends"></i><h3>No Parent Accounts</h3><p>Add parent accounts so they can access the parent portal to view their children\'s progress.</p></div>';
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Linked Children</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                parents.forEach(parent => {
                    const children = students.filter(s => s.parentPhone === parent.phone || s.parentEmail === parent.email);
                    const childNames = children.map(c => c.name).join(', ') || 'None';
                    
                    html += `
                        <tr>
                            <td>${parent.name}</td>
                            <td>${parent.email || '-'}</td>
                            <td>${parent.phone || '-'}</td>
                            <td>${childNames}</td>
                            <td><span class="badge badge-${parent.status === 'active' ? 'success' : 'warning'}">${parent.status}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline" title="Edit Parent" onclick="Admin.editParent('${parent.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-${parent.status === 'active' ? 'warning' : 'success'}" title="${parent.status === 'active' ? 'Deactivate' : 'Activate'}" onclick="Admin.toggleParentStatus('${parent.id}')"><i class="fas fa-${parent.status === 'active' ? 'ban' : 'check'}"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            showAddParentModal() {
                const schoolId = Auth.getCurrentSchoolId();
                const students = Storage.getStudents(schoolId);
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'addParentModal';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-user-plus"></i> Add Parent Account</h3>
                            <button class="modal-close" onclick="document.getElementById('addParentModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Parent Name</label>
                                <input type="text" id="parentName" class="form-control" placeholder="Enter parent's name">
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Email</label>
                                    <input type="email" id="parentEmail" class="form-control" placeholder="Enter email">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" id="parentPhone" class="form-control" placeholder="Enter phone number">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Password</label>
                                <input type="password" id="parentPassword" class="form-control" placeholder="Enter password (min 6 characters)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Link to Child(ren)</label>
                                <select id="parentChildren" class="form-control" multiple style="height: 100px;">
                                    ${students.map(s => `<option value="${s.id}">${s.name} - ${s.class}</option>`).join('')}
                                </select>
                                <small class="text-muted">Hold Ctrl/Cmd to select multiple children</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('addParentModal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="Admin.saveParent()"><i class="fas fa-save"></i> Save Parent</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            },
            saveParent() {
                const name = document.getElementById('parentName').value.trim();
                const email = document.getElementById('parentEmail').value.trim();
                const phone = document.getElementById('parentPhone').value.trim();
                const password = document.getElementById('parentPassword').value;
                const childrenSelect = document.getElementById('parentChildren');
                const selectedChildren = Array.from(childrenSelect.selectedOptions).map(opt => opt.value);
                
                if (!name || !password) {
                    Toast.error('Name and password are required');
                    return;
                }
                
                if (password.length < 6) {
                    Toast.error('Password must be at least 6 characters');
                    return;
                }
                
                const schoolId = Auth.getCurrentSchoolId();
                const existingUsers = Storage.getUsers(schoolId);
                
                if (existingUsers.some(u => u.email === email && email)) {
                    Toast.error('A user with this email already exists');
                    return;
                }
                
                const parent = {
                    id: Storage.generateId(),
                    name,
                    email,
                    phone,
                    username: email || phone,
                    password: Storage.hashPassword(password),
                    role: 'parent',
                    schoolId,
                    status: 'active',
                    createdAt: new Date().toISOString()
                };
                
                Storage.addItem('users', parent);
                
                selectedChildren.forEach(studentId => {
                    const student = Storage.getItemById('students', studentId);
                    if (student) {
                        student.parentPhone = phone;
                        student.parentEmail = email;
                        Storage.updateItem('students', studentId, student);
                    }
                });
                
                Toast.success('Parent account created successfully');
                document.getElementById('addParentModal').remove();
                this.showParentsList();
            },
            editParent(parentId) {
                const parent = Storage.getItemById('users', parentId);
                if (!parent) return;
                
                document.getElementById('editParentId').value = parent.id;
                document.getElementById('editParentName').value = parent.name || '';
                document.getElementById('editParentEmail').value = parent.email || '';
                document.getElementById('editParentPhone').value = parent.phone || '';
                document.getElementById('editParentPassword').value = '';
                
                Modal.show('editParentModal');
            },
            updateParent() {
                const parentId = document.getElementById('editParentId').value;
                const name = document.getElementById('editParentName').value.trim();
                const email = document.getElementById('editParentEmail').value.trim();
                const phone = document.getElementById('editParentPhone').value.trim();
                const password = document.getElementById('editParentPassword').value;
                
                if (!name) {
                    Toast.error('Name is required');
                    return;
                }
                
                const updates = { name, email, phone };
                
                if (password && password.length >= 6) {
                    updates.password = Storage.hashPassword(password);
                }
                
                Storage.updateItem('users', parentId, updates);
                Toast.success('Parent account updated');
                Modal.hide('editParentModal');
                this.showParentsList();
            },
            toggleParentStatus(parentId) {
                const parent = Storage.getItemById('users', parentId);
                if (!parent) return;
                
                const newStatus = parent.status === 'active' ? 'inactive' : 'active';
                if (!confirm(`Are you sure you want to ${newStatus === 'active' ? 'activate' : 'deactivate'} this parent account?`)) return;
                
                Storage.updateItem('users', parentId, { status: newStatus });
                Toast.success(`Parent account ${newStatus === 'active' ? 'activated' : 'deactivated'}`);
                this.showParentsList();
            },
            processStaffPassport(file, callback) {
                if (file.size > 500 * 1024) {
                    Toast.error('Image size must be less than 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    callback(e.target.result);
                };
                reader.readAsDataURL(file);
            },
            previewStaffPassport(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('staffPassportPreview').style.display = 'block';
                        document.getElementById('staffPassportImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearStaffPassport() {
                const passportInput = document.getElementById('staffPassport');
                if (passportInput) passportInput.value = '';
                const preview = document.getElementById('staffPassportPreview');
                if (preview) preview.style.display = 'none';
                const img = document.getElementById('staffPassportImg');
                if (img) img.src = '';
            },
            saveStaff() {
                const role = document.getElementById('staffRole').value;
                const name = document.getElementById('staffName').value.trim();
                const username = document.getElementById('staffUsername').value.trim();
                const email = document.getElementById('staffEmail').value.trim();
                const phone = document.getElementById('staffPhone').value.trim();
                const password = document.getElementById('staffPassword').value;
                const gender = document.getElementById('staffGender').value;
                const address = document.getElementById('staffAddress').value.trim();
                const assignedClass = document.getElementById('staffClass').value;
                if (!name || !username || !email || !phone || !password) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                const schoolId = Auth.getCurrentSchoolId();
                const existingUsers = Storage.getUsers(schoolId);
                if (existingUsers.some(u => u.username === username)) {
                    Toast.error('Username already exists');
                    return;
                }
                if (existingUsers.some(u => u.email === email)) {
                    Toast.error('Email already exists');
                    return;
                }
                const roleLabel = role.charAt(0).toUpperCase() + role.slice(1);
                const userData = {
                    name,
                    username,
                    email,
                    phone,
                    password,
                    role,
                    schoolId,
                    gender,
                    address,
                    assignedClass: assignedClass || null,
                    className: assignedClass || null
                };
                
                const passportInput = document.getElementById('staffPassport');
                if (passportInput && passportInput.files[0]) {
                    Admin.processStaffPassport(passportInput.files[0], (passportUrl) => {
                        userData.passportUrl = passportUrl;
                        Admin.saveStaffData(userData, roleLabel);
                        Admin.clearStaffPassport();
                    });
                } else {
                    Admin.saveStaffData(userData, roleLabel);
                }
            },
            saveStaffData(userData, roleLabel) {
                const result = Auth.registerUser(userData);
                if (result.success) {
                    const currentUser = Auth.getCurrentUser();
                    Auth.logActivity(currentUser.id, 'staff_add', `Added new ${userData.role}: ${userData.name}`);
                    Auth.addNotification(currentUser.id, `Added new ${userData.role}: ${userData.name}`, 'success');
                    Toast.success(`${roleLabel} added successfully! Login: ${userData.username}`);
                    Modal.hide('addStaffModal');
                    this.showStaffList();
                    Admin.clearStaffPassport();
                    document.getElementById('staffForm').reset();
                } else {
                    Toast.error(result.message);
                }
            },
            editStaff(userId) {
                const schoolId = Auth.getCurrentSchoolId();
                const users = Storage.getUsers(schoolId);
                const user = users.find(u => u.id === userId);
                if (!user) {
                    Toast.error('Staff not found');
                    return;
                }
                document.getElementById('editStaffId').value = user.id;
                document.getElementById('editStaffName').value = user.name || '';
                document.getElementById('editStaffUsername').value = user.username || '';
                document.getElementById('editStaffEmail').value = user.email || '';
                document.getElementById('editStaffPhone').value = user.phone || '';
                document.getElementById('editStaffGender').value = user.gender || '';
                document.getElementById('editStaffAddress').value = user.address || '';
                document.getElementById('editStaffPassword').value = '';
                
                if (user.passportUrl) {
                    document.getElementById('editStaffPassportPreview').style.display = 'block';
                    document.getElementById('editStaffPassportImg').src = user.passportUrl;
                } else {
                    Admin.clearEditStaffPassport();
                }
                
                const classes = Storage.getSchoolClasses(schoolId);
                const classSelect = document.getElementById('editStaffClass');
                classSelect.innerHTML = '<option value="">Select Class</option>' + 
                    classes.map(c => `<option value="${c}" ${c === user.className ? 'selected' : ''}>${c}</option>`).join('');
                document.getElementById('editStaffClassAssign').style.display = (user.role === 'teacher') ? 'block' : 'none';
                Modal.show('editStaffModal');
            },
            previewEditStaffPassport(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('editStaffPassportPreview').style.display = 'block';
                        document.getElementById('editStaffPassportImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearEditStaffPassport() {
                const passportInput = document.getElementById('editStaffPassport');
                if (passportInput) passportInput.value = '';
                const preview = document.getElementById('editStaffPassportPreview');
                if (preview) preview.style.display = 'none';
                const img = document.getElementById('editStaffPassportImg');
                if (img) img.src = '';
            },
            saveEditedStaff() {
                const userId = document.getElementById('editStaffId').value;
                const name = document.getElementById('editStaffName').value.trim();
                const username = document.getElementById('editStaffUsername').value.trim();
                const email = document.getElementById('editStaffEmail').value.trim();
                const phone = document.getElementById('editStaffPhone').value.trim();
                const password = document.getElementById('editStaffPassword').value;
                const gender = document.getElementById('editStaffGender').value;
                const address = document.getElementById('editStaffAddress').value.trim();
                const assignedClass = document.getElementById('editStaffClass').value;
                if (!name || !username || !email || !phone) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                const schoolId = Auth.getCurrentSchoolId();
                const users = Storage.getUsers(schoolId);
                const existingUser = users.find(u => u.id === userId);
                if (!existingUser) {
                    Toast.error('Staff not found');
                    return;
                }
                if (users.some(u => u.username === username && u.id !== userId)) {
                    Toast.error('Username already exists');
                    return;
                }
                if (users.some(u => u.email === email && u.id !== userId)) {
                    Toast.error('Email already exists');
                    return;
                }
                const updates = {
                    name,
                    username,
                    email,
                    phone,
                    gender,
                    address,
                    className: assignedClass || null
                };
                if (password && password.length >= 6) {
                    updates.password = password;
                }
                
                const passportInput = document.getElementById('editStaffPassport');
                if (passportInput && passportInput.files[0]) {
                    Admin.processStaffPassport(passportInput.files[0], (passportUrl) => {
                        updates.passportUrl = passportUrl;
                        Admin.saveEditedStaffData(userId, updates, existingUser, password);
                    });
                } else {
                    Admin.saveEditedStaffData(userId, updates, existingUser, password);
                }
            },
            saveEditedStaffData(userId, updates, existingUser, password) {
                const result = Storage.updateItem('users', userId, updates);
                if (result) {
                    const currentUser = Auth.getCurrentUser();
                    Auth.logActivity(currentUser.id, 'staff_edit', `Updated ${existingUser.role}: ${updates.name}`);
                    Auth.addNotification(currentUser.id, `${existingUser.role.charAt(0).toUpperCase() + existingUser.role.slice(1)} details updated`, 'info');
                    Toast.success('Staff details updated successfully!');
                    if (password && password.length >= 6) {
                        Toast.success(`Password reset! New password: ${password}`);
                    }
                    Modal.hide('editStaffModal');
                    this.showStaffList();
                    Admin.clearEditStaffPassport();
                } else {
                    Toast.error('Failed to update staff');
                }
            },
            showStaffList(filter = 'all') {
                const schoolId = Auth.getCurrentSchoolId();
                let users = Storage.getUsers(schoolId);
                if (filter === 'teachers') {
                    users = users.filter(u => u.role === 'teacher');
                } else if (filter === 'accountants') {
                    users = users.filter(u => u.role === 'accountant');
                } else if (filter === 'directors') {
                    users = users.filter(u => u.role === 'director');
                } else {
                    users = users.filter(u => ['teacher', 'accountant', 'director'].includes(u.role));
                }
                const container = document.getElementById('staffTable');
                if (!users.length) {
                    container.innerHTML = '<div class="empty-state"><p>No staff found</p></div>';
                    return;
                }
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Email</th><th>Phone</th><th>Actions</th></tr></thead><tbody>';
                users.forEach(user => {
                    const roleBadge = {
                        teacher: 'primary',
                        accountant: 'success',
                        director: 'warning'
                    }[user.role] || 'primary';
                    html += `
                        <tr>
                            <td><div style="font-weight: 500;">${user.name || '-'}</div></td>
                            <td>${user.username || '-'}</td>
                            <td><span class="badge badge-${roleBadge}">${user.role || '-'}</span></td>
                            <td>${user.email || '-'}</td>
                            <td>${user.phone || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="Admin.editStaff('${user.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="Admin.deleteStaff('${user.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            switchStaffTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tab) {
                        btn.classList.add('active');
                    }
                });
                const tabMap = {
                    allStaff: 'all',
                    teachers: 'teachers',
                    accountants: 'accountants',
                    directors: 'directors'
                };
                this.showStaffList(tabMap[tab]);
            },
            deleteStaff(userId) {
                if (!confirm('Are you sure you want to delete this staff member?')) return;
                const users = Storage.getData('users');
                const index = users.findIndex(u => u.id === userId);
                if (index !== -1) {
                    users.splice(index, 1);
                    Storage.setData('users', users);
                    Toast.success('Staff deleted successfully');
                    this.showStaffList();
                }
            },
            showClassesManagement() {
                const schoolId = Auth.getCurrentSchoolId();
                const enabledClasses = Storage.getSchoolClasses(schoolId);
                const allClasses = Storage.DEFAULT_CLASSES;
                const container = document.getElementById('classesList');
                let html = '<div class="grid-3">';
                allClasses.forEach(cls => {
                    const isEnabled = enabledClasses.includes(cls);
                    html += `
                        <div class="card" style="padding: 16px;">
                            <div class="flex-align-center" style="justify-content: space-between;">
                                <span style="font-weight: 500;">${cls}</span>
                                <label class="switch">
                                    <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="Admin.toggleClass('${cls}', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            },
            toggleClass(className, enabled) {
                const schoolId = Auth.getCurrentSchoolId();
                let classes = Storage.getSchoolClasses(schoolId);
                if (enabled && !classes.includes(className)) {
                    classes.push(className);
                } else if (!enabled) {
                    classes = classes.filter(c => c !== className);
                }
                Storage.updateSchoolSettings(schoolId, { classes });
                Toast.success(enabled ? `${className} enabled` : `${className} disabled`);
            },
            openSubjectsManagement() {
                // First switch to subjects section
                this.showSection('subjects');
                // Then load the content
                setTimeout(() => {
                    this.showSubjectsManagement();
                }, 100);
            },
            openScoreTypesSettings() {
                // First switch to scoreTypes section
                this.showSection('scoreTypes');
                // Then load the content
                setTimeout(() => {
                    this.showScoreTypesSettings();
                }, 100);
            },
            showSubjectsManagement() {
                const schoolId = Auth.getCurrentSchoolId();
                const subjects = Storage.getSchoolSubjects(schoolId);
                const container = document.getElementById('subjectsList');
                const levelMap = {
                    'Nursery 1': 'Nursery', 'Nursery 2': 'Nursery',
                    'Primary 1': 'Primary', 'Primary 2': 'Primary', 'Primary 3': 'Primary',
                    'Primary 4': 'Primary', 'Primary 5': 'Primary', 'Primary 6': 'Primary',
                    'JSS 1': 'JSS', 'JSS 2': 'JSS', 'JSS 3': 'JSS',
                    'SS 1': 'SS', 'SS 2': 'SS', 'SS 3': 'SS'
                };
                const school = Storage.getSchoolById(schoolId);
                const enabledClasses = Storage.getSchoolClasses(schoolId);
                let html = '<div class="tabs">';
                enabledClasses.forEach((cls, idx) => {
                    const level = levelMap[cls] || 'Primary';
                    html += `<button class="tab-btn ${idx === 0 ? 'active' : ''}" data-level="${level}" onclick="Admin.showSubjectsByLevel('${level}', this)">${cls}</button>`;
                });
                html += '</div><div id="subjectsByLevel"></div>';
                container.innerHTML = html;
                if (enabledClasses.length > 0) {
                    const level = levelMap[enabledClasses[0]] || 'Primary';
                    this.showSubjectsByLevel(level, container.querySelector('.tab-btn'));
                }
            },
            showSubjectsByLevel(level, btn) {
                document.querySelectorAll('#subjectsList .tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const schoolId = Auth.getCurrentSchoolId();
                const allSubjects = Storage.DEFAULT_SUBJECTS[level] || [];
                const enabledSubjects = Storage.getSchoolSubjects(schoolId)[level] || [];
                const customSubjects = Storage.getSchoolCustomSubjects(schoolId, level) || [];
                const allSubjectsList = [...allSubjects, ...customSubjects];
                let html = `
                    <div class="flex-align-center mb-3" style="justify-content: space-between;">
                        <h4>${level} Level Subjects</h4>
                        <button class="btn btn-primary btn-sm" onclick="Admin.showAddSubjectModal('${level}')">
                            <i class="fas fa-plus"></i> Add Subject
                        </button>
                    </div>
                    <div class="grid-3 mt-3">
                `;
                allSubjectsList.forEach(subject => {
                    const isDefault = allSubjects.includes(subject);
                    const isEnabled = enabledSubjects.includes(subject);
                    html += `
                        <div class="card" style="padding: 16px;">
                            <div class="flex-align-center" style="justify-content: space-between;">
                                <span>${subject}${isDefault ? '' : ' <span class="badge badge-info">Custom</span>'}</span>
                                <div class="flex-align-center">
                                    ${!isDefault ? `<button class="btn btn-icon btn-sm" style="margin-right:8px;color:var(--danger);" onclick="Admin.deleteSubject('${level}', '${subject}')" title="Delete"><i class="fas fa-trash"></i></button>` : ''}
                                    <label class="switch">
                                        <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="Admin.toggleSubject('${level}', '${subject}', this.checked)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('subjectsByLevel').innerHTML = html;
            },
            showAddSubjectModal(level) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'addSubjectModal';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Add Subject - ${level}</h3>
                            <button class="modal-close" onclick="document.getElementById('addSubjectModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Subject Name</label>
                                <input type="text" id="newSubjectName" class="form-control" placeholder="Enter subject name">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('addSubjectModal').remove()">Cancel</button>
                            <button class="btn btn-primary" onclick="Admin.addSubject('${level}')">Add Subject</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('newSubjectName').focus();
            },
            addSubject(level) {
                const name = document.getElementById('newSubjectName').value.trim();
                if (!name) {
                    Toast.error('Please enter subject name');
                    return;
                }
                const schoolId = Auth.getCurrentSchoolId();
                const subjects = Storage.getSchoolSubjects(schoolId);
                const allDefaults = Storage.DEFAULT_SUBJECTS[level] || [];
                const customSubjects = subjects.custom?.[level] || [];
                if (allDefaults.includes(name) || customSubjects.includes(name)) {
                    Toast.error('Subject already exists');
                    return;
                }
                if (!subjects.custom) subjects.custom = {};
                if (!subjects.custom[level]) subjects.custom[level] = [];
                subjects.custom[level].push(name);
                Storage.updateSchoolSettings(schoolId, { subjects });
                document.getElementById('addSubjectModal').remove();
                Toast.success(`${name} added to ${level}`);
                this.showSubjectsByLevel(level, document.querySelector('#subjectsList .tab-btn.active'));
            },
            deleteSubject(level, subject) {
                if (!confirm(`Are you sure you want to delete "${subject}"?`)) return;
                const schoolId = Auth.getCurrentSchoolId();
                const subjects = Storage.getSchoolSubjects(schoolId);
                if (subjects.custom && subjects.custom[level]) {
                    subjects.custom[level] = subjects.custom[level].filter(s => s !== subject);
                    if (subjects[level]) {
                        subjects[level] = subjects[level].filter(s => s !== subject);
                    }
                    Storage.updateSchoolSettings(schoolId, { subjects });
                    Toast.success(`${subject} deleted`);
                    this.showSubjectsByLevel(level, document.querySelector('#subjectsList .tab-btn.active'));
                }
            },
            toggleSubject(level, subject, enabled) {
                const schoolId = Auth.getCurrentSchoolId();
                let subjects = Storage.getSchoolSubjects(schoolId);
                if (!subjects[level]) {
                    subjects[level] = [];
                }
                if (enabled && !subjects[level].includes(subject)) {
                    subjects[level].push(subject);
                } else if (!enabled) {
                    subjects[level] = subjects[level].filter(s => s !== subject);
                }
                Storage.updateSchoolSettings(schoolId, { subjects });
                Toast.success(enabled ? `${subject} enabled for ${level}` : `${subject} disabled for ${level}`);
            },
            showScoreTypesSettings() {
                const schoolId = Auth.getCurrentSchoolId();
                const enabledTypes = Storage.getSchoolScoreTypes(schoolId);
                const allTypes = Storage.SCORE_TYPES;
                const container = document.getElementById('scoreTypesList');
                let html = '<div class="grid-2">';
                allTypes.forEach(type => {
                    const isEnabled = enabledTypes.includes(type);
                    html += `
                        <div class="card" style="padding: 16px;">
                            <div class="flex-align-center" style="justify-content: space-between;">
                                <div>
                                    <span style="font-weight: 500;">${type}</span>
                                    <p style="font-size: 12px; color: var(--gray); margin: 0;">${type === 'Daily' ? 'Daily class tests' : type === 'Weekly' ? 'Weekly tests (Friday)' : type === 'Mid-term' ? 'Mid-term examinations' : 'End of term examinations'}</p>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" ${isEnabled ? 'checked' : ''} onchange="Admin.toggleScoreType('${type}', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            },
            toggleScoreType(type, enabled) {
                const schoolId = Auth.getCurrentSchoolId();
                let types = Storage.getSchoolScoreTypes(schoolId);
                if (enabled && !types.includes(type)) {
                    types.push(type);
                } else if (!enabled) {
                    types = types.filter(t => t !== type);
                }
                Storage.updateSchoolSettings(schoolId, { scoreTypes: types });
                Toast.success(enabled ? `${type} enabled` : `${type} disabled`);
            },
            importCSV(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    if (lines.length < 2) {
                        Toast.error('CSV file is empty or has no data');
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    const requiredHeaders = ['name', 'class'];
                    const missing = requiredHeaders.filter(h => !headers.includes(h));
                    if (missing.length > 0) {
                        Toast.error('CSV must have columns: name, class (at minimum). Optional: email, phone, gender, dob, parentname, parentphone');
                        return;
                    }
                    let imported = 0;
                    const schoolId = Auth.getCurrentSchoolId();
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((h, idx) => {
                            row[h] = values[idx] || '';
                        });
                        if (row.name && row.class) {
                            const student = {
                                name: row.name,
                                class: row.class,
                                email: row.email || '',
                                phone: row.phone || '',
                                gender: row.gender || '',
                                dob: row.dob || '',
                                parentName: row.parentname || '',
                                parentPhone: row.parentphone || '',
                                schoolId,
                                status: 'active',
                                qrCode: null
                            };
                            const existingStudents = Storage.getStudents(schoolId);
                            if (!existingStudents.some(s => s.name === student.name && s.class === student.class)) {
                                Storage.addItem('students', student);
                                imported++;
                            }
                        }
                    }
                    Toast.success(`Successfully imported ${imported} students`);
                    Students.loadStudents();
                    input.value = '';
                };
                reader.readAsText(file);
            },
            generateReport() {
                const studentId = document.getElementById('studentSelect').value;
                const term = document.getElementById('termSelect').value;
                const year = document.getElementById('yearSelect').value;
                if (!studentId) {
                    Toast.error('Please select a student');
                    return;
                }
                const reportData = Reports.generateReportCard(studentId, term, year);
                if (reportData) {
                    Reports.renderReportCard(reportData);
                }
            },
            loadIDCardUsers() {
                const schoolId = Auth.getCurrentSchoolId();
                const type = document.getElementById('idCardType').value;
                const select = document.getElementById('idCardUser');
                let users = [];
                if (type === 'student') {
                    users = Storage.getStudents(schoolId);
                } else if (type === 'teacher') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'teacher');
                } else if (type === 'accountant') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'accountant');
                } else if (type === 'director') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'director');
                } else if (type === 'school_admin') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'school_admin');
                }
                select.innerHTML = '<option value="">Select...</option>' + 
                    users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            },
            async generateIDCard() {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                const format = document.getElementById('idCardFormat')?.value || 'portrait';
                let cardHtml;
                if (type === 'student') {
                    cardHtml = await IDCard.generate(userId, format);
                } else {
                    cardHtml = await IDCard.generateStaff(userId, format);
                }
                if (cardHtml) {
                    document.getElementById('idCardPreview').innerHTML = cardHtml;
                }
            },
            async downloadIDCard(format, orientation) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.download(userId, orientation, format);
                    } else {
                        await IDCard.downloadStaff(userId, orientation, format);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card');
                }
                Loading.hide();
            },
            async downloadIDCardBack(format, orientation) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.downloadBack(userId, orientation, format);
                    } else {
                        await IDCard.downloadStaffBack(userId, orientation, format);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card back');
                }
                Loading.hide();
            },
            async downloadIDCardBoth(format, layout) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.downloadBoth(userId, 'portrait', format, layout);
                    } else {
                        await IDCard.downloadStaffBoth(userId, 'portrait', format, layout);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card');
                }
                Loading.hide();
            },
            initAttendanceSection() {
                const schoolId = Auth.getCurrentSchoolId();
                const classes = Storage.getClasses(schoolId);
                
                // Populate attendanceClass for term attendance
                const attendanceClassSelect = document.getElementById('attendanceClass');
                if (attendanceClassSelect) {
                    attendanceClassSelect.innerHTML = '<option value="">Select Class</option>' +
                        classes.map(c => `<option value="${c}">${c}</option>`).join('');
                    if (classes.length > 0) {
                        attendanceClassSelect.value = classes[0];
                        this.loadTermAttendance();
                    }
                }
                
                // Also populate classSelect for manual attendance
                const classSelect = document.getElementById('classSelect');
                if (classSelect) {
                    classSelect.innerHTML = '<option value="">Select Class</option>' +
                        classes.map(c => `<option value="${c}">${c}</option>`).join('');
                }
            },
            loadTermAttendance() {
                const schoolId = Auth.getCurrentSchoolId();
                const year = document.getElementById('attendanceYear').value;
                const term = document.getElementById('attendanceTerm').value;
                const className = document.getElementById('attendanceClass').value;
                const container = document.getElementById('attendanceTableContainer');
                
                if (!className) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-check"></i><h3>No Class Selected</h3><p>Please select a class to view attendance</p></div>';
                    return;
                }
                
                const attendance = Attendance.getAttendanceByTerm(schoolId, className, term, parseInt(year));
                
                if (attendance.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-check"></i><h3>No Attendance Records</h3><p>No attendance records found for this term</p></div>';
                    return;
                }
                
                const students = Storage.getStudentsByClass(schoolId, className);
                const studentMap = {};
                students.forEach(s => studentMap[s.id] = s.name);
                
                const dateGroups = {};
                attendance.forEach(record => {
                    if (!dateGroups[record.date]) {
                        dateGroups[record.date] = [];
                    }
                    dateGroups[record.date].push(record);
                });
                
                const sortedDates = Object.keys(dateGroups).sort((a, b) => new Date(b) - new Date(a));
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Date</th><th>Present</th><th>Absent</th><th>Total</th><th>% Present</th></tr></thead><tbody>';
                
                sortedDates.forEach(date => {
                    const records = dateGroups[date];
                    const present = records.filter(r => r.status === 'present').length;
                    const absent = students.length - present;
                    const total = students.length;
                    const percentage = total > 0 ? Math.round((present / total) * 100) : 0;
                    
                    html += `<tr>
                        <td>${date}</td>
                        <td><span class="badge badge-success">${present}</span></td>
                        <td><span class="badge badge-danger">${absent}</span></td>
                        <td>${total}</td>
                        <td>${percentage}%</td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            exportTermAttendance() {
                const schoolId = Auth.getCurrentSchoolId();
                const year = document.getElementById('attendanceYear').value;
                const term = document.getElementById('attendanceTerm').value;
                const className = document.getElementById('attendanceClass').value;
                
                if (!className) {
                    Toast.error('Please select a class');
                    return;
                }
                
                Attendance.exportAttendanceToCSV(schoolId, className, term, parseInt(year));
            },
            showProfile() {
                this.showSection('profile');
            }
        };

        const NotificationPanel = {
            init() { this.loadNotifications(); },
            loadNotifications() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
                const unreadNotifications = notifications.filter(n => n.userId === user.id && !n.read);
                const dot = document.getElementById('notificationDot');
                if (dot) dot.style.display = unreadNotifications.length > 0 ? 'block' : 'none';
                const list = document.getElementById('notificationList');
                if (!list) return;
                if (userNotifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
                    return;
                }
                let html = '';
                userNotifications.forEach(notif => {
                    const time = this.getTimeAgo(notif.createdAt);
                    const iconClass = this.getIconClass(notif.type);
                    html += `<div class="notification-dropdown-item ${notif.read ? '' : 'unread'}" onclick="NotificationPanel.handleNotificationClick('${notif.id}')">
                        <div class="notification-dropdown-icon ${notif.type || 'info'}"><i class="fas ${iconClass}"></i></div>
                        <div class="notification-dropdown-content"><p>${notif.message}</p><div class="notification-dropdown-time">${time}</div></div></div>`;
                });
                list.innerHTML = html;
            },
            getIconClass(type) {
                const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', error: 'fa-times-circle', message: 'fa-envelope', student: 'fa-user-graduate', score: 'fa-clipboard-list', attendance: 'fa-clipboard-check', finance: 'fa-wallet' };
                return icons[type] || 'fa-bell';
            },
            getTimeAgo(dateStr) {
                const date = new Date(dateStr), now = new Date(), diff = now - date;
                const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            },
            toggle() {
                const dropdown = document.getElementById('notificationDropdown');
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) this.loadNotifications();
            },
            handleNotificationClick(notifId) {
                const notifications = Storage.getData('notifications') || [];
                const index = notifications.findIndex(n => n.id === notifId);
                if (index !== -1) { notifications[index].read = true; Storage.setData('notifications', notifications); this.loadNotifications(); }
                document.getElementById('notificationDropdown').classList.remove('show');
            },
            markAllRead() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                notifications.forEach(n => { if (n.userId === user.id) n.read = true; });
                Storage.setData('notifications', notifications);
                this.loadNotifications();
            }
        };

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const btn = document.querySelector('.notification-container');
            if (dropdown && !btn.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        function toggleSidebar() { 
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('active');
        }
        
        // Close sidebar when clicking on nav items (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });
        
        // Close sidebar when clicking outside (mobile overlay)
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 992 && 
                sidebar && sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
        
        function toggleDarkMode() {
            const isDark = ThemeManager.toggleDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
        }
        
        function initDarkModeToggle() {
            const isDark = ThemeManager.isDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
        }
        
        Admin.downloadBackup = function() {
            if (confirm('Do you want to download a backup of all school data? This will include all students, staff, scores, and settings.')) {
                Storage.downloadBackup();
                Toast.success('Backup downloaded successfully!');
            }
        };
        
        window.toggleDarkMode = toggleDarkMode;
        window.Admin = Admin;
        window.NotificationPanel = NotificationPanel;
        
        Profile.init = function() { this.loadProfile(); };
        Profile.loadProfile = function() {
            const user = Auth.getCurrentUser();
            if (!user) return;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1).replace('_', ' ');
            document.getElementById('profileNameInput').value = user.name || '';
            document.getElementById('profileEmailInput').value = user.email || '';
            document.getElementById('profilePhoneInput').value = user.phone || '';
            document.getElementById('profileAddressInput').value = user.address || '';
            document.getElementById('profileGenderInput').value = user.gender || '';
            document.getElementById('profileAvatarInitials').textContent = Utils.getInitials(user.name);
            if (user.avatar) {
                const img = document.getElementById('profileAvatarImg');
                img.src = user.avatar;
                img.style.display = 'block';
                document.getElementById('profileAvatarInitials').style.display = 'none';
            }
            document.getElementById('profileMemberSince').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            const activityData = this.getActivityData();
            document.getElementById('activityScore').textContent = activityData.score;
            document.getElementById('totalLogins').textContent = activityData.logins;
            this.loadRecentActivity();
            this.loadNotifications();
        };
        Profile.getActivityData = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id);
            return { score: Math.min(100, userActivities.length * 5 + 10), logins: userActivities.filter(a => a.type === 'login').length || 1 };
        };
        Profile.loadRecentActivity = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileActivityList');
            if (!userActivities.length) { container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>'; return; }
            let html = '<div class="activity-timeline">';
            userActivities.forEach(activity => {
                const iconMap = { login: 'fa-sign-in-alt', profile_update: 'fa-user-edit', password_change: 'fa-key' };
                html += `<div class="activity-item"><div class="activity-icon"><i class="fas ${iconMap[activity.type] || 'fa-circle'}"></i></div><div class="activity-content"><p>${activity.description || activity.type}</p><span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span></div></div>`;
            });
            container.innerHTML = html + '</div>';
        };
        Profile.loadNotifications = function() {
            const user = Auth.getCurrentUser();
            const notifications = Storage.getData('notifications') || [];
            const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileNotifications');
            if (!userNotifications.length) { container.innerHTML = '<div class="empty-state"><p>No notifications</p></div>'; return; }
            let html = '<div class="notifications-list">';
            userNotifications.forEach(notif => { html += `<div class="notification-item ${notif.read ? '' : 'unread'}"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><p>${notif.message}</p><span class="notification-time">${new Date(notif.timestamp || notif.createdAt).toLocaleString()}</span></div></div>`; });
            container.innerHTML = html + '</div>';
        };
        Profile.handleAvatarUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { this.updateAvatar(e.target.result); };
            reader.readAsDataURL(file);
            input.value = '';
        };
        Profile.updateAvatar = function(avatarData) {
            const user = Auth.getCurrentUser();
            const result = Auth.updateProfile(user.id, { avatar: avatarData });
            if (result.success) { Toast.success('Profile picture updated'); this.loadProfile(); this.updateNavAvatar(avatarData); this.updateSidebarAvatar(avatarData); }
            else { Toast.error('Failed to update profile picture'); }
        };
        Profile.updateNavAvatar = function(avatarData) {
            const navAvatar = document.getElementById('navAvatar');
            if (navAvatar && avatarData) { navAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        Profile.updateSidebarAvatar = function(avatarData) {
            const sidebarAvatar = document.getElementById('currentUserAvatar');
            if (sidebarAvatar && avatarData) { sidebarAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        Profile.saveProfile = function() {
            const user = Auth.getCurrentUser();
            const name = document.getElementById('profileNameInput').value.trim();
            const email = document.getElementById('profileEmailInput').value.trim();
            const phone = document.getElementById('profilePhoneInput').value.trim();
            const address = document.getElementById('profileAddressInput').value.trim();
            const gender = document.getElementById('profileGenderInput').value;
            if (!name) { Toast.error('Name is required'); return; }
            const result = Auth.updateProfile(user.id, { name, email, phone, address, gender });
            if (result.success) { Toast.success('Profile updated successfully'); this.loadProfile(); this.logActivity('profile_update', 'Updated profile'); Auth.addNotification(user.id, 'Your profile information was updated', 'info'); NotificationPanel.init(); }
            else { Toast.error('Failed to update profile'); }
        };
        Profile.changePassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) { Toast.error('Please fill all password fields'); return; }
            if (newPassword !== confirmPassword) { Toast.error('New passwords do not match'); return; }
            if (newPassword.length < 6) { Toast.error('Password must be at least 6 characters'); return; }
            const user = Auth.getCurrentUser();
            const result = Auth.changePassword(user.id, currentPassword, newPassword);
            if (result.success) { Toast.success('Password changed successfully'); document.getElementById('passwordForm').reset(); this.logActivity('password_change', 'Changed password'); Auth.addNotification(user.id, 'Your password was changed successfully', 'success'); NotificationPanel.init(); }
            else { Toast.error(result.message); }
        };
        Profile.logActivity = function(type, description) {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            activities.push({ id: Storage.generateId(), userId: user.id, type, description, timestamp: new Date().toISOString() });
            Storage.setData('activities', activities);
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            Admin.init();
            Chat.init();
            NotificationPanel.init();
            Calendar.init();
            initDarkModeToggle();
            // Set today's date for transaction date input if present
            var dateInput = document.getElementById('transactionDateInput');
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>
