<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher - My School</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <!-- Local Storage Only -->
    <script src="../assets/js/firebase-config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="../assets/js/storage.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/core.js"></script>
    <script src="../assets/js/attendance.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/chat.js"></script>
    <script src="../assets/js/qr.js"></script>
    <script src="../assets/js/calendar.js"></script>
    <script src="../assets/js/export.js"></script>
    <script src="../assets/js/calculator.js"></script>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-graduation-cap"></i>
                    <span>My School</span>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="teacher.html" class="nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Teaching</div>
                    <a href="#" class="nav-item" data-page="students" onclick="event.preventDefault(); Teacher.showSection('students')">
                        <i class="fas fa-users"></i>
                        <span>My Students</span>
                    </a>
                    <a href="#" class="nav-item" data-page="attendance" onclick="event.preventDefault(); Teacher.showSection('attendance')">
                        <i class="fas fa-qrcode"></i>
                        <span>Attendance</span>
                    </a>
                    <a href="#" class="nav-item" data-page="scores" onclick="event.preventDefault(); Teacher.showSection('scores')">
                        <i class="fas fa-clipboard-list"></i>
                        <span>Scores</span>
                    </a>
                    <a href="#" class="nav-item" data-page="reports" onclick="event.preventDefault(); Teacher.showSection('reports')">
                        <i class="fas fa-file-alt"></i>
                        <span>Write Reports</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Questions & Tests</div>
                    <a href="#" class="nav-item" data-page="questions" onclick="event.preventDefault(); Teacher.showSection('questions')">
                        <i class="fas fa-question-circle"></i>
                        <span>Question Bank</span>
                    </a>
                    <a href="#" class="nav-item" data-page="tests" onclick="event.preventDefault(); Teacher.showSection('tests')">
                        <i class="fas fa-file-alt"></i>
                        <span>Create Test</span>
                    </a>
                    <a href="#" class="nav-item" data-page="testResults" onclick="event.preventDefault(); Teacher.showSection('testResults')">
                        <i class="fas fa-chart-line"></i>
                        <span>Test Results</span>
                    </a>
                    <a href="#" class="nav-item" data-page="scoreSessions" onclick="event.preventDefault(); Teacher.showSection('scoreSessions')">
                        <i class="fas fa-calculator"></i>
                        <span>Score Sessions</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Communication</div>
                    <a href="#" class="nav-item" data-page="chat" onclick="event.preventDefault(); Teacher.showSection('chat')">
                        <i class="fas fa-comments"></i>
                        <span>Chat</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Public Pages</div>
                    <a href="../public/blog.html" target="_blank" class="nav-item">
                        <i class="fas fa-blog"></i>
                        <span>Blog</span>
                    </a>
                    <a href="../public/resources.html" target="_blank" class="nav-item">
                        <i class="fas fa-folder-open"></i>
                        <span>Resources</span>
                    </a>
                    <a href="../public/pricing.html" target="_blank" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span>Pricing</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Support</div>
                    <a href="#" class="nav-item" data-page="help" onclick="event.preventDefault(); Teacher.showSection('help')">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Guide</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" data-page="profile" onclick="event.preventDefault(); Teacher.showSection('profile')">
                        <i class="fas fa-user-circle"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">TR</div>
                    <div class="user-details">
                        <div class="user-name" id="currentUserName">Teacher</div>
                        <div class="user-role">Teacher</div>
                    </div>
                </div>
                <button class="btn logout-btn" onclick="Auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div id="announcementBanner" class="announcement-banner">
                <div class="announcement-content" id="announcementContent"></div>
                <button class="announcement-close" onclick="document.getElementById('announcementBanner').classList.remove('active')">&times;</button>
            </div>
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="navbar-right">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="notification-container">
                        <button class="navbar-icon-btn" onclick="NotificationPanel.toggle()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button class="btn btn-sm btn-link" onclick="NotificationPanel.markAllRead()">Mark all read</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <div class="navbar-profile" onclick="Teacher.showProfile()">
                        <div class="avatar" id="navAvatar">TR</div>
                        <span class="name" id="navUserName">Teacher</span>
                    </div>
                </div>
            </nav>

            <div class="page-content">
                <div id="dashboardSection">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Teacher Dashboard</h1>
                            <p class="page-subtitle">Welcome, <span id="welcomeName">Teacher</span></p>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">My Students</div>
                                <div class="stat-value" id="myStudents">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Classes</div>
                                <div class="stat-value" id="myClasses">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Attendance Today</div>
                                <div class="stat-value" id="attendanceToday">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar"></i> Calendar</h3>
                                <button class="btn btn-sm btn-outline" onclick="Calendar.showAddEventModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="calendarWidget" class="calendar-widget"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="studentsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">My Students</h1>
                        </div>
                        <div class="flex gap-2">
                            <label class="btn btn-outline" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Import CSV
                                <input type="file" accept=".csv" style="display: none;" onchange="Teacher.importCSV(this)">
                            </label>
                            <button class="btn btn-primary" onclick="Modal.show('addStudentModal')">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="studentsTable"></div>
                    </div>
                </div>

                <div id="attendanceSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Take Attendance</h1>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" onclick="Attendance.exportAttendanceCSV()">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    <div class="grid-2 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-users"></i> Manual Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="filters-bar">
                                    <div class="filter-group">
                                        <label>Class:</label>
                                        <select id="classSelect" class="form-control"></select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Date:</label>
                                        <input type="date" id="attendanceDate" class="form-control">
                                    </div>
                                    <button class="btn btn-primary" onclick="Attendance.loadStudents()">Load Students</button>
                                    <button class="btn btn-success" onclick="Attendance.markAllPresent()">Mark All Present</button>
                                </div>
                                <div id="studentsList"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-qrcode"></i> QR Scan Attendance</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Scan Date:</label>
                                        <input type="date" id="scanAttendanceDate" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Manual Entry:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="scanStudentInput" class="form-control" placeholder="Enter student ID or scan QR code">
                                        <button class="btn btn-primary" onclick="QR.scanStudentForAttendance()">
                                            <i class="fas fa-check"></i> Mark Present
                                        </button>
                                    </div>
                                </div>
                                <div id="scanResult" class="mt-3"></div>
                                <div class="mt-3">
                                    <button class="btn btn-success" onclick="QR.openQRScanner()">
                                        <i class="fas fa-camera"></i> Open Camera Scanner
                                    </button>
                                </div>
                                <div id="qrScannerContainer" class="mt-3" style="display: none;">
                                    <div class="qr-scanner-wrapper" style="position: relative; max-width: 400px; margin: 0 auto;">
                                        <video id="qrScanner" style="width: 100%; border-radius: 12px; border: 3px solid var(--primary);"></video>
                                        <div class="qr-scan-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px dashed var(--primary); border-radius: 12px; pointer-events: none;"></div>
                                    </div>
                                    <div style="text-align: center; margin-top: 15px;">
                                        <p class="text-muted" style="font-size: 13px;"><i class="fas fa-info-circle"></i> Position the QR code within the frame to scan automatically</p>
                                        <button class="btn btn-secondary mt-2" onclick="QR.closeQRScanner()">
                                            <i class="fas fa-times"></i> Close Scanner
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Recently Scanned Today Section -->
                    <div class="card" style="margin-top:20px;border-left:4px solid #16a34a;">
                        <div class="card-header" style="background:rgba(22,163,74,0.1);">
                            <h3 class="card-title" style="color:#16a34a;">
                                <i class="fas fa-user-check"></i> Recently Scanned Today 
                                <span id="scannedCountBadge" style="display:none;background:#16a34a;color:white;padding:2px 8px;border-radius:10px;font-size:12px;margin-left:10px;">0</span>
                                <button onclick="QRScanner.clearRecentlyScanned()" style="float:right;background:none;border:none;color:#666;cursor:pointer;font-size:12px;">Clear</button>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="recentlyScannedContainer">
                                <p class="text-muted" style="text-align:center;padding:20px;">No students scanned today</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scoresSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Enter Scores</h1>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="scoreClassSelect" class="form-control" onchange="TeacherScores.loadStudents()">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Score Type:</label>
                                    <select id="scoreTypeSelect" class="form-control" onchange="TeacherScores.loadScoreEntry()">
                                        <option value="">Select Score Type</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="scoreSubjectSelect" class="form-control" onchange="TeacherScores.loadScoreEntry()">
                                        <option value="">Select Subject</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Term:</label>
                                    <select id="scoreTermSelect" class="form-control" onchange="TeacherScores.loadScoreEntry()">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Year:</label>
                                    <select id="scoreYearSelect" class="form-control" onchange="TeacherScores.loadScoreEntry()">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header flex justify-between items-center">
                            <h3 class="card-title" id="scoreEntryTitle">Enter Scores</h3>
                            <button class="btn btn-primary" onclick="TeacherScores.saveScores()">
                                <i class="fas fa-save"></i> Save Scores
                            </button>
                        </div>
                        <div class="card-body" id="scoresTable">
                            <p class="text-muted">Select class, score type, and subject to enter scores</p>
                        </div>
                    </div>
                    
                    <div class="card mt-3" id="rankingCard" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">Class Rankings - <span id="rankingTitle"></span></h3>
                        </div>
                        <div class="card-body" id="rankingTable"></div>
                    </div>
                </div>

                <div id="reportsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Reports & Analytics</h1>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card-item" onclick="TeacherReports.showReportType('student')">
                            <div class="report-icon"><i class="fas fa-user-graduate"></i></div>
                            <h3>Student Report</h3>
                            <p>Individual student term results</p>
                        </div>
                        <div class="report-card-item" onclick="TeacherReports.showReportType('class')">
                            <div class="report-icon"><i class="fas fa-users"></i></div>
                            <h3>Class Report</h3>
                            <p>All students in a class</p>
                        </div>
                        <div class="report-card-item" onclick="TeacherReports.showReportType('attendance')">
                            <div class="report-icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3>Attendance</h3>
                            <p>Daily/weekly attendance</p>
                        </div>
                        <div class="report-card-item" onclick="TeacherReports.showReportType('scores')">
                            <div class="report-icon"><i class="fas fa-star"></i></div>
                            <h3>Scores Report</h3>
                            <p>Daily/Weekly/Mid-term/Exam</p>
                        </div>
                        <div class="report-card-item" onclick="TeacherReports.showReportType('continuous')">
                            <div class="report-icon"><i class="fas fa-clock"></i></div>
                            <h3>Continuous Assessment</h3>
                            <p>Daily & Weekly scores only</p>
                        </div>
                    </div>
                    
                    <div id="reportFilters" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="reportTypeTitle">Select Report Options</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row" id="reportFiltersContent"></div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-primary" onclick="TeacherReports.generateSelectedReport()">
                                    <i class="fas fa-sync"></i> Generate Report
                                </button>
                                <button class="btn btn-outline" onclick="TeacherReports.exportReport('csv')">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-outline" onclick="TeacherReports.exportReport('pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                                <button class="btn btn-outline" onclick="TeacherReports.exportReport('doc')">
                                    <i class="fas fa-file-word"></i> DOC
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reportContent" class="card mt-3" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="reportContentTitle">Report Results</h3>
                        </div>
                        <div class="card-body" id="reportContentBody"></div>
                    </div>

                    <div class="page-header mt-4">
                        <div>
                            <h1 class="page-title">Write Student Reports</h1>
                            <p class="page-subtitle">Write personalized reports for your students</p>
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Select Student</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Class:</label>
                                    <select id="reportClassSelect" class="form-control" onchange="TeacherReports.loadStudents()">
                                        <option value="">Select Class</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Student:</label>
                                    <select id="reportStudentSelect" class="form-control" onchange="TeacherReports.loadStudentData()">
                                        <option value="">Select Student</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Term:</label>
                                    <select id="reportTermSelect" class="form-control">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Year:</label>
                                    <select id="reportYearSelect" class="form-control">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Student Overview</h3>
                            </div>
                            <div class="card-body" id="reportStudentOverview">
                                <p class="text-muted">Select a student to view their overview</p>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title">Write Report</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Academic Performance Comment</label>
                                <textarea id="reportAcademic" class="form-control" rows="3" placeholder="Write about the student's academic performance..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Behavioral Comment</label>
                                <textarea id="reportBehavior" class="form-control" rows="3" placeholder="Write about the student's behavior..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Attendance Comment</label>
                                <textarea id="reportAttendance" class="form-control" rows="2" placeholder="Write about the student's attendance..."></textarea>
                            </div>
                            <div class="form-group">
                                <label>Overall Recommendation</label>
                                <textarea id="reportRecommendation" class="form-control" rows="2" placeholder="Write your overall recommendation..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="TeacherReports.saveReport()">
                                <i class="fas fa-save"></i> Save Report
                            </button>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h3 class="card-title">Saved Reports</h3>
                        </div>
                        <div class="card-body" id="savedReportsList">
                            <p class="text-muted">No reports saved yet</p>
                        </div>
                    </div>
                </div>

                <div id="chatSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Chat</h1></div>
                    </div>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-sidebar" id="chatSidebar">
                            <button class="chat-sidebar-close" id="chatSidebarClose" onclick="Chat.closeSidebar()" style="display: none;">&times;</button>
                            <div class="chat-search">
                                <input type="text" id="chatSearch" placeholder="Search...">
                            </div>
                            <button class="btn btn-outline mt-2" id="newChatBtn" style="width:100%" onclick="Chat.showNewChatModal()">New Chat</button>
                            <div class="chat-list" id="chatList"></div>
                            <div id="groupsList"></div>
                        </div>
                        <div class="chat-main" id="chatMain">
                            <div class="chat-header" id="chatHeader">
                                <button class="chat-back-btn" id="chatBackBtn" onclick="Chat.showSidebar()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                                <div class="chat-header-info"><h3>Select a conversation</h3></div>
                            </div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area">
                                <button class="btn btn-icon" onclick="Chat.showEmojiPicker()" title="Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" id="chatInput" placeholder="Type a message...">
                                <div class="chat-input-actions">
                                    <button id="fileBtn" title="Attach File"><i class="fas fa-paperclip"></i></button>
                                    <button id="voiceBtn" title="Voice Message"><i class="fas fa-microphone"></i></button>
                                    <button id="sendBtn" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Chat Modal -->
                <div id="newChatModal" class="modal-overlay">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Start New Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('newChatModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="newChatSearch" class="form-control" placeholder="Search users..." oninput="Chat.filterNewChatUsers(this.value)">
                            <div id="newChatUserList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <div id="helpSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Help & Guide</h1>
                            <p class="page-subtitle">Learn how to use the system effectively</p>
                        </div>
                    </div>
                    <div id="helpGuideContainer"></div>
                </div>

                <!-- Questions Section -->
                <div id="questionsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Question Bank</h1>
                            <p class="page-subtitle">Manage your questions for tests and exams</p>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="Teacher.showAddQuestionModal()">
                                <i class="fas fa-plus"></i> Add Question
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="questionFilterSubject" class="form-control" onchange="Teacher.loadQuestions()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="questionFilterClass" class="form-control" onchange="Teacher.loadQuestions()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Type:</label>
                                    <select id="questionFilterType" class="form-control" onchange="Teacher.loadQuestions()">
                                        <option value="">All Types</option>
                                        <option value="mcq">Multiple Choice</option>
                                        <option value="tf">True/False</option>
                                        <option value="fillblank">Fill in Blank</option>
                                        <option value="essay">Essay</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Test Type:</label>
                                    <select id="questionFilterTestType" class="form-control" onchange="Teacher.loadQuestions()">
                                        <option value="">All Test Types</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="quiz">Quiz</option>
                                        <option value="assignment">Assignment</option>
                                        <option value="midterm">Mid-term</option>
                                        <option value="exam">Exam</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body" id="questionsList">
                            <div class="empty-state">
                                <i class="fas fa-question-circle"></i>
                                <h3>No questions yet</h3>
                                <p>Create your first question to get started</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tests Section -->
                <div id="testsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Create Test / Exam</h1>
                            <p class="page-subtitle">Create and publish tests for your students</p>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="Teacher.showCreateTestModal()">
                                <i class="fas fa-plus"></i> Create Test
                            </button>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="testFilterSubject" class="form-control" onchange="Teacher.loadTests()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="testFilterClass" class="form-control" onchange="Teacher.loadTests()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Status:</label>
                                    <select id="testFilterStatus" class="form-control" onchange="Teacher.loadTests()">
                                        <option value="">All</option>
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                        <option value="closed">Closed</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body" id="testsList">
                            <div class="empty-state">
                                <i class="fas fa-file-alt"></i>
                                <h3>No tests created</h3>
                                <p>Create your first test to assign to students</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Results Section -->
                <div id="testResultsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Test Results</h1>
                            <p class="page-subtitle">View student test results and performance</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" onclick="Teacher.exportTestResultsDOC()">
                                <i class="fas fa-file-word"></i> Export DOC
                            </button>
                            <button class="btn btn-outline" onclick="Teacher.exportTestResultsPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid mb-3" id="testResultsStats">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Attempts</div>
                                <div class="stat-value" id="testTotalAttempts">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-star"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Average Score</div>
                                <div class="stat-value" id="testAvgScore">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="fas fa-trophy"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Highest Score</div>
                                <div class="stat-value" id="testHighestScore">0%</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Pass Rate</div>
                                <div class="stat-value" id="testPassRate">0%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="resultFilterSubject" class="form-control" onchange="Teacher.loadTestResults()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="resultFilterClass" class="form-control" onchange="Teacher.loadTestResults()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Test Type:</label>
                                    <select id="resultFilterTestType" class="form-control" onchange="Teacher.loadTestResults()">
                                        <option value="">All</option>
                                        <option value="exam">Exam</option>
                                        <option value="midterm">Mid-term</option>
                                        <option value="quiz">Quiz</option>
                                        <option value="assignment">Assignment</option>
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body" id="testResultsList">
                            <div class="empty-state">
                                <i class="fas fa-chart-line"></i>
                                <h3>No results yet</h3>
                                <p>Results will appear here after students complete tests</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Score Sessions Section -->
                <div id="scoreSessionsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Score Sessions</h1>
                            <p class="page-subtitle">Manage daily and weekly score entries</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="Teacher.showAddScoreSessionModal()">
                                <i class="fas fa-plus"></i> New Session
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filters -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Class</label>
                                    <select id="scoreSessionFilterClass" class="form-control" onchange="Teacher.loadScoreSessions()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subject</label>
                                    <select id="scoreSessionFilterSubject" class="form-control" onchange="Teacher.loadScoreSessions()">
                                        <option value="">All Subjects</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Type</label>
                                    <select id="scoreSessionFilterType" class="form-control" onchange="Teacher.loadScoreSessions()">
                                        <option value="">All Types</option>
                                        <option value="Daily">Daily</option>
                                        <option value="Weekly">Weekly</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" id="scoreSessionFilterDate" class="form-control" onchange="Teacher.loadScoreSessions()">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sessions List -->
                    <div class="card">
                        <div class="card-body">
                            <div id="scoreSessionsList"></div>
                        </div>
                    </div>
                </div>

                <div id="profileSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">My Profile</h1>
                            <p class="page-subtitle">Manage your account settings</p>
                        </div>
                    </div>
                    
                    <div class="profile-page">
                        <div class="profile-header-card">
                            <div class="profile-avatar-section">
                                <div class="profile-avatar-large" id="profileAvatarLarge">
                                    <img id="profileAvatarImg" src="" alt="Profile" style="display: none;">
                                    <span id="profileAvatarInitials"></span>
                                </div>
                                <label class="profile-avatar-edit">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="Profile.handleAvatarUpload(this)">
                                </label>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profileName">Teacher</h2>
                                <p id="profileRole">Teacher</p>
                                <p class="profile-member-since"><i class="fas fa-calendar"></i> Member since: <span id="profileMemberSince">-</span></p>
                            </div>
                            <div class="profile-stats">
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="activityScore">0</div>
                                    <div class="profile-stat-label">Activity Score</div>
                                </div>
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="totalLogins">0</div>
                                    <div class="profile-stat-label">Total Logins</div>
                                </div>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-user"></i> Personal Information</h3>
                                </div>
                                <div class="card-body">
                                    <form id="profileForm">
                                        <div class="form-group">
                                            <label class="form-label">Full Name</label>
                                            <input type="text" id="profileNameInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <input type="email" id="profileEmailInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" id="profilePhoneInput" class="form-control">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Address</label>
                                            <textarea id="profileAddressInput" class="form-control" rows="2"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Gender</label>
                                            <select id="profileGenderInput" class="form-control">
                                                <option value="">Select</option>
                                                <option value="male">Male</option>
                                                <option value="female">Female</option>
                                            </select>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="Profile.saveProfile()">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fas fa-lock"></i> Change Password</h3>
                                </div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="form-group">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" id="currentPassword" class="form-control" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">New Password</label>
                                            <input type="password" id="newPassword" class="form-control" required minlength="6">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" id="confirmPassword" class="form-control" required>
                                        </div>
                                        <button type="button" class="btn btn-warning" onclick="Profile.changePassword()">
                                            <i class="fas fa-key"></i> Change Password
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3>
                            </div>
                            <div class="card-body">
                                <div id="profileActivityList">
                                    <div class="empty-state">
                                        <p>No recent activity</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3>
                            </div>
                            <div class="card-body">
                                <div id="profileNotifications">
                                    <div class="empty-state">
                                        <p>No notifications</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <div id="addStudentModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Add Student</h3>
                <button class="modal-close" onclick="Modal.hide('addStudentModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Class</label>
                            <input name="class" type="text" class="form-control" required placeholder="e.g., JSS 1A">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" name="dob" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select name="gender" class="form-control">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Parent Name</label>
                            <input type="text" name="parentName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parent Phone</label>
                            <input type="tel" name="parentPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passport Photo (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="studentPassport" accept="image/*" onchange="Teacher.previewStudentPassport(this)">
                            <div id="studentPassportPreview" class="passport-preview" style="display:none;">
                                <img id="studentPassportImg" src="" alt="Passport Preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="Teacher.clearStudentPassport()">Remove</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addStudentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Teacher.saveStudent()">Save Student</button>
            </div>
        </div>
    </div>
    <!-- Close page-content -->
    </div>
    <!-- Close main-content -->
    </main>

    <!-- Footer OUTSIDE main-content -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>My School System</span>
            </div>
            <div class="footer-links">
                <a href="../public/blog.html" target="_blank"><i class="fas fa-blog"></i> Blog</a>
                <a href="../public/resources.html" target="_blank"><i class="fas fa-folder-open"></i> Resources</a>
                <a href="../public/pricing.html" target="_blank"><i class="fas fa-tags"></i> Pricing</a>
                <a href="../public/privacy.html" target="_blank"><i class="fas fa-shield-alt"></i> Privacy</a>
                <a href="../public/terms.html" target="_blank"><i class="fas fa-file-contract"></i> Terms</a>
            </div>
            <div class="footer-info">
                <p>&copy; 2026 My School System. All rights reserved.</p>
                <p>My School System - Odebunmi Tawwab</p>
            </div>
            <div class="footer-social">
                <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://twitter.com" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://linkedin.com" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
        </div>
    </footer>

    <!-- Add Question Modal -->
    <div id="addQuestionModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Add New Question</h3>
                <button class="modal-close" onclick="Modal.hide('addQuestionModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="addQuestionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Subject *</label>
                            <select id="questionSubject" class="form-control" required onchange="Teacher.loadClassesForSubject()">
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Class *</label>
                            <select id="questionClass" class="form-control" required>
                                <option value="">Select Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Question Type *</label>
                            <select id="questionType" class="form-control" required onchange="Teacher.toggleQuestionOptions()">
                                <option value="mcq">Multiple Choice</option>
                                <option value="tf">True/False</option>
                                <option value="fillblank">Fill in the Blank</option>
                                <option value="essay">Essay/Theory</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Test Type *</label>
                            <select id="questionTestType" class="form-control" required>
                                <option value="daily">Daily Test</option>
                                <option value="weekly">Weekly Test</option>
                                <option value="quiz">Quiz</option>
                                <option value="assignment">Assignment</option>
                                <option value="midterm">Mid-term Exam</option>
                                <option value="exam">Final Exam</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Topic/Chapter</label>
                        <input type="text" id="questionTopic" class="form-control" placeholder="e.g., Chapter 1: Algebra">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Question *</label>
                        <textarea id="questionText" class="form-control" rows="4" required placeholder="Enter your question here..."></textarea>
                    </div>
                    
                    <!-- MCQ Options -->
                    <div id="mcqOptions">
                        <div class="form-group">
                            <label class="form-label"><i class="fas fa-check-circle"></i> Select the Correct Answer *</label>
                            <small class="text-muted">Click the radio button next to the correct option</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Option A <span class="correct-badge" id="badgeA" style="display:none;"> Correct</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <input type="radio" name="correctAnswer" value="A" id="correctA" onchange="Teacher.updateCorrectBadge('A')">
                                </span>
                                <input type="text" id="optionA" class="form-control" placeholder="Enter option A text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Option B <span class="correct-badge" id="badgeB" style="display:none;"> Correct</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <input type="radio" name="correctAnswer" value="B" id="correctB" onchange="Teacher.updateCorrectBadge('B')">
                                </span>
                                <input type="text" id="optionB" class="form-control" placeholder="Enter option B text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Option C <span class="correct-badge" id="badgeC" style="display:none;"> Correct</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <input type="radio" name="correctAnswer" value="C" id="correctC" onchange="Teacher.updateCorrectBadge('C')">
                                </span>
                                <input type="text" id="optionC" class="form-control" placeholder="Enter option C text">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Option D <span class="correct-badge" id="badgeD" style="display:none;"> Correct</span></label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <input type="radio" name="correctAnswer" value="D" id="correctD" onchange="Teacher.updateCorrectBadge('D')">
                                </span>
                                <input type="text" id="optionD" class="form-control" placeholder="Enter option D text">
                            </div>
                        </div>
                    </div>
                    
                    <!-- True/False Options -->
                    <div id="tfOptions" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Correct Answer *</label>
                            <select id="tfCorrectAnswer" class="form-control">
                                <option value="True">True</option>
                                <option value="False">False</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Fill in Blank -->
                    <div id="fillblankOptions" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Correct Answer *</label>
                            <input type="text" id="fillblankCorrectAnswer" class="form-control" placeholder="Enter the correct answer">
                            <small class="text-muted">The answer will be matched case-insensitively</small>
                        </div>
                    </div>
                    
                    <!-- Essay Options -->
                    <div id="essayOptions" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Model Answer (Optional)</label>
                            <textarea id="essayModelAnswer" class="form-control" rows="4" placeholder="Enter model answer for reference"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Marks *</label>
                            <input type="number" id="questionMarks" class="form-control" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Difficulty</label>
                            <select id="questionDifficulty" class="form-control">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Record to Report Card?</label>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="questionRecordToReport">
                            <span>Yes, include this in official report card</span>
                        </label>
                        <small class="text-muted">Only Mid-term and Final Exam scores are typically recorded in report cards</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addQuestionModal')">Cancel</button>
                <button class="btn btn-outline" onclick="Teacher.previewQuestion()">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button class="btn btn-primary" onclick="Teacher.saveQuestion()">
                    <i class="fas fa-save"></i> Save Question
                </button>
            </div>
        </div>
    </div>

    <!-- Create Test Modal -->
    <div id="createTestModal" class="modal-overlay">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Create New Test</h3>
                <button class="modal-close" onclick="Modal.hide('createTestModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="createTestForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Test Title *</label>
                            <input type="text" id="testTitle" class="form-control" placeholder="e.g., First Term Mathematics Exam" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Subject *</label>
                            <select id="testSubject" class="form-control" required onchange="Teacher.loadTestClasses(); Teacher.loadTestQuestionsForSelection();">
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Class *</label>
                            <select id="testClass" class="form-control" required onchange="Teacher.loadTestQuestionsForSelection()">
                                <option value="">Select Class</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Test Type *</label>
                            <select id="testType" class="form-control" required>
                                <option value="daily">Daily Test</option>
                                <option value="weekly">Weekly Test</option>
                                <option value="quiz">Quiz</option>
                                <option value="assignment">Assignment</option>
                                <option value="midterm">Mid-term Exam</option>
                                <option value="exam">Final Exam</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Duration (minutes)</label>
                            <input type="number" id="testDuration" class="form-control" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Record to Report Card?</label>
                            <select id="testRecordToReport" class="form-control">
                                <option value="false">No - Practice/Test Only</option>
                                <option value="true">Yes - Official Exam Score</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Instructions</label>
                        <textarea id="testInstructions" class="form-control" rows="3" placeholder="Enter instructions for students..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Select Questions *</label>
                        <div id="testQuestionsList" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); padding: 10px;">
                            <div class="text-center text-muted">Select a subject and class to see available questions</div>
                        </div>
                        <small class="text-muted">Selected: <span id="selectedQuestionsCount">0</span> questions</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('createTestModal')">Cancel</button>
                <button class="btn btn-outline" onclick="Teacher.saveTestAsDraft()">
                    <i class="fas fa-save"></i> Save as Draft
                </button>
                <button class="btn btn-primary" onclick="Teacher.publishTest()">
                    <i class="fas fa-paper-plane"></i> Publish Test
                </button>
            </div>
        </div>
    </div>

    <!-- Print Questions Modal -->
    <div id="printQuestionsModal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Print Questions</h3>
                <button class="modal-close" onclick="Modal.hide('printQuestionsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Include Answer Key?</label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="printIncludeAnswers">
                        <span>Yes, include answer key</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label">Title on Print</label>
                    <input type="text" id="printTitle" class="form-control" placeholder="e.g., First Term Mathematics Exam">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('printQuestionsModal')">Cancel</button>
                <button class="btn btn-outline" onclick="Teacher.exportQuestionsDOC()">
                    <i class="fas fa-file-word"></i> DOC
                </button>
                <button class="btn btn-outline" onclick="Teacher.exportQuestionsPDF()">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-primary" onclick="Teacher.printQuestions()">
                    <i class="fas fa-print"></i> Print
                </button>
            </div>
        </div>
    </div>

    <!-- Add Score Session Modal -->
    <div id="addScoreSessionModal" class="modal-overlay">
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">New Score Session</h3>
                <button class="modal-close" onclick="Modal.hide('addScoreSessionModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Class *</label>
                        <select id="scoreSessionClass" class="form-control" onchange="Teacher.loadStudentsForScoreSession()">
                            <option value="">Select Class</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Subject *</label>
                        <select id="scoreSessionSubject" class="form-control">
                            <option value="">Select Subject</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select id="scoreSessionType" class="form-control">
                            <option value="">Select Type</option>
                            <option value="Daily">Daily</option>
                            <option value="Weekly">Weekly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" id="scoreSessionDate" class="form-control" onchange="Teacher.loadStudentsForScoreSession()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Term</label>
                        <select id="scoreSessionTerm" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Year</label>
                        <input type="number" id="scoreSessionYear" class="form-control" value="2026">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Students & Scores</label>
                    <div id="scoreSessionStudents" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                        <div class="text-center text-muted">Select a class</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addScoreSessionModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Teacher.saveScoreSession()">
                    <i class="fas fa-save"></i> Save Session
                </button>
            </div>
        </div>
    </div>

    <!-- View Score Session Modal -->
    <div id="viewScoreSessionModal" class="modal-overlay">
        <div class="modal" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 class="modal-title">Score Session Details</h3>
                <button class="modal-close" onclick="Modal.hide('viewScoreSessionModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="scoreSessionDetails"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('viewScoreSessionModal')">Close</button>
                <button class="btn btn-outline" onclick="Teacher.downloadScoreSessionDOC(Teacher.currentViewSessionId)">
                    <i class="fas fa-file-word"></i> DOC
                </button>
                <button class="btn btn-outline" onclick="Teacher.downloadScoreSessionPDF(Teacher.currentViewSessionId)">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <script>
        const Teacher = {
            init() {
                if (!Auth.checkRole(['teacher'])) {
                    window.location.href = '../login.html';
                    return;
                }
                const user = Auth.getCurrentUser();
                document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('navUserName').textContent = user.name;
                document.getElementById('currentUserAvatar').textContent = Utils.getInitials(user.name);
                document.getElementById('navAvatar').textContent = Utils.getInitials(user.name);
                displayAnnouncementBanner();
                this.loadDashboard();
                this.applyFeatureRestrictions();
            },
            
            applyFeatureRestrictions() {
                const restrictions = [
                    { feature: 'chat', navPage: 'chat' },
                    { feature: 'scores_entry', navPage: 'scores' },
                    { feature: 'attendance_qr', navPage: 'attendance' },
                    { feature: 'reports', navPage: 'reports' }
                ];
                
                restrictions.forEach(r => {
                    if (!Auth.hasFeature(r.feature)) {
                        if (r.navPage) {
                            const navItem = document.querySelector(`.nav-item[data-page="${r.navPage}"]`);
                            if (navItem) navItem.style.display = 'none';
                        }
                    }
                });
            },
            
            checkFeatureAccess(feature) {
                if (!Auth.hasFeature(feature)) {
                    const features = Auth.RESTRICTABLE_FEATURES;
                    Toast.error(`This feature (${features[feature] || feature}) has been restricted by the Super Admin.`);
                    return false;
                }
                return true;
            },
            loadDashboard() {
                const schoolId = Auth.getCurrentSchoolId();
                const students = Storage.getStudents(schoolId);
                const classes = Storage.getClasses(schoolId);
                document.getElementById('myStudents').textContent = students.length;
                document.getElementById('myClasses').textContent = classes.length;
                const today = new Date().toISOString().split('T')[0];
                const attendance = Storage.getAttendance(schoolId, today);
                const present = attendance.filter(a => a.status === 'present').length;
                const percentage = students.length ? Math.round((present / students.length) * 100) : 0;
                document.getElementById('attendanceToday').textContent = percentage + '%';
            },
            showSection(section) {
                const featureMap = {
                    'chat': 'chat',
                    'scores': 'scores_entry',
                    'attendance': 'attendance_qr',
                    'reports': 'reports'
                };
                
                if (featureMap[section] && !Auth.hasFeature(featureMap[section])) {
                    Toast.error(`This feature has been restricted by the Super Admin.`);
                    return;
                }
                
                document.querySelectorAll('#dashboardSection, #studentsSection, #attendanceSection, #scoresSection, #reportsSection, #chatSection, #helpSection, #profileSection, #questionsSection, #testsSection, #testResultsSection, #scoreSessionsSection').forEach(el => {
                    if (el) el.style.display = 'none';
                });
                const targetEl = document.getElementById(section + 'Section');
                if (targetEl) targetEl.style.display = 'block';
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === section) item.classList.add('active');
                });
                if (section === 'students') Students.loadStudents();
                if (section === 'attendance' && typeof Attendance !== 'undefined') Attendance.init();
                if (section === 'attendance' && typeof QRScanner !== 'undefined') QRScanner.renderRecentlyScanned();
                if (section === 'scores' && typeof TeacherScores !== 'undefined') TeacherScores.init();
                if (section === 'reports' && typeof TeacherReports !== 'undefined') TeacherReports.init();
                if (section === 'chat' && typeof Chat !== 'undefined') Chat.init();
                if (section === 'help') this.loadHelpGuide();
                if (section === 'profile' && typeof Profile !== 'undefined') Profile.init();
                if (section === 'questions') this.initQuestionsSection();
                if (section === 'tests') this.initTestsSection();
                if (section === 'testResults') this.initTestResultsSection();
                if (section === 'scoreSessions') this.initScoreSessionsSection();
            },
            
            // ==================== QUESTIONS SECTION ====================
            initQuestionsSection() {
                this.loadTeacherSubjects();
                this.loadQuestions();
            },
            
            loadTeacherSubjects() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                const school = Storage.getSchoolById(schoolId);
                const teacher = Storage.getUsers(schoolId).find(u => u.id === user.id);
                
                // Ensure assignedSubjects and assignedClasses are always arrays
                let assignedSubjects = [];
                let assignedClasses = [];
                
                if (teacher) {
                    if (Array.isArray(teacher.assignedSubjects)) {
                        assignedSubjects = teacher.assignedSubjects;
                    } else if (teacher.assignedSubjects) {
                        assignedSubjects = [teacher.assignedSubjects];
                    }
                    
                    if (Array.isArray(teacher.assignedClasses)) {
                        assignedClasses = teacher.assignedClasses;
                    } else if (teacher.assignedClasses) {
                        assignedClasses = [teacher.assignedClasses];
                    }
                }
                
                // If no assigned subjects, get all subjects from school
                if (assignedSubjects.length === 0) {
                    const schoolSubjects = school?.settings?.subjects;
                    if (schoolSubjects && typeof schoolSubjects === 'object') {
                        // Subjects are stored by level (Nursery, Primary, JSS, SS)
                        Object.values(schoolSubjects).forEach(levelSubjects => {
                            if (Array.isArray(levelSubjects)) {
                                levelSubjects.forEach(subj => {
                                    if (!assignedSubjects.includes(subj)) {
                                        assignedSubjects.push(subj);
                                    }
                                });
                            }
                        });
                    }
                }
                
                // If no assigned classes, get all classes from school
                if (assignedClasses.length === 0) {
                    const schoolClasses = school?.settings?.classes;
                    if (Array.isArray(schoolClasses)) {
                        assignedClasses = schoolClasses;
                    }
                }
                
                const subjectSelects = ['questionFilterSubject', 'questionSubject', 'testFilterSubject', 'testSubject', 'resultFilterSubject'];
                const classSelects = ['questionFilterClass', 'questionClass', 'testFilterClass', 'testClass', 'resultFilterClass'];
                
                subjectSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let html = '<option value="">All Subjects</option>';
                    if (selectId === 'questionSubject' || selectId === 'testSubject') {
                        html = '<option value="">Select Subject</option>';
                    }
                    assignedSubjects.forEach(subj => {
                        html += '<option value="' + subj + '">' + subj + '</option>';
                    });
                    select.innerHTML = html;
                });
                
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let html = '<option value="">All Classes</option>';
                    if (selectId === 'questionClass' || selectId === 'testClass') {
                        html = '<option value="">Select Class</option>';
                    }
                    assignedClasses.forEach(cls => {
                        html += '<option value="' + cls + '">' + cls + '</option>';
                    });
                    select.innerHTML = html;
                });
            },
            
            loadClassesForSubject() {
                const subject = document.getElementById('questionSubject').value;
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                const school = Storage.getSchoolById(schoolId);
                const teacher = Storage.getUsers(schoolId).find(u => u.id === user.id);
                
                let assignedClasses = [];
                if (teacher && Array.isArray(teacher.assignedClasses)) {
                    assignedClasses = teacher.assignedClasses;
                } else if (school?.settings?.classes) {
                    assignedClasses = school.settings.classes;
                }
                
                let html = '<option value="">Select Class</option>';
                assignedClasses.forEach(cls => {
                    html += '<option value="' + cls + '">' + cls + '</option>';
                });
                
                // Update question class dropdown
                const questionClassSelect = document.getElementById('questionClass');
                if (questionClassSelect) questionClassSelect.innerHTML = html;
                
                // Also update test class dropdown
                const testClassSelect = document.getElementById('testClass');
                if (testClassSelect) testClassSelect.innerHTML = html;
            },
            
            loadTestClasses() {
                this.loadClassesForSubject();
                // Also load questions when subject changes
                this.loadTestQuestionsForSelection();
            },
            
            showAddQuestionModal() {
                document.getElementById('addQuestionForm').reset();
                this.loadTeacherSubjects();
                Modal.show('addQuestionModal');
            },
            
            toggleQuestionOptions() {
                const type = document.getElementById('questionType').value;
                document.getElementById('mcqOptions').style.display = type === 'mcq' ? 'block' : 'none';
                document.getElementById('tfOptions').style.display = type === 'tf' ? 'block' : 'none';
                document.getElementById('fillblankOptions').style.display = type === 'fillblank' ? 'block' : 'none';
                document.getElementById('essayOptions').style.display = type === 'essay' ? 'block' : 'none';
            },
            
            updateCorrectBadge(selectedOption) {
                // Hide all badges first
                ['A', 'B', 'C', 'D'].forEach(opt => {
                    const badge = document.getElementById('badge' + opt);
                    if (badge) badge.style.display = 'none';
                });
                // Show badge for selected option
                const badge = document.getElementById('badge' + selectedOption);
                if (badge) badge.style.display = 'inline';
            },
            
            saveQuestion() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const subject = document.getElementById('questionSubject').value;
                const className = document.getElementById('questionClass').value;
                const type = document.getElementById('questionType').value;
                const testType = document.getElementById('questionTestType').value;
                const topic = document.getElementById('questionTopic').value;
                const questionText = document.getElementById('questionText').value;
                const marks = parseInt(document.getElementById('questionMarks').value) || 1;
                const difficulty = document.getElementById('questionDifficulty').value;
                const recordToReport = document.getElementById('questionRecordToReport').checked;
                
                if (!subject || !className || !questionText) {
                    Toast.error('Please fill in all required fields');
                    return;
                }
                
                let question = {
                    id: Storage.generateId(),
                    schoolId: schoolId,
                    teacherId: user.id,
                    subject: subject,
                    class: className,
                    type: type,
                    testType: testType,
                    topic: topic,
                    question: questionText,
                    marks: marks,
                    difficulty: difficulty,
                    recordToReportCard: recordToReport,
                    createdAt: new Date().toISOString()
                };
                
                if (type === 'mcq') {
                    const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');
                    if (!correctAnswer) {
                        Toast.error('Please select the correct answer');
                        return;
                    }
                    question.options = [
                        { letter: 'A', text: document.getElementById('optionA').value },
                        { letter: 'B', text: document.getElementById('optionB').value },
                        { letter: 'C', text: document.getElementById('optionC').value },
                        { letter: 'D', text: document.getElementById('optionD').value }
                    ];
                    question.correctAnswer = correctAnswer.value;
                } else if (type === 'tf') {
                    question.correctAnswer = document.getElementById('tfCorrectAnswer').value;
                } else if (type === 'fillblank') {
                    question.correctAnswer = document.getElementById('fillblankCorrectAnswer').value;
                } else if (type === 'essay') {
                    question.correctAnswer = document.getElementById('essayModelAnswer').value;
                }
                
                Storage.addItem('questions', question);
                Toast.success('Question saved successfully!');
                Modal.hide('addQuestionModal');
                this.loadQuestions();
            },
            
            previewQuestion() {
                const type = document.getElementById('questionType').value;
                const question = document.getElementById('questionText').value;
                
                let html = '<div class="card"><div class="card-body">';
                html += '<h4>Preview</h4>';
                html += '<p>' + question + '</p>';
                
                if (type === 'mcq') {
                    const opts = ['A', 'B', 'C', 'D'];
                    const correct = document.querySelector('input[name="correctAnswer"]:checked')?.value;
                    opts.forEach(opt => {
                        const val = document.getElementById('option' + opt).value;
                        const isCorrect = opt === correct;
                        html += '<div class="option-btn ' + (isCorrect ? 'correct' : '') + '">' + opt + '. ' + val + '</div>';
                    });
                }
                html += '</div></div>';
                
                Toast.show(html);
            },
            
            loadQuestions() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const subject = document.getElementById('questionFilterSubject').value;
                const className = document.getElementById('questionFilterClass').value;
                const type = document.getElementById('questionFilterType').value;
                const testType = document.getElementById('questionFilterTestType').value;
                
                let questions = Storage.getData('questions') || [];
                questions = questions.filter(q => 
                    q.teacherId === user.id && 
                    q.schoolId === schoolId
                );
                
                if (subject) questions = questions.filter(q => q.subject === subject);
                if (className) questions = questions.filter(q => q.class === className);
                if (type) questions = questions.filter(q => q.type === type);
                if (testType) questions = questions.filter(q => q.testType === testType);
                
                const container = document.getElementById('questionsList');
                if (!questions.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-question-circle"></i><h3>No questions found</h3><p>Create your first question to get started</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>#</th><th>Question</th><th>Subject</th><th>Class</th><th>Type</th><th>Marks</th><th>Actions</th></tr></thead><tbody>';
                
                questions.forEach((q, index) => {
                    const typeLabels = { mcq: 'MCQ', tf: 'T/F', fillblank: 'Fill Blank', essay: 'Essay' };
                    html += '<tr>';
                    html += '<td>' + (index + 1) + '</td>';
                    html += '<td>' + q.question.substring(0, 50) + (q.question.length > 50 ? '...' : '') + '</td>';
                    html += '<td>' + q.subject + '</td>';
                    html += '<td>' + q.class + '</td>';
                    html += '<td><span class="test-type-badge ' + q.testType + '">' + typeLabels[q.type] + '</span></td>';
                    html += '<td>' + q.marks + '</td>';
                    html += '<td>';
                    html += '<button class="btn btn-sm btn-outline" onclick="Teacher.editQuestion(\'' + q.id + '\')"><i class="fas fa-edit"></i></button> ';
                    html += '<button class="btn btn-sm btn-outline" onclick="Teacher.printSingleQuestion(\'' + q.id + '\')"><i class="fas fa-print"></i></button> ';
                    html += '<button class="btn btn-sm btn-danger" onclick="Teacher.deleteQuestion(\'' + q.id + '\')"><i class="fas fa-trash"></i></button>';
                    html += '</td></tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            editQuestion(id) {
                Toast.info('Edit question - functionality coming soon');
            },
            
            deleteQuestion(id) {
                Modal.confirm({
                    title: 'Delete Question',
                    message: 'Are you sure you want to delete this question?',
                    onConfirm: function() {
                        Storage.deleteItem('questions', id);
                        Toast.success('Question deleted');
                        Teacher.loadQuestions();
                    }
                });
            },
            
            printSingleQuestion(id) {
                const questions = Storage.getData('questions') || [];
                const question = questions.find(q => q.id === id);
                if (question) {
                    window.printQuestion = question;
                    document.getElementById('printTitle').value = question.subject + ' - ' + question.class;
                    Modal.show('printQuestionsModal');
                }
            },
            
            // ==================== TESTS SECTION ====================
            initTestsSection() {
                this.loadTeacherSubjects();
                this.loadTests();
            },
            
            showCreateTestModal() {
                document.getElementById('createTestForm').reset();
                this.loadTeacherSubjects();
                document.getElementById('testQuestionsList').innerHTML = '<div class="text-center text-muted">Select a subject and class to see available questions</div>';
                document.getElementById('selectedQuestionsCount').textContent = '0';
                Modal.show('createTestModal');
            },
            
            loadTestQuestionsForSelection() {
                const subject = document.getElementById('testSubject').value;
                const className = document.getElementById('testClass').value;
                
                if (!subject || !className) {
                    document.getElementById('testQuestionsList').innerHTML = '<div class="text-center text-muted">Select subject and class to see available questions</div>';
                    return;
                }
                
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                let allQuestions = Storage.getData('questions') || [];
                
                // Filter by subject and class (and school)
                let questions = allQuestions.filter(q => 
                    q.schoolId === schoolId &&
                    q.subject === subject &&
                    q.class === className
                );
                
                if (!questions.length) {
                    document.getElementById('testQuestionsList').innerHTML = '<div class="text-center text-muted">No questions found for ' + subject + ' - ' + className + '<br><small>Please create questions first in Question Bank</small></div>';
                    return;
                }
                
                let html = '<div style="padding: 10px; background: var(--lighter); border-radius: 8px; margin-bottom: 10px;">';
                html += '<strong>' + questions.length + '</strong> question(s) found for ' + subject + ' - ' + className;
                html += '</div>';
                
                questions.forEach(q => {
                    html += '<label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer;">';
                    html += '<input type="checkbox" class="test-question-checkbox" value="' + q.id + '" data-marks="' + q.marks + '" onchange="Teacher.updateSelectedQuestionsCount()" style="margin-top: 5px;">';
                    html += '<div style="flex: 1;"><div>' + q.question.substring(0, 80) + (q.question.length > 80 ? '...' : '') + '</div><small class="text-muted">' + q.type + ' - ' + q.marks + ' marks</small></div>';
                    html += '</label>';
                });
                
                document.getElementById('testQuestionsList').innerHTML = html;
            },
            
            updateSelectedQuestionsCount() {
                const checkboxes = document.querySelectorAll('.test-question-checkbox:checked');
                document.getElementById('selectedQuestionsCount').textContent = checkboxes.length;
            },
            
            saveTestAsDraft() {
                this.createTest('draft');
            },
            
            publishTest() {
                this.createTest('published');
            },
            
            createTest(status) {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const title = document.getElementById('testTitle').value;
                const subject = document.getElementById('testSubject').value;
                const className = document.getElementById('testClass').value;
                const testType = document.getElementById('testType').value;
                const duration = parseInt(document.getElementById('testDuration').value) || 30;
                const recordToReport = document.getElementById('testRecordToReport').value === 'true';
                const instructions = document.getElementById('testInstructions').value;
                
                const checkboxes = document.querySelectorAll('.test-question-checkbox:checked');
                const questionIds = Array.from(checkboxes).map(cb => cb.value);
                
                if (!title || !subject || !className || !questionIds.length) {
                    Toast.error('Please fill in all required fields and select at least one question');
                    return;
                }
                
                let totalMarks = 0;
                checkboxes.forEach(cb => {
                    totalMarks += parseInt(cb.dataset.marks) || 0;
                });
                
                const test = {
                    id: Storage.generateId(),
                    schoolId: schoolId,
                    teacherId: user.id,
                    title: title,
                    subject: subject,
                    class: className,
                    testType: testType,
                    duration: duration,
                    recordToReportCard: recordToReport,
                    instructions: instructions,
                    questionIds: questionIds,
                    totalMarks: totalMarks,
                    status: status,
                    createdAt: new Date().toISOString()
                };
                
                Storage.addItem('tests', test);
                Toast.success('Test ' + (status === 'published' ? 'published' : 'saved as draft') + ' successfully!');
                Modal.hide('createTestModal');
                this.loadTests();
            },
            
            loadTests() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const subject = document.getElementById('testFilterSubject').value;
                const className = document.getElementById('testFilterClass').value;
                const status = document.getElementById('testFilterStatus').value;
                
                let tests = Storage.getData('tests') || [];
                tests = tests.filter(t => 
                    t.teacherId === user.id && 
                    t.schoolId === schoolId
                );
                
                if (subject) tests = tests.filter(t => t.subject === subject);
                if (className) tests = tests.filter(t => t.class === className);
                if (status) tests = tests.filter(t => t.status === status);
                
                const container = document.getElementById('testsList');
                if (!tests.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><h3>No tests created</h3><p>Create your first test to assign to students</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Title</th><th>Subject</th><th>Class</th><th>Type</th><th>Questions</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                tests.forEach(t => {
                    html += '<tr>';
                    html += '<td>' + t.title + '</td>';
                    html += '<td>' + t.subject + '</td>';
                    html += '<td>' + t.class + '</td>';
                    html += '<td><span class="test-type-badge ' + t.testType + '">' + t.testType + '</span></td>';
                    html += '<td>' + (t.questionIds ? t.questionIds.length : 0) + '</td>';
                    html += '<td><span class="badge badge-' + (t.status === 'published' ? 'success' : t.status === 'closed' ? 'danger' : 'warning') + '">' + t.status + '</span></td>';
                    html += '<td>';
                    html += '<div class="flex gap-1">';
                    if (t.status === 'published') {
                        html += '<button class="btn btn-sm btn-info" title="Download PDF" onclick="Teacher.downloadTestPDF(\'' + t.id + '\')"><i class="fas fa-file-pdf"></i></button> ';
                        html += '<button class="btn btn-sm btn-success" title="Download DOC" onclick="Teacher.downloadTestDOC(\'' + t.id + '\')"><i class="fas fa-file-word"></i></button> ';
                    }
                    if (t.status === 'draft') {
                        html += '<button class="btn btn-sm btn-primary" onclick="Teacher.publishTestById(\'' + t.id + '\')"><i class="fas fa-paper-plane"></i></button> ';
                    }
                    if (t.status === 'published') {
                        html += '<button class="btn btn-sm btn-warning" onclick="Teacher.closeTest(\'' + t.id + '\')"><i class="fas fa-lock"></i></button> ';
                    }
                    html += '<button class="btn btn-sm btn-danger" onclick="Teacher.deleteTest(\'' + t.id + '\')"><i class="fas fa-trash"></i></button>';
                    html += '</div>';
                    html += '</td></tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            publishTestById(id) {
                Storage.updateItem('tests', id, { status: 'published' });
                Toast.success('Test published!');
                this.loadTests();
            },
            
            closeTest(id) {
                Storage.updateItem('tests', id, { status: 'closed' });
                Toast.success('Test closed!');
                this.loadTests();
            },
            
            deleteTest(id) {
                Modal.confirm({
                    title: 'Delete Test',
                    message: 'Are you sure you want to delete this test?',
                    onConfirm: function() {
                        Storage.deleteItem('tests', id);
                        Toast.success('Test deleted');
                        Teacher.loadTests();
                    }
                });
            },
            
            downloadTestPDF(testId) {
                const test = Storage.getData('tests').find(t => t.id === testId);
                if (!test) {
                    Toast.error('Test not found');
                    return;
                }
                
                const allQuestions = Storage.getData('questions') || [];
                const questions = allQuestions.filter(q => test.questionIds.includes(q.id));
                
                const school = Storage.getSchoolById(test.schoolId);
                const schoolName = school ? school.name : 'My School';
                
                const htmlContent = ExportUtils.generateTestPrintHTML(test, questions, {
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                ExportUtils.exportToPDF(htmlContent, test.title + '.pdf');
            },
            
            downloadTestDOC(testId) {
                const test = Storage.getData('tests').find(t => t.id === testId);
                if (!test) {
                    Toast.error('Test not found');
                    return;
                }
                
                const allQuestions = Storage.getData('questions') || [];
                const questions = allQuestions.filter(q => test.questionIds.includes(q.id));
                
                const school = Storage.getSchoolById(test.schoolId);
                const schoolName = school ? school.name : 'My School';
                
                const htmlContent = ExportUtils.generateTestPrintHTML(test, questions, {
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                ExportUtils.exportToDOC(htmlContent, test.title + '.doc');
            },
            
            // ==================== TEST RESULTS SECTION ====================
            initTestResultsSection() {
                this.loadTeacherSubjects();
                this.loadTestResults();
            },
            
            loadTestResults() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const subject = document.getElementById('resultFilterSubject').value;
                const className = document.getElementById('resultFilterClass').value;
                const testType = document.getElementById('resultFilterTestType').value;
                
                let results = Storage.getData('testResults') || [];
                
                // Get teacher's test IDs
                const tests = Storage.getData('tests') || [];
                const teacherTestIds = tests.filter(t => t.teacherId === user.id).map(t => t.id);
                
                results = results.filter(r => 
                    teacherTestIds.includes(r.testId) && 
                    r.schoolId === schoolId
                );
                
                if (subject) results = results.filter(r => r.subject === subject);
                if (className) results = results.filter(r => r.class === className);
                if (testType) results = results.filter(r => r.testType === testType);
                
                // Calculate analytics
                if (results.length > 0) {
                    const totalAttempts = results.length;
                    const avgScore = results.reduce((sum, r) => sum + r.percentage, 0) / totalAttempts;
                    const highestScore = Math.max(...results.map(r => r.percentage));
                    const passedCount = results.filter(r => r.percentage >= 50).length;
                    const passRate = (passedCount / totalAttempts) * 100;
                    
                    document.getElementById('testTotalAttempts').textContent = totalAttempts;
                    document.getElementById('testAvgScore').textContent = Math.round(avgScore) + '%';
                    document.getElementById('testHighestScore').textContent = Math.round(highestScore) + '%';
                    document.getElementById('testPassRate').textContent = Math.round(passRate) + '%';
                } else {
                    document.getElementById('testTotalAttempts').textContent = '0';
                    document.getElementById('testAvgScore').textContent = '0%';
                    document.getElementById('testHighestScore').textContent = '0%';
                    document.getElementById('testPassRate').textContent = '0%';
                }
                
                const container = document.getElementById('testResultsList');
                if (!results.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-chart-line"></i><h3>No results yet</h3><p>Results will appear here after students complete tests</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Student</th><th>Test</th><th>Subject</th><th>Type</th><th>Score</th><th>Percentage</th><th>Date</th></tr></thead><tbody>';
                
                results.forEach(r => {
                    const student = Storage.getStudents(schoolId).find(s => s.id === r.studentId);
                    html += '<tr>';
                    html += '<td>' + (student ? student.name : 'Unknown') + '</td>';
                    html += '<td>' + r.testTitle + '</td>';
                    html += '<td>' + r.subject + '</td>';
                    html += '<td><span class="test-type-badge ' + r.testType + '">' + r.testType + '</span></td>';
                    html += '<td>' + r.obtainedMarks + '/' + r.totalMarks + '</td>';
                    html += '<td>' + Math.round(r.percentage) + '%</td>';
                    html += '<td>' + new Date(r.completedAt).toLocaleDateString() + '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            exportTestResultsPDF() {
                this.exportTestResults('PDF');
            },
            
            exportTestResultsDOC() {
                this.exportTestResults('DOC');
            },
            
            exportTestResults(format) {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const subject = document.getElementById('resultFilterSubject').value;
                const className = document.getElementById('resultFilterClass').value;
                const testType = document.getElementById('resultFilterTestType').value;
                
                let results = Storage.getData('testResults') || [];
                
                const tests = Storage.getData('tests') || [];
                const teacherTestIds = tests.filter(t => t.teacherId === user.id).map(t => t.id);
                
                results = results.filter(r => 
                    teacherTestIds.includes(r.testId) && 
                    r.schoolId === schoolId
                );
                
                if (subject) results = results.filter(r => r.subject === subject);
                if (className) results = results.filter(r => r.class === className);
                if (testType) results = results.filter(r => r.testType === testType);
                
                const school = Storage.getSchoolById(schoolId);
                const schoolName = school ? school.name : 'My School';
                
                const processedResults = results.map(r => {
                    const student = Storage.getStudents(schoolId).find(s => s.id === r.studentId);
                    return {
                        studentId: student ? student.admissionNo || student.id : 'N/A',
                        studentName: student ? student.name : 'Unknown',
                        subject: r.subject,
                        testType: r.testType,
                        totalMarks: r.totalMarks,
                        obtainedMarks: r.obtainedMarks,
                        percentage: r.percentage
                    };
                });
                
                const htmlContent = ExportUtils.generateTestResultsPrintHTML(processedResults, {
                    title: 'Test Results Report',
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                if (format === 'PDF') {
                    ExportUtils.exportToPDF(htmlContent, 'test-results.pdf');
                } else {
                    ExportUtils.exportToDOC(htmlContent, 'test-results.doc');
                }
            },
            
            // Print Questions
            printQuestions() {
                const includeAnswers = document.getElementById('printIncludeAnswers').checked;
                const title = document.getElementById('printTitle').value || 'Questions';
                
                let questions = [];
                if (window.printQuestion) {
                    questions = [window.printQuestion];
                } else {
                    const subject = document.getElementById('questionFilterSubject').value;
                    const className = document.getElementById('questionFilterClass').value;
                    const type = document.getElementById('questionFilterType').value;
                    
                    let allQuestions = Storage.getData('questions') || [];
                    const user = Auth.getCurrentUser();
                    const schoolId = Auth.getCurrentSchoolId();
                    
                    questions = allQuestions.filter(q => 
                        q.teacherId === user.id && 
                        q.schoolId === schoolId
                    );
                    
                    if (subject) questions = questions.filter(q => q.subject === subject);
                    if (className) questions = questions.filter(q => q.class === className);
                    if (type) questions = questions.filter(q => q.type === type);
                }
                
                const school = Storage.getSchoolById(Auth.getCurrentSchoolId());
                
                let printContent = '<html><head><title>' + title + '</title>';
                printContent += '<style>';
                printContent += 'body { font-family: Arial, sans-serif; padding: 20px; }';
                printContent += '.header { text-align: center; margin-bottom: 30px; }';
                printContent += '.school-name { font-size: 24px; font-weight: bold; }';
                printContent += '.test-title { font-size: 18px; margin-top: 10px; }';
                printContent += '.question { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; }';
                printContent += '.question-number { font-weight: bold; margin-bottom: 10px; }';
                printContent += '.options { margin-left: 20px; }';
                printContent += '.option { margin-bottom: 5px; }';
                printContent += '.correct { color: green; font-weight: bold; }';
                printContent += '.footer { text-align: center; margin-top: 30px; font-size: 12px; color: #666; }';
                printContent += '@media print { body { padding: 0; } }';
                printContent += '</style></head><body>';
                
                printContent += '<div class="header">';
                printContent += '<div class="school-name">' + (school ? school.name : 'My School') + '</div>';
                printContent += '<div class="test-title">' + title + '</div>';
                printContent += '<div>Date: ' + new Date().toLocaleDateString() + '</div>';
                printContent += '</div>';
                
                questions.forEach(function(q, index) {
                    printContent += '<div class="question">';
                    printContent += '<div class="question-number">Question ' + (index + 1) + ' (' + q.marks + ' marks)</div>';
                    printContent += '<div>' + q.question + '</div>';
                    
                    if (q.type === 'mcq' && q.options) {
                        printContent += '<div class="options">';
                        q.options.forEach(function(opt) {
                            var isCorrect = opt.letter === q.correctAnswer;
                            printContent += '<div class="option' + (isCorrect && includeAnswers ? ' correct' : '') + '">';
                            printContent += opt.letter + '. ' + opt.text;
                            if (isCorrect && includeAnswers) printContent += ' ';
                            printContent += '</div>';
                        });
                        printContent += '</div>';
                    } else if (q.type === 'tf') {
                        printContent += '<div class="options">';
                        printContent += '<div class="option' + (q.correctAnswer === 'True' && includeAnswers ? ' correct' : '') + '">A. True';
                        if (q.correctAnswer === 'True' && includeAnswers) printContent += ' ';
                        printContent += '</div>';
                        printContent += '<div class="option' + (q.correctAnswer === 'False' && includeAnswers ? ' correct' : '') + '">B. False';
                        if (q.correctAnswer === 'False' && includeAnswers) printContent += ' ';
                        printContent += '</div>';
                        printContent += '</div>';
                    } else if (q.type === 'fillblank' && includeAnswers) {
                        printContent += '<div style="margin-top: 10px;"><strong>Answer: </strong>' + q.correctAnswer + '</div>';
                    }
                    
                    printContent += '</div>';
                });
                
                printContent += '<div class="footer">';
                printContent += '<p>My School System - Odebunmi Tawwab</p>';
                printContent += '</div>';
                
                printContent += '</body></html>';
                
                var printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.print();
                
                Modal.hide('printQuestionsModal');
                window.printQuestion = null;
            },
            
            exportQuestionsPDF() {
                const includeAnswers = document.getElementById('printIncludeAnswers').checked;
                const title = document.getElementById('printTitle').value || 'Questions';
                
                let questions = [];
                if (window.printQuestion) {
                    questions = [window.printQuestion];
                } else {
                    const subject = document.getElementById('questionFilterSubject').value;
                    const className = document.getElementById('questionFilterClass').value;
                    const type = document.getElementById('questionFilterType').value;
                    
                    let allQuestions = Storage.getData('questions') || [];
                    const user = Auth.getCurrentUser();
                    const schoolId = Auth.getCurrentSchoolId();
                    
                    questions = allQuestions.filter(q => 
                        q.teacherId === user.id && 
                        q.schoolId === schoolId
                    );
                    
                    if (subject) questions = questions.filter(q => q.subject === subject);
                    if (className) questions = questions.filter(q => q.class === className);
                    if (type) questions = questions.filter(q => q.type === type);
                }
                
                const school = Storage.getSchoolById(Auth.getCurrentSchoolId());
                const schoolName = school ? school.name : 'My School';
                
                const htmlContent = ExportUtils.generateQuestionsPrintHTML(questions, {
                    title: title,
                    includeAnswers: includeAnswers,
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                ExportUtils.exportToPDF(htmlContent, title + '.pdf');
                Modal.hide('printQuestionsModal');
                window.printQuestion = null;
            },
            
            exportQuestionsDOC() {
                const includeAnswers = document.getElementById('printIncludeAnswers').checked;
                const title = document.getElementById('printTitle').value || 'Questions';
                
                let questions = [];
                if (window.printQuestion) {
                    questions = [window.printQuestion];
                } else {
                    const subject = document.getElementById('questionFilterSubject').value;
                    const className = document.getElementById('questionFilterClass').value;
                    const type = document.getElementById('questionFilterType').value;
                    
                    let allQuestions = Storage.getData('questions') || [];
                    const user = Auth.getCurrentUser();
                    const schoolId = Auth.getCurrentSchoolId();
                    
                    questions = allQuestions.filter(q => 
                        q.teacherId === user.id && 
                        q.schoolId === schoolId
                    );
                    
                    if (subject) questions = questions.filter(q => q.subject === subject);
                    if (className) questions = questions.filter(q => q.class === className);
                    if (type) questions = questions.filter(q => q.type === type);
                }
                
                const school = Storage.getSchoolById(Auth.getCurrentSchoolId());
                const schoolName = school ? school.name : 'My School';
                
                const htmlContent = ExportUtils.generateQuestionsPrintHTML(questions, {
                    title: title,
                    includeAnswers: includeAnswers,
                    schoolName: schoolName,
                    ownerName: 'Odebunmi Tawwab'
                });
                
                ExportUtils.exportToDOC(htmlContent, title + '.doc');
                Modal.hide('printQuestionsModal');
                window.printQuestion = null;
            },
            
            // ==================== SCORE SESSIONS ====================
            initScoreSessionsSection() {
                this.loadTeacherSubjectsForScoreSessions();
                this.loadScoreSessions();
            },
            
            loadTeacherSubjectsForScoreSessions() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                const school = Storage.getSchoolById(schoolId);
                const teacher = Storage.getUsers(schoolId).find(u => u.id === user.id);
                
                let assignedSubjects = [];
                let assignedClasses = [];
                
                if (teacher) {
                    if (Array.isArray(teacher.assignedSubjects)) assignedSubjects = teacher.assignedSubjects;
                    else if (teacher.assignedSubjects) assignedSubjects = [teacher.assignedSubjects];
                    
                    if (Array.isArray(teacher.assignedClasses)) assignedClasses = teacher.assignedClasses;
                    else if (teacher.assignedClasses) assignedClasses = [teacher.assignedClasses];
                }
                
                if (assignedSubjects.length === 0 && school?.settings?.subjects) {
                    Object.values(school.settings.subjects).forEach(levelSubjects => {
                        if (Array.isArray(levelSubjects)) {
                            levelSubjects.forEach(subj => {
                                if (!assignedSubjects.includes(subj)) assignedSubjects.push(subj);
                            });
                        }
                    });
                }
                
                if (assignedClasses.length === 0 && school?.settings?.classes) {
                    assignedClasses = school.settings.classes;
                }
                
                const classSelects = ['scoreSessionFilterClass', 'scoreSessionClass'];
                const subjectSelects = ['scoreSessionFilterSubject', 'scoreSessionSubject'];
                
                classSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let html = '<option value="">All Classes</option>';
                    if (selectId === 'scoreSessionClass') html = '<option value="">Select Class</option>';
                    assignedClasses.forEach(cls => { html += '<option value="' + cls + '">' + cls + '</option>'; });
                    select.innerHTML = html;
                });
                
                subjectSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (!select) return;
                    let html = '<option value="">All Subjects</option>';
                    if (selectId === 'scoreSessionSubject') html = '<option value="">Select Subject</option>';
                    assignedSubjects.forEach(subj => { html += '<option value="' + subj + '">' + subj + '</option>'; });
                    select.innerHTML = html;
                });
            },
            
            loadScoreSessions() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const filters = {
                    teacherId: user.id,
                    class: document.getElementById('scoreSessionFilterClass')?.value,
                    subject: document.getElementById('scoreSessionFilterSubject')?.value,
                    type: document.getElementById('scoreSessionFilterType')?.value,
                    date: document.getElementById('scoreSessionFilterDate')?.value
                };
                
                const sessions = Storage.getScoreSessions(schoolId, filters);
                const container = document.getElementById('scoreSessionsList');
                
                if (!container) return;
                
                if (!sessions.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-calculator"></i><h3>No score sessions</h3><p>Create a new score session</p></div>';
                    return;
                }
                
                let html = '<div class="table-container"><table class="table"><thead><tr><th>Date</th><th>Class</th><th>Subject</th><th>Type</th><th>Term</th><th>Students</th><th>Avg</th><th>Actions</th></tr></thead><tbody>';
                
                sessions.forEach(session => {
                    html += '<tr>';
                    html += '<td>' + session.date + '</td>';
                    html += '<td>' + session.class + '</td>';
                    html += '<td>' + session.subject + '</td>';
                    html += '<td><span class="test-type-badge ' + session.type.toLowerCase() + '">' + session.type + '</span></td>';
                    html += '<td>' + session.term + '</td>';
                    html += '<td>' + (session.scores?.length || 0) + '</td>';
                    html += '<td>' + (session.averageScore ? session.averageScore.toFixed(1) + '%' : '-') + '</td>';
                    html += '<td><div class="flex gap-1">';
                    html += '<button class="btn btn-sm btn-info" onclick="Teacher.viewScoreSession(\'' + session.id + '\')"><i class="fas fa-eye"></i></button> ';
                    html += '<button class="btn btn-sm btn-primary" onclick="Teacher.downloadScoreSessionPDF(\'' + session.id + '\')"><i class="fas fa-file-pdf"></i></button> ';
                    html += '<button class="btn btn-sm btn-success" onclick="Teacher.downloadScoreSessionDOC(\'' + session.id + '\')"><i class="fas fa-file-word"></i></button> ';
                    html += '<button class="btn btn-sm btn-danger" onclick="Teacher.deleteScoreSession(\'' + session.id + '\')"><i class="fas fa-trash"></i></button>';
                    html += '</div></td></tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            },
            
            showAddScoreSessionModal() {
                this.loadTeacherSubjectsForScoreSessions();
                const schoolId = Auth.getCurrentSchoolId();
                const school = Storage.getSchoolById(schoolId);
                const terms = school?.settings?.terms || ['First Term', 'Second Term', 'Third Term'];
                
                let termsHtml = '';
                terms.forEach(term => { termsHtml += '<option value="' + term + '">' + term + '</option>'; });
                
                const termSelect = document.getElementById('scoreSessionTerm');
                if (termSelect) termSelect.innerHTML = termsHtml;
                
                const yearInput = document.getElementById('scoreSessionYear');
                if (yearInput) yearInput.value = new Date().getFullYear();
                
                const dateInput = document.getElementById('scoreSessionDate');
                if (dateInput) dateInput.value = new Date().toISOString().split('T')[0];
                
                const studentsDiv = document.getElementById('scoreSessionStudents');
                if (studentsDiv) studentsDiv.innerHTML = '<div class="text-center text-muted">Select a class</div>';
                
                Modal.show('addScoreSessionModal');
            },
            
            loadStudentsForScoreSession() {
                const className = document.getElementById('scoreSessionClass')?.value;
                const date = document.getElementById('scoreSessionDate')?.value;
                const schoolId = Auth.getCurrentSchoolId();
                const container = document.getElementById('scoreSessionStudents');
                
                if (!container) return;
                if (!className) {
                    container.innerHTML = '<div class="text-center text-muted">Select a class</div>';
                    return;
                }
                
                const students = Storage.getStudents(schoolId).filter(s => s.class === className && s.status === 'active');
                const attendance = date ? Storage.getAttendance(schoolId, date, className) : [];
                
                if (!students.length) {
                    container.innerHTML = '<div class="text-center text-muted">No students in this class</div>';
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Student</th><th>Adm No</th><th>Present</th><th>Score</th></tr></thead><tbody>';
                
                students.forEach(student => {
                    const record = attendance.find(a => a.studentId === student.id);
                    const isPresent = record?.status === 'present';
                    
                    html += '<tr>';
                    html += '<td>' + student.name + '</td>';
                    html += '<td>' + (student.admissionNo || '-') + '</td>';
                    html += '<td><span class="badge badge-' + (isPresent ? 'success' : 'danger') + '">' + (isPresent ? 'Present' : 'Absent') + '</span></td>';
                    html += '<td><input type="number" class="form-control" min="0" max="100" data-student-id="' + student.id + '" placeholder="Score" ' + (isPresent ? '' : 'disabled') + '></td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            
            saveScoreSession() {
                const user = Auth.getCurrentUser();
                const schoolId = Auth.getCurrentSchoolId();
                
                const className = document.getElementById('scoreSessionClass')?.value;
                const subject = document.getElementById('scoreSessionSubject')?.value;
                const scoreType = document.getElementById('scoreSessionType')?.value;
                const term = document.getElementById('scoreSessionTerm')?.value;
                const year = document.getElementById('scoreSessionYear')?.value;
                const date = document.getElementById('scoreSessionDate')?.value;
                
                if (!className || !subject || !scoreType || !date) {
                    Toast.error('Please fill all required fields');
                    return;
                }
                
                const scoreInputs = document.querySelectorAll('#scoreSessionStudents input[data-student-id]');
                const scores = [];
                let totalScore = 0, count = 0;
                
                scoreInputs.forEach(input => {
                    const score = parseInt(input.value);
                    if (!isNaN(score) && score >= 0) {
                        scores.push({ studentId: input.dataset.studentId, score: score });
                        totalScore += score;
                        count++;
                    }
                });
                
                const existingSessions = Storage.getScoreSessions(schoolId, { class: className, subject: subject, type: scoreType, date: date });
                
                if (existingSessions.length > 0) {
                    if (!confirm('A session already exists for this date/class/subject/type. Save anyway?')) return;
                }
                
                const session = {
                    schoolId: schoolId,
                    teacherId: user.id,
                    teacherName: user.name,
                    class: className,
                    subject: subject,
                    type: scoreType,
                    term: term,
                    year: year,
                    date: date,
                    scores: scores,
                    totalStudents: scores.length,
                    averageScore: count > 0 ? totalScore / count : 0,
                    status: 'saved'
                };
                
                Storage.addScoreSession(session);
                Toast.success('Score session saved!');
                Modal.hide('addScoreSessionModal');
                this.loadScoreSessions();
            },
            
            viewScoreSession(sessionId) {
                this.currentViewSessionId = sessionId;
                const schoolId = Auth.getCurrentSchoolId();
                const sessions = Storage.getScoreSessions(schoolId);
                const session = sessions.find(s => s.id === sessionId);
                const container = document.getElementById('scoreSessionDetails');
                
                if (!session || !container) {
                    Toast.error('Session not found');
                    return;
                }
                
                const students = Storage.getStudents(schoolId);
                
                let html = '<div class="card mb-3"><div class="card-header"><h3>Details</h3></div><div class="card-body">';
                html += '<p><strong>Date:</strong> ' + session.date + '</p>';
                html += '<p><strong>Class:</strong> ' + session.class + '</p>';
                html += '<p><strong>Subject:</strong> ' + session.subject + '</p>';
                html += '<p><strong>Type:</strong> ' + session.type + '</p>';
                html += '<p><strong>Term:</strong> ' + session.term + '</p>';
                html += '<p><strong>Average:</strong> ' + (session.averageScore ? session.averageScore.toFixed(1) + '%' : '-') + '</p>';
                html += '</div></div>';
                
                html += '<div class="card"><div class="card-header"><h3>Scores</h3></div><div class="card-body">';
                html += '<table class="table"><thead><tr><th>Student</th><th>Adm No</th><th>Score</th></tr></thead><tbody>';
                
                session.scores.forEach(s => {
                    const student = students.find(st => st.id === s.studentId);
                    html += '<tr><td>' + (student?.name || 'N/A') + '</td><td>' + (student?.admissionNo || '-') + '</td><td>' + s.score + '</td></tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                Modal.show('viewScoreSessionModal');
            },
            
            deleteScoreSession(sessionId) {
                Modal.confirm({
                    title: 'Delete Session',
                    message: 'Delete this score session?',
                    onConfirm: () => {
                        Storage.deleteScoreSession(sessionId);
                        Toast.success('Deleted');
                        this.loadScoreSessions();
                    }
                });
            },
            
            downloadScoreSessionPDF(sessionId) { this.downloadScoreSession(sessionId, 'PDF'); },
            downloadScoreSessionDOC(sessionId) { this.downloadScoreSession(sessionId, 'DOC'); },
            
            downloadScoreSession(sessionId, format) {
                const schoolId = Auth.getCurrentSchoolId();
                const sessions = Storage.getScoreSessions(schoolId);
                const session = sessions.find(s => s.id === sessionId);
                const school = Storage.getSchoolById(schoolId);
                
                if (!session) { Toast.error('Not found'); return; }
                
                const students = Storage.getStudents(schoolId);
                
                let html = '<html><head><title>Score Report</title>';
                html += '<style>body{font-family:Arial;padding:40px;max-width:800px;margin:0 auto}.header{text-align:center;margin-bottom:20px;border-bottom:2px solid #333}.info{margin:15px 0}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:10px;text-align:left}th{background:#f5f5f5}.summary{background:#f0f0f0;padding:15px;margin-top:20px}.footer{text-align:center;margin-top:30px;font-size:12px;color:#666}</style></head><body>';
                html += '<div class="header"><div><strong>' + (school?.name || 'My School') + '</strong></div><div>Score Session Report</div></div>';
                html += '<div class="info"><p><strong>Date:</strong> ' + session.date + '</p>';
                html += '<p><strong>Class:</strong> ' + session.class + ' | <strong>Subject:</strong> ' + | <strong>Type:</strong> session.subject + ' ' + session.type + '</p>';
                html += '<p><strong>Term:</strong> ' + session.term + ' | <strong>Year:</strong> ' + session.year + '</p></div>';
                html += '<table><thead><tr><th>S/N</th><th>Student</th><th>Adm No</th><th>Score</th></tr></thead><tbody>';
                
                session.scores.forEach((s, i) => {
                    const student = students.find(st => st.id === s.studentId);
                    html += '<tr><td>' + (i+1) + '</td><td>' + (student?.name || 'N/A') + '</td><td>' + (student?.admissionNo || '-') + '</td><td>' + s.score + '</td></tr>';
                });
                
                html += '</tbody></table>';
                html += '<div class="summary"><p><strong>Total:</strong> ' + session.scores.length + ' | <strong>Average:</strong> ' + (session.averageScore ? session.averageScore.toFixed(2) : '0') + '%</p></div>';
                html += '<div class="footer"><p>My School System - Odebunmi Tawwab</p></div></body></html>';
                
                if (format === 'PDF') ExportUtils.exportToPDF(html, 'score-' + session.date + '.pdf');
                else ExportUtils.exportToDOC(html, 'score-' + session.date + '.doc');
            },
            
            loadHelpGuide() {
                const role = 'teacher';
                const content = Storage.getHelpContent(role);
                const container = document.getElementById('helpGuideContainer');
                if (!content || !content.sections || !content.sections.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-question-circle"></i><h3>No help content available</h3><p>Contact your administrator for assistance.</p></div>';
                    return;
                }
                let html = `
                    <div class="help-guide-container">
                        <div class="help-guide-header">
                            <h2>${content.title}</h2>
                        </div>
                        <div class="help-guide-accordion">
                `;
                content.sections.forEach((section, index) => {
                    html += `
                        <div class="help-accordion-item ${index === 0 ? 'active' : ''}">
                            <div class="help-accordion-header" onclick="this.parentElement.classList.toggle('active')">
                                <div class="help-accordion-title">
                                    <i class="fas ${section.icon || 'fa-book'}"></i>
                                    <span>${section.title}</span>
                                </div>
                                <i class="fas fa-chevron-down help-accordion-arrow"></i>
                            </div>
                            <div class="help-accordion-body">
                                <div class="help-content">${section.content}</div>
                            </div>
                        </div>
                    `;
                });
                html += '</div></div>';
                container.innerHTML = html;
            },
            showProfile() {
                this.showSection('profile');
            },
            saveStudent() {
                const form = document.getElementById('studentForm');
                const formData = new FormData(form);
                const studentData = Object.fromEntries(formData.entries());
                studentData.schoolId = Auth.getCurrentSchoolId();
                studentData.status = 'active';
                
                const passportInput = document.getElementById('studentPassport');
                if (passportInput && passportInput.files[0]) {
                    Teacher.processStudentPassport(passportInput.files[0], (passportUrl) => {
                        studentData.passportUrl = passportUrl;
                        Teacher.saveStudentData(studentData, form);
                    });
                } else {
                    Teacher.saveStudentData(studentData, form);
                }
            },
            processStudentPassport(file, callback) {
                if (file.size > 500 * 1024) {
                    Toast.error('Image size must be less than 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    callback(e.target.result);
                };
                reader.readAsDataURL(file);
            },
            previewStudentPassport(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('studentPassportPreview').style.display = 'block';
                        document.getElementById('studentPassportImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearStudentPassport() {
                document.getElementById('studentPassport').value = '';
                document.getElementById('studentPassportPreview').style.display = 'none';
                document.getElementById('studentPassportImg').src = '';
            },
            saveStudentData(studentData, form) {
                const result = Storage.addItem('students', studentData);
                if (result) {
                    Toast.success('Student added successfully');
                    Modal.hide('addStudentModal');
                    form.reset();
                    Teacher.clearStudentPassport();
                    this.loadStudents();
                } else {
                    Toast.error('Failed to add student');
                }
            },
            importCSV(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    if (lines.length < 2) {
                        Toast.error('CSV file is empty');
                        return;
                    }
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let imported = 0;
                    const schoolId = Auth.getCurrentSchoolId();
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((h, idx) => row[h] = values[idx] || '');
                        if (row.name && row.class) {
                            Storage.addItem('students', {
                                name: row.name,
                                class: row.class,
                                email: row.email || '',
                                phone: row.phone || '',
                                gender: row.gender || '',
                                parentName: row.parentname || '',
                                parentPhone: row.parentphone || '',
                                schoolId,
                                status: 'active'
                            });
                            imported++;
                        }
                    }
                    Toast.success(`Imported ${imported} students`);
                    this.loadStudents();
                    input.value = '';
                };
                reader.readAsText(file);
            }
        };

        const NotificationPanel = {
            init() { this.loadNotifications(); },
            loadNotifications() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
                const unreadNotifications = notifications.filter(n => n.userId === user.id && !n.read);
                const dot = document.getElementById('notificationDot');
                if (dot) dot.style.display = unreadNotifications.length > 0 ? 'block' : 'none';
                const list = document.getElementById('notificationList');
                if (!list) return;
                if (userNotifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
                    return;
                }
                let html = '';
                userNotifications.forEach(notif => {
                    const time = this.getTimeAgo(notif.createdAt);
                    const iconClass = this.getIconClass(notif.type);
                    html += `<div class="notification-dropdown-item ${notif.read ? '' : 'unread'}" onclick="NotificationPanel.handleNotificationClick('${notif.id}')">
                        <div class="notification-dropdown-icon ${notif.type || 'info'}"><i class="fas ${iconClass}"></i></div>
                        <div class="notification-dropdown-content"><p>${notif.message}</p><div class="notification-dropdown-time">${time}</div></div></div>`;
                });
                list.innerHTML = html;
            },
            getIconClass(type) {
                const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', error: 'fa-times-circle', message: 'fa-envelope', student: 'fa-user-graduate', score: 'fa-clipboard-list', attendance: 'fa-clipboard-check', finance: 'fa-wallet' };
                return icons[type] || 'fa-bell';
            },
            getTimeAgo(dateStr) {
                const date = new Date(dateStr), now = new Date(), diff = now - date;
                const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            },
            toggle() {
                const dropdown = document.getElementById('notificationDropdown');
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) this.loadNotifications();
            },
            handleNotificationClick(notifId) {
                const notifications = Storage.getData('notifications') || [];
                const index = notifications.findIndex(n => n.id === notifId);
                if (index !== -1) { notifications[index].read = true; Storage.setData('notifications', notifications); this.loadNotifications(); }
                document.getElementById('notificationDropdown').classList.remove('show');
            },
            markAllRead() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                notifications.forEach(n => { if (n.userId === user.id) n.read = true; });
                Storage.setData('notifications', notifications);
                this.loadNotifications();
            }
        };

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const btn = document.querySelector('.notification-container');
            if (dropdown && btn && !btn.contains(e.target)) dropdown.classList.remove('show');
        });

        Profile.init = function() { this.loadProfile(); };
        
        Profile.loadProfile = function() {
            const user = Auth.getCurrentUser();
            if (!user) return;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1).replace('_', ' ');
            document.getElementById('profileNameInput').value = user.name || '';
            document.getElementById('profileEmailInput').value = user.email || '';
            document.getElementById('profilePhoneInput').value = user.phone || '';
            document.getElementById('profileAddressInput').value = user.address || '';
            document.getElementById('profileGenderInput').value = user.gender || '';
            const initials = Utils.getInitials(user.name);
            document.getElementById('profileAvatarInitials').textContent = initials;
            if (user.avatar) {
                const img = document.getElementById('profileAvatarImg');
                img.src = user.avatar;
                img.style.display = 'block';
                document.getElementById('profileAvatarInitials').style.display = 'none';
            }
            const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            document.getElementById('profileMemberSince').textContent = createdAt;
            const activityData = this.getActivityData();
            document.getElementById('activityScore').textContent = activityData.score;
            document.getElementById('totalLogins').textContent = activityData.logins;
            this.loadRecentActivity();
            this.loadNotifications();
        };
        
        Profile.getActivityData = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id);
            const score = Math.min(100, userActivities.length * 5 + (user.createdAt ? 10 : 0));
            const logins = userActivities.filter(a => a.type === 'login').length || 1;
            return { score, logins };
        };
        
        Profile.loadRecentActivity = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileActivityList');
            if (!userActivities.length) {
                container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>';
                return;
            }
            let html = '<div class="activity-timeline">';
            userActivities.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleString();
                const iconMap = { login: 'fa-sign-in-alt', profile_update: 'fa-user-edit', password_change: 'fa-key', student_add: 'fa-user-plus', score_entry: 'fa-clipboard-list', attendance: 'fa-clipboard-check' };
                const icon = iconMap[activity.type] || 'fa-circle';
                html += `<div class="activity-item"><div class="activity-icon"><i class="fas ${icon}"></i></div><div class="activity-content"><p>${activity.description || activity.type}</p><span class="activity-time">${date}</span></div></div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        };
        
        Profile.loadNotifications = function() {
            const user = Auth.getCurrentUser();
            const notifications = Storage.getData('notifications') || [];
            const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileNotifications');
            if (!userNotifications.length) {
                container.innerHTML = '<div class="empty-state"><p>No notifications</p></div>';
                return;
            }
            let html = '<div class="notifications-list">';
            userNotifications.forEach(notif => {
                const date = new Date(notif.timestamp || notif.createdAt).toLocaleString();
                html += `<div class="notification-item ${notif.read ? '' : 'unread'}"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><p>${notif.message}</p><span class="notification-time">${date}</span></div></div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        };
        
        Profile.handleAvatarUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { this.updateAvatar(e.target.result); };
            reader.readAsDataURL(file);
            input.value = '';
        };
        
        Profile.updateAvatar = function(avatarData) {
            const user = Auth.getCurrentUser();
            const result = Auth.updateProfile(user.id, { avatar: avatarData });
            if (result.success) {
                Toast.success('Profile picture updated');
                this.loadProfile();
                this.updateNavAvatar(avatarData);
                this.updateSidebarAvatar(avatarData);
            } else { Toast.error('Failed to update profile picture'); }
        };
        
        Profile.updateNavAvatar = function(avatarData) {
            const navAvatar = document.getElementById('navAvatar');
            if (navAvatar) { if (avatarData) { navAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; } }
        };
        
        Profile.updateSidebarAvatar = function(avatarData) {
            const sidebarAvatar = document.getElementById('currentUserAvatar');
            if (sidebarAvatar) { if (avatarData) { sidebarAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; } }
        };
        
        Profile.saveProfile = function() {
            const user = Auth.getCurrentUser();
            const name = document.getElementById('profileNameInput').value.trim();
            const email = document.getElementById('profileEmailInput').value.trim();
            const phone = document.getElementById('profilePhoneInput').value.trim();
            const address = document.getElementById('profileAddressInput').value.trim();
            const gender = document.getElementById('profileGenderInput').value;
            if (!name) { Toast.error('Name is required'); return; }
            const updates = { name, email, phone, address, gender };
            const result = Auth.updateProfile(user.id, updates);
            if (result.success) {
                Toast.success('Profile updated successfully');
                this.loadProfile();
                document.getElementById('welcomeName').textContent = name.split(' ')[0];
                document.getElementById('currentUserName').textContent = name;
                document.getElementById('navUserName').textContent = name;
                document.getElementById('profileName').textContent = name;
                this.logActivity('profile_update', 'Updated profile information');
                Auth.addNotification(user.id, 'Your profile information was updated', 'info');
                NotificationPanel.init();
            } else { Toast.error('Failed to update profile'); }
        };
        
        Profile.logActivity = function(type, description) {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            activities.push({ id: Storage.generateId(), userId: user.id, type, description, timestamp: new Date().toISOString() });
            Storage.setData('activities', activities);
        };
        
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('active'); }
        
        // Close sidebar when clicking on nav items (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });
        
        // Close sidebar when clicking outside (mobile overlay)
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 992 && 
                sidebar && sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
        
        function toggleDarkMode() {
            const isDark = ThemeManager.toggleDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        function initDarkModeToggle() {
            const isDark = ThemeManager.isDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        const TeacherReports = {
            currentStudent: null,
            
            init() {
                this.loadClasses();
                this.loadSavedReports();
            },
            
            loadClasses() {
                const schoolId = Auth.getCurrentSchoolId();
                const classes = Storage.getClasses(schoolId);
                const select = document.getElementById('reportClassSelect');
                if (!select) return;
                select.innerHTML = '<option value="">Select Class</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
            },
            
            loadStudents() {
                const schoolId = Auth.getCurrentSchoolId();
                const classSelect = document.getElementById('reportClassSelect');
                const studentSelect = document.getElementById('reportStudentSelect');
                const selectedClass = classSelect?.value;
                
                if (!selectedClass) {
                    studentSelect.innerHTML = '<option value="">Select Student</option>';
                    return;
                }
                
                const students = Storage.getStudentsByClass(schoolId, selectedClass);
                studentSelect.innerHTML = '<option value="">Select Student</option>' + 
                    students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            },
            
            loadStudentData() {
                const studentId = document.getElementById('reportStudentSelect').value;
                const schoolId = Auth.getCurrentSchoolId();
                const container = document.getElementById('reportStudentOverview');
                
                if (!studentId) {
                    container.innerHTML = '<p class="text-muted">Select a student to view their overview</p>';
                    return;
                }
                
                const student = Storage.getItemById('students', studentId);
                const className = document.getElementById('reportClassSelect').value;
                const term = document.getElementById('reportTermSelect').value;
                const year = document.getElementById('reportYearSelect').value;
                
                const scores = Storage.getScores(schoolId, studentId, className);
                const termScores = scores.filter(s => s.term === term && s.year === parseInt(year));
                
                const attendance = Storage.getAttendance(schoolId);
                const studentAttendance = attendance.filter(a => a.studentId === studentId);
                const presentCount = studentAttendance.filter(a => a.status === 'present').length;
                const attendancePercent = studentAttendance.length > 0 ? Math.round((presentCount / studentAttendance.length) * 100) : 0;
                
                const totalScore = termScores.reduce((sum, s) => sum + (s.score || 0), 0);
                const avgScore = termScores.length > 0 ? (totalScore / termScores.length).toFixed(1) : 0;
                
                this.currentStudent = student;
                
                container.innerHTML = `
                    <div class="grid-2">
                        <div><strong>Name:</strong> ${student?.name || 'N/A'}</div>
                        <div><strong>Class:</strong> ${className}</div>
                        <div><strong>Gender:</strong> ${student?.gender || 'N/A'}</div>
                        <div><strong>Attendance:</strong> ${attendancePercent}%</div>
                        <div><strong>Average Score:</strong> ${avgScore}</div>
                        <div><strong>Total Subjects:</strong> ${termScores.length}</div>
                    </div>
                `;
                
                this.loadExistingReport(studentId, className, term, year);
            },
            
            loadExistingReport(studentId, className, term, year) {
                const reports = Storage.getData('studentReports') || [];
                const existing = reports.find(r => 
                    r.studentId === studentId && 
                    r.className === className && 
                    r.term === term && 
                    r.year === parseInt(year)
                );
                
                if (existing) {
                    document.getElementById('reportAcademic').value = existing.academic || '';
                    document.getElementById('reportBehavior').value = existing.behavior || '';
                    document.getElementById('reportAttendance').value = existing.attendance || '';
                    document.getElementById('reportRecommendation').value = existing.recommendation || '';
                } else {
                    document.getElementById('reportAcademic').value = '';
                    document.getElementById('reportBehavior').value = '';
                    document.getElementById('reportAttendance').value = '';
                    document.getElementById('reportRecommendation').value = '';
                }
            },
            
            saveReport() {
                const studentId = document.getElementById('reportStudentSelect').value;
                const className = document.getElementById('reportClassSelect').value;
                const term = document.getElementById('reportTermSelect').value;
                const year = document.getElementById('reportYearSelect').value;
                
                if (!studentId || !className) {
                    Toast.error('Please select a student');
                    return;
                }
                
                const reportData = {
                    studentId,
                    className,
                    term,
                    year: parseInt(year),
                    academic: document.getElementById('reportAcademic').value.trim(),
                    behavior: document.getElementById('reportBehavior').value.trim(),
                    attendance: document.getElementById('reportAttendance').value.trim(),
                    recommendation: document.getElementById('reportRecommendation').value.trim(),
                    teacherId: Auth.getCurrentUser()?.id,
                    schoolId: Auth.getCurrentSchoolId(),
                    createdAt: new Date().toISOString()
                };
                
                const reports = Storage.getData('studentReports') || [];
                const existingIndex = reports.findIndex(r => 
                    r.studentId === studentId && 
                    r.className === className && 
                    r.term === term && 
                    r.year === parseInt(year)
                );
                
                if (existingIndex !== -1) {
                    reports[existingIndex] = { ...reports[existingIndex], ...reportData, updatedAt: new Date().toISOString() };
                } else {
                    reportData.id = Storage.generateId();
                    reports.push(reportData);
                }
                
                Storage.setData('studentReports', reports);
                Toast.success('Report saved successfully');
                this.loadSavedReports();
            },
            
            loadSavedReports() {
                const schoolId = Auth.getCurrentSchoolId();
                const reports = Storage.getData('studentReports') || [];
                const container = document.getElementById('savedReportsList');
                
                const teacherReports = reports.filter(r => r.schoolId === schoolId);
                
                if (teacherReports.length === 0) {
                    container.innerHTML = '<p class="text-muted">No reports saved yet</p>';
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Student</th><th>Class</th><th>Term</th><th>Year</th><th>Actions</th></tr></thead><tbody>';
                
                teacherReports.slice(0, 10).forEach(report => {
                    const student = Storage.getItemById('students', report.studentId);
                    html += `
                        <tr>
                            <td>${student?.name || 'Unknown'}</td>
                            <td>${report.className}</td>
                            <td>${report.term}</td>
                            <td>${report.year}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="TeacherReports.viewReport('${report.id}')"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            
            viewReport(reportId) {
                const reports = Storage.getData('studentReports') || [];
                const report = reports.find(r => r.id === reportId);
                if (!report) return;
                
                const student = Storage.getItemById('students', report.studentId);
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Student Report - ${student?.name}</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p><strong>Class:</strong> ${report.className} | <strong>Term:</strong> ${report.term} | <strong>Year:</strong> ${report.year}</p>
                            <hr>
                            <h5>Academic Performance</h5>
                            <p>${report.academic || 'No comment'}</p>
                            <h5>Behavior</h5>
                            <p>${report.behavior || 'No comment'}</p>
                            <h5>Attendance</h5>
                            <p>${report.attendance || 'No comment'}</p>
                            <h5>Recommendation</h5>
                            <p>${report.recommendation || 'No comment'}</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            currentReportType: null,
            
            showReportType(type) {
                this.currentReportType = type;
                const filtersCard = document.getElementById('reportFilters');
                const contentCard = document.getElementById('reportContent');
                const filtersContent = document.getElementById('reportFiltersContent');
                const titleEl = document.getElementById('reportTypeTitle');
                
                filtersCard.style.display = 'block';
                contentCard.style.display = 'none';
                
                const schoolId = Auth.getCurrentSchoolId();
                const user = Auth.getCurrentUser();
                const classes = Storage.getSchoolClasses(schoolId);
                const subjectsObj = Storage.getSchoolSubjects(schoolId) || {};
                const subjects = Array.isArray(subjectsObj) ? subjectsObj : Object.values(subjectsObj).flat();
                const scoreTypes = Storage.getSchoolScoreTypes(schoolId);
                
                const yearOptions = `<option value="2026">2026</option><option value="2025">2025</option><option value="2024">2024</option>`;
                const termOptions = `<option value="First Term">First Term</option><option value="Second Term">Second Term</option><option value="Third Term">Third Term</option>`;
                
                let html = '';
                
                switch(type) {
                    case 'student':
                        titleEl.textContent = 'Student Report';
                        const students = Storage.getStudents(schoolId);
                        html = `
                            <div class="form-group">
                                <label class="form-label">Student</label>
                                <select id="filterStudent" class="form-control">
                                    <option value="">Select Student</option>
                                    ${students.map(s => `<option value="${s.id}">${s.name} - ${s.class}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Term</label>
                                <select id="filterTerm" class="form-control">${termOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year</label>
                                <select id="filterYear" class="form-control">${yearOptions}</select>
                            </div>
                        `;
                        break;
                        
                    case 'class':
                        titleEl.textContent = 'Class Report';
                        html = `
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <select id="filterClass" class="form-control">
                                    <option value="">Select Class</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Term</label>
                                <select id="filterTerm" class="form-control">${termOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year</label>
                                <select id="filterYear" class="form-control">${yearOptions}</select>
                            </div>
                        `;
                        break;
                        
                    case 'attendance':
                        titleEl.textContent = 'Attendance Report';
                        html = `
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <select id="filterClass" class="form-control">
                                    <option value="">Select Class</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Term</label>
                                <select id="filterTerm" class="form-control">${termOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year</label>
                                <select id="filterYear" class="form-control">${yearOptions}</select>
                            </div>
                        `;
                        break;
                        
                    case 'scores':
                        titleEl.textContent = 'Scores Report';
                        html = `
                            <div class="form-group">
                                <label class="form-label">Score Type</label>
                                <select id="filterScoreType" class="form-control">
                                    <option value="all">All Types</option>
                                    ${scoreTypes.map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Class</label>
                                <select id="filterClass" class="form-control">
                                    <option value="">Select Class</option>
                                    ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Subject</label>
                                <select id="filterSubject" class="form-control">
                                    <option value="">All Subjects</option>
                                    ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Term</label>
                                <select id="filterTerm" class="form-control">${termOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Year</label>
                                <select id="filterYear" class="form-control">${yearOptions}</select>
                            </div>
                        `;
                        break;
                        
                    case 'continuous':
                        titleEl.textContent = 'Continuous Assessment (Daily/Weekly)';
                        const hasDaily = scoreTypes.includes('Daily');
                        const hasWeekly = scoreTypes.includes('Weekly');
                        
                        if (!hasDaily && !hasWeekly) {
                            html = `<div class="alert alert-warning">Your school does not use Daily or Weekly scores.</div>`;
                        } else {
                            html = `
                                <div class="form-group">
                                    <label class="form-label">Class</label>
                                    <select id="filterClass" class="form-control">
                                        <option value="">Select Class</option>
                                        ${classes.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Subject</label>
                                    <select id="filterSubject" class="form-control">
                                        <option value="">All Subjects</option>
                                        ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Term</label>
                                    <select id="filterTerm" class="form-control">${termOptions}</select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Year</label>
                                    <select id="filterYear" class="form-control">${yearOptions}</select>
                                </div>
                            `;
                        }
                        break;
                }
                
                filtersContent.innerHTML = html;
            },
            
            generateSelectedReport() {
                const type = this.currentReportType;
                const schoolId = Auth.getCurrentSchoolId();
                const filtersCard = document.getElementById('reportFilters');
                const contentCard = document.getElementById('reportContent');
                const contentBody = document.getElementById('reportContentBody');
                const titleEl = document.getElementById('reportContentTitle');
                
                filtersCard.style.display = 'none';
                contentCard.style.display = 'block';
                
                let html = '';
                
                switch(type) {
                    case 'student':
                        titleEl.textContent = 'Student Report';
                        const studentId = document.getElementById('filterStudent').value;
                        const term = document.getElementById('filterTerm').value;
                        const year = document.getElementById('filterYear').value;
                        
                        if (!studentId) {
                            contentBody.innerHTML = '<p class="text-danger">Please select a student</p>';
                            return;
                        }
                        
                        const student = Storage.getItemById('students', studentId);
                        const scores = Storage.getScores(schoolId, studentId);
                        const termScores = scores.filter(s => s.term === term && s.year === parseInt(year));
                        const reports = Storage.getData('studentReports') || [];
                        const studentReport = reports.find(r => r.studentId === studentId && r.term === term && r.year === parseInt(year));
                        
                        html = `
                            <div class="report-card" style="max-width:800px;margin:0 auto;padding:20px;border:2px solid #333;background:#fff;">
                                <div class="report-header" style="text-align:center;border-bottom:2px solid #333;padding-bottom:15px;margin-bottom:15px;">
                                    <h2>${Auth.getSchool()?.name || 'School'}</h2>
                                    <p>Student Report - ${term} ${year}</p>
                                </div>
                                <div style="display:flex;gap:20px;margin-bottom:20px;">
                                    <div><strong>Name:</strong> ${student?.name}</div>
                                    <div><strong>Class:</strong> ${student?.class}</div>
                                </div>
                                <table style="width:100%;border-collapse:collapse;border:1px solid #333;">
                                    <thead style="background:#f5f5f5;">
                                        <tr>
                                            <th style="border:1px solid #333;padding:8px;">Subject</th>
                                            <th style="border:1px solid #333;padding:8px;text-align:center;">Score</th>
                                            <th style="border:1px solid #333;padding:8px;text-align:center;">Grade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                        `;
                        
                        const subjectScores = {};
                        termScores.forEach(s => {
                            if (!subjectScores[s.subject]) subjectScores[s.subject] = s.score;
                        });
                        
                        Object.keys(subjectScores).forEach(subject => {
                            const score = subjectScores[subject];
                            const grade = score >= 90 ? 'A' : score >= 80 ? 'B' : score >= 70 ? 'C' : score >= 60 ? 'D' : score >= 50 ? 'E' : 'F';
                            html += `
                                <tr>
                                    <td style="border:1px solid #333;padding:8px;">${subject}</td>
                                    <td style="border:1px solid #333;padding:8px;text-align:center;">${score}</td>
                                    <td style="border:1px solid #333;padding:8px;text-align:center;">${grade}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</tbody></table>';
                        
                        if (studentReport) {
                            html += `
                                <div style="margin-top:20px;padding:15px;border:1px solid #ddd;">
                                    <h4>Teacher's Comments</h4>
                                    <p><strong>Academic:</strong> ${studentReport.academic || 'N/A'}</p>
                                    <p><strong>Behavior:</strong> ${studentReport.behavior || 'N/A'}</p>
                                    <p><strong>Recommendation:</strong> ${studentReport.recommendation || 'N/A'}</p>
                                </div>
                            `;
                        }
                        
                        html += '</div>';
                        break;
                        
                    case 'class':
                        titleEl.textContent = 'Class Report';
                        const className = document.getElementById('filterClass').value;
                        const classTerm = document.getElementById('filterTerm').value;
                        const classYear = document.getElementById('filterYear').value;
                        
                        if (!className) {
                            contentBody.innerHTML = '<p class="text-danger">Please select a class</p>';
                            return;
                        }
                        
                        const classStudents = Storage.getStudentsByClass(schoolId, className);
                        html = `<h3>${className} - ${classTerm} ${classYear}</h3>`;
                        html += `<table class="table"><thead><tr><th>Student</th><th>Total Score</th><th>Average</th><th>Grade</th></tr></thead><tbody>`;
                        
                        classStudents.forEach(student => {
                            const scores = Storage.getScores(schoolId, student.id).filter(s => s.term === classTerm && s.year === parseInt(classYear));
                            let total = 0;
                            scores.forEach(s => total += s.score);
                            const avg = scores.length > 0 ? total / scores.length : 0;
                            const grade = avg >= 90 ? 'A' : avg >= 80 ? 'B' : avg >= 70 ? 'C' : avg >= 60 ? 'D' : avg >= 50 ? 'E' : 'F';
                            html += `<tr><td>${student.name}</td><td>${total}</td><td>${avg.toFixed(1)}</td><td>${grade}</td></tr>`;
                        });
                        
                        html += '</tbody></table>';
                        break;
                        
                    case 'attendance':
                        titleEl.textContent = 'Attendance Report';
                        const attClass = document.getElementById('filterClass').value;
                        const attTerm = document.getElementById('filterTerm').value;
                        const attYear = document.getElementById('filterYear').value;
                        
                        if (!attClass) {
                            contentBody.innerHTML = '<p class="text-danger">Please select a class</p>';
                            return;
                        }
                        
                        const attStudents = Storage.getStudentsByClass(schoolId, attClass);
                        const attendance = Storage.getAttendance(schoolId).filter(a => a.class === attClass && a.term === attTerm && a.year === parseInt(attYear));
                        
                        html = `<h3>Attendance - ${attClass} ${attTerm} ${attYear}</h3>`;
                        html += `<table class="table"><thead><tr><th>Student</th><th>Present</th><th>Absent</th><th>Total</th><th>Percentage</th></tr></thead><tbody>`;
                        
                        attStudents.forEach(student => {
                            const studentAtt = attendance.filter(a => a.studentId === student.id);
                            const present = studentAtt.filter(a => a.status === 'present').length;
                            const absent = studentAtt.filter(a => a.status === 'absent').length;
                            const total = present + absent;
                            const pct = total > 0 ? Math.round((present / total) * 100) : 0;
                            html += `<tr><td>${student.name}</td><td>${present}</td><td>${absent}</td><td>${total}</td><td>${pct}%</td></tr>`;
                        });
                        
                        html += '</tbody></table>';
                        break;
                        
                    case 'scores':
                    case 'continuous':
                        titleEl.textContent = type === 'continuous' ? 'Continuous Assessment' : 'Scores Report';
                        const scoreClass = document.getElementById('filterClass').value;
                        const scoreSubject = document.getElementById('filterSubject').value;
                        const scoreTerm = document.getElementById('filterTerm').value;
                        const scoreYear = document.getElementById('filterYear').value;
                        const scoreTypeFilter = document.getElementById('filterScoreType')?.value || 'all';
                        
                        if (!scoreClass) {
                            contentBody.innerHTML = '<p class="text-danger">Please select a class</p>';
                            return;
                        }
                        
                        const scoreStudents = Storage.getStudentsByClass(schoolId, scoreClass);
                        let allScores = Storage.getScores(schoolId).filter(s => s.class === scoreClass && s.term === scoreTerm && s.year === parseInt(scoreYear));
                        
                        if (scoreSubject) allScores = allScores.filter(s => s.subject === scoreSubject);
                        if (scoreTypeFilter !== 'all') allScores = allScores.filter(s => s.type === scoreTypeFilter);
                        
                        const schoolScoreTypes = Storage.getSchoolScoreTypes(schoolId);
                        const hasDaily = schoolScoreTypes.includes('Daily');
                        const hasWeekly = schoolScoreTypes.includes('Weekly');
                        
                        html = `<h3>${type === 'continuous' ? 'Continuous Assessment' : 'Scores'} - ${scoreClass} ${scoreTerm} ${scoreYear}</h3>`;
                        
                        if (type === 'continuous' && (hasDaily || hasWeekly)) {
                            html += `<table class="table"><thead><tr><th>Student</th>`;
                            if (hasDaily) html += `<th>Daily Avg</th>`;
                            if (hasWeekly) html += `<th>Weekly Avg</th>`;
                            html += `<th>Total</th></tr></thead><tbody>`;
                            
                            scoreStudents.forEach(student => {
                                const stuScores = allScores.filter(s => s.studentId === student.id);
                                let dailyTotal = 0, dailyCount = 0, weeklyTotal = 0, weeklyCount = 0;
                                stuScores.forEach(s => {
                                    if (s.type === 'Daily') { dailyTotal += s.score; dailyCount++; }
                                    if (s.type === 'Weekly') { weeklyTotal += s.score; weeklyCount++; }
                                });
                                const dailyAvg = dailyCount > 0 ? (dailyTotal / dailyCount).toFixed(1) : '-';
                                const weeklyAvg = weeklyCount > 0 ? (weeklyTotal / weeklyCount).toFixed(1) : '-';
                                const total = dailyTotal + weeklyTotal;
                                
                                html += `<tr><td>${student.name}</td>`;
                                if (hasDaily) html += `<td>${dailyAvg}</td>`;
                                if (hasWeekly) html += `<td>${weeklyAvg}</td>`;
                                html += `<td>${total}</td></tr>`;
                            });
                        } else {
                            html += `<table class="table"><thead><tr><th>Student</th><th>Subject</th><th>Score</th><th>Type</th></tr></thead><tbody>`;
                            
                            allScores.forEach(s => {
                                const stu = scoreStudents.find(st => st.id === s.studentId);
                                html += `<tr><td>${stu?.name || 'Unknown'}</td><td>${s.subject}</td><td>${s.score}</td><td>${s.type}</td></tr>`;
                            });
                        }
                        
                        html += '</tbody></table>';
                        break;
                }
                
                contentBody.innerHTML = html;
            },
            
            exportReport(format) {
                const schoolId = Auth.getCurrentSchoolId();
                const school = Auth.getSchool();
                if (!schoolId) { Toast.error('No school selected'); return; }
                
                const reportType = this.currentReportType;
                if (!reportType) { Toast.error('Please generate a report first'); return; }
                
                const getEl = (id) => document.getElementById(id);
                const classVal = getEl('filterClass')?.value;
                const termVal = getEl('filterTerm')?.value;
                const yearVal = getEl('filterYear')?.value;
                
                if (!classVal || !termVal || !yearVal) {
                    Toast.error('Please select class, term and year');
                    return;
                }
                
                const schoolScoreTypes = Storage.getSchoolScoreTypes(schoolId);
                const hasDaily = schoolScoreTypes.includes('Daily');
                const hasWeekly = schoolScoreTypes.includes('Weekly');
                
                const getReportContent = () => {
                    let html = '';
                    
                    if (reportType === 'student') {
                        const studentId = getEl('filterStudent')?.value;
                        if (!studentId) return '';
                        const student = Storage.getItemById('students', studentId);
                        const scores = Storage.getScores(schoolId, studentId).filter(s => s.term === termVal && s.year === parseInt(yearVal));
                        
                        html = `
                            <div style="padding: 20px; font-family: Arial, sans-serif;">
                                <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                                <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                                <h3 style="text-align: center; margin: 20px 0;">Student Report - ${termVal} ${yearVal}</h3>
                                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                                    <tr><td><strong>Student:</strong> ${student?.name || 'N/A'}</td><td><strong>Class:</strong> ${student?.class || 'N/A'}</td></tr>
                                </table>
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                                    <tr style="background: #16a34a; color: white;">
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Subject</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Grade</th>
                                    </tr>
                                    ${scores.map(s => {
                                        const grade = s.score >= 90 ? 'A' : s.score >= 80 ? 'B' : s.score >= 70 ? 'C' : s.score >= 60 ? 'D' : s.score >= 50 ? 'E' : 'F';
                                        return `<tr><td style="padding: 8px; border: 1px solid #ddd;">${s.subject}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td><td style="padding: 8px; border: 1px solid #ddd;">${grade}</td></tr>`;
                                    }).join('')}
                                </table>
                                <p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p>
                            </div>
                        `;
                    } else if (reportType === 'class' || reportType === 'scores') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        html = `
                            <div style="padding: 20px; font-family: Arial, sans-serif;">
                                <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                                <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                                <h3 style="text-align: center; margin: 20px 0;">Class Scores - ${classVal} ${termVal} ${yearVal}</h3>
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                                    <tr style="background: #16a34a; color: white;">
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Subject</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Type</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Score</th>
                                    </tr>
                        `;
                        students.forEach(student => {
                            const scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                            if (scores.length === 0) {
                                html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">N/A</td><td style="padding: 8px; border: 1px solid #ddd;">0</td></tr>`;
                            } else {
                                scores.forEach(s => {
                                    html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.subject}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.type}</td><td style="padding: 8px; border: 1px solid #ddd;">${s.score}</td></tr>`;
                                });
                            }
                        });
                        html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
                    } else if (reportType === 'attendance') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        const attendance = Storage.getAttendance(schoolId).filter(a => a.class === classVal && a.term === termVal && a.year === parseInt(yearVal));
                        
                        html = `
                            <div style="padding: 20px; font-family: Arial, sans-serif;">
                                <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                                <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                                <h3 style="text-align: center; margin: 20px 0;">Attendance Report - ${classVal} ${termVal} ${yearVal}</h3>
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                                    <tr style="background: #16a34a; color: white;">
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Present</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Absent</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Total</th>
                                        <th style="padding: 10px; border: 1px solid #16a34a;">%</th>
                                    </tr>
                        `;
                        students.forEach(student => {
                            const stuAtt = attendance.filter(a => a.studentId === student.id);
                            const present = stuAtt.filter(a => a.status === 'present').length;
                            const absent = stuAtt.filter(a => a.status === 'absent').length;
                            const total = present + absent;
                            const pct = total > 0 ? Math.round((present / total) * 100) : 0;
                            html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td><td style="padding: 8px; border: 1px solid #ddd;">${present}</td><td style="padding: 8px; border: 1px solid #ddd;">${absent}</td><td style="padding: 8px; border: 1px solid #ddd;">${total}</td><td style="padding: 8px; border: 1px solid #ddd;">${pct}%</td></tr>`;
                        });
                        html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
                    } else if (reportType === 'continuous') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        html = `
                            <div style="padding: 20px; font-family: Arial, sans-serif;">
                                <h2 style="text-align: center; color: #16a34a;">${school?.name || 'School'}</h2>
                                <p style="text-align: center;">${school?.address || ''} | ${school?.phone || ''}</p>
                                <h3 style="text-align: center; margin: 20px 0;">Continuous Assessment - ${classVal} ${termVal} ${yearVal}</h3>
                                <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                                    <tr style="background: #16a34a; color: white;">
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Student</th>
                                        ${hasDaily ? '<th style="padding: 10px; border: 1px solid #16a34a;">Daily Avg</th>' : ''}
                                        ${hasWeekly ? '<th style="padding: 10px; border: 1px solid #16a34a;">Weekly Avg</th>' : ''}
                                        <th style="padding: 10px; border: 1px solid #16a34a;">Total</th>
                                    </tr>
                        `;
                        students.forEach(student => {
                            const stuScores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                            let dailyTotal = 0, dailyCount = 0, weeklyTotal = 0, weeklyCount = 0;
                            stuScores.forEach(s => {
                                if (s.type === 'Daily') { dailyTotal += s.score; dailyCount++; }
                                if (s.type === 'Weekly') { weeklyTotal += s.score; weeklyCount++; }
                            });
                            const dailyAvg = dailyCount > 0 ? (dailyTotal / dailyCount).toFixed(1) : '-';
                            const weeklyAvg = weeklyCount > 0 ? (weeklyTotal / weeklyCount).toFixed(1) : '-';
                            const total = dailyTotal + weeklyTotal;
                            
                            html += `<tr><td style="padding: 8px; border: 1px solid #ddd;">${student.name}</td>`;
                            if (hasDaily) html += `<td style="padding: 8px; border: 1px solid #ddd;">${dailyAvg}</td>`;
                            if (hasWeekly) html += `<td style="padding: 8px; border: 1px solid #ddd;">${weeklyAvg}</td>`;
                            html += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${total}</strong></td></tr>`;
                        });
                        html += `</table><p style="text-align: center; font-size: 9px; color: #999; margin-top: 30px;">My School System - Odebunmi Tawwab</p></div>`;
                    }
                    
                    return html;
                };
                
                if (format === 'csv') {
                    let csv = '';
                    let filename = '';
                    
                    if (reportType === 'student') {
                        const studentId = getEl('filterStudent')?.value;
                        if (!studentId) { Toast.error('Please select a student'); return; }
                        const student = Storage.getItemById('students', studentId);
                        const scores = Storage.getScores(schoolId, studentId).filter(s => s.term === termVal && s.year === parseInt(yearVal));
                        
                        csv = 'Subject,Score,Grade\n';
                        scores.forEach(s => {
                            const grade = s.score >= 90 ? 'A' : s.score >= 80 ? 'B' : s.score >= 70 ? 'C' : s.score >= 60 ? 'D' : s.score >= 50 ? 'E' : 'F';
                            csv += `${s.subject},${s.score},${grade}\n`;
                        });
                        filename = `student_report_${student.name.replace(/\s/g,'_')}_${termVal}_${yearVal}.csv`;
                    } else if (reportType === 'class' || reportType === 'scores') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        csv = 'Student,Subject,Type,Score\n';
                        students.forEach(student => {
                            const scores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                            if (scores.length === 0) {
                                csv += `${student.name},N/A,N/A,0\n`;
                            } else {
                                scores.forEach(s => {
                                    csv += `${student.name},${s.subject},${s.type},${s.score}\n`;
                                });
                            }
                        });
                        filename = `class_scores_${classVal}_${termVal}_${yearVal}.csv`;
                    } else if (reportType === 'attendance') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        const attendance = Storage.getAttendance(schoolId).filter(a => a.class === classVal && a.term === termVal && a.year === parseInt(yearVal));
                        
                        csv = 'Student,Present,Absent,Total,Percentage\n';
                        students.forEach(student => {
                            const stuAtt = attendance.filter(a => a.studentId === student.id);
                            const present = stuAtt.filter(a => a.status === 'present').length;
                            const absent = stuAtt.filter(a => a.status === 'absent').length;
                            const total = present + absent;
                            const pct = total > 0 ? Math.round((present / total) * 100) : 0;
                            csv += `${student.name},${present},${absent},${total},${pct}%\n`;
                        });
                        filename = `attendance_${classVal}_${termVal}_${yearVal}.csv`;
                    } else if (reportType === 'continuous') {
                        const students = Storage.getStudentsByClass(schoolId, classVal);
                        csv = 'Student';
                        if (hasDaily) csv += ',Daily Avg';
                        if (hasWeekly) csv += ',Weekly Avg';
                        csv += ',Total\n';
                        
                        students.forEach(student => {
                            const stuScores = Storage.getScores(schoolId, student.id).filter(s => s.class === classVal && s.term === termVal && s.year === parseInt(yearVal));
                            let dailyTotal = 0, dailyCount = 0, weeklyTotal = 0, weeklyCount = 0;
                            stuScores.forEach(s => {
                                if (s.type === 'Daily') { dailyTotal += s.score; dailyCount++; }
                                if (s.type === 'Weekly') { weeklyTotal += s.score; weeklyCount++; }
                            });
                            const dailyAvg = dailyCount > 0 ? (dailyTotal / dailyCount).toFixed(1) : '-';
                            const weeklyAvg = weeklyCount > 0 ? (weeklyTotal / weeklyCount).toFixed(1) : '-';
                            const total = dailyTotal + weeklyTotal;
                            
                            csv += `${student.name}`;
                            if (hasDaily) csv += `,${dailyAvg}`;
                            if (hasWeekly) csv += `,${weeklyAvg}`;
                            csv += `,${total}\n`;
                        });
                        filename = `continuous_assessment_${classVal}_${termVal}_${yearVal}.csv`;
                    }
                    
                    if (csv) {
                        csv += `\nMy School System - Odebunmi Tawwab`;
                        const blob = new Blob([csv], { type: 'text/csv' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                        Toast.success('Report exported to CSV');
                    } else {
                        Toast.error('No data to export');
                    }
                } else if (format === 'pdf') {
                    const content = getReportContent();
                    if (!content) {
                        Toast.error('No data to export');
                        return;
                    }
                    
                    const temp = document.createElement('div');
                    temp.innerHTML = content;
                    document.body.appendChild(temp);
                    
                    if (window.html2canvas && window.jspdf) {
                        html2canvas(temp, { scale: 2 }).then(canvas => {
                            const imgData = canvas.toDataURL('image/png');
                            const pdf = new window.jspdf.jsPDF({ orientation: canvas.width > canvas.height ? 'landscape' : 'portrait', unit: 'pt', format: [canvas.width, canvas.height] });
                            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                            pdf.save(`report_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`);
                            document.body.removeChild(temp);
                            Toast.success('Report exported to PDF');
                        }).catch(err => {
                            document.body.removeChild(temp);
                            Toast.error('Error generating PDF');
                        });
                    } else {
                        const fullHtml = `<!DOCTYPE html><html><head><title>Report</title></head><body>${content}</body></html>`;
                        const printWindow = window.open('', '_blank');
                        printWindow.document.write(fullHtml);
                        printWindow.document.close();
                        printWindow.print();
                        document.body.removeChild(temp);
                        Toast.success('Report opened for printing/saving as PDF');
                    }
                } else if (format === 'doc') {
                    const content = getReportContent();
                    if (!content) {
                        Toast.error('No data to export');
                        return;
                    }
                    
                    const fullHtml = `<!DOCTYPE html><html><head><title>Report</title></head><body>${content}</body></html>`;
                    const blob = new Blob([fullHtml], { type: 'application/msword' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `report_${reportType}_${new Date().toISOString().split('T')[0]}.doc`;
                    a.click();
                    URL.revokeObjectURL(url);
                    Toast.success('Report exported to DOC');
                }
            }
        };
        
        window.TeacherReports = TeacherReports;
        
        const TeacherScores = {
            currentScores: {},
            
            init() {
                this.loadClasses();
                this.loadScoreTypes();
            },
            
            loadClasses() {
                const schoolId = Auth.getCurrentSchoolId();
                if (!schoolId) {
                    console.error('No schoolId found for teacher');
                    const select = document.getElementById('scoreClassSelect');
                    if (select) select.innerHTML = '<option value="">Error: No school assigned</option>';
                    return;
                }
                
                // Get unique classes from actual students in the school
                const students = Storage.getStudents(schoolId) || [];
                const uniqueClasses = [...new Set(students.map(s => s.class).filter(c => c))];
                
                console.log('Teacher schoolId:', schoolId);
                console.log('Total students in school:', students.length);
                console.log('Student class names:', uniqueClasses);
                
                const select = document.getElementById('scoreClassSelect');
                if (!select) return;
                
                if (uniqueClasses.length === 0) {
                    select.innerHTML = '<option value="">No students found in any class</option>';
                    return;
                }
                
                // Sort classes naturally (JSS 1, JSS 2, JSS 3, SS 1, etc.)
                const sortClasses = (a, b) => {
                    const order = ['Nursery', 'Primary', 'JSS', 'SS'];
                    const getPrefix = (c) => {
                        for (let o of order) {
                            if (c.startsWith(o)) return o;
                        }
                        return 'Other';
                    };
                    const getNumber = (c) => {
                        const match = c.match(/\d+/);
                        return match ? parseInt(match[0]) : 0;
                    };
                    
                    const prefixA = getPrefix(a);
                    const prefixB = getPrefix(b);
                    
                    if (prefixA !== prefixB) {
                        return order.indexOf(prefixA) - order.indexOf(prefixB);
                    }
                    return getNumber(a) - getNumber(b);
                };
                
                uniqueClasses.sort(sortClasses);
                select.innerHTML = '<option value="">Select Class</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            },
            
            loadScoreTypes() {
                const schoolId = Auth.getCurrentSchoolId();
                if (!schoolId) return;
                const scoreTypes = Storage.getSchoolScoreTypes(schoolId) || [];
                const select = document.getElementById('scoreTypeSelect');
                if (!select) return;
                
                let html = '<option value="">Select Score Type</option>';
                scoreTypes.forEach(type => {
                    const label = type === 'Daily' ? 'Daily Scores (Continuous)' : 
                                 type === 'Weekly' ? 'Weekly Scores (Continuous)' :
                                 type === 'Mid-term' ? 'Mid-term Exam' : 'End of Term Exam';
                    html += `<option value="${type}">${label}</option>`;
                });
                select.innerHTML = html;
            },
            
            loadStudents() {
                const schoolId = Auth.getCurrentSchoolId();
                if (!schoolId) return;
                
                const classSelect = document.getElementById('scoreClassSelect');
                const subjectSelect = document.getElementById('scoreSubjectSelect');
                const scoreTypeSelect = document.getElementById('scoreTypeSelect');
                const selectedClass = classSelect?.value;
                
                if (!selectedClass) {
                    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                    return;
                }
                
                const subjectsObj = Storage.getSchoolSubjects(schoolId) || {};
                const subjects = Array.isArray(subjectsObj) ? subjectsObj : Object.values(subjectsObj).flat() || [];
                subjectSelect.innerHTML = '<option value="">Select Subject</option>' + subjects.map(s => `<option value="${s}">${s}</option>`).join('');
                
                // Auto-select first score type if none selected
                if (!scoreTypeSelect?.value && scoreTypeSelect?.options?.length > 1) {
                    scoreTypeSelect.selectedIndex = 1;
                }
                
                this.loadScoreEntry();
            },
            
            loadScoreEntry() {
                const className = document.getElementById('scoreClassSelect')?.value;
                const scoreType = document.getElementById('scoreTypeSelect')?.value;
                const subject = document.getElementById('scoreSubjectSelect')?.value;
                const container = document.getElementById('scoresTable');
                const titleEl = document.getElementById('scoreEntryTitle');
                
                if (!className) {
                    container.innerHTML = '<p class="text-muted">Please select a class first</p>';
                    return;
                }
                if (!scoreType) {
                    container.innerHTML = '<p class="text-muted">Please select a score type</p>';
                    return;
                }
                if (!subject) {
                    container.innerHTML = '<p class="text-muted">Please select a subject</p>';
                    return;
                }
                
                titleEl.textContent = `${scoreType} - ${subject}`;
                
                const schoolId = Auth.getCurrentSchoolId();
                if (!schoolId) {
                    container.innerHTML = '<p class="text-danger">Error: No school assigned. Please contact administrator.</p>';
                    return;
                }
                
                // Get students from the selected class
                let students = Storage.getStudentsByClass(schoolId, className) || [];
                
                // If no students found, try case-insensitive match
                if (students.length === 0) {
                    const allStudents = Storage.getStudents(schoolId) || [];
                    students = allStudents.filter(s => s.class && s.class.toLowerCase() === className.toLowerCase());
                }
                
                // If still no students, try partial match
                if (students.length === 0) {
                    const allStudents = Storage.getStudents(schoolId) || [];
                    students = allStudents.filter(s => s.class && s.class.toLowerCase().includes(className.toLowerCase()));
                }
                
                if (students.length === 0) {
                    const allStudents = Storage.getStudents(schoolId) || [];
                    const availableClasses = [...new Set(allStudents.map(s => s.class).filter(c => c))];
                    container.innerHTML = `<p class="text-warning">No students found in class "${className}".<br><br>Available classes: ${availableClasses.join(', ') || 'None'}</p>`;
                    return;
                }
                
                const term = document.getElementById('scoreTermSelect').value;
                const year = parseInt(document.getElementById('scoreYearSelect').value);
                
                const allScores = (Storage.getScores(schoolId) || []).filter(s => 
                    s.class === className && 
                    s.subject === subject && 
                    s.term === term && 
                    s.year === year &&
                    s.type === scoreType
                );
                
                this.currentScores = {};
                allScores.forEach(s => {
                    if (!this.currentScores[s.studentId]) this.currentScores[s.studentId] = [];
                    this.currentScores[s.studentId].push(s);
                });
                
                const isContinuous = scoreType === 'Daily' || scoreType === 'Weekly';
                
                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                ${isContinuous ? '<th>Add Score</th>' : '<th>Score (0-100)</th>'}
                                <th>Previous Scores</th>
                                ${isContinuous ? '<th>Average</th><th>Rank</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const studentData = [];
                
                students.forEach(student => {
                    const scores = this.currentScores[student.id] || [];
                    const scoreValues = scores.map(s => s.score);
                    const avg = scoreValues.length > 0 ? scoreValues.reduce((a,b) => a+b, 0) / scoreValues.length : 0;
                    
                    studentData.push({ student, scores, avg });
                });
                
                studentData.sort((a, b) => b.avg - a.avg);
                studentData.forEach((data, index) => {
                    const { student, scores, avg } = data;
                    const rank = avg > 0 ? index + 1 : '-';
                    
                    html += `
                        <tr>
                            <td>${student.name}</td>
                            <td>
                                <input type="number" class="form-control score-input" 
                                    data-student-id="${student.id}" 
                                    data-score-type="${scoreType}"
                                    min="0" max="100" 
                                    placeholder="Enter score"
                                    style="width: 120px;">
                            </td>
                            <td>
                                ${scores.length > 0 ? scores.map(s => `<span class="badge badge-info" style="margin-right: 4px;">${s.score}</span>`).join('') : '-'}
                            </td>
                            ${isContinuous ? `<td><strong>${avg.toFixed(1)}</strong></td><td>${rank}</td>` : ''}
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                if (isContinuous) {
                    document.getElementById('rankingCard').style.display = 'block';
                    document.getElementById('rankingTitle').textContent = `${scoreType} - ${subject} (${term} ${year})`;
                    this.loadRankingTable(studentData, scoreType);
                } else {
                    document.getElementById('rankingCard').style.display = 'none';
                }
            },
            
            loadRankingTable(studentData, scoreType) {
                const container = document.getElementById('rankingTable');
                const ranked = studentData.filter(s => s.avg > 0).sort((a, b) => b.avg - a.avg);
                
                let html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Student</th>
                                <th>Score Count</th>
                                <th>Average</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                ranked.forEach((data, index) => {
                    html += `
                        <tr>
                            <td><span class="badge badge-${index < 3 ? 'success' : 'secondary'}">${index + 1}</span></td>
                            <td>${data.student.name}</td>
                            <td>${data.scores.length}</td>
                            <td><strong>${data.avg.toFixed(1)}</strong></td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html || '<p class="text-muted">No scores recorded yet</p>';
            },
            
            saveScores() {
                const schoolId = Auth.getCurrentSchoolId();
                const className = document.getElementById('scoreClassSelect').value;
                const scoreType = document.getElementById('scoreTypeSelect').value;
                const subject = document.getElementById('scoreSubjectSelect').value;
                const term = document.getElementById('scoreTermSelect').value;
                const year = parseInt(document.getElementById('scoreYearSelect').value);
                
                if (!className || !scoreType || !subject) {
                    Toast.error('Please select class, score type, and subject');
                    return;
                }
                
                const inputs = document.querySelectorAll('.score-input');
                let savedCount = 0;
                
                inputs.forEach(input => {
                    const score = parseFloat(input.value);
                    if (!isNaN(score) && score >= 0 && score <= 100) {
                        const studentId = input.dataset.studentId;
                        
                        const scoreData = {
                            studentId,
                            class: className,
                            subject,
                            type: scoreType,
                            term,
                            year,
                            score,
                            schoolId,
                            createdAt: new Date().toISOString()
                        };
                        
                        Storage.addItem('scores', scoreData);
                        savedCount++;
                    }
                });
                
                if (savedCount > 0) {
                    Toast.success(`${savedCount} score(s) saved successfully`);
                    this.loadScoreEntry();
                } else {
                    Toast.error('No valid scores to save');
                }
            }
        };
        
        window.TeacherScores = TeacherScores;
        
        window.toggleDarkMode = toggleDarkMode;
        window.Teacher = Teacher;
        document.addEventListener('DOMContentLoaded', () => { Teacher.init(); Chat.init(); NotificationPanel.init(); initDarkModeToggle(); Calendar.init(); });
    </script>
</body>
</html>
