<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Director - My School</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    
    <!-- Local Storage Only -->
    <script src="../assets/js/firebase-config.js"></script>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar" id="mainSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-graduation-cap"></i><span>My School</span></div>
                <button class="sidebar-close" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <a href="#" class="nav-item active" data-page="dashboard" onclick="event.preventDefault(); Director.showSection('dashboard')">
                        <i class="fas fa-tachometer-alt"></i><span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Management</div>
                    <a href="#" class="nav-item" data-page="students" onclick="event.preventDefault(); Director.showSection('students')">
                        <i class="fas fa-users"></i><span>Students</span>
                    </a>
                    <a href="#" class="nav-item" data-page="staff" onclick="event.preventDefault(); Director.showSection('staff')">
                        <i class="fas fa-user-tie"></i><span>Staff</span>
                    </a>
                    <a href="#" class="nav-item" data-page="attendance" onclick="event.preventDefault(); Director.showSection('attendance')">
                        <i class="fas fa-qrcode"></i><span>Attendance</span>
                    </a>
                    <a href="#" class="nav-item" data-page="scores" onclick="event.preventDefault(); Director.showSection('scores')">
                        <i class="fas fa-clipboard-list"></i><span>Scores</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Finance</div>
                    <a href="#" class="nav-item" data-page="finance" onclick="event.preventDefault(); Director.showSection('finance')">
                        <i class="fas fa-wallet"></i><span>Finance</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <a href="#" class="nav-item" data-page="reports" onclick="event.preventDefault(); Director.showSection('reports')">
                        <i class="fas fa-file-alt"></i><span>Reports</span>
                    </a>
                    <a href="#" class="nav-item" data-page="idcards" onclick="event.preventDefault(); Director.showSection('idcards')">
                        <i class="fas fa-id-card"></i><span>ID Cards</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Communication</div>
                    <a href="#" class="nav-item" data-page="chat" onclick="event.preventDefault(); Director.showSection('chat')">
                        <i class="fas fa-comments"></i><span>Chat</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Public Pages</div>
                    <a href="../public/blog.html" target="_blank" class="nav-item">
                        <i class="fas fa-blog"></i>
                        <span>Blog</span>
                    </a>
                    <a href="../public/resources.html" target="_blank" class="nav-item">
                        <i class="fas fa-folder-open"></i>
                        <span>Resources</span>
                    </a>
                    <a href="../public/pricing.html" target="_blank" class="nav-item">
                        <i class="fas fa-tags"></i>
                        <span>Pricing</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Support</div>
                    <a href="#" class="nav-item" data-page="help" onclick="event.preventDefault(); Director.showSection('help')">
                        <i class="fas fa-question-circle"></i><span>Help & Guide</span>
                    </a>
                    <a href="#" class="nav-item" data-page="parentAnnouncements" onclick="event.preventDefault(); Director.showSection('parentAnnouncements')">
                        <i class="fas fa-bullhorn"></i><span>Parent Announcements</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Account</div>
                    <a href="#" class="nav-item" data-page="profile" onclick="event.preventDefault(); Director.showSection('profile')">
                        <i class="fas fa-user-circle"></i><span>Profile</span>
                    </a>
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="currentUserAvatar">DIR</div>
                    <div class="user-details">
                        <div class="user-name" id="currentUserName">Director</div>
                        <div class="user-role">Director</div>
                    </div>
                </div>
                <button class="btn logout-btn" onclick="Auth.logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div id="announcementBanner" class="announcement-banner">
                <div class="announcement-content" id="announcementContent"></div>
                <button class="announcement-close" onclick="document.getElementById('announcementBanner').classList.remove('active')">&times;</button>
            </div>
            <nav class="top-navbar">
                <div class="navbar-left">
                    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
                </div>
                <div class="navbar-right">
                    <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="notification-container">
                        <button class="navbar-icon-btn" onclick="NotificationPanel.toggle()">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button class="btn btn-sm btn-link" onclick="NotificationPanel.markAllRead()">Mark all read</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <div class="navbar-profile" onclick="Director.showProfile()">
                        <div class="avatar" id="navAvatar">DIR</div>
                        <span class="name" id="navUserName">Director</span>
                    </div>
                </div>
            </nav>

            <div class="page-content">
                <div id="dashboardSection">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Director Dashboard</h1>
                            <p class="page-subtitle">Welcome, <span id="welcomeName">Director</span></p>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-users"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Students</div>
                                <div class="stat-value" id="totalStudents">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon info"><i class="fas fa-chalkboard-teacher"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Teachers</div>
                                <div class="stat-value" id="totalTeachers">0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="balanceAmount">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon warning"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Attendance</div>
                                <div class="stat-value" id="attendanceRate">0%</div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-3 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fas fa-calendar"></i> Calendar</h3>
                                <button class="btn btn-sm btn-outline" onclick="Calendar.showAddEventModal()">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="calendarWidget" class="calendar-widget"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="analyticsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">School Analytics</h1></div>
                    </div>
                    <div class="grid-2">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Performance Overview</h3></div>
                            <div class="card-body"><canvas id="performanceChart" style="height: 250px;"></canvas></div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Finance Overview</h3></div>
                            <div class="card-body"><canvas id="financeChart" style="height: 250px;"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="reportsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Reports & Analytics</h1>
                        </div>
                    </div>
                    
                    <div class="reports-grid">
                        <div class="report-card-item" onclick="Reports.showReportType('student')">
                            <div class="report-icon"><i class="fas fa-user-graduate"></i></div>
                            <h3>Student Report</h3>
                            <p>Individual student term results</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('class')">
                            <div class="report-icon"><i class="fas fa-users"></i></div>
                            <h3>Class Report</h3>
                            <p>All students in a class</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('attendance')">
                            <div class="report-icon"><i class="fas fa-clipboard-check"></i></div>
                            <h3>Attendance</h3>
                            <p>Daily/weekly/monthly attendance</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('scores')">
                            <div class="report-icon"><i class="fas fa-star"></i></div>
                            <h3>Scores Report</h3>
                            <p>Daily/Weekly/Mid-term/Exam</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('subject')">
                            <div class="report-icon"><i class="fas fa-chart-bar"></i></div>
                            <h3>Subject Analysis</h3>
                            <p>Subject performance analysis</p>
                        </div>
                        <div class="report-card-item" onclick="Reports.showReportType('finance')">
                            <div class="report-icon"><i class="fas fa-wallet"></i></div>
                            <h3>Finance Report</h3>
                            <p>Income & expenses summary</p>
                        </div>
                    </div>
                    
                    <div id="reportFilters" class="card" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title" id="reportTypeTitle">Select Report Options</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-row" id="reportFiltersContent"></div>
                            <div class="flex gap-2 mt-3">
                                <button class="btn btn-primary" onclick="Reports.generateSelectedReport()">
                                    <i class="fas fa-sync"></i> Generate Report
                                </button>
                                <button class="btn btn-outline" onclick="Reports.exportCurrentToCSV()">
                                    <i class="fas fa-file-csv"></i> CSV
                                </button>
                                <button class="btn btn-outline" onclick="Reports.exportCurrentToPDF()">
                                    <i class="fas fa-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="reportContent" class="card mt-3" style="display: none;">
                        <div class="card-body" id="reportContentBody"></div>
                    </div>
                </div>

                <div id="studentsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Students</h1></div>
                        <div class="flex gap-2">
                            <label class="btn btn-outline" style="cursor: pointer;">
                                <i class="fas fa-upload"></i> Import CSV
                                <input type="file" accept=".csv" style="display: none;" onchange="Director.importCSV(this)">
                            </label>
                            <button class="btn btn-outline" onclick="Students.export('csv')">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button class="btn btn-primary" onclick="Modal.show('addStudentModal')">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body" id="studentsTable"></div>
                    </div>
                </div>

                <div id="staffSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Staff Management</h1></div>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn active" data-tab="teachers" onclick="Director.switchStaffTab('teachers')">Teachers</button>
                        <button class="tab-btn" data-tab="accountants" onclick="Director.switchStaffTab('accountants')">Accountants</button>
                    </div>
                    <div class="card">
                        <div class="card-body" id="staffTable"></div>
                    </div>
                </div>

                <div id="attendanceSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Attendance</h1></div>
                    </div>
                    <div class="grid-2 mb-3">
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">Manual Attendance</h3></div>
                            <div class="card-body">
                                <div class="filters-bar">
                                    <div class="filter-group">
                                        <label>Class:</label>
                                        <select id="classSelect" class="form-control"></select>
                                    </div>
                                    <div class="filter-group">
                                        <label>Date:</label>
                                        <input type="date" id="attendanceDate" class="form-control">
                                    </div>
                                    <button class="btn btn-primary" onclick="Attendance.loadStudents()">Load</button>
                                    <button class="btn btn-success" onclick="Attendance.markAllPresent()">Mark All Present</button>
                                </div>
                                <div id="studentsList"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header"><h3 class="card-title">QR Scan Attendance</h3></div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Scan Date:</label>
                                    <input type="date" id="scanAttendanceDate" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label>Enter Student ID:</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="scanStudentInput" class="form-control" placeholder="Enter student ID">
                                        <button class="btn btn-primary" onclick="QR.scanStudentForAttendance()">Mark Present</button>
                                    </div>
                                </div>
                                <div id="scanResult" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="scoresSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Scores & Grades</h1></div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="filters-bar">
                                <div class="filter-group">
                                    <label>Class:</label>
                                    <select id="scoreClassSelect" class="form-control"></select>
                                </div>
                                <div class="filter-group">
                                    <label>Subject:</label>
                                    <select id="scoreSubjectSelect" class="form-control"></select>
                                </div>
                                <div class="filter-group">
                                    <label>Term:</label>
                                    <select id="scoreTermSelect" class="form-control">
                                        <option value="First Term">First Term</option>
                                        <option value="Second Term">Second Term</option>
                                        <option value="Third Term">Third Term</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label>Year:</label>
                                    <select id="scoreYearSelect" class="form-control">
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026" selected>2026</option>
                                    </select>
                                </div>
                                <button class="btn btn-primary" onclick="Scores.loadScores()">Load</button>
                                <button class="btn btn-success" onclick="Scores.addScore()">Add Score</button>
                            </div>
                            <div id="scoresTable"></div>
                        </div>
                    </div>
                </div>

                <div id="financeSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">Finance</h1></div>
                        <button class="btn btn-primary" onclick="Modal.show('addTransactionModal')">
                            <i class="fas fa-plus"></i> Add Transaction
                        </button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon success"><i class="fas fa-arrow-up"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Income</div>
                                <div class="stat-value" id="totalIncome">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon danger"><i class="fas fa-arrow-down"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Total Expenses</div>
                                <div class="stat-value" id="totalExpenses">₦0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon primary"><i class="fas fa-wallet"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Balance</div>
                                <div class="stat-value" id="balance">₦0</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Transactions</h3>
                        </div>
                        <div class="card-body" id="transactionsList"></div>
                    </div>
                </div>

                <div id="idcardsSection" style="display: none;">
                    <div class="page-header">
                        <div><h1 class="page-title">ID Cards</h1></div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Select Type</label>
                                    <select id="idCardType" class="form-control" onchange="Director.loadIDCardUsers()">
                                        <option value="student">Student</option>
                                        <option value="teacher">Teacher</option>
                                        <option value="accountant">Accountant</option>
                                        <option value="director">Director</option>
                                        <option value="school_admin">School Admin</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Select Person</label>
                                    <select id="idCardUser" class="form-control"></select>
                                </div>
                                <div class="form-group">
                                    <label>Format</label>
                                    <select id="idCardFormat" class="form-control">
                                        <option value="portrait">Portrait</option>
                                        <option value="landscape">Landscape</option>
                                    </select>
                                </div>
                            </div>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-primary" onclick="Director.generateIDCard()">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Front Only</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-success" onclick="Director.downloadIDCard('png', 'portrait')">
                                    <i class="fas fa-image"></i> Portrait PNG
                                </button>
                                <button class="btn btn-success" onclick="Director.downloadIDCard('png', 'landscape')">
                                    <i class="fas fa-image"></i> Landscape PNG
                                </button>
                                <button class="btn btn-danger" onclick="Director.downloadIDCard('pdf', 'portrait')">
                                    <i class="fas fa-file-pdf"></i> Portrait PDF
                                </button>
                                <button class="btn btn-danger" onclick="Director.downloadIDCard('pdf', 'landscape')">
                                    <i class="fas fa-file-pdf"></i> Landscape PDF
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Back Only</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-outline" onclick="Director.downloadIDCardBack('png', 'portrait')">
                                    <i class="fas fa-image"></i> Portrait PNG
                                </button>
                                <button class="btn btn-outline" onclick="Director.downloadIDCardBack('png', 'landscape')">
                                    <i class="fas fa-image"></i> Landscape PNG
                                </button>
                                <button class="btn btn-outline" onclick="Director.downloadIDCardBack('pdf', 'portrait')">
                                    <i class="fas fa-file-pdf"></i> Portrait PDF
                                </button>
                                <button class="btn btn-outline" onclick="Director.downloadIDCardBack('pdf', 'landscape')">
                                    <i class="fas fa-file-pdf"></i> Landscape PDF
                                </button>
                            </div>
                            <p class="form-label" style="font-weight:600;margin-bottom:8px;">Download Both Sides</p>
                            <div class="flex gap-2 mb-3">
                                <button class="btn btn-info" onclick="Director.downloadIDCardBoth('png', 'side')">
                                    <i class="fas fa-images"></i> Side by Side (PNG)
                                </button>
                                <button class="btn btn-info" onclick="Director.downloadIDCardBoth('png', 'stack')">
                                    <i class="fas fa-images"></i> Stacked (PNG)
                                </button>
                                <button class="btn btn-warning" onclick="Director.downloadIDCardBoth('pdf', 'pdf')">
                                    <i class="fas fa-file-pdf"></i> PDF (2 pages)
                                </button>
                            </div>
                            <div id="idCardPreview" style="margin-top: 24px; display: flex; justify-content: center; flex-wrap: wrap; gap: 20px;"></div>
                        </div>
                    </div>
                </div>

                <div id="chatSection" style="display: none;">
                    <div class="page-header"><div><h1 class="page-title">Chat</h1></div></div>
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-sidebar" id="chatSidebar">
                            <button class="chat-sidebar-close" id="chatSidebarClose" onclick="Chat.closeSidebar()" style="display: none;">&times;</button>
                            <div class="chat-search"><input type="text" id="chatSearch" placeholder="Search..."></div>
                            <button class="btn btn-outline mt-2" id="newChatBtn" style="width:100%" onclick="Chat.showNewChatModal()">New Chat</button>
                            <div class="chat-list" id="chatList"></div>
                            <div id="groupsList"></div>
                            <button class="btn btn-primary mt-2" id="createGroupBtn" style="width:100%" onclick="Chat.showCreateGroupModal()">Create Group Chat</button>
                        </div>
                        <div class="chat-main" id="chatMain">
                            <div class="chat-header" id="chatHeader">
                                <button class="chat-back-btn" id="chatBackBtn" onclick="Chat.showSidebar()" style="display: none;"><i class="fas fa-arrow-left"></i></button>
                                <div class="chat-header-info"><h3>Select a conversation</h3></div>
                            </div>
                            <div class="chat-messages" id="chatMessages"></div>
                            <div class="chat-input-area">
                                <button class="btn btn-icon" onclick="Chat.showEmojiPicker()" title="Emoji">
                                    <i class="fas fa-smile"></i>
                                </button>
                                <input type="text" id="chatInput" placeholder="Type a message...">
                                <div class="chat-input-actions">
                                    <button id="fileBtn" title="Attach File"><i class="fas fa-paperclip"></i></button>
                                    <button id="voiceBtn" title="Voice Message"><i class="fas fa-microphone"></i></button>
                                    <button id="sendBtn" class="send-btn" title="Send"><i class="fas fa-paper-plane"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Group Chat Creation Modal -->
                <div id="createGroupModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Create Group Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('createGroupModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Group Name</label>
                                <input type="text" id="groupNameInput" class="form-control" placeholder="Enter group name">
                            </div>
                            <div class="form-group">
                                <label>Select Staff Members</label>
                                <button class="btn btn-outline mt-2" onclick="Chat.selectAllStaff()">Select All Staff</button>
                                <div id="groupStaffList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; margin-top: 10px;">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="Modal.hide('createGroupModal')">Cancel</button>
                            <button class="btn btn-primary" onclick="Chat.createGroupChat()">Create Group</button>
                        </div>
                    </div>
                </div>

                <!-- New Chat Modal -->
                <div id="newChatModal" class="modal-overlay" style="display:none;">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">Start New Chat</h3>
                            <button class="modal-close" onclick="Modal.hide('newChatModal')">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="newChatSearch" class="form-control" placeholder="Search users..." oninput="Chat.filterNewChatUsers(this.value)">
                            <div id="newChatUserList" style="max-height: 300px; overflow-y: auto; margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <div id="helpSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Help & Guide</h1>
                            <p class="page-subtitle">Learn how to use the system effectively</p>
                        </div>
                    </div>
                    <div id="helpGuideContainer"></div>
                </div>

                <!-- Parent Announcements Section -->
                <div id="parentAnnouncementsSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">Parent Announcements</h1>
                            <p class="page-subtitle">Create announcements visible only to parents</p>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bullhorn"></i> Create New Announcement</h3>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Message</label>
                                <textarea id="parentAnnouncementMessage" class="form-control" rows="3" placeholder="Enter announcement message for parents..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="Director.createParentAnnouncement()">
                                <i class="fas fa-paper-plane"></i> Post to Parents
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-list"></i> Previous Announcements</h3>
                        </div>
                        <div class="card-body">
                            <div id="parentAnnouncementsList"></div>
                        </div>
                    </div>
                </div>

                <div id="profileSection" style="display: none;">
                    <div class="page-header">
                        <div>
                            <h1 class="page-title">My Profile</h1>
                            <p class="page-subtitle">Manage your account settings</p>
                        </div>
                    </div>
                    <div class="profile-page">
                        <div class="profile-header-card">
                            <div class="profile-avatar-section">
                                <div class="profile-avatar-large" id="profileAvatarLarge">
                                    <img id="profileAvatarImg" src="" alt="Profile" style="display: none;">
                                    <span id="profileAvatarInitials"></span>
                                </div>
                                <label class="profile-avatar-edit">
                                    <i class="fas fa-camera"></i>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="Profile.handleAvatarUpload(this)">
                                </label>
                            </div>
                            <div class="profile-header-info">
                                <h2 id="profileName">Director</h2>
                                <p id="profileRole">Director</p>
                                <p class="profile-member-since"><i class="fas fa-calendar"></i> Member since: <span id="profileMemberSince">-</span></p>
                            </div>
                            <div class="profile-stats">
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="activityScore">0</div>
                                    <div class="profile-stat-label">Activity Score</div>
                                </div>
                                <div class="profile-stat-item">
                                    <div class="profile-stat-value" id="totalLogins">0</div>
                                    <div class="profile-stat-label">Total Logins</div>
                                </div>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-user"></i> Personal Information</h3></div>
                                <div class="card-body">
                                    <form id="profileForm">
                                        <div class="form-group"><label class="form-label">Full Name</label><input type="text" id="profileNameInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Email</label><input type="email" id="profileEmailInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Phone</label><input type="tel" id="profilePhoneInput" class="form-control"></div>
                                        <div class="form-group"><label class="form-label">Address</label><textarea id="profileAddressInput" class="form-control" rows="2"></textarea></div>
                                        <div class="form-group"><label class="form-label">Gender</label><select id="profileGenderInput" class="form-control"><option value="">Select</option><option value="male">Male</option><option value="female">Female</option></select></div>
                                        <button type="button" class="btn btn-primary" onclick="Profile.saveProfile()"><i class="fas fa-save"></i> Save Changes</button>
                                    </form>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-header"><h3 class="card-title"><i class="fas fa-lock"></i> Change Password</h3></div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="form-group"><label class="form-label">Current Password</label><input type="password" id="currentPassword" class="form-control" required></div>
                                        <div class="form-group"><label class="form-label">New Password</label><input type="password" id="newPassword" class="form-control" required minlength="6"></div>
                                        <div class="form-group"><label class="form-label">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" required></div>
                                        <button type="button" class="btn btn-warning" onclick="Profile.changePassword()"><i class="fas fa-key"></i> Change Password</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-history"></i> Recent Activity</h3></div>
                            <div class="card-body"><div id="profileActivityList"><div class="empty-state"><p>No recent activity</p></div></div></div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-header"><h3 class="card-title"><i class="fas fa-bell"></i> Notifications</h3></div>
                            <div class="card-body"><div id="profileNotifications"><div class="empty-state"><p>No notifications</p></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>My School System</span>
            </div>
            <div class="footer-links">
                <a href="../public/blog.html" target="_blank"><i class="fas fa-blog"></i> Blog</a>
                <a href="../public/resources.html" target="_blank"><i class="fas fa-folder-open"></i> Resources</a>
                <a href="../public/pricing.html" target="_blank"><i class="fas fa-tags"></i> Pricing</a>
                <a href="../public/privacy.html" target="_blank"><i class="fas fa-shield-alt"></i> Privacy</a>
                <a href="../public/terms.html" target="_blank"><i class="fas fa-file-contract"></i> Terms</a>
            </div>
            <div class="footer-info">
                <p>&copy; 2026 My School System. All rights reserved.</p>
                <p>My School System - Odebunmi Tawwab</p>
            </div>
            <div class="footer-social">
                <a href="https://facebook.com" target="_blank" title="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://twitter.com" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>
                <a href="https://instagram.com" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                <a href="https://linkedin.com" target="_blank" title="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
            </div>
        </div>
    </footer>
    </div>

    <div id="toastContainer" class="toast-container"></div>

    <div id="addStudentModal" class="modal-overlay">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 class="modal-title">Add Student</h3>
                <button class="modal-close" onclick="Modal.hide('addStudentModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form id="studentForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Full Name</label>
                            <input type="text" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Class</label>
                            <input type="text" name="class" class="form-control" required placeholder="e.g., JSS 1A">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" name="phone" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" name="dob" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gender</label>
                            <select name="gender" class="form-control">
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Parent Name</label>
                            <input type="text" name="parentName" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Parent Phone</label>
                            <input type="tel" name="parentPhone" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Address</label>
                        <textarea name="address" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Passport Photo (Optional)</label>
                        <div class="file-upload-wrapper">
                            <input type="file" id="studentPassport" accept="image/*" onchange="Director.previewStudentPassport(this)">
                            <div id="studentPassportPreview" class="passport-preview" style="display:none;">
                                <img id="studentPassportImg" src="" alt="Passport Preview">
                                <button type="button" class="btn btn-sm btn-danger" onclick="Director.clearStudentPassport()">Remove</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('addStudentModal')">Cancel</button>
                <button class="btn btn-primary" onclick="Director.saveStudent()">Save Student</button>
            </div>
        </div>
    </div>

    <div id="addTransactionModal" class="modal-overlay">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="../assets/js/storage.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/core.js"></script>
    <script src="../assets/js/attendance.js"></script>
    <script src="../assets/js/theme.js"></script>
    <script src="../assets/js/finance.js"></script>
    <script src="../assets/js/reports.js"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="../assets/js/chat.js"></script>
    <script src="../assets/js/qr.js"></script>
    <script src="../assets/js/calendar.js"></script>
    <script src="../assets/js/export.js"></script>
    <script>
        const Director = {
            init() {
                if (!Auth.checkRole(['director'])) {
                    window.location.href = '../login.html';
                    return;
                }
                const user = Auth.getCurrentUser();
                document.getElementById('welcomeName').textContent = user.name.split(' ')[0];
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('navUserName').textContent = user.name;
                document.getElementById('currentUserAvatar').textContent = Utils.getInitials(user.name);
                document.getElementById('navAvatar').textContent = Utils.getInitials(user.name);
                displayAnnouncementBanner();
                this.loadDashboard();
                this.applyFeatureRestrictions();
            },
            
            applyFeatureRestrictions() {
                const restrictions = [
                    { feature: 'chat', navPage: 'chat' },
                    { feature: 'scores_entry', navPage: 'scores' },
                    { feature: 'attendance_qr', navPage: 'attendance' },
                    { feature: 'id_cards', navPage: 'idcards' },
                    { feature: 'finance', navPage: 'finance' },
                    { feature: 'reports', navPage: 'reports' }
                ];
                
                restrictions.forEach(r => {
                    if (!Auth.hasFeature(r.feature)) {
                        if (r.navPage) {
                            const navItem = document.querySelector(`.nav-item[data-page="${r.navPage}"]`);
                            if (navItem) navItem.style.display = 'none';
                        }
                    }
                });
            },
            
            checkFeatureAccess(feature) {
                if (!Auth.hasFeature(feature)) {
                    const features = Auth.RESTRICTABLE_FEATURES;
                    Toast.error(`This feature (${features[feature] || feature}) has been restricted by the Super Admin.`);
                    return false;
                }
                return true;
            },
            loadDashboard() {
                const schoolId = Auth.getCurrentSchoolId();
                const students = Storage.getStudents(schoolId);
                const users = Storage.getUsers(schoolId);
                const teachers = users.filter(u => u.role === 'teacher');
                const finance = Storage.getFinance(schoolId);
                
                const income = finance.filter(f => f.type === 'income').reduce((s, f) => s + f.amount, 0);
                const expenses = finance.filter(f => f.type === 'expense').reduce((s, f) => s + f.amount, 0);
                
                document.getElementById('totalStudents').textContent = students.length;
                document.getElementById('totalTeachers').textContent = teachers.length;
                document.getElementById('balanceAmount').textContent = '₦' + Utils.formatNumber(income - expenses);
                document.getElementById('attendanceRate').textContent = '95%';
            },
            showSection(section) {
                const featureMap = {
                    'chat': 'chat',
                    'scores': 'scores_entry',
                    'attendance': 'attendance_qr',
                    'idcards': 'id_cards',
                    'finance': 'finance',
                    'reports': 'reports'
                };
                
                if (featureMap[section] && !Auth.hasFeature(featureMap[section])) {
                    Toast.error(`This feature has been restricted by the Super Admin.`);
                    return;
                }
                
                // Hide all sections
                document.querySelectorAll('#dashboardSection, #studentsSection, #staffSection, #attendanceSection, #scoresSection, #financeSection, #reportsSection, #idcardsSection, #chatSection, #helpSection, #parentAnnouncementsSection, #profileSection').forEach(el => {
                    if (el) el.style.display = 'none';
                });
                
                // Show target section
                const targetEl = document.getElementById(section + 'Section');
                if (targetEl) targetEl.style.display = 'block';
                
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === section) item.classList.add('active');
                });
                
                if (section === 'students') Students.loadStudents();
                if (section === 'staff') this.showStaffList('teachers');
                if (section === 'attendance') {
                    Attendance.init();
                }
                if (section === 'scores') Scores.init();
                if (section === 'finance') Finance.init();
                if (section === 'reports') Reports.init();
                if (section === 'chat') Chat.init();
                if (section === 'idcards') this.loadIDCardUsers();
                if (section === 'help') this.loadHelpGuide();
                if (section === 'parentAnnouncements') this.loadParentAnnouncements();
                if (section === 'profile') Profile.init();
            },
            loadHelpGuide() {
                const role = 'director';
                const content = Storage.getHelpContent(role);
                const container = document.getElementById('helpGuideContainer');
                
                if (!content || !content.sections || !content.sections.length) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-question-circle"></i><h3>No help content available</h3><p>Contact your administrator for assistance.</p></div>';
                    return;
                }
                
                let html = `
                    <div class="help-guide-container">
                        <div class="help-guide-header">
                            <h2>${content.title}</h2>
                        </div>
                        <div class="help-guide-accordion">
                `;
                
                content.sections.forEach((section, index) => {
                    html += `
                        <div class="help-accordion-item ${index === 0 ? 'active' : ''}">
                            <div class="help-accordion-header" onclick="this.parentElement.classList.toggle('active')">
                                <div class="help-accordion-title">
                                    <i class="fas ${section.icon || 'fa-book'}"></i>
                                    <span>${section.title}</span>
                                </div>
                                <i class="fas fa-chevron-down help-accordion-arrow"></i>
                            </div>
                            <div class="help-accordion-body">
                                <div class="help-content">${section.content}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                container.innerHTML = html;
            },
            loadParentAnnouncements() {
                const schoolId = Auth.getCurrentSchoolId();
                const announcements = Storage.getParentAnnouncements(schoolId);
                const container = document.getElementById('parentAnnouncementsList');
                
                if (!announcements || announcements.length === 0) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-bullhorn"></i><p>No announcements yet</p></div>';
                    return;
                }
                
                let html = '';
                announcements.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(ann => {
                    const date = new Date(ann.createdAt).toLocaleDateString() + ' ' + new Date(ann.createdAt).toLocaleTimeString();
                    html += `
                        <div class="announcement-item" style="padding: 15px; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <p style="margin: 0 0 8px;">${ann.message}</p>
                                    <small class="text-muted">${date}</small>
                                </div>
                                <button class="btn btn-sm btn-outline" onclick="Director.deleteParentAnnouncement('${ann.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            },
            createParentAnnouncement() {
                const message = document.getElementById('parentAnnouncementMessage').value.trim();
                if (!message) {
                    Toast.error('Please enter a message');
                    return;
                }
                const schoolId = Auth.getCurrentSchoolId();
                const user = Auth.getCurrentUser();
                Storage.addParentAnnouncement(message, schoolId, user.id);
                document.getElementById('parentAnnouncementMessage').value = '';
                Toast.success('Announcement posted to parents');
                this.loadParentAnnouncements();
            },
            deleteParentAnnouncement(id) {
                Storage.deleteParentAnnouncement(id);
                Toast.success('Announcement removed');
                this.loadParentAnnouncements();
            },
            saveStudent() {
                const form = document.getElementById('studentForm');
                const formData = new FormData(form);
                const studentData = Object.fromEntries(formData.entries());
                studentData.schoolId = Auth.getCurrentSchoolId();
                studentData.status = 'active';
                
                const passportInput = document.getElementById('studentPassport');
                if (passportInput && passportInput.files[0]) {
                    Director.processStudentPassport(passportInput.files[0], (passportUrl) => {
                        studentData.passportUrl = passportUrl;
                        Director.saveStudentData(studentData, form);
                    });
                } else {
                    Director.saveStudentData(studentData, form);
                }
            },
            processStudentPassport(file, callback) {
                if (file.size > 500 * 1024) {
                    Toast.error('Image size must be less than 500KB');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    callback(e.target.result);
                };
                reader.readAsDataURL(file);
            },
            previewStudentPassport(input) {
                if (input.files && input.files[0]) {
                    if (input.files[0].size > 500 * 1024) {
                        Toast.error('Image size must be less than 500KB');
                        input.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('studentPassportPreview').style.display = 'block';
                        document.getElementById('studentPassportImg').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            clearStudentPassport() {
                document.getElementById('studentPassport').value = '';
                document.getElementById('studentPassportPreview').style.display = 'none';
                document.getElementById('studentPassportImg').src = '';
            },
            saveStudentData(studentData, form) {
                const result = Storage.addItem('students', studentData);
                
                if (result) {
                    Toast.success('Student added successfully');
                    Modal.hide('addStudentModal');
                    form.reset();
                    Director.clearStudentPassport();
                    Students.loadStudents();
                } else {
                    Toast.error('Failed to add student');
                }
            },
            showStaffList(filter) {
                const schoolId = Auth.getCurrentSchoolId();
                let users = Storage.getUsers(schoolId);
                
                if (filter === 'teachers') {
                    users = users.filter(u => u.role === 'teacher');
                } else if (filter === 'accountants') {
                    users = users.filter(u => u.role === 'accountant');
                }
                
                const container = document.getElementById('staffTable');
                if (!users.length) {
                    container.innerHTML = '<div class="empty-state"><p>No staff found</p></div>';
                    return;
                }
                
                let html = '<table class="table"><thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Email</th><th>Phone</th></tr></thead><tbody>';
                users.forEach(u => {
                    html += `<tr><td>${u.name}</td><td>${u.username}</td><td>${u.role}</td><td>${u.email}</td><td>${u.phone}</td></tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            },
            switchStaffTab(tab) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tab) btn.classList.add('active');
                });
                this.showStaffList(tab);
            },
            importCSV(input) {
                const file = input.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim());
                    if (lines.length < 2) {
                        Toast.error('CSV file is empty');
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                    let imported = 0;
                    const schoolId = Auth.getCurrentSchoolId();
                    
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((h, idx) => row[h] = values[idx] || '');
                        
                        if (row.name && row.class) {
                            Storage.addItem('students', {
                                name: row.name,
                                class: row.class,
                                email: row.email || '',
                                phone: row.phone || '',
                                gender: row.gender || '',
                                parentName: row.parentname || '',
                                parentPhone: row.parentphone || '',
                                schoolId,
                                status: 'active'
                            });
                            imported++;
                        }
                    }
                    
                    Toast.success(`Imported ${imported} students`);
                    Students.loadStudents();
                    input.value = '';
                };
                reader.readAsText(file);
            },
            loadIDCardUsers() {
                const schoolId = Auth.getCurrentSchoolId();
                const type = document.getElementById('idCardType').value;
                const select = document.getElementById('idCardUser');
                
                let users = [];
                if (type === 'student') {
                    users = Storage.getStudents(schoolId);
                } else if (type === 'teacher') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'teacher');
                } else if (type === 'accountant') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'accountant');
                } else if (type === 'director') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'director');
                } else if (type === 'school_admin') {
                    users = Storage.getUsers(schoolId).filter(u => u.role === 'school_admin');
                }
                
                select.innerHTML = '<option value="">Select...</option>' + users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
            },
            async generateIDCard() {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                
                const cardData = await IDCard.generate(userId, type);
                if (cardData) IDCard.render(cardData);
            },
            async downloadIDCard(format, orientation) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.download(userId, orientation, format);
                    } else {
                        await IDCard.downloadStaff(userId, orientation, format);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card');
                }
                Loading.hide();
            },
            async downloadIDCardBack(format, orientation) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.downloadBack(userId, orientation, format);
                    } else {
                        await IDCard.downloadStaffBack(userId, orientation, format);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card back');
                }
                Loading.hide();
            },
            async downloadIDCardBoth(format, layout) {
                const userId = document.getElementById('idCardUser').value;
                const type = document.getElementById('idCardType').value;
                if (!userId) {
                    Toast.error('Please select a person');
                    return;
                }
                Loading.show();
                try {
                    if (type === 'student') {
                        await IDCard.downloadBoth(userId, 'portrait', format, layout);
                    } else {
                        await IDCard.downloadStaffBoth(userId, 'portrait', format, layout);
                    }
                } catch (e) {
                    Toast.error('Error generating ID card');
                }
                Loading.hide();
            },
            generateReport() {
                document.getElementById('reportContent').innerHTML = '<p>Select a student and term to generate report</p>';
            },
            showProfile() {
                this.showSection('profile');
            }
        };

        const NotificationPanel = {
            init() { this.loadNotifications(); },
            loadNotifications() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
                const unreadNotifications = notifications.filter(n => n.userId === user.id && !n.read);
                const dot = document.getElementById('notificationDot');
                if (dot) dot.style.display = unreadNotifications.length > 0 ? 'block' : 'none';
                const list = document.getElementById('notificationList');
                if (!list) return;
                if (userNotifications.length === 0) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-bell-slash"></i><p>No notifications</p></div>';
                    return;
                }
                let html = '';
                userNotifications.forEach(notif => {
                    const time = this.getTimeAgo(notif.createdAt);
                    const iconClass = this.getIconClass(notif.type);
                    html += `<div class="notification-dropdown-item ${notif.read ? '' : 'unread'}" onclick="NotificationPanel.handleNotificationClick('${notif.id}')">
                        <div class="notification-dropdown-icon ${notif.type || 'info'}"><i class="fas ${iconClass}"></i></div>
                        <div class="notification-dropdown-content"><p>${notif.message}</p><div class="notification-dropdown-time">${time}</div></div></div>`;
                });
                list.innerHTML = html;
            },
            getIconClass(type) {
                const icons = { info: 'fa-info-circle', success: 'fa-check-circle', warning: 'fa-exclamation-circle', error: 'fa-times-circle', message: 'fa-envelope', student: 'fa-user-graduate', score: 'fa-clipboard-list', attendance: 'fa-clipboard-check', finance: 'fa-wallet' };
                return icons[type] || 'fa-bell';
            },
            getTimeAgo(dateStr) {
                const date = new Date(dateStr), now = new Date(), diff = now - date;
                const minutes = Math.floor(diff / 60000), hours = Math.floor(diff / 3600000), days = Math.floor(diff / 86400000);
                if (minutes < 1) return 'Just now';
                if (minutes < 60) return `${minutes}m ago`;
                if (hours < 24) return `${hours}h ago`;
                if (days < 7) return `${days}d ago`;
                return date.toLocaleDateString();
            },
            toggle() {
                const dropdown = document.getElementById('notificationDropdown');
                dropdown.classList.toggle('show');
                if (dropdown.classList.contains('show')) this.loadNotifications();
            },
            handleNotificationClick(notifId) {
                const notifications = Storage.getData('notifications') || [];
                const index = notifications.findIndex(n => n.id === notifId);
                if (index !== -1) { notifications[index].read = true; Storage.setData('notifications', notifications); this.loadNotifications(); }
                document.getElementById('notificationDropdown').classList.remove('show');
            },
            markAllRead() {
                const user = Auth.getCurrentUser();
                const notifications = Storage.getData('notifications') || [];
                notifications.forEach(n => { if (n.userId === user.id) n.read = true; });
                Storage.setData('notifications', notifications);
                this.loadNotifications();
            }
        };

        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notificationDropdown');
            const btn = document.querySelector('.notification-container');
            if (dropdown && btn && !btn.contains(e.target)) dropdown.classList.remove('show');
        });

        Profile.init = function() { this.loadProfile(); };
        
        Profile.loadProfile = function() {
            const user = Auth.getCurrentUser();
            if (!user) return;
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1).replace('_', ' ');
            document.getElementById('profileNameInput').value = user.name || '';
            document.getElementById('profileEmailInput').value = user.email || '';
            document.getElementById('profilePhoneInput').value = user.phone || '';
            document.getElementById('profileAddressInput').value = user.address || '';
            document.getElementById('profileGenderInput').value = user.gender || '';
            document.getElementById('profileAvatarInitials').textContent = Utils.getInitials(user.name);
            if (user.avatar) {
                const img = document.getElementById('profileAvatarImg');
                img.src = user.avatar;
                img.style.display = 'block';
                document.getElementById('profileAvatarInitials').style.display = 'none';
            }
            document.getElementById('profileMemberSince').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
            const activityData = this.getActivityData();
            document.getElementById('activityScore').textContent = activityData.score;
            document.getElementById('totalLogins').textContent = activityData.logins;
            this.loadRecentActivity();
            this.loadNotifications();
        };
        
        Profile.getActivityData = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id);
            return { score: Math.min(100, userActivities.length * 5 + 10), logins: userActivities.filter(a => a.type === 'login').length || 1 };
        };
        
        Profile.loadRecentActivity = function() {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            const userActivities = activities.filter(a => a.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileActivityList');
            if (!userActivities.length) { container.innerHTML = '<div class="empty-state"><p>No recent activity</p></div>'; return; }
            let html = '<div class="activity-timeline">';
            userActivities.forEach(activity => {
                const iconMap = { login: 'fa-sign-in-alt', profile_update: 'fa-user-edit', password_change: 'fa-key' };
                html += `<div class="activity-item"><div class="activity-icon"><i class="fas ${iconMap[activity.type] || 'fa-circle'}"></i></div><div class="activity-content"><p>${activity.description || activity.type}</p><span class="activity-time">${new Date(activity.timestamp).toLocaleString()}</span></div></div>`;
            });
            container.innerHTML = html + '</div>';
        };
        
        Profile.loadNotifications = function() {
            const user = Auth.getCurrentUser();
            const notifications = Storage.getData('notifications') || [];
            const userNotifications = notifications.filter(n => n.userId === user.id).slice(0, 10);
            const container = document.getElementById('profileNotifications');
            if (!userNotifications.length) { container.innerHTML = '<div class="empty-state"><p>No notifications</p></div>'; return; }
            let html = '<div class="notifications-list">';
            userNotifications.forEach(notif => { html += `<div class="notification-item ${notif.read ? '' : 'unread'}"><div class="notification-icon"><i class="fas fa-bell"></i></div><div class="notification-content"><p>${notif.message}</p><span class="notification-time">${new Date(notif.timestamp || notif.createdAt).toLocaleString()}</span></div></div>`; });
            container.innerHTML = html + '</div>';
        };
        
        Profile.handleAvatarUpload = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => { this.updateAvatar(e.target.result); };
            reader.readAsDataURL(file);
            input.value = '';
        };
        
        Profile.updateAvatar = function(avatarData) {
            const user = Auth.getCurrentUser();
            const result = Auth.updateProfile(user.id, { avatar: avatarData });
            if (result.success) { Toast.success('Profile picture updated'); this.loadProfile(); this.updateNavAvatar(avatarData); this.updateSidebarAvatar(avatarData); }
            else { Toast.error('Failed to update profile picture'); }
        };
        
        Profile.updateNavAvatar = function(avatarData) {
            const navAvatar = document.getElementById('navAvatar');
            if (navAvatar && avatarData) { navAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        
        Profile.updateSidebarAvatar = function(avatarData) {
            const sidebarAvatar = document.getElementById('currentUserAvatar');
            if (sidebarAvatar && avatarData) { sidebarAvatar.innerHTML = `<img src="${avatarData}" style="width: 100%; height: 100%; object-fit: cover;">`; }
        };
        
        Profile.saveProfile = function() {
            const user = Auth.getCurrentUser();
            const name = document.getElementById('profileNameInput').value.trim();
            const email = document.getElementById('profileEmailInput').value.trim();
            const phone = document.getElementById('profilePhoneInput').value.trim();
            const address = document.getElementById('profileAddressInput').value.trim();
            const gender = document.getElementById('profileGenderInput').value;
            if (!name) { Toast.error('Name is required'); return; }
            const result = Auth.updateProfile(user.id, { name, email, phone, address, gender });
            if (result.success) { Toast.success('Profile updated successfully'); this.loadProfile(); this.logActivity('profile_update', 'Updated profile'); Auth.addNotification(user.id, 'Your profile information was updated', 'info'); NotificationPanel.init(); }
            else { Toast.error('Failed to update profile'); }
        };
        
        Profile.changePassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            if (!currentPassword || !newPassword || !confirmPassword) { Toast.error('Please fill all password fields'); return; }
            if (newPassword !== confirmPassword) { Toast.error('New passwords do not match'); return; }
            if (newPassword.length < 6) { Toast.error('Password must be at least 6 characters'); return; }
            const user = Auth.getCurrentUser();
            const result = Auth.changePassword(user.id, currentPassword, newPassword);
            if (result.success) { Toast.success('Password changed successfully'); document.getElementById('passwordForm').reset(); this.logActivity('password_change', 'Changed password'); Auth.addNotification(user.id, 'Your password was changed successfully', 'success'); NotificationPanel.init(); }
            else { Toast.error(result.message); }
        };
        
        Profile.logActivity = function(type, description) {
            const user = Auth.getCurrentUser();
            const activities = Storage.getData('activities') || [];
            activities.push({ id: Storage.generateId(), userId: user.id, type, description, timestamp: new Date().toISOString() });
            Storage.setData('activities', activities);
        };
        
        function toggleSidebar() { document.querySelector('.sidebar').classList.toggle('active'); }
        
        // Close sidebar when clicking on nav items (mobile)
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (window.innerWidth <= 992) {
                    document.querySelector('.sidebar').classList.remove('active');
                }
            });
        });
        
        // Close sidebar when clicking outside (mobile overlay)
        document.addEventListener('click', (e) => {
            const sidebar = document.querySelector('.sidebar');
            const menuToggle = document.querySelector('.menu-toggle');
            if (window.innerWidth <= 992 && 
                sidebar && sidebar.classList.contains('active') &&
                !sidebar.contains(e.target) && 
                !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
        
        function toggleDarkMode() {
            const isDark = ThemeManager.toggleDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        function initDarkModeToggle() {
            const isDark = ThemeManager.isDarkMode();
            const icon = document.querySelector('.dark-mode-toggle i');
            if (icon) icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        window.toggleDarkMode = toggleDarkMode;
        window.Director = Director;
        document.addEventListener('DOMContentLoaded', () => { Director.init(); Chat.init(); NotificationPanel.init(); initDarkModeToggle(); Calendar.init(); });
    </script>
</body>
</html>
